{% extends "base.html" %}

{% block title %}Bank Reconciliation - TekVwarho ProAudit{% endblock %}

{% block head %}
<style>
    [x-cloak] { display: none !important; }
    .match-line { 
        background: linear-gradient(90deg, #dcfce7 0%, #dcfce7 100%);
    }
    .unmatched-line {
        background: linear-gradient(90deg, #fef9c3 0%, #fef9c3 100%);
    }
    .charge-line {
        background: linear-gradient(90deg, #fee2e2 0%, #fee2e2 100%);
    }
    .confidence-high { color: #16a34a; }
    .confidence-medium { color: #ca8a04; }
    .confidence-low { color: #dc2626; }
</style>
{% endblock %}

{% block content %}
<div x-data="bankReconciliationApp()" x-init="init()" x-cloak>
    <!-- Page Header -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Bank Reconciliation</h1>
            <p class="text-gray-600">Nigerian-compliant bank reconciliation with auto-charge detection</p>
        </div>
        <div class="mt-4 lg:mt-0 flex flex-wrap gap-3">
            <button @click="showImportModal = true" 
                    class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                Import CSV
            </button>
            <button @click="syncFromBank()" :disabled="!selectedAccount || syncing"
                    class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-5 h-5 mr-2" :class="{ 'animate-spin': syncing }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span x-text="syncing ? 'Syncing...' : 'Sync Bank'"></span>
            </button>
            <button @click="showNewReconciliationModal = true" 
                    class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                New Reconciliation
            </button>
            <button @click="showAccountModal = true" 
                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                </svg>
                Add Account
            </button>
            <button @click="showGLLinkageModal = true; validateAllGLLinkages()" 
                    class="inline-flex items-center px-4 py-2 border border-amber-300 text-amber-700 bg-amber-50 rounded-lg hover:bg-amber-100 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                </svg>
                GL Linkage
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-blue-100">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-xs text-gray-500">Bank Accounts</p>
                    <p class="text-xl font-bold text-gray-900" x-text="summary.total_accounts || 0"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-green-100">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-xs text-gray-500">Matched</p>
                    <p class="text-xl font-bold text-green-600" x-text="currentRecon?.matched_transactions || 0"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-amber-100">
                    <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-xs text-gray-500">Unmatched</p>
                    <p class="text-xl font-bold text-amber-600" x-text="currentRecon?.unmatched_transactions || 0"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center">
                <div class="p-2 rounded-lg bg-red-100">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-xs text-gray-500">Bank Charges</p>
                    <p class="text-xl font-bold text-red-600" x-text="formatCurrency(currentRecon?.bank_charges || 0)"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center">
                <div class="p-2 rounded-lg" :class="(currentRecon?.difference || 0) == 0 ? 'bg-green-100' : 'bg-red-100'">
                    <svg class="w-6 h-6" :class="(currentRecon?.difference || 0) == 0 ? 'text-green-600' : 'text-red-600'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-xs text-gray-500">Difference</p>
                    <p class="text-xl font-bold" :class="(currentRecon?.difference || 0) == 0 ? 'text-green-600' : 'text-red-600'" x-text="formatCurrency(currentRecon?.difference || 0)"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Left Panel: Bank Accounts & Reconciliations -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Bank Accounts List -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-4 py-3 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Bank Accounts</h2>
                </div>
                <div class="divide-y divide-gray-200 max-h-64 overflow-y-auto">
                    <template x-for="account in accounts" :key="account.id">
                        <div @click="selectAccount(account)" 
                             class="px-4 py-3 cursor-pointer hover:bg-gray-50 transition-colors"
                             :class="{ 'bg-blue-50 border-l-4 border-blue-500': selectedAccount?.id === account.id }">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium text-gray-900" x-text="account.bank_name"></p>
                                    <p class="text-sm text-gray-500" x-text="'***' + account.account_number.slice(-4)"></p>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold text-gray-900" x-text="formatCurrency(account.current_balance)"></p>
                                    <span x-show="account.has_api_integration" class="inline-flex items-center text-xs text-green-600">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        API Linked
                                    </span>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">
                                Last reconciled: <span x-text="account.last_reconciled_date ? formatDate(account.last_reconciled_date) : 'Never'"></span>
                            </p>
                        </div>
                    </template>
                    <div x-show="accounts.length === 0" class="px-4 py-8 text-center text-gray-500">
                        <p>No bank accounts yet</p>
                        <button @click="showAccountModal = true" class="mt-2 text-blue-600 hover:underline">Add your first account</button>
                    </div>
                </div>
            </div>

            <!-- Reconciliations List -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200" x-show="selectedAccount">
                <div class="px-4 py-3 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Reconciliations</h2>
                </div>
                <div class="divide-y divide-gray-200 max-h-72 overflow-y-auto">
                    <template x-for="recon in reconciliations" :key="recon.id">
                        <div @click="selectReconciliation(recon)" 
                             class="px-4 py-3 cursor-pointer hover:bg-gray-50"
                             :class="{ 'bg-blue-50 border-l-4 border-blue-500': currentRecon?.id === recon.id }">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium text-gray-900" x-text="formatDate(recon.reconciliation_date)"></p>
                                    <p class="text-xs text-gray-500" x-text="recon.reference || 'No ref'"></p>
                                </div>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                      :class="{
                                          'bg-gray-100 text-gray-800': recon.status === 'draft',
                                          'bg-blue-100 text-blue-800': recon.status === 'in_progress',
                                          'bg-amber-100 text-amber-800': recon.status === 'in_review',
                                          'bg-green-100 text-green-800': recon.status === 'approved' || recon.status === 'completed',
                                          'bg-red-100 text-red-800': recon.status === 'rejected'
                                      }" x-text="recon.status.replace('_', ' ')"></span>
                            </div>
                            <div class="flex justify-between mt-1 text-xs text-gray-500">
                                <span x-text="'Diff: ' + formatCurrency(recon.difference)"></span>
                                <span :class="recon.difference == 0 ? 'text-green-600' : 'text-red-600'" x-text="recon.difference == 0 ? 'Balanced' : 'Unbalanced'"></span>
                            </div>
                        </div>
                    </template>
                    <div x-show="reconciliations.length === 0" class="px-4 py-6 text-center text-gray-500 text-sm">
                        No reconciliations for this account
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Transaction Matching -->
        <div class="lg:col-span-3">
            <!-- Reconciliation Actions Bar -->
            <div x-show="currentRecon" class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-medium text-gray-700">
                            Period: <span x-text="formatDate(currentRecon?.period_start) + ' - ' + formatDate(currentRecon?.period_end)"></span>
                        </span>
                        <span class="text-sm text-gray-500">|</span>
                        <span class="text-sm">
                            Status: <span class="font-medium" :class="{
                                'text-gray-600': currentRecon?.status === 'draft',
                                'text-blue-600': currentRecon?.status === 'in_progress',
                                'text-amber-600': currentRecon?.status === 'in_review',
                                'text-green-600': currentRecon?.status === 'approved' || currentRecon?.status === 'completed',
                                'text-red-600': currentRecon?.status === 'rejected'
                            }" x-text="currentRecon?.status?.replace('_', ' ') || ''"></span>
                        </span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button @click="runAutoMatch()" :disabled="autoMatching"
                                class="inline-flex items-center px-3 py-1.5 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 disabled:opacity-50">
                            <svg class="w-4 h-4 mr-1" :class="{ 'animate-spin': autoMatching }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Auto Match
                        </button>
                        <button @click="autoCreateChargeAdjustments()" 
                                class="inline-flex items-center px-3 py-1.5 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Auto-Detect Charges
                        </button>
                        <button @click="showAdjustmentModal = true" 
                                class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-gray-700 text-sm rounded-lg hover:bg-gray-50">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Adjustment
                        </button>
                        <template x-if="currentRecon?.status === 'draft' || currentRecon?.status === 'in_progress'">
                            <button @click="submitForReview()" :disabled="currentRecon?.difference != 0"
                                    class="inline-flex items-center px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                Submit for Review
                            </button>
                        </template>
                        <template x-if="currentRecon?.status === 'in_review'">
                            <div class="flex gap-2">
                                <button @click="approveReconciliation()" 
                                        class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                                    Approve
                                </button>
                                <button @click="showRejectModal = true" 
                                        class="inline-flex items-center px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700">
                                    Reject
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Tabs for Transactions, Adjustments, Unmatched -->
            <div x-show="currentRecon" class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button @click="activeTab = 'transactions'" 
                                class="px-6 py-3 text-sm font-medium border-b-2 transition-colors"
                                :class="activeTab === 'transactions' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                            Transactions
                            <span class="ml-2 px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs" x-text="transactions.length"></span>
                        </button>
                        <button @click="activeTab = 'adjustments'" 
                                class="px-6 py-3 text-sm font-medium border-b-2 transition-colors"
                                :class="activeTab === 'adjustments' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                            Adjustments
                            <span class="ml-2 px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs" x-text="adjustments.length"></span>
                        </button>
                        <button @click="activeTab = 'unmatched'" 
                                class="px-6 py-3 text-sm font-medium border-b-2 transition-colors"
                                :class="activeTab === 'unmatched' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                            Unmatched Items
                            <span class="ml-2 px-2 py-0.5 bg-amber-100 text-amber-600 rounded-full text-xs" x-text="unmatchedItems.length"></span>
                        </button>
                    </nav>
                </div>

                <!-- Transactions Tab -->
                <div x-show="activeTab === 'transactions'" class="p-4">
                    <!-- Filter Bar -->
                    <div class="flex flex-wrap gap-3 mb-4">
                        <select x-model="txnFilter" class="text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Transactions</option>
                            <option value="unmatched">Unmatched Only</option>
                            <option value="matched">Matched Only</option>
                            <option value="charges">Bank Charges</option>
                        </select>
                        <div class="flex-1"></div>
                        <span class="text-sm text-gray-500" x-text="filteredTransactions.length + ' transactions'"></span>
                    </div>

                    <!-- Transactions Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Debit</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Credit</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Confidence</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="txn in filteredTransactions" :key="txn.id">
                                    <tr :class="{
                                        'match-line': txn.match_status === 'auto_matched' || txn.match_status === 'manual_matched',
                                        'unmatched-line': txn.match_status === 'unmatched',
                                        'charge-line': txn.is_bank_charge
                                    }">
                                        <td class="px-4 py-3 text-sm text-gray-900" x-text="formatDate(txn.transaction_date)"></td>
                                        <td class="px-4 py-3">
                                            <div class="text-sm text-gray-900" x-text="txn.description"></div>
                                            <div class="flex gap-1 mt-1">
                                                <span x-show="txn.is_emtl" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-700">EMTL</span>
                                                <span x-show="txn.is_stamp_duty" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-700">Stamp Duty</span>
                                                <span x-show="txn.is_vat" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-700">VAT</span>
                                                <span x-show="txn.is_wht" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-700">WHT</span>
                                                <span x-show="txn.is_bank_charge && !txn.is_emtl && !txn.is_stamp_duty" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700">Charge</span>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-right text-red-600 font-medium" x-text="txn.debit_amount > 0 ? formatCurrency(txn.debit_amount) : '-'"></td>
                                        <td class="px-4 py-3 text-sm text-right text-green-600 font-medium" x-text="txn.credit_amount > 0 ? formatCurrency(txn.credit_amount) : '-'"></td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                                  :class="{
                                                      'bg-green-100 text-green-800': txn.match_status === 'auto_matched' || txn.match_status === 'manual_matched',
                                                      'bg-amber-100 text-amber-800': txn.match_status === 'unmatched',
                                                      'bg-blue-100 text-blue-800': txn.match_status === 'reconciled'
                                                  }" x-text="txn.match_status?.replace('_', ' ') || 'unmatched'"></span>
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <span x-show="txn.match_confidence" 
                                                  class="text-sm font-medium"
                                                  :class="{
                                                      'confidence-high': txn.match_confidence >= 90,
                                                      'confidence-medium': txn.match_confidence >= 70 && txn.match_confidence < 90,
                                                      'confidence-low': txn.match_confidence < 70
                                                  }" x-text="txn.match_confidence + '%'"></span>
                                            <span x-show="!txn.match_confidence" class="text-gray-400">-</span>
                                        </td>
                                        <td class="px-4 py-3 text-right">
                                            <div class="flex justify-end gap-2">
                                                <button x-show="txn.match_status === 'unmatched'" 
                                                        @click="showManualMatchModal(txn)"
                                                        class="text-blue-600 hover:text-blue-800 text-sm">Match</button>
                                                <button x-show="txn.match_status === 'auto_matched' || txn.match_status === 'manual_matched'" 
                                                        @click="unmatchTransaction(txn)"
                                                        class="text-red-600 hover:text-red-800 text-sm">Unmatch</button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div x-show="filteredTransactions.length === 0" class="py-8 text-center text-gray-500">
                        <p>No transactions found</p>
                    </div>
                </div>

                <!-- Adjustments Tab -->
                <div x-show="activeTab === 'adjustments'" class="p-4">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Affects</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Posted</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="adj in adjustments" :key="adj.id">
                                    <tr>
                                        <td class="px-4 py-3">
                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium"
                                                  :class="{
                                                      'bg-blue-100 text-blue-800': adj.adjustment_type === 'deposit_in_transit',
                                                      'bg-purple-100 text-purple-800': adj.adjustment_type === 'outstanding_check',
                                                      'bg-red-100 text-red-800': ['bank_charges', 'emtl', 'stamp_duty'].includes(adj.adjustment_type),
                                                      'bg-green-100 text-green-800': adj.adjustment_type === 'interest_earned',
                                                      'bg-gray-100 text-gray-800': !['deposit_in_transit', 'outstanding_check', 'bank_charges', 'emtl', 'stamp_duty', 'interest_earned'].includes(adj.adjustment_type)
                                                  }" x-text="adj.adjustment_type?.replace(/_/g, ' ') || 'other'"></span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-900" x-text="adj.description"></td>
                                        <td class="px-4 py-3 text-sm text-right font-medium" x-text="formatCurrency(adj.amount)"></td>
                                        <td class="px-4 py-3 text-center text-xs">
                                            <span x-show="adj.affects_bank" class="text-blue-600 mr-1">Bank</span>
                                            <span x-show="adj.affects_book" class="text-purple-600">Book</span>
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <span x-show="adj.is_posted" class="text-green-600">Yes</span>
                                            <span x-show="!adj.is_posted" class="text-gray-400">No</span>
                                        </td>
                                        <td class="px-4 py-3 text-right">
                                            <button @click="deleteAdjustment(adj)" x-show="!adj.is_posted"
                                                    class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div x-show="adjustments.length === 0" class="py-8 text-center text-gray-500">
                        <p>No adjustments yet</p>
                    </div>
                    <div x-show="adjustments.length > 0 && adjustments.some(a => !a.is_posted)" class="mt-4 flex justify-end">
                        <button @click="postAdjustments()" 
                                class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Post Adjustments to GL
                        </button>
                    </div>
                </div>

                <!-- Unmatched Items Tab -->
                <div x-show="activeTab === 'unmatched'" class="p-4">
                    <div x-show="unmatchedItems.length > 0" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="item in unmatchedItems" :key="item.id">
                                    <tr>
                                        <td class="px-4 py-3">
                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-amber-100 text-amber-800"
                                                  x-text="item.item_type?.replace(/_/g, ' ') || 'unknown'"></span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-900" x-text="formatDate(item.transaction_date)"></td>
                                        <td class="px-4 py-3 text-sm text-gray-900" x-text="item.description"></td>
                                        <td class="px-4 py-3 text-sm text-right font-medium" x-text="formatCurrency(item.amount)"></td>
                                        <td class="px-4 py-3 text-center">
                                            <span :class="item.status === 'resolved' ? 'text-green-600' : 'text-amber-600'" x-text="item.status"></span>
                                        </td>
                                        <td class="px-4 py-3 text-right">
                                            <button @click="resolveUnmatchedItem(item)" x-show="item.status !== 'resolved'"
                                                    class="text-blue-600 hover:text-blue-800 text-sm">Resolve</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div x-show="unmatchedItems.length === 0" class="py-8 text-center text-gray-500">
                        <p>No unmatched items</p>
                        <button @click="autoCreateUnmatchedItems()" class="mt-2 text-blue-600 hover:underline">
                            Auto-create from unmatched transactions
                        </button>
                    </div>
                </div>
            </div>

            <!-- Empty State when no reconciliation selected -->
            <div x-show="!currentRecon" class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
                <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900">No Reconciliation Selected</h3>
                <p class="mt-2 text-gray-500">Select a bank account and reconciliation to start matching transactions.</p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Bank Account Modal -->
    <div x-show="showAccountModal" x-cloak 
         class="fixed inset-0 z-50 overflow-y-auto" 
         @keydown.escape.window="showAccountModal = false">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="showAccountModal = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Add Bank Account</h3>
                <form @submit.prevent="createAccount()">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bank Name</label>
                                <select x-model="accountForm.bank_name" required
                                        class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select bank...</option>
                                    <optgroup label="Commercial Banks">
                                        <option value="Access Bank">Access Bank</option>
                                        <option value="Citibank Nigeria">Citibank Nigeria</option>
                                        <option value="Ecobank Nigeria">Ecobank Nigeria</option>
                                        <option value="Fidelity Bank">Fidelity Bank</option>
                                        <option value="First Bank of Nigeria">First Bank of Nigeria</option>
                                        <option value="First City Monument Bank (FCMB)">First City Monument Bank (FCMB)</option>
                                        <option value="Globus Bank">Globus Bank</option>
                                        <option value="Guaranty Trust Bank (GTBank)">Guaranty Trust Bank (GTBank)</option>
                                        <option value="Heritage Bank">Heritage Bank</option>
                                        <option value="Keystone Bank">Keystone Bank</option>
                                        <option value="Polaris Bank">Polaris Bank</option>
                                        <option value="Premium Trust Bank">Premium Trust Bank</option>
                                        <option value="Providus Bank">Providus Bank</option>
                                        <option value="Stanbic IBTC Bank">Stanbic IBTC Bank</option>
                                        <option value="Standard Chartered Bank">Standard Chartered Bank</option>
                                        <option value="Sterling Bank">Sterling Bank</option>
                                        <option value="SunTrust Bank">SunTrust Bank</option>
                                        <option value="Titan Trust Bank">Titan Trust Bank</option>
                                        <option value="Union Bank of Nigeria">Union Bank of Nigeria</option>
                                        <option value="United Bank for Africa (UBA)">United Bank for Africa (UBA)</option>
                                        <option value="Unity Bank">Unity Bank</option>
                                        <option value="Wema Bank">Wema Bank</option>
                                        <option value="Zenith Bank">Zenith Bank</option>
                                    </optgroup>
                                    <optgroup label="Merchant Banks">
                                        <option value="Coronation Merchant Bank">Coronation Merchant Bank</option>
                                        <option value="FBN Merchant Bank">FBN Merchant Bank</option>
                                        <option value="FSDH Merchant Bank">FSDH Merchant Bank</option>
                                        <option value="Nova Merchant Bank">Nova Merchant Bank</option>
                                        <option value="Rand Merchant Bank">Rand Merchant Bank</option>
                                    </optgroup>
                                    <optgroup label="Digital/Mobile Banks">
                                        <option value="Kuda Bank">Kuda Bank</option>
                                        <option value="Moniepoint MFB">Moniepoint MFB</option>
                                        <option value="OPay">OPay</option>
                                        <option value="PalmPay">PalmPay</option>
                                        <option value="Rubies Bank">Rubies Bank</option>
                                        <option value="Sparkle MFB">Sparkle MFB</option>
                                        <option value="VFD Microfinance Bank">VFD Microfinance Bank</option>
                                    </optgroup>
                                    <optgroup label="Microfinance Banks">
                                        <option value="AB Microfinance Bank">AB Microfinance Bank</option>
                                        <option value="Accion MFB">Accion MFB</option>
                                        <option value="Baobab MFB">Baobab MFB</option>
                                        <option value="CEMCS MFB">CEMCS MFB</option>
                                        <option value="Coronation MFB">Coronation MFB</option>
                                        <option value="Ekondo MFB">Ekondo MFB</option>
                                        <option value="e-Barcs MFB">e-Barcs MFB</option>
                                        <option value="FairMoney MFB">FairMoney MFB</option>
                                        <option value="Fina Trust MFB">Fina Trust MFB</option>
                                        <option value="First Multiple MFB">First Multiple MFB</option>
                                        <option value="Hasal MFB">Hasal MFB</option>
                                        <option value="Infinity MFB">Infinity MFB</option>
                                        <option value="LAPO MFB">LAPO MFB</option>
                                        <option value="Mainstreet MFB">Mainstreet MFB</option>
                                        <option value="Mutual Trust MFB">Mutual Trust MFB</option>
                                        <option value="NPF MFB">NPF MFB</option>
                                        <option value="Peace MFB">Peace MFB</option>
                                        <option value="Renmoney MFB">Renmoney MFB</option>
                                        <option value="Seedvest MFB">Seedvest MFB</option>
                                        <option value="TCF MFB">TCF MFB</option>
                                        <option value="Unical MFB">Unical MFB</option>
                                    </optgroup>
                                    <optgroup label="Development Banks">
                                        <option value="Bank of Agriculture (BOA)">Bank of Agriculture (BOA)</option>
                                        <option value="Bank of Industry (BOI)">Bank of Industry (BOI)</option>
                                        <option value="Development Bank of Nigeria">Development Bank of Nigeria</option>
                                        <option value="NEXIM Bank">NEXIM Bank</option>
                                    </optgroup>
                                    <optgroup label="Other">
                                        <option value="Other">Other (Enter manually)</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Account Number</label>
                                <input type="text" x-model="accountForm.account_number" required maxlength="10" pattern="[0-9]{10}"
                                       placeholder="10-digit NUBAN"
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <!-- Custom Bank Name (if Other selected) -->
                        <div x-show="accountForm.bank_name === 'Other'" x-cloak>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Custom Bank Name</label>
                            <input type="text" x-model="accountForm.custom_bank_name" 
                                   :required="accountForm.bank_name === 'Other'"
                                   placeholder="Enter bank name"
                                   class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Account Name</label>
                            <input type="text" x-model="accountForm.account_name" required
                                   class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Account Type</label>
                                <select x-model="accountForm.account_type"
                                        class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="current">Current</option>
                                    <option value="savings">Savings</option>
                                    <option value="domiciliary">Domiciliary</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                                <select x-model="accountForm.currency"
                                        class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="NGN">NGN - Naira</option>
                                    <option value="USD">USD - Dollar</option>
                                    <option value="GBP">GBP - Pound</option>
                                    <option value="EUR">EUR - Euro</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Opening Balance</label>
                                <input type="number" step="0.01" x-model="accountForm.opening_balance"
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Opening Balance Date</label>
                                <input type="date" x-model="accountForm.opening_balance_date"
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">GL Account Code (Optional)</label>
                            <input type="text" x-model="accountForm.gl_account_code"
                                   class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" @click="showAccountModal = false"
                                class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
                        <button type="submit" :disabled="savingAccount"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                            <span x-text="savingAccount ? 'Creating...' : 'Create Account'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- New Reconciliation Modal -->
    <div x-show="showNewReconciliationModal" x-cloak 
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="showNewReconciliationModal = false">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="showNewReconciliationModal = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">New Reconciliation</h3>
                <form @submit.prevent="createReconciliation()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bank Account</label>
                            <select x-model="reconForm.bank_account_id" required
                                    class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select account...</option>
                                <template x-for="acc in accounts" :key="acc.id">
                                    <option :value="acc.id" x-text="acc.bank_name + ' - ' + acc.account_number"></option>
                                </template>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Period Start</label>
                                <input type="date" x-model="reconForm.period_start" required
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Period End</label>
                                <input type="date" x-model="reconForm.period_end" required
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Reconciliation Date</label>
                            <input type="date" x-model="reconForm.reconciliation_date" required
                                   class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Statement Opening Balance</label>
                                <input type="number" step="0.01" x-model="reconForm.statement_opening_balance" required
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Statement Closing Balance</label>
                                <input type="number" step="0.01" x-model="reconForm.statement_closing_balance" required
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Book Opening Balance</label>
                                <input type="number" step="0.01" x-model="reconForm.book_opening_balance" required
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Book Closing Balance</label>
                                <input type="number" step="0.01" x-model="reconForm.book_closing_balance" required
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Reference (Optional)</label>
                            <input type="text" x-model="reconForm.reference" placeholder="e.g., RECON-2026-01"
                                   class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" @click="showNewReconciliationModal = false"
                                class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
                        <button type="submit" :disabled="creatingRecon"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
                            <span x-text="creatingRecon ? 'Creating...' : 'Create Reconciliation'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Import CSV Modal -->
    <div x-show="showImportModal" x-cloak 
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="showImportModal = false">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="showImportModal = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Import Bank Statement (CSV)</h3>
                <form @submit.prevent="importCSV()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bank Account</label>
                            <select x-model="importForm.account_id" required
                                    class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select account...</option>
                                <template x-for="acc in accounts" :key="acc.id">
                                    <option :value="acc.id" x-text="acc.bank_name + ' - ' + acc.account_number"></option>
                                </template>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">CSV File</label>
                            <input type="file" @change="handleFileSelect" accept=".csv"
                                   class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Date Column</label>
                                <input type="text" x-model="importForm.date_column" value="Date"
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description Column</label>
                                <input type="text" x-model="importForm.description_column" value="Description"
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Debit Column</label>
                                <input type="text" x-model="importForm.debit_column" value="Debit"
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Credit Column</label>
                                <input type="text" x-model="importForm.credit_column" value="Credit"
                                       class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date Format</label>
                            <select x-model="importForm.date_format"
                                    class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                <option value="%Y-%m-%d">YYYY-MM-DD</option>
                                <option value="%d/%m/%Y">DD/MM/YYYY</option>
                                <option value="%d-%m-%Y">DD-MM-YYYY</option>
                                <option value="%m/%d/%Y">MM/DD/YYYY</option>
                            </select>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <p class="text-sm text-blue-800">
                                <strong>Auto-Detection:</strong> Nigerian bank charges (EMTL, Stamp Duty, VAT, WHT) will be automatically detected from transaction descriptions.
                            </p>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" @click="showImportModal = false"
                                class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
                        <button type="submit" :disabled="importing"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                            <span x-text="importing ? 'Importing...' : 'Import'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Adjustment Modal -->
    <div x-show="showAdjustmentModal" x-cloak 
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="showAdjustmentModal = false">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="showAdjustmentModal = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Add Adjustment</h3>
                <form @submit.prevent="addAdjustment()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Adjustment Type</label>
                            <select x-model="adjustmentForm.adjustment_type" required
                                    class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select type...</option>
                                <option value="deposit_in_transit">Deposit in Transit</option>
                                <option value="outstanding_check">Outstanding Check</option>
                                <option value="bank_charges">Bank Charges</option>
                                <option value="emtl">EMTL (Electronic Money Transfer Levy)</option>
                                <option value="stamp_duty">Stamp Duty</option>
                                <option value="vat">VAT</option>
                                <option value="wht">WHT (Withholding Tax)</option>
                                <option value="interest_earned">Interest Earned</option>
                                <option value="sms_fee">SMS Alert Fee</option>
                                <option value="maintenance_fee">Account Maintenance Fee</option>
                                <option value="bank_error">Bank Error</option>
                                <option value="book_error">Book Error</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                            <input type="number" step="0.01" x-model="adjustmentForm.amount" required
                                   class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea x-model="adjustmentForm.description" required rows="2"
                                      class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="checkbox" x-model="adjustmentForm.affects_bank"
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Affects Bank Balance</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="adjustmentForm.affects_book"
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Affects Book Balance</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" @click="showAdjustmentModal = false"
                                class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
                        <button type="submit" :disabled="addingAdjustment"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                            <span x-text="addingAdjustment ? 'Adding...' : 'Add Adjustment'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- GL Linkage Validation Modal -->
    <div x-show="showGLLinkageModal" x-cloak 
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="showGLLinkageModal = false">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="showGLLinkageModal = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">GL Linkage Validation</h3>
                    <button @click="showGLLinkageModal = false" class="text-gray-400 hover:text-gray-500"></button>
                </div>
                
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                    <!-- Loading State -->
                    <div x-show="validatingGLLinkage" class="text-center py-8">
                        <div class="animate-spin w-10 h-10 border-4 border-amber-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p class="text-gray-600">Validating GL linkages...</p>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div x-show="!validatingGLLinkage && glLinkageResult" class="space-y-6">
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <div class="bg-blue-50 rounded-lg p-4 text-center">
                                <p class="text-2xl font-bold text-blue-600" x-text="glLinkageResult?.total_accounts || 0"></p>
                                <p class="text-xs text-blue-700">Total Accounts</p>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4 text-center">
                                <p class="text-2xl font-bold text-green-600" x-text="glLinkageResult?.linked_count || 0"></p>
                                <p class="text-xs text-green-700">Properly Linked</p>
                            </div>
                            <div class="bg-amber-50 rounded-lg p-4 text-center">
                                <p class="text-2xl font-bold text-amber-600" x-text="glLinkageResult?.unlinked_count || 0"></p>
                                <p class="text-xs text-amber-700">Unlinked</p>
                            </div>
                            <div class="bg-red-50 rounded-lg p-4 text-center">
                                <p class="text-2xl font-bold text-red-600" x-text="glLinkageResult?.invalid_count || 0"></p>
                                <p class="text-xs text-red-700">Invalid Link</p>
                            </div>
                        </div>
                        
                        <!-- Validation Status -->
                        <div x-show="glLinkageResult?.all_valid" class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-6 h-6 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <p class="font-medium text-green-800">All Bank Accounts Properly Linked</p>
                                    <p class="text-sm text-green-700">Every bank account has a valid GL account code for reconciliation.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Issues List -->
                        <div x-show="glLinkageResult?.issues && glLinkageResult.issues.length > 0">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Issues Found</h4>
                            <div class="space-y-3">
                                <template x-for="issue in glLinkageResult?.issues || []" :key="issue.account_id">
                                    <div class="border rounded-lg p-4" 
                                         :class="issue.issue_type === 'unlinked' ? 'border-amber-200 bg-amber-50' : 'border-red-200 bg-red-50'">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-medium text-gray-900" x-text="issue.bank_name + ' - ' + issue.account_number"></p>
                                                <p class="text-sm text-gray-600" x-text="issue.account_name"></p>
                                                <p class="text-xs mt-1" 
                                                   :class="issue.issue_type === 'unlinked' ? 'text-amber-700' : 'text-red-700'"
                                                   x-text="issue.issue_type === 'unlinked' ? 'No GL account linked' : 'GL code does not exist: ' + issue.gl_account_code"></p>
                                            </div>
                                            <button @click="showLinkGLDialog(issue)" 
                                                    class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                                Link GL
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Properly Linked Accounts -->
                        <div x-show="glLinkageResult?.linked_accounts && glLinkageResult.linked_accounts.length > 0">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Properly Linked Accounts</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Bank Account</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">GL Code</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">GL Account Name</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="acc in glLinkageResult?.linked_accounts || []" :key="acc.account_id">
                                            <tr>
                                                <td class="px-4 py-2 text-sm">
                                                    <span class="font-medium" x-text="acc.bank_name"></span>
                                                    <span class="text-gray-500" x-text="' - ***' + acc.account_number?.slice(-4)"></span>
                                                </td>
                                                <td class="px-4 py-2 text-sm font-mono text-green-600" x-text="acc.gl_account_code"></td>
                                                <td class="px-4 py-2 text-sm text-gray-600" x-text="acc.gl_account_name"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Recommendations -->
                        <div x-show="glLinkageResult?.recommendations && glLinkageResult.recommendations.length > 0" 
                             class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-medium text-blue-800 mb-2"> Recommendations</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <template x-for="rec in glLinkageResult?.recommendations || []" :key="rec">
                                    <li class="flex items-start">
                                        <span class="mr-2"></span>
                                        <span x-text="rec"></span>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
                    <button @click="validateAllGLLinkages()" :disabled="validatingGLLinkage"
                            class="px-4 py-2 text-blue-700 bg-blue-100 rounded-lg hover:bg-blue-200 disabled:opacity-50">
                        <span x-text="validatingGLLinkage ? 'Validating...' : ' Refresh'"></span>
                    </button>
                    <button @click="showGLLinkageModal = false"
                            class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Link GL Account Dialog -->
    <div x-show="showLinkGLModal" x-cloak 
         class="fixed inset-0 z-[60] overflow-y-auto"
         @keydown.escape.window="showLinkGLModal = false">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="showLinkGLModal = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Link GL Account</h3>
                <form @submit.prevent="linkGLAccount()">
                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-sm text-gray-600">Bank Account:</p>
                            <p class="font-medium text-gray-900" x-text="linkGLForm.bank_name + ' - ' + linkGLForm.account_number"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">GL Account Code</label>
                            <input type="text" x-model="linkGLForm.gl_account_code" required
                                   placeholder="e.g., 1120, 1121, 1122"
                                   class="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Enter a valid GL account code from your Chart of Accounts (Bank accounts are typically 11xx)</p>
                        </div>
                        <!-- Common Bank GL Codes -->
                        <div class="bg-blue-50 rounded-lg p-3">
                            <p class="text-xs font-medium text-blue-800 mb-2">Quick Select (Nigerian Standard COA):</p>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" @click="linkGLForm.gl_account_code = '1120'" 
                                        class="px-2 py-1 text-xs bg-white border border-blue-200 rounded hover:bg-blue-100">1120 - Bank</button>
                                <button type="button" @click="linkGLForm.gl_account_code = '1121'" 
                                        class="px-2 py-1 text-xs bg-white border border-blue-200 rounded hover:bg-blue-100">1121 - GTBank</button>
                                <button type="button" @click="linkGLForm.gl_account_code = '1122'" 
                                        class="px-2 py-1 text-xs bg-white border border-blue-200 rounded hover:bg-blue-100">1122 - Zenith</button>
                                <button type="button" @click="linkGLForm.gl_account_code = '1123'" 
                                        class="px-2 py-1 text-xs bg-white border border-blue-200 rounded hover:bg-blue-100">1123 - UBA</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" @click="showLinkGLModal = false"
                                class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
                        <button type="submit" :disabled="linkingGL"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
                            <span x-text="linkingGL ? 'Linking...' : 'Link Account'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function bankReconciliationApp() {
    return {
        // Data
        accounts: [],
        reconciliations: [],
        transactions: [],
        adjustments: [],
        unmatchedItems: [],
        summary: {},
        
        // Selection
        selectedAccount: null,
        currentRecon: null,
        
        // UI State
        loading: true,
        syncing: false,
        autoMatching: false,
        importing: false,
        savingAccount: false,
        creatingRecon: false,
        addingAdjustment: false,
        activeTab: 'transactions',
        txnFilter: 'all',
        
        // Modals
        showAccountModal: false,
        showNewReconciliationModal: false,
        showImportModal: false,
        showAdjustmentModal: false,
        showRejectModal: false,
        showGLLinkageModal: false,
        showLinkGLModal: false,
        
        // GL Linkage Validation
        validatingGLLinkage: false,
        linkingGL: false,
        glLinkageResult: null,
        linkGLForm: {
            account_id: '',
            bank_name: '',
            account_number: '',
            gl_account_code: ''
        },
        
        // Forms
        accountForm: {
            bank_name: '',
            custom_bank_name: '',
            account_name: '',
            account_number: '',
            account_type: 'current',
            currency: 'NGN',
            opening_balance: 0,
            opening_balance_date: new Date().toISOString().split('T')[0],
            gl_account_code: ''
        },
        reconForm: {
            bank_account_id: '',
            period_start: '',
            period_end: '',
            reconciliation_date: new Date().toISOString().split('T')[0],
            statement_opening_balance: 0,
            statement_closing_balance: 0,
            book_opening_balance: 0,
            book_closing_balance: 0,
            reference: ''
        },
        importForm: {
            account_id: '',
            file: null,
            date_column: 'Date',
            description_column: 'Description',
            debit_column: 'Debit',
            credit_column: 'Credit',
            date_format: '%d/%m/%Y'
        },
        adjustmentForm: {
            adjustment_type: '',
            amount: 0,
            description: '',
            affects_bank: true,
            affects_book: false
        },
        
        // Computed
        get filteredTransactions() {
            if (this.txnFilter === 'all') return this.transactions;
            if (this.txnFilter === 'unmatched') return this.transactions.filter(t => t.match_status === 'unmatched');
            if (this.txnFilter === 'matched') return this.transactions.filter(t => ['auto_matched', 'manual_matched'].includes(t.match_status));
            if (this.txnFilter === 'charges') return this.transactions.filter(t => t.is_bank_charge);
            return this.transactions;
        },
        
        // Methods
        async init() {
            await this.loadSummary();
            await this.loadAccounts();
            this.loading = false;
        },
        
        async loadSummary() {
            try {
                const res = await fetch('/api/v1/entities/bank-reconciliation/summary', { credentials: 'include' });
                if (res.ok) this.summary = await res.json();
            } catch (e) { console.error('Error loading summary:', e); }
        },
        
        async loadAccounts() {
            try {
                const res = await fetch('/api/v1/entities/bank-reconciliation/accounts', { credentials: 'include' });
                if (res.ok) this.accounts = await res.json();
            } catch (e) { console.error('Error loading accounts:', e); }
        },
        
        async selectAccount(account) {
            this.selectedAccount = account;
            this.currentRecon = null;
            this.transactions = [];
            this.adjustments = [];
            this.unmatchedItems = [];
            await this.loadReconciliations();
        },
        
        async loadReconciliations() {
            if (!this.selectedAccount) return;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/reconciliations?account_id=${this.selectedAccount.id}`, { credentials: 'include' });
                if (res.ok) this.reconciliations = await res.json();
            } catch (e) { console.error('Error loading reconciliations:', e); }
        },
        
        async selectReconciliation(recon) {
            this.currentRecon = recon;
            await Promise.all([
                this.loadTransactions(),
                this.loadAdjustments(),
                this.loadUnmatchedItems()
            ]);
        },
        
        async loadTransactions() {
            if (!this.currentRecon) return;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/reconciliations/${this.currentRecon.id}/transactions`, { credentials: 'include' });
                if (res.ok) this.transactions = await res.json();
            } catch (e) { console.error('Error loading transactions:', e); }
        },
        
        async loadAdjustments() {
            if (!this.currentRecon) return;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/reconciliations/${this.currentRecon.id}/adjustments`, { credentials: 'include' });
                if (res.ok) this.adjustments = await res.json();
            } catch (e) { console.error('Error loading adjustments:', e); }
        },
        
        async loadUnmatchedItems() {
            if (!this.currentRecon) return;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/reconciliations/${this.currentRecon.id}/unmatched-items`, { credentials: 'include' });
                if (res.ok) this.unmatchedItems = await res.json();
            } catch (e) { console.error('Error loading unmatched items:', e); }
        },
        
        async createAccount() {
            this.savingAccount = true;
            try {
                // Handle custom bank name
                const payload = {
                    ...this.accountForm,
                    bank_name: this.accountForm.bank_name === 'Other' 
                        ? this.accountForm.custom_bank_name 
                        : this.accountForm.bank_name
                };
                delete payload.custom_bank_name;
                
                const res = await fetch('/api/v1/entities/bank-reconciliation/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    this.showAccountModal = false;
                    await this.loadAccounts();
                    this.resetAccountForm();
                    alert('Bank account created successfully');
                } else {
                    const err = await res.json();
                    alert(err.detail || 'Failed to create account');
                }
            } catch (e) {
                alert('Error creating account');
            } finally {
                this.savingAccount = false;
            }
        },
        
        async createReconciliation() {
            this.creatingRecon = true;
            try {
                const res = await fetch('/api/v1/entities/bank-reconciliation/reconciliations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(this.reconForm)
                });
                if (res.ok) {
                    const recon = await res.json();
                    this.showNewReconciliationModal = false;
                    
                    // Select the account if different
                    const account = this.accounts.find(a => a.id === this.reconForm.bank_account_id);
                    if (account && this.selectedAccount?.id !== account.id) {
                        await this.selectAccount(account);
                    } else {
                        await this.loadReconciliations();
                    }
                    
                    // Select the new reconciliation
                    await this.selectReconciliation(recon);
                    this.resetReconForm();
                    alert('Reconciliation created successfully');
                } else {
                    const err = await res.json();
                    alert(err.detail || 'Failed to create reconciliation');
                }
            } catch (e) {
                alert('Error creating reconciliation');
            } finally {
                this.creatingRecon = false;
            }
        },
        
        async syncFromBank() {
            if (!this.selectedAccount) return;
            this.syncing = true;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/accounts/${this.selectedAccount.id}/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        start_date: this.currentRecon?.period_start,
                        end_date: this.currentRecon?.period_end,
                        reconciliation_id: this.currentRecon?.id
                    })
                });
                const result = await res.json();
                if (res.ok) {
                    alert(`Synced ${result.imported_count} transactions. ${result.charges_detected} charges detected.`);
                    if (this.currentRecon) await this.loadTransactions();
                } else {
                    alert(result.detail || 'Sync failed');
                }
            } catch (e) {
                alert('Error syncing from bank');
            } finally {
                this.syncing = false;
            }
        },
        
        handleFileSelect(e) {
            this.importForm.file = e.target.files[0];
        },
        
        async importCSV() {
            if (!this.importForm.file || !this.importForm.account_id) return;
            this.importing = true;
            try {
                const formData = new FormData();
                formData.append('file', this.importForm.file);
                
                const url = new URL(`/api/v1/entities/bank-reconciliation/accounts/${this.importForm.account_id}/import/csv`, window.location.origin);
                url.searchParams.set('date_column', this.importForm.date_column);
                url.searchParams.set('description_column', this.importForm.description_column);
                url.searchParams.set('debit_column', this.importForm.debit_column);
                url.searchParams.set('credit_column', this.importForm.credit_column);
                url.searchParams.set('date_format', this.importForm.date_format);
                if (this.currentRecon) url.searchParams.set('reconciliation_id', this.currentRecon.id);
                
                const res = await fetch(url, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                const result = await res.json();
                if (res.ok) {
                    this.showImportModal = false;
                    alert(`Imported ${result.imported} transactions. ${result.charges_detected} charges detected.`);
                    if (this.currentRecon) await this.loadTransactions();
                } else {
                    alert(result.detail || 'Import failed');
                }
            } catch (e) {
                alert('Error importing CSV');
            } finally {
                this.importing = false;
            }
        },
        
        async runAutoMatch() {
            if (!this.currentRecon) return;
            this.autoMatching = true;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/reconciliations/${this.currentRecon.id}/auto-match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({})
                });
                const result = await res.json();
                if (res.ok) {
                    alert(`Auto-matched ${result.auto_matched} of ${result.total_unmatched} transactions.`);
                    await this.loadTransactions();
                    await this.refreshCurrentRecon();
                } else {
                    alert(result.detail || 'Auto-match failed');
                }
            } catch (e) {
                alert('Error running auto-match');
            } finally {
                this.autoMatching = false;
            }
        },
        
        async autoCreateChargeAdjustments() {
            if (!this.currentRecon) return;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/reconciliations/${this.currentRecon.id}/adjustments/auto-create-charges`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const result = await res.json();
                if (res.ok) {
                    alert(`Created ${result.adjustments_created} charge adjustments.`);
                    await this.loadAdjustments();
                    await this.refreshCurrentRecon();
                } else {
                    alert(result.detail || 'Failed to auto-create adjustments');
                }
            } catch (e) {
                alert('Error auto-creating adjustments');
            }
        },
        
        async addAdjustment() {
            if (!this.currentRecon) return;
            this.addingAdjustment = true;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/reconciliations/${this.currentRecon.id}/adjustments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(this.adjustmentForm)
                });
                if (res.ok) {
                    this.showAdjustmentModal = false;
                    await this.loadAdjustments();
                    await this.refreshCurrentRecon();
                    this.resetAdjustmentForm();
                } else {
                    const err = await res.json();
                    alert(err.detail || 'Failed to add adjustment');
                }
            } catch (e) {
                alert('Error adding adjustment');
            } finally {
                this.addingAdjustment = false;
            }
        },
        
        async deleteAdjustment(adj) {
            if (!confirm('Delete this adjustment?')) return;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/adjustments/${adj.id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (res.ok) {
                    await this.loadAdjustments();
                    await this.refreshCurrentRecon();
                }
            } catch (e) {
                alert('Error deleting adjustment');
            }
        },
        
        async postAdjustments() {
            if (!this.currentRecon) return;
            if (!confirm('This will create journal entries in the General Ledger for all unposted adjustments. Continue?')) return;
            
            try {
                // First create GL journal entries
                const glRes = await fetch(`/api/v1/entities/bank-reconciliation/reconciliations/${this.currentRecon.id}/create-journal-entries?auto_post=true`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const glResult = await glRes.json();
                
                if (glRes.ok && glResult.success) {
                    await this.loadAdjustments();
                    alert(` Created ${glResult.journal_entries_created} GL journal entries.\n\n` +
                          `Posted to accounts:\n` +
                          (glResult.created_entries || []).map(e => ` ${e.type}: ${e.amount.toLocaleString()}`).join('\n'));
                } else {
                    const errors = glResult.errors || [];
                    if (errors.length > 0) {
                        alert(` Some adjustments could not be posted:\n${errors.map(e => e.error).join('\n')}`);
                    } else {
                        alert(glResult.detail || glResult.message || 'No adjustments to post');
                    }
                }
            } catch (e) {
                console.error('Error posting adjustments:', e);
                alert('Error posting adjustments to GL');
            }
        },
        
        async unmatchTransaction(txn) {
            if (!confirm('Unmatch this transaction?')) return;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/transactions/${txn.id}/unmatch`, {
                    method: 'POST',
                    credentials: 'include'
                });
                if (res.ok) {
                    await this.loadTransactions();
                    await this.refreshCurrentRecon();
                }
            } catch (e) {
                alert('Error unmatching transaction');
            }
        },
        
        showManualMatchModal(txn) {
            // Simplified - would need a proper modal for selecting book transactions
            alert('Manual matching: Select book transactions to match with this statement transaction.');
        },
        
        async submitForReview() {
            if (!this.currentRecon) return;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/reconciliations/${this.currentRecon.id}/submit`, {
                    method: 'POST',
                    credentials: 'include'
                });
                if (res.ok) {
                    alert('Submitted for review');
                    await this.refreshCurrentRecon();
                }
            } catch (e) {
                alert('Error submitting for review');
            }
        },
        
        async approveReconciliation() {
            if (!this.currentRecon) return;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/reconciliations/${this.currentRecon.id}/approve`, {
                    method: 'POST',
                    credentials: 'include'
                });
                if (res.ok) {
                    alert('Reconciliation approved');
                    await this.refreshCurrentRecon();
                }
            } catch (e) {
                alert('Error approving reconciliation');
            }
        },
        
        async autoCreateUnmatchedItems() {
            if (!this.currentRecon) return;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/reconciliations/${this.currentRecon.id}/unmatched-items/auto-create`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const result = await res.json();
                if (res.ok) {
                    alert(`Created ${result.items_created} unmatched items.`);
                    await this.loadUnmatchedItems();
                }
            } catch (e) {
                alert('Error creating unmatched items');
            }
        },
        
        async resolveUnmatchedItem(item) {
            const resolution = prompt('Enter resolution:');
            if (!resolution) return;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/unmatched-items/${item.id}/resolve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ resolution })
                });
                if (res.ok) {
                    await this.loadUnmatchedItems();
                }
            } catch (e) {
                alert('Error resolving item');
            }
        },
        
        async refreshCurrentRecon() {
            if (!this.currentRecon) return;
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/reconciliations/${this.currentRecon.id}`, { credentials: 'include' });
                if (res.ok) this.currentRecon = await res.json();
            } catch (e) { console.error(e); }
        },
        
        // GL Linkage Validation Methods
        async validateAllGLLinkages() {
            this.validatingGLLinkage = true;
            this.glLinkageResult = null;
            try {
                const res = await fetch('/api/v1/entities/bank-reconciliation/gl-linkage/validate-all', { credentials: 'include' });
                if (res.ok) {
                    this.glLinkageResult = await res.json();
                } else {
                    alert('Failed to validate GL linkages');
                }
            } catch (e) {
                console.error('Error validating GL linkages:', e);
                alert('Error validating GL linkages');
            } finally {
                this.validatingGLLinkage = false;
            }
        },
        
        showLinkGLDialog(issue) {
            this.linkGLForm = {
                account_id: issue.account_id,
                bank_name: issue.bank_name,
                account_number: issue.account_number,
                gl_account_code: issue.gl_account_code || ''
            };
            this.showLinkGLModal = true;
        },
        
        async linkGLAccount() {
            if (!this.linkGLForm.account_id || !this.linkGLForm.gl_account_code) {
                alert('Please enter a GL account code');
                return;
            }
            
            this.linkingGL = true;
            try {
                const res = await fetch(
                    `/api/v1/entities/bank-reconciliation/accounts/${this.linkGLForm.account_id}/link-gl?gl_account_code=${encodeURIComponent(this.linkGLForm.gl_account_code)}`,
                    { 
                        method: 'POST',
                        credentials: 'include'
                    }
                );
                
                if (res.ok) {
                    const result = await res.json();
                    this.showLinkGLModal = false;
                    alert(' GL account linked successfully!\n\nBank: ' + this.linkGLForm.bank_name + '\nGL Code: ' + this.linkGLForm.gl_account_code);
                    // Refresh the validation results
                    await this.validateAllGLLinkages();
                    // Also refresh accounts list
                    await this.loadAccounts();
                } else {
                    const err = await res.json();
                    alert('Error: ' + (err.detail || err.error || 'Failed to link GL account'));
                }
            } catch (e) {
                console.error('Error linking GL account:', e);
                alert('Error linking GL account');
            } finally {
                this.linkingGL = false;
            }
        },
        
        async validateSingleGLLinkage(accountId) {
            try {
                const res = await fetch(`/api/v1/entities/bank-reconciliation/accounts/${accountId}/gl-linkage`, { credentials: 'include' });
                if (res.ok) {
                    return await res.json();
                }
            } catch (e) {
                console.error('Error validating GL linkage:', e);
            }
            return null;
        },
        
        // Form resets
        resetAccountForm() {
            this.accountForm = {
                bank_name: '', custom_bank_name: '', account_name: '', account_number: '',
                account_type: 'current', currency: 'NGN',
                opening_balance: 0, opening_balance_date: new Date().toISOString().split('T')[0],
                gl_account_code: ''
            };
        },
        resetReconForm() {
            this.reconForm = {
                bank_account_id: '', period_start: '', period_end: '',
                reconciliation_date: new Date().toISOString().split('T')[0],
                statement_opening_balance: 0, statement_closing_balance: 0,
                book_opening_balance: 0, book_closing_balance: 0, reference: ''
            };
        },
        resetAdjustmentForm() {
            this.adjustmentForm = {
                adjustment_type: '', amount: 0, description: '',
                affects_bank: true, affects_book: false
            };
        },
        
        // Formatters
        formatCurrency(value) {
            const num = parseFloat(value) || 0;
            return '' + num.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },
        formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-NG', { year: 'numeric', month: 'short', day: 'numeric' });
        }
    };
}
</script>
{% endblock %}

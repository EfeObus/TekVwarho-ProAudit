{% extends "base.html" %}

{% block title %}Register - TekVwarho ProAudit{% endblock %}

{% block nav %}{% endblock %}

{% block content %}
<div class="min-h-screen py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
            <div class="flex justify-center mb-4">
                <img src="/static/images/logo.jpg" alt="TekVwarho ProAudit" class="h-20 w-20 rounded-xl shadow-lg">
            </div>
            <h1 class="text-3xl font-bold">
                <span class="text-green-600">TekVwarho</span>
                <span class="text-gray-700">ProAudit</span>
            </h1>
            <h2 class="mt-4 text-2xl font-bold text-gray-900">Create your account</h2>
            <p class="mt-2 text-sm text-gray-600">
                Already have an account? <a href="/login" class="font-medium text-green-600 hover:text-green-500">Sign in</a>
            </p>
        </div>
        
        <form x-data="registerForm()" @submit.prevent="submit()" class="bg-white shadow-lg rounded-lg p-8 space-y-6">
            <!-- Error/Success Messages -->
            <div x-show="error" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md text-sm" x-text="error"></div>
            <div x-show="success" class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-md text-sm" x-text="success"></div>
            
            <!-- Progress Steps -->
            <div class="flex items-center justify-center space-x-4 mb-8">
                <template x-for="(stepName, index) in ['Account Type', 'Personal Info', 'Business Details', 'Review']" :key="index">
                    <div class="flex items-center">
                        <div 
                            :class="step > index ? 'bg-green-600 text-white' : step === index ? 'bg-green-100 text-green-600 border-2 border-green-600' : 'bg-gray-100 text-gray-400'"
                            class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium"
                        >
                            <span x-show="step > index">OK</span>
                            <span x-show="step <= index" x-text="index + 1"></span>
                        </div>
                        <span 
                            :class="step >= index ? 'text-green-600' : 'text-gray-400'"
                            class="ml-2 text-xs font-medium hidden sm:block" 
                            x-text="stepName"
                        ></span>
                        <div x-show="index < 3" class="w-8 h-0.5 mx-2" :class="step > index ? 'bg-green-600' : 'bg-gray-200'"></div>
                    </div>
                </template>
            </div>
            
            <!-- ========================================= -->
            <!-- STEP 1: Account Type Selection -->
            <!-- ========================================= -->
            <div x-show="step === 0" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">What type of account do you need?</h3>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Individual -->
                    <label 
                        class="relative border-2 rounded-lg p-4 cursor-pointer transition-all hover:border-green-300"
                        :class="accountType === 'individual' ? 'border-green-500 bg-green-50' : 'border-gray-200'"
                    >
                        <input type="radio" name="account_type" value="individual" x-model="accountType" class="sr-only">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">Individual</span>
                                <span class="block text-xs text-gray-500">Freelancers, Sole Proprietors, Personal Use</span>
                            </div>
                        </div>
                    </label>
                    
                    <!-- Small Business -->
                    <label 
                        class="relative border-2 rounded-lg p-4 cursor-pointer transition-all hover:border-green-300"
                        :class="accountType === 'small_business' ? 'border-green-500 bg-green-50' : 'border-gray-200'"
                    >
                        <input type="radio" name="account_type" value="small_business" x-model="accountType" class="sr-only">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">Small Business</span>
                                <span class="block text-xs text-gray-500">Micro businesses, CAC BN Registration</span>
                            </div>
                        </div>
                    </label>
                    
                    <!-- SME -->
                    <label 
                        class="relative border-2 rounded-lg p-4 cursor-pointer transition-all hover:border-green-300"
                        :class="accountType === 'sme' ? 'border-green-500 bg-green-50' : 'border-gray-200'"
                    >
                        <input type="radio" name="account_type" value="sme" x-model="accountType" class="sr-only">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">SME</span>
                                <span class="block text-xs text-gray-500">Small & Medium Enterprises, CAC RC</span>
                            </div>
                        </div>
                    </label>
                    
                    <!-- School -->
                    <label 
                        class="relative border-2 rounded-lg p-4 cursor-pointer transition-all hover:border-green-300"
                        :class="accountType === 'school' ? 'border-green-500 bg-green-50' : 'border-gray-200'"
                    >
                        <input type="radio" name="account_type" value="school" x-model="accountType" class="sr-only">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">School</span>
                                <span class="block text-xs text-gray-500">Educational Institutions</span>
                            </div>
                        </div>
                    </label>
                    
                    <!-- Non-Profit -->
                    <label 
                        class="relative border-2 rounded-lg p-4 cursor-pointer transition-all hover:border-green-300"
                        :class="accountType === 'non_profit' ? 'border-green-500 bg-green-50' : 'border-gray-200'"
                    >
                        <input type="radio" name="account_type" value="non_profit" x-model="accountType" class="sr-only">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="w-8 h-8 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">Non-Profit</span>
                                <span class="block text-xs text-gray-500">NGOs, Charities, CAC IT Registration</span>
                            </div>
                        </div>
                    </label>
                    
                    <!-- Corporation -->
                    <label 
                        class="relative border-2 rounded-lg p-4 cursor-pointer transition-all hover:border-green-300"
                        :class="accountType === 'corporation' ? 'border-green-500 bg-green-50' : 'border-gray-200'"
                    >
                        <input type="radio" name="account_type" value="corporation" x-model="accountType" class="sr-only">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="w-8 h-8 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">Corporation</span>
                                <span class="block text-xs text-gray-500">Large Companies, PLCs</span>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- ========================================= -->
            <!-- STEP 2: Personal Information -->
            <!-- ========================================= -->
            <div x-show="step === 1" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Your Personal Information</h3>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="first_name" class="block text-sm font-medium text-gray-700">First Name <span class="text-red-500">*</span></label>
                            <input 
                                id="first_name" 
                                type="text" 
                                required 
                                x-model="firstName"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            >
                        </div>
                        <div>
                            <label for="last_name" class="block text-sm font-medium text-gray-700">Last Name <span class="text-red-500">*</span></label>
                            <input 
                                id="last_name" 
                                type="text" 
                                required 
                                x-model="lastName"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            >
                        </div>
                    </div>
                    
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email Address <span class="text-red-500">*</span></label>
                        <input 
                            id="email" 
                            type="email" 
                            required 
                            x-model="email"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            placeholder="you@example.com"
                        >
                    </div>
                    
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        <input 
                            id="phone" 
                            type="tel" 
                            x-model="phone"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            placeholder="+234 800 000 0000"
                        >
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password <span class="text-red-500">*</span></label>
                        <div class="relative mt-1">
                            <input 
                                id="password" 
                                :type="showPassword ? 'text' : 'password'" 
                                required 
                                x-model="password"
                                minlength="8"
                                class="block w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                                placeholder="Min 8 chars, 1 uppercase, 1 number"
                            >
                            <button type="button" @click="showPassword = !showPassword" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                                <svg x-show="!showPassword" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                <svg x-show="showPassword" x-cloak class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg>
                            </button>
                        </div>
                        <!-- Password Strength Indicator -->
                        <div class="mt-2">
                            <div class="flex space-x-1">
                                <div class="h-1 flex-1 rounded" :class="passwordStrength >= 1 ? 'bg-red-500' : 'bg-gray-200'"></div>
                                <div class="h-1 flex-1 rounded" :class="passwordStrength >= 2 ? 'bg-yellow-500' : 'bg-gray-200'"></div>
                                <div class="h-1 flex-1 rounded" :class="passwordStrength >= 3 ? 'bg-green-400' : 'bg-gray-200'"></div>
                                <div class="h-1 flex-1 rounded" :class="passwordStrength >= 4 ? 'bg-green-600' : 'bg-gray-200'"></div>
                            </div>
                            <p class="text-xs mt-1" :class="passwordStrengthColor" x-text="passwordStrengthText"></p>
                        </div>
                    </div>
                    
                    <div>
                        <label for="confirm_password" class="block text-sm font-medium text-gray-700">Confirm Password <span class="text-red-500">*</span></label>
                        <input 
                            id="confirm_password" 
                            :type="showPassword ? 'text' : 'password'" 
                            required 
                            x-model="confirmPassword"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                        >
                        <p x-show="confirmPassword && password !== confirmPassword" class="text-xs text-red-500 mt-1">Passwords do not match</p>
                    </div>
                    
                    <!-- NIN for Individual accounts -->
                    <div x-show="accountType === 'individual'">
                        <label for="nin" class="block text-sm font-medium text-gray-700">NIN (National Identification Number)</label>
                        <input 
                            id="nin" 
                            type="text" 
                            x-model="nin"
                            maxlength="11"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            placeholder="11 digit NIN (optional)"
                        >
                        <p class="text-xs text-gray-500 mt-1">Optional but recommended for tax compliance</p>
                    </div>
                </div>
            </div>
            
            <!-- ========================================= -->
            <!-- STEP 3: Business/Organization Details -->
            <!-- ========================================= -->
            <div x-show="step === 2" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
                <h3 class="text-lg font-semibold text-gray-900 mb-4" x-text="accountType === 'individual' ? 'Additional Details' : 'Business/Organization Details'"></h3>
                
                <div class="space-y-4">
                    <!-- Organization Name (not for Individual) -->
                    <div x-show="accountType !== 'individual'">
                        <label for="org_name" class="block text-sm font-medium text-gray-700">
                            <span x-text="getOrgNameLabel()"></span> <span class="text-red-500">*</span>
                        </label>
                        <input 
                            id="org_name" 
                            type="text" 
                            x-model="organizationName"
                            :required="accountType !== 'individual'"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            :placeholder="getOrgNamePlaceholder()"
                        >
                    </div>
                    
                    <!-- Address Fields (for business accounts) -->
                    <div x-show="accountType !== 'individual'" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Street Address</label>
                            <input 
                                type="text" 
                                x-model="streetAddress"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                                placeholder="123 Business Street"
                            >
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">State <span class="text-red-500">*</span></label>
                                <select 
                                    x-model="state"
                                    @change="loadLGAs()"
                                    :required="accountType !== 'individual'"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                                >
                                    <option value="">Select State</option>
                                    <template x-for="s in nigerianStates" :key="s">
                                        <option :value="s" x-text="s"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">LGA <span class="text-red-500">*</span></label>
                                <select 
                                    x-model="lga"
                                    :required="accountType !== 'individual'"
                                    :disabled="!state || lgasLoading"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 disabled:bg-gray-100"
                                >
                                    <option value="">
                                        <span x-text="lgasLoading ? 'Loading...' : (state ? 'Select LGA' : 'Select state first')"></span>
                                    </option>
                                    <template x-for="l in availableLGAs" :key="l">
                                        <option :value="l" x-text="l"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">City/Town <span class="text-red-500">*</span></label>
                                <input 
                                    type="text" 
                                    x-model="city"
                                    :required="accountType !== 'individual'"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                                    placeholder="Enter city or town"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Postal Code</label>
                                <input 
                                    type="text" 
                                    x-model="postalCode"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                                >
                            </div>
                        </div>
                    </div>
                    
                    <!-- CAC Registration (for business types) -->
                    <div x-show="['small_business', 'sme', 'non_profit', 'corporation'].includes(accountType)" class="bg-gray-50 p-4 rounded-lg space-y-4">
                        <h4 class="font-medium text-gray-900 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                            CAC Registration
                        </h4>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Registration Type</label>
                                <select 
                                    x-model="cacRegistrationType"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                                >
                                    <option value="">Select Type</option>
                                    <option value="BN" x-show="accountType === 'small_business'">BN - Business Name</option>
                                    <option value="RC" x-show="['sme', 'corporation'].includes(accountType)">RC - Registered Company</option>
                                    <option value="IT" x-show="accountType === 'non_profit'">IT - Incorporated Trustees</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Registration Number</label>
                                <input 
                                    type="text" 
                                    x-model="cacRegistrationNumber"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                                    :placeholder="cacRegistrationType ? cacRegistrationType + '-XXXXXX' : 'Enter registration number'"
                                >
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Date of Incorporation</label>
                            <input 
                                type="date" 
                                x-model="dateOfIncorporation"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            >
                        </div>
                    </div>
                    
                    <!-- TIN (for all business types) -->
                    <div x-show="accountType !== 'individual'">
                        <label class="block text-sm font-medium text-gray-700">
                            TIN (Tax Identification Number)
                            <span class="text-gray-400 text-xs ml-1">(10-14 digits)</span>
                        </label>
                        <input 
                            type="text" 
                            x-model="tin"
                            maxlength="14"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            placeholder="Enter TIN if available"
                        >
                        <p class="text-xs text-gray-500 mt-1">Can be added later during verification</p>
                    </div>
                    
                    <!-- Industry (for SME, Corporation) -->
                    <div x-show="['sme', 'corporation', 'small_business'].includes(accountType)">
                        <label class="block text-sm font-medium text-gray-700">Industry/Sector</label>
                        <select 
                            x-model="industry"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                        >
                            <option value="">Select Industry</option>
                            <option value="agriculture">Agriculture</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="retail">Retail</option>
                            <option value="wholesale">Wholesale</option>
                            <option value="technology">Technology & IT</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="education">Education</option>
                            <option value="construction">Construction</option>
                            <option value="real_estate">Real Estate</option>
                            <option value="financial_services">Financial Services</option>
                            <option value="hospitality">Hospitality & Tourism</option>
                            <option value="transportation">Transportation & Logistics</option>
                            <option value="professional_services">Professional Services</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <!-- Employee Count & Revenue (for SME, Corporation) -->
                    <div x-show="['sme', 'corporation'].includes(accountType)" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Number of Employees</label>
                            <select 
                                x-model="employeeCount"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            >
                                <option value="">Select Range</option>
                                <option value="1-5">1-5</option>
                                <option value="6-20">6-20</option>
                                <option value="21-50">21-50</option>
                                <option value="51-100">51-100</option>
                                <option value="101-250">101-250</option>
                                <option value="251-500">251-500</option>
                                <option value="500+">500+</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Annual Revenue (₦)</label>
                            <select 
                                x-model="annualRevenueRange"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            >
                                <option value="">Select Range</option>
                                <option value="0-5m">₦0 - ₦5M</option>
                                <option value="5m-25m">₦5M - ₦25M</option>
                                <option value="25m-100m">₦25M - ₦100M</option>
                                <option value="100m-500m">₦100M - ₦500M</option>
                                <option value="500m-1b">₦500M - ₦1B</option>
                                <option value="1b+">₦1B+</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- School-specific fields -->
                    <div x-show="accountType === 'school'" class="space-y-4 bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900">School Information</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">School Type <span class="text-red-500">*</span></label>
                            <select 
                                x-model="schoolType"
                                :required="accountType === 'school'"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            >
                                <option value="">Select Type</option>
                                <option value="primary">Primary School</option>
                                <option value="secondary">Secondary School</option>
                                <option value="tertiary">Tertiary Institution</option>
                                <option value="vocational">Vocational/Technical</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ministry of Education Registration No.</label>
                            <input 
                                type="text" 
                                x-model="moeRegistrationNumber"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            >
                        </div>
                    </div>
                    
                    <!-- Non-Profit specific fields -->
                    <div x-show="accountType === 'non_profit'" class="space-y-4 bg-pink-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900">Non-Profit Information</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">SCUML Registration Number</label>
                            <input 
                                type="text" 
                                x-model="scumlRegistration"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                                placeholder="Special Control Unit Against Money Laundering"
                            >
                            <p class="text-xs text-gray-500 mt-1">Required for NGOs handling funds</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Mission Statement</label>
                            <textarea 
                                x-model="missionStatement"
                                rows="3"
                                maxlength="1000"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                                placeholder="Briefly describe your organization's mission..."
                            ></textarea>
                        </div>
                    </div>
                    
                    <!-- Referral Code -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Referral Code (Optional)</label>
                        <input 
                            type="text" 
                            x-model="referralCode"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                            placeholder="Enter referral code if you have one"
                        >
                    </div>
                </div>
            </div>
            
            <!-- ========================================= -->
            <!-- STEP 4: Review & Submit -->
            <!-- ========================================= -->
            <div x-show="step === 3" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Review Your Information</h3>
                
                <div class="bg-gray-50 rounded-lg p-4 space-y-4">
                    <!-- Account Type -->
                    <div class="flex justify-between py-2 border-b border-gray-200">
                        <span class="text-sm text-gray-500">Account Type</span>
                        <span class="text-sm font-medium text-gray-900 capitalize" x-text="accountType.replace('_', ' ')"></span>
                    </div>
                    
                    <!-- Personal Info -->
                    <div class="py-2 border-b border-gray-200">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Personal Information</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="text-gray-500">Name:</div>
                            <div class="text-gray-900" x-text="firstName + ' ' + lastName"></div>
                            <div class="text-gray-500">Email:</div>
                            <div class="text-gray-900" x-text="email"></div>
                            <div class="text-gray-500" x-show="phone">Phone:</div>
                            <div class="text-gray-900" x-show="phone" x-text="phone"></div>
                        </div>
                    </div>
                    
                    <!-- Business Info (if applicable) -->
                    <div x-show="accountType !== 'individual'" class="py-2 border-b border-gray-200">
                        <h4 class="text-sm font-medium text-gray-700 mb-2" x-text="getOrgNameLabel()"></h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="text-gray-500">Name:</div>
                            <div class="text-gray-900" x-text="organizationName"></div>
                            <div class="text-gray-500" x-show="state">State:</div>
                            <div class="text-gray-900" x-show="state" x-text="state"></div>
                            <div class="text-gray-500" x-show="lga">LGA:</div>
                            <div class="text-gray-900" x-show="lga" x-text="lga"></div>
                            <div class="text-gray-500" x-show="city">City/Town:</div>
                            <div class="text-gray-900" x-show="city" x-text="city"></div>
                            <div class="text-gray-500" x-show="streetAddress">Address:</div>
                            <div class="text-gray-900" x-show="streetAddress" x-text="streetAddress"></div>
                            <div class="text-gray-500" x-show="cacRegistrationNumber">CAC:</div>
                            <div class="text-gray-900" x-show="cacRegistrationNumber" x-text="cacRegistrationType + '-' + cacRegistrationNumber"></div>
                            <div class="text-gray-500" x-show="tin">TIN:</div>
                            <div class="text-gray-900" x-show="tin" x-text="tin"></div>
                        </div>
                    </div>
                    
                    <!-- Terms -->
                    <div class="flex items-start pt-4">
                        <input 
                            id="terms" 
                            type="checkbox" 
                            x-model="termsAccepted"
                            required 
                            class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded mt-0.5"
                        >
                        <label for="terms" class="ml-2 text-sm text-gray-600">
                            I agree to the <a href="/terms" class="text-green-600 hover:underline" target="_blank">Terms of Service</a>, 
                            <a href="/privacy" class="text-green-600 hover:underline" target="_blank">Privacy Policy</a>, and 
                            <a href="/dpa" class="text-green-600 hover:underline" target="_blank">Data Processing Agreement</a>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- ========================================= -->
            <!-- Navigation Buttons -->
            <!-- ========================================= -->
            <div class="flex justify-between pt-6">
                <button 
                    type="button"
                    x-show="step > 0"
                    @click="step--"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                >
                    ← Back
                </button>
                <div x-show="step === 0"></div>
                
                <button 
                    type="button"
                    x-show="step < 3"
                    @click="nextStep()"
                    :disabled="!canProceed()"
                    class="px-6 py-2 bg-green-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    Next →
                </button>
                
                <button 
                    type="submit"
                    x-show="step === 3"
                    :disabled="loading || !termsAccepted"
                    class="px-6 py-2 bg-green-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span x-show="!loading">Create Account</span>
                    <span x-show="loading" class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Creating...
                    </span>
                </button>
            </div>
        </form>
        
        <div class="text-center text-xs text-gray-500 mt-8">
            <p>Nigeria Revenue Service (NRS) 2026 Compliant</p>
            <p class="mt-1">Your data is encrypted and secure </p>
        </div>
    </div>
</div>

<script>
function registerForm() {
    return {
        step: 0,
        
        // Account Type
        accountType: 'individual',
        
        // Personal Info
        firstName: '',
        lastName: '',
        email: '',
        phone: '',
        password: '',
        confirmPassword: '',
        showPassword: false,
        nin: '',
        
        // Business Info
        organizationName: '',
        streetAddress: '',
        city: '',
        state: '',
        lga: '',
        postalCode: '',
        
        // Compliance
        tin: '',
        cacRegistrationType: '',
        cacRegistrationNumber: '',
        dateOfIncorporation: '',
        
        // Business Details
        industry: '',
        employeeCount: '',
        annualRevenueRange: '',
        
        // School
        schoolType: '',
        moeRegistrationNumber: '',
        
        // Non-Profit
        scumlRegistration: '',
        missionStatement: '',
        
        // Other
        referralCode: '',
        termsAccepted: false,
        
        // State
        loading: false,
        error: null,
        success: null,
        
        // Nigerian States and LGAs
        nigerianStates: [
            'Abia', 'Adamawa', 'Akwa Ibom', 'Anambra', 'Bauchi', 'Bayelsa', 'Benue', 'Borno',
            'Cross River', 'Delta', 'Ebonyi', 'Edo', 'Ekiti', 'Enugu', 'FCT', 'Gombe',
            'Imo', 'Jigawa', 'Kaduna', 'Kano', 'Katsina', 'Kebbi', 'Kogi', 'Kwara',
            'Lagos', 'Nasarawa', 'Niger', 'Ogun', 'Ondo', 'Osun', 'Oyo', 'Plateau',
            'Rivers', 'Sokoto', 'Taraba', 'Yobe', 'Zamfara'
        ],
        availableLGAs: [],
        lgasLoading: false,
        
        // Load LGAs for selected state
        async loadLGAs() {
            if (!this.state) {
                this.availableLGAs = [];
                this.lga = '';
                return;
            }
            
            this.lgasLoading = true;
            this.lga = ''; // Reset LGA when state changes
            
            try {
                const response = await fetch(`/api/v1/auth/nigeria/states/${encodeURIComponent(this.state)}/lgas`);
                if (response.ok) {
                    const data = await response.json();
                    this.availableLGAs = data.lgas || [];
                } else {
                    this.availableLGAs = [];
                }
            } catch (err) {
                console.error('Failed to load LGAs:', err);
                this.availableLGAs = [];
            } finally {
                this.lgasLoading = false;
            }
        },
        
        // Computed Properties
        get passwordStrength() {
            if (!this.password) return 0;
            let strength = 0;
            if (this.password.length >= 8) strength++;
            if (/[A-Z]/.test(this.password)) strength++;
            if (/[a-z]/.test(this.password)) strength++;
            if (/[0-9]/.test(this.password)) strength++;
            if (/[^A-Za-z0-9]/.test(this.password)) strength++;
            return Math.min(strength, 4);
        },
        
        get passwordStrengthText() {
            const levels = ['', 'Weak', 'Fair', 'Good', 'Strong'];
            return levels[this.passwordStrength] || '';
        },
        
        get passwordStrengthColor() {
            const colors = ['', 'text-red-500', 'text-yellow-500', 'text-green-400', 'text-green-600'];
            return colors[this.passwordStrength] || '';
        },
        
        // Methods
        getOrgNameLabel() {
            const labels = {
                'small_business': 'Business Name',
                'sme': 'Company Name',
                'school': 'School Name',
                'non_profit': 'Organization Name',
                'corporation': 'Company Name'
            };
            return labels[this.accountType] || 'Organization Name';
        },
        
        getOrgNamePlaceholder() {
            const placeholders = {
                'small_business': 'e.g., Adamu Ventures',
                'sme': 'e.g., Adamu Enterprises Ltd',
                'school': 'e.g., Bright Future Academy',
                'non_profit': 'e.g., Hope Foundation Nigeria',
                'corporation': 'e.g., Adamu Holdings PLC'
            };
            return placeholders[this.accountType] || 'Enter name';
        },
        
        canProceed() {
            if (this.step === 0) {
                return !!this.accountType;
            }
            if (this.step === 1) {
                const hasBasics = this.firstName && this.lastName && this.email && this.password && this.confirmPassword;
                const passwordsMatch = this.password === this.confirmPassword;
                const passwordStrong = this.passwordStrength >= 3;
                return hasBasics && passwordsMatch && passwordStrong;
            }
            if (this.step === 2) {
                if (this.accountType === 'individual') return true;
                const hasOrgName = !!this.organizationName;
                const hasLocation = this.state && this.lga && this.city;  // Added LGA validation
                const schoolValid = this.accountType !== 'school' || !!this.schoolType;
                return hasOrgName && hasLocation && schoolValid;
            }
            return true;
        },
        
        nextStep() {
            if (this.canProceed() && this.step < 3) {
                // Auto-set CAC type based on account type
                if (this.step === 1 && !this.cacRegistrationType) {
                    if (this.accountType === 'small_business') this.cacRegistrationType = 'BN';
                    else if (['sme', 'corporation'].includes(this.accountType)) this.cacRegistrationType = 'RC';
                    else if (this.accountType === 'non_profit') this.cacRegistrationType = 'IT';
                }
                this.step++;
            }
        },
        
        async submit() {
            if (!this.termsAccepted) {
                this.error = 'Please accept the terms and conditions';
                return;
            }
            
            this.loading = true;
            this.error = null;
            this.success = null;
            
            // Build request body
            const body = {
                email: this.email,
                password: this.password,
                first_name: this.firstName,
                last_name: this.lastName,
                phone_number: this.phone || null,
                account_type: this.accountType,
                organization_name: this.accountType === 'individual' 
                    ? `${this.firstName} ${this.lastName}` 
                    : this.organizationName,
            };
            
            // Add business fields
            if (this.accountType !== 'individual') {
                body.street_address = this.streetAddress || null;
                body.city = this.city || null;
                body.state = this.state || null;
                body.lga = this.lga || null;
                body.postal_code = this.postalCode || null;
                body.tin = this.tin || null;
                body.cac_registration_number = this.cacRegistrationNumber || null;
                body.cac_registration_type = this.cacRegistrationType || null;
                body.date_of_incorporation = this.dateOfIncorporation || null;
                body.industry = this.industry || null;
            }
            
            // SME/Corporation specific
            if (['sme', 'corporation'].includes(this.accountType)) {
                body.employee_count = this.employeeCount || null;
                body.annual_revenue_range = this.annualRevenueRange || null;
            }
            
            // School specific
            if (this.accountType === 'school') {
                body.school_type = this.schoolType || null;
                body.moe_registration_number = this.moeRegistrationNumber || null;
            }
            
            // Non-Profit specific
            if (this.accountType === 'non_profit') {
                body.scuml_registration = this.scumlRegistration || null;
                body.mission_statement = this.missionStatement || null;
            }
            
            // Individual specific
            if (this.accountType === 'individual') {
                body.nin = this.nin || null;
            }
            
            // Referral
            if (this.referralCode) {
                body.referral_code = this.referralCode;
            }
            
            try {
                const response = await fetch('/api/v1/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Store tokens
                    localStorage.setItem('token', data.tokens.access_token);
                    localStorage.setItem('refresh_token', data.tokens.refresh_token);
                    document.cookie = `access_token=${data.tokens.access_token}; path=/; max-age=${60 * 60 * 24 * 7}; SameSite=Lax`;
                    
                    this.success = 'Account created successfully! Redirecting...';
                    
                    setTimeout(() => {
                        // Redirect based on account type
                        if (this.accountType === 'individual') {
                            window.location.href = '/dashboard';
                        } else {
                            window.location.href = '/select-entity';
                        }
                    }, 1500);
                } else {
                    const errorData = await response.json();
                    this.error = errorData.detail || 'Registration failed. Please try again.';
                }
            } catch (err) {
                this.error = 'An error occurred. Please check your connection and try again.';
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>
{% endblock %}

{% block footer %}{% endblock %}

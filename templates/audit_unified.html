{% extends "base.html" %}

{% block title %}Unified Audit Center - TekVwarho ProAudit{% endblock %}

{% block content %}
<div x-data="unifiedAudit()" x-init="init()">
    <!-- Toast Notification -->
    <div x-show="toast.show" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform translate-y-0"
         x-transition:leave-end="opacity-0 transform translate-y-2"
         class="fixed top-4 right-4 z-[100] max-w-md"
         style="display: none;">
        <div :class="toast.type === 'success' ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'"
             class="rounded-lg border-l-4 p-4 shadow-lg">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <template x-if="toast.type === 'success'">
                        <svg class="h-6 w-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </template>
                    <template x-if="toast.type === 'error'">
                        <svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </template>
                </div>
                <div class="ml-3 flex-1">
                    <p :class="toast.type === 'success' ? 'text-green-800' : 'text-red-800'" 
                       class="text-sm font-medium" x-text="toast.message"></p>
                    <template x-if="toast.runId">
                        <p class="mt-1 text-xs text-gray-600">
                            Run ID: <span class="font-mono font-medium" x-text="toast.runId"></span>
                        </p>
                    </template>
                </div>
                <div class="ml-4 flex-shrink-0">
                    <button @click="toast.show = false" 
                            :class="toast.type === 'success' ? 'text-green-500 hover:text-green-600' : 'text-red-500 hover:text-red-600'"
                            class="inline-flex">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                    <svg class="w-8 h-8 mr-3 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    Unified Audit Center
                </h1>
                <p class="text-gray-600 mt-1">Comprehensive audit tools for Nigerian Tax Reform 2026 compliance</p>
            </div>
            <div class="flex items-center space-x-3">
                <span class="bg-green-100 text-green-800 text-xs px-3 py-1 rounded-full font-medium">NTAA 2025</span>
                <span class="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full font-medium">2026 Tax Reform</span>
            </div>
        </div>
    </div>

    <!-- Quick Stats Bar -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
        <!-- Data Integrity -->
        <div class="bg-white rounded-lg shadow p-4 border-l-4"
             :class="integrity.verified ? 'border-green-500' : 'border-red-500'">
            <p class="text-xs font-medium text-gray-600">Data Integrity</p>
            <p class="text-lg font-bold" :class="integrity.verified ? 'text-green-600' : 'text-red-600'"
               x-text="integrity.status || 'Unknown'"></p>
        </div>
        
        <!-- NRS Compliance -->
        <div class="bg-white rounded-lg shadow p-4 border-l-4"
             :class="{'border-green-500': nrsCompliance.rate >= 95, 'border-yellow-500': nrsCompliance.rate >= 80 && nrsCompliance.rate < 95, 'border-red-500': nrsCompliance.rate < 80}">
            <p class="text-xs font-medium text-gray-600">NRS Compliance</p>
            <p class="text-lg font-bold" x-text="nrsCompliance.rate + '%'"></p>
        </div>
        
        <!-- Anomalies -->
        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-amber-500">
            <p class="text-xs font-medium text-gray-600">Anomalies</p>
            <p class="text-lg font-bold text-amber-600" x-text="anomalies.total || 0"></p>
        </div>
        
        <!-- Audit Runs -->
        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
            <p class="text-xs font-medium text-gray-600">Audit Runs</p>
            <p class="text-lg font-bold text-purple-600" x-text="auditRuns.total || 0"></p>
        </div>
        
        <!-- Findings -->
        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
            <p class="text-xs font-medium text-gray-600">Open Findings</p>
            <p class="text-lg font-bold text-blue-600" x-text="findings.open || 0"></p>
        </div>
    </div>

    <!-- Main Tabs Navigation -->
    <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
            <button @click="activeTab = 'dashboard'"
                    :class="activeTab === 'dashboard' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                Dashboard
            </button>
            <button @click="activeTab = 'logs'; loadAuditLogs()"
                    :class="activeTab === 'logs' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                Audit Logs
            </button>
            <button @click="activeTab = 'forensic'"
                    :class="activeTab === 'forensic' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                Forensic Analysis
            </button>
            <button @click="activeTab = 'runs'; loadAuditRuns()"
                    :class="activeTab === 'runs' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                Audit Runs
            </button>
            <button @click="activeTab = 'findings'; loadFindings()"
                    :class="activeTab === 'findings' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                Findings
            </button>
            <button @click="activeTab = 'evidence'; loadEvidence()"
                    :class="activeTab === 'evidence' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                Evidence
            </button>
            <button @click="activeTab = 'explainability'"
                    :class="activeTab === 'explainability' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                Tax Explainability
            </button>
            <button @click="activeTab = 'vault'; loadVaultStats(); loadVaultFiscalYears(); loadVaultTimeline(); loadVaultRecords()"
                    :class="activeTab === 'vault' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                Audit Vault
            </button>
            <button @click="activeTab = 'payroll-decisions'; loadPayrollDecisions()"
                    :class="activeTab === 'payroll-decisions' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Payroll Decisions
            </button>
        </nav>
    </div>

    <!-- ========================================
         TAB: DASHBOARD
         ======================================== -->
    <div x-show="activeTab === 'dashboard'" class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Integrity Verification Card -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    Data Integrity Verification
                </h3>
                <p class="text-sm text-gray-600 mb-4">Verify blockchain-style hash chain integrity for all records.</p>
                <button @click="verifyIntegrity()" 
                        :disabled="loading"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
                    <span x-show="!loading">Run Integrity Check</span>
                    <span x-show="loading">Checking...</span>
                </button>
                <div x-show="integrity.lastCheck" class="mt-4 p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm"><strong>Last Check:</strong> <span x-text="integrity.lastCheck"></span></p>
                    <p class="text-sm"><strong>Records Verified:</strong> <span x-text="integrity.recordCount"></span></p>
                </div>
            </div>

            <!-- Quick Forensic Tools -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Quick Forensic Tools
                </h3>
                <div class="space-y-3">
                    <button @click="runBenfordsLaw()" class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <span class="font-medium">Benford's Law Analysis</span>
                        <p class="text-xs text-gray-500">Detect manipulated numbers</p>
                    </button>
                    <button @click="runAnomalyDetection()" class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <span class="font-medium">Z-Score Anomaly Detection</span>
                        <p class="text-xs text-gray-500">Find statistical outliers</p>
                    </button>
                    <button @click="runNRSGapAnalysis()" class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <span class="font-medium">NRS Gap Analysis</span>
                        <p class="text-xs text-gray-500">Find missing IRN submissions</p>
                    </button>
                </div>
            </div>
        </div>

        <!-- Recent Audit Activity -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Recent Audit Activity</h3>
            <div class="space-y-3" x-show="recentLogs.length > 0">
                <template x-for="log in recentLogs.slice(0, 5)" :key="log.id">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <span class="font-medium" x-text="log.action"></span>
                            <span class="text-gray-600" x-text="' on ' + log.target_entity_type"></span>
                        </div>
                        <span class="text-sm text-gray-500" x-text="log.timestamp"></span>
                    </div>
                </template>
            </div>
            <p x-show="recentLogs.length === 0" class="text-gray-500 text-center py-4">No recent activity</p>
        </div>
    </div>

    <!-- ========================================
         TAB: AUDIT LOGS
         ======================================== -->
    <div x-show="activeTab === 'logs'" class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">Audit Trail</h3>
                <div class="flex items-center space-x-4">
                    <select x-model="logsFilter.action" @change="loadAuditLogs()"
                            class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Actions</option>
                        <option value="create">Create</option>
                        <option value="update">Update</option>
                        <option value="delete">Delete</option>
                        <option value="view">View</option>
                        <option value="export">Export</option>
                    </select>
                    <input type="date" x-model="logsFilter.startDate" @change="loadAuditLogs()"
                           class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <button @click="exportLogs()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">
                        Export
                    </button>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entity</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP Address</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="log in auditLogs" :key="log.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="log.timestamp"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full"
                                      :class="{
                                          'bg-green-100 text-green-800': log.action === 'create',
                                          'bg-blue-100 text-blue-800': log.action === 'update',
                                          'bg-red-100 text-red-800': log.action === 'delete',
                                          'bg-gray-100 text-gray-800': log.action === 'view'
                                      }"
                                      x-text="log.action"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="log.target_entity_type"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="log.user_id || 'System'"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="log.ip_address || '-'"></td>
                            <td class="px-6 py-4 text-sm">
                                <button @click="viewLogDetails(log)" class="text-indigo-600 hover:text-indigo-800">View</button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        
        <div x-show="auditLogs.length === 0" class="p-8 text-center text-gray-500">
            No audit logs found
        </div>
    </div>

    <!-- ========================================
         TAB: FORENSIC ANALYSIS
         ======================================== -->
    <div x-show="activeTab === 'forensic'" class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Benford's Law -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                        <span class="text-blue-600 font-bold text-sm">B</span>
                    </span>
                    Benford's Law
                </h3>
                <p class="text-sm text-gray-600 mb-4">Analyze first-digit distribution to detect potential manipulation.</p>
                <button @click="runBenfordsLaw()" 
                        :disabled="forensicLoading"
                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                    Run Analysis
                </button>
            </div>

            <!-- Z-Score Anomaly -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center mr-2">
                        <span class="text-amber-600 font-bold text-sm">Z</span>
                    </span>
                    Z-Score Anomaly
                </h3>
                <p class="text-sm text-gray-600 mb-4">Identify statistical outliers using Z-score analysis.</p>
                <button @click="runAnomalyDetection()" 
                        :disabled="forensicLoading"
                        class="w-full px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50">
                    Detect Anomalies
                </button>
            </div>

            <!-- NRS Gap Analysis -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <span class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-2">
                        <span class="text-green-600 font-bold text-sm">N</span>
                    </span>
                    NRS Gap Analysis
                </h3>
                <p class="text-sm text-gray-600 mb-4">Find invoices missing IRN submissions.</p>
                <button @click="runNRSGapAnalysis()" 
                        :disabled="forensicLoading"
                        class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
                    Analyze Gaps
                </button>
            </div>
        </div>

        <!-- Forensic Results Modal -->
        <div x-show="forensicResult" x-transition class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
            <div class="relative w-full max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">
                        <span x-show="forensicResult?._analysisType === 'nrs_gap'">NRS Gap Analysis Report</span>
                        <span x-show="forensicResult?._analysisType === 'benfords'">Benford's Law Analysis</span>
                        <span x-show="forensicResult?._analysisType === 'benfords_insufficient'">Benford's Law - Data Required</span>
                        <span x-show="forensicResult?._analysisType === 'anomaly'">Anomaly Detection Results</span>
                        <span x-show="forensicResult?._analysisType === 'anomaly_insufficient'">Anomaly Detection - Data Required</span>
                        <span x-show="!forensicResult?._analysisType">Analysis Results</span>
                    </h3>
                    <div class="flex gap-2">
                        <button x-show="forensicResult?._analysisType !== 'anomaly_insufficient' && forensicResult?._analysisType !== 'benfords_insufficient'" @click="exportForensicResult()" class="px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                            Export CSV
                        </button>
                        <button @click="forensicResult = null" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="max-h-[70vh] overflow-y-auto">
                    <!-- NRS Gap Analysis Human-Readable Format -->
                    <template x-if="forensicResult?._analysisType === 'nrs_gap'">
                        <div class="space-y-6">
                            <!-- Overall Compliance Score -->
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-800">Overall Compliance Score</h4>
                                        <p class="text-sm text-gray-600">Nigerian Reporting Standards Compliance</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-4xl font-bold" 
                                              :class="(forensicResult.compliance_rate || 0) >= 80 ? 'text-green-600' : (forensicResult.compliance_rate || 0) >= 50 ? 'text-yellow-600' : 'text-red-600'"
                                              x-text="(forensicResult.compliance_rate || 0).toFixed(1) + '%'"></span>
                                        <p class="text-sm text-gray-500" x-text="'Fiscal Year ' + (forensicResult.fiscal_year || new Date().getFullYear())"></p>
                                    </div>
                                </div>
                                <div class="mt-4 h-3 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full transition-all duration-500"
                                         :class="(forensicResult.compliance_rate || 0) >= 80 ? 'bg-green-500' : (forensicResult.compliance_rate || 0) >= 50 ? 'bg-yellow-500' : 'bg-red-500'"
                                         :style="'width: ' + (forensicResult.compliance_rate || 0) + '%'"></div>
                                </div>
                            </div>

                            <!-- Gap Summary Cards -->
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                    <div class="text-2xl font-bold text-red-600" x-text="forensicResult.gaps?.length || 0"></div>
                                    <div class="text-sm text-gray-600">Compliance Gaps Found</div>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                    <div class="text-2xl font-bold text-yellow-600" x-text="forensicResult.recommendations?.length || 0"></div>
                                    <div class="text-sm text-gray-600">Recommendations</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                    <div class="text-2xl font-bold text-green-600" x-text="forensicResult.compliant_areas?.length || 0"></div>
                                    <div class="text-sm text-gray-600">Compliant Areas</div>
                                </div>
                            </div>

                            <!-- Identified Gaps -->
                            <div x-show="forensicResult.gaps?.length > 0" class="bg-white border rounded-lg">
                                <div class="px-4 py-3 bg-red-50 border-b border-red-200 rounded-t-lg">
                                    <h5 class="font-semibold text-red-800">Identified Compliance Gaps</h5>
                                </div>
                                <div class="divide-y">
                                    <template x-for="(gap, idx) in forensicResult.gaps" :key="idx">
                                        <div class="p-4 hover:bg-gray-50">
                                            <div class="flex items-start justify-between">
                                                <div>
                                                    <span class="font-medium text-gray-900" x-text="gap.area || gap.nrs_section || gap"></span>
                                                    <p x-show="gap.description" class="text-sm text-gray-600 mt-1" x-text="gap.description"></p>
                                                </div>
                                                <span x-show="gap.severity" class="px-2 py-1 text-xs rounded-full"
                                                      :class="gap.severity === 'high' ? 'bg-red-100 text-red-800' : gap.severity === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'"
                                                      x-text="gap.severity"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Recommendations -->
                            <div x-show="forensicResult.recommendations?.length > 0" class="bg-white border rounded-lg">
                                <div class="px-4 py-3 bg-blue-50 border-b border-blue-200 rounded-t-lg">
                                    <h5 class="font-semibold text-blue-800">Recommendations</h5>
                                </div>
                                <ul class="divide-y">
                                    <template x-for="(rec, idx) in forensicResult.recommendations" :key="idx">
                                        <li class="p-4 flex items-start gap-3">
                                            <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm font-medium" x-text="idx + 1"></span>
                                            <span class="text-gray-700" x-text="rec.action || rec.recommendation || rec"></span>
                                        </li>
                                    </template>
                                </ul>
                            </div>

                            <!-- Compliant Areas -->
                            <div x-show="forensicResult.compliant_areas?.length > 0" class="bg-white border rounded-lg">
                                <div class="px-4 py-3 bg-green-50 border-b border-green-200 rounded-t-lg">
                                    <h5 class="font-semibold text-green-800">Compliant Areas</h5>
                                </div>
                                <div class="p-4 flex flex-wrap gap-2">
                                    <template x-for="(area, idx) in forensicResult.compliant_areas" :key="idx">
                                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm" x-text="area"></span>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Benford's Law Results -->
                    <template x-if="forensicResult?._analysisType === 'benfords'">
                        <div class="space-y-6">
                            <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg border border-purple-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-800">Benford's Law Conformity</h4>
                                        <p class="text-sm text-gray-600">Statistical analysis of leading digit distribution</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-4xl font-bold"
                                              :class="forensicResult.conforms_to_benfords ? 'text-green-600' : 'text-red-600'"
                                              x-text="forensicResult.conforms_to_benfords ? '✓ PASS' : '✗ FAIL'"></span>
                                        <p class="text-sm text-gray-500" x-text="'Chi-Square: ' + (forensicResult.chi_square || 0).toFixed(4)"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white border rounded-lg p-4">
                                <h5 class="font-semibold mb-4">Digit Distribution Analysis</h5>
                                <div class="space-y-2">
                                    <template x-for="(item, digit) in forensicResult.digit_distribution || []" :key="digit">
                                        <div class="flex items-center gap-4">
                                            <span class="w-8 text-center font-mono font-bold" x-text="digit + 1"></span>
                                            <div class="flex-1 h-6 bg-gray-100 rounded relative overflow-hidden">
                                                <div class="absolute inset-y-0 left-0 bg-blue-500 opacity-60" :style="'width: ' + ((item.expected || 0) * 100) + '%'"></div>
                                                <div class="absolute inset-y-0 left-0 bg-purple-600" :style="'width: ' + ((item.actual || 0) * 100) + '%'; 'height: 50%'; 'top: 25%'"></div>
                                            </div>
                                            <span class="text-sm text-gray-600 w-24" x-text="'Act: ' + ((item.actual || 0) * 100).toFixed(1) + '%'"></span>
                                        </div>
                                    </template>
                                </div>
                                <div class="mt-4 flex gap-4 text-sm">
                                    <span class="flex items-center gap-2"><span class="w-3 h-3 bg-blue-500 opacity-60 rounded"></span> Expected</span>
                                    <span class="flex items-center gap-2"><span class="w-3 h-3 bg-purple-600 rounded"></span> Actual</span>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Benford's Law - Insufficient Data -->
                    <template x-if="forensicResult?._analysisType === 'benfords_insufficient'">
                        <div class="space-y-6">
                            <div class="bg-gradient-to-r from-amber-50 to-yellow-50 p-6 rounded-lg border border-amber-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="w-12 h-12 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <h4 class="text-lg font-semibold text-amber-800">Insufficient Data for Analysis</h4>
                                        <p class="text-sm text-amber-600" x-text="forensicResult.message"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Data Requirements -->
                            <div class="bg-white border rounded-lg p-5">
                                <div class="flex items-center justify-between mb-4">
                                    <h5 class="font-medium text-gray-800">Data Requirements</h5>
                                    <div class="text-right">
                                        <span class="text-2xl font-bold" :class="forensicResult.records_found >= 100 ? 'text-green-600' : 'text-red-600'" x-text="forensicResult.records_found || 0"></span>
                                        <span class="text-gray-500">/ 100 minimum</span>
                                    </div>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                    <div class="h-full transition-all duration-500"
                                         :class="forensicResult.records_found >= 100 ? 'bg-green-500' : forensicResult.records_found >= 50 ? 'bg-yellow-500' : 'bg-red-500'"
                                         :style="'width: ' + Math.min(100, (forensicResult.records_found / 100) * 100) + '%'"></div>
                                </div>
                                <p class="text-sm text-gray-600 mt-2">
                                    Benford's Law requires at least 100 data points to produce statistically meaningful results.
                                </p>
                            </div>
                            
                            <!-- Data Sources Summary -->
                            <div class="bg-white border rounded-lg p-4">
                                <h5 class="font-medium text-gray-800 mb-3">Current Data Sources</h5>
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                    <template x-for="(count, source) in forensicResult.data_sources" :key="source">
                                        <div class="bg-gray-50 p-3 rounded-lg text-center">
                                            <p class="text-2xl font-bold" :class="typeof count === 'number' && count > 0 ? 'text-green-600' : 'text-gray-400'" x-text="typeof count === 'number' ? count : 0"></p>
                                            <p class="text-xs text-gray-500 capitalize" x-text="source.replace('_', ' ')"></p>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- Why 100? -->
                            <div x-show="forensicResult.interpretation" class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <h5 class="font-medium text-purple-800 mb-2 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Why 100 Records?
                                </h5>
                                <p class="text-sm text-purple-700" x-text="forensicResult.interpretation?.why_100"></p>
                                <p class="text-sm text-purple-600 mt-2" x-text="forensicResult.interpretation?.alternatives"></p>
                            </div>
                            
                            <!-- Suggestions -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h5 class="font-medium text-blue-800 mb-3 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                    </svg>
                                    How to Enable This Analysis
                                </h5>
                                <ul class="space-y-2">
                                    <template x-for="(suggestion, idx) in forensicResult.suggestions" :key="idx">
                                        <li class="flex items-start text-sm text-blue-700">
                                            <span class="mr-2">•</span>
                                            <span x-text="suggestion"></span>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                            
                            <!-- Quick Links -->
                            <div class="flex flex-wrap gap-3">
                                <a href="/transactions" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    Add Transactions
                                </a>
                                <a href="/accounting" class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    Record Journal Entries
                                </a>
                                <a href="/invoices" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    Create Invoices
                                </a>
                                <button @click="runAnomalyDetection()" class="inline-flex items-center px-4 py-2 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                    Try Anomaly Detection (10 min)
                                </button>
                            </div>
                        </div>
                    </template>

                    <!-- Anomaly Detection Results -->
                    <template x-if="forensicResult?._analysisType === 'anomaly'">
                        <div class="space-y-6">
                            <div class="bg-gradient-to-r from-orange-50 to-red-50 p-6 rounded-lg border border-orange-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-800">Anomaly Detection Summary</h4>
                                        <p class="text-sm text-gray-600">Z-score based statistical outlier detection</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-4xl font-bold text-orange-600" x-text="(forensicResult.anomalies?.length || 0)"></span>
                                        <p class="text-sm text-gray-500">Anomalies Detected</p>
                                    </div>
                                </div>
                            </div>
                            <div x-show="forensicResult.anomalies?.length > 0" class="bg-white border rounded-lg">
                                <div class="px-4 py-3 bg-orange-50 border-b">
                                    <h5 class="font-semibold text-orange-800">Detected Anomalous Transactions</h5>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Z-Score</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Risk</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y">
                                            <template x-for="(a, idx) in forensicResult.anomalies" :key="idx">
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-2 text-sm" x-text="a.date || a.transaction_date || '-'"></td>
                                                    <td class="px-4 py-2 text-sm font-mono" x-text="'₦' + (a.amount || 0).toLocaleString()"></td>
                                                    <td class="px-4 py-2 text-sm" x-text="(a.z_score || 0).toFixed(2)"></td>
                                                    <td class="px-4 py-2">
                                                        <span class="px-2 py-1 text-xs rounded-full"
                                                              :class="Math.abs(a.z_score || 0) > 3 ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'"
                                                              x-text="Math.abs(a.z_score || 0) > 3 ? 'High' : 'Medium'"></span>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div x-show="!forensicResult.anomalies?.length" class="bg-green-50 p-6 rounded-lg text-center">
                                <span class="text-4xl text-green-500"><svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <p class="text-green-800 font-medium mt-2">No anomalies detected in transaction data</p>
                            </div>
                        </div>
                    </template>

                    <!-- Anomaly Detection - Insufficient Data -->
                    <template x-if="forensicResult?._analysisType === 'anomaly_insufficient'">
                        <div class="space-y-6">
                            <div class="bg-gradient-to-r from-amber-50 to-yellow-50 p-6 rounded-lg border border-amber-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="w-12 h-12 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <h4 class="text-lg font-semibold text-amber-800">Insufficient Data for Analysis</h4>
                                        <p class="text-sm text-amber-600" x-text="forensicResult.message"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Data Sources Summary -->
                            <div class="bg-white border rounded-lg p-4">
                                <h5 class="font-medium text-gray-800 mb-3">Current Data Sources</h5>
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                    <template x-for="(count, source) in forensicResult.data_sources" :key="source">
                                        <div class="bg-gray-50 p-3 rounded-lg text-center">
                                            <p class="text-2xl font-bold" :class="count > 0 ? 'text-green-600' : 'text-gray-400'" x-text="typeof count === 'number' ? count : 0"></p>
                                            <p class="text-xs text-gray-500 capitalize" x-text="source.replace('_', ' ')"></p>
                                        </div>
                                    </template>
                                </div>
                                <p class="text-sm text-gray-600 mt-3">
                                    <span class="font-medium">Total Records Found:</span> 
                                    <span x-text="forensicResult.records_found || 0"></span> 
                                    <span class="text-gray-400">(Minimum required: 10)</span>
                                </p>
                            </div>
                            
                            <!-- Suggestions -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h5 class="font-medium text-blue-800 mb-3 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Suggestions to Enable Analysis
                                </h5>
                                <ul class="space-y-2">
                                    <template x-for="(suggestion, idx) in forensicResult.suggestions" :key="idx">
                                        <li class="flex items-start text-sm text-blue-700">
                                            <span class="mr-2">•</span>
                                            <span x-text="suggestion"></span>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                            
                            <!-- Quick Links -->
                            <div class="flex flex-wrap gap-3">
                                <a href="/transactions" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    Add Transactions
                                </a>
                                <a href="/accounting" class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    Record Journal Entries
                                </a>
                                <a href="/invoices" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    Create Invoices
                                </a>
                            </div>
                        </div>
                    </template>

                    <!-- Fallback: Raw JSON for unknown types -->
                    <template x-if="!forensicResult?._analysisType">
                        <pre class="bg-gray-50 p-4 rounded-lg text-sm overflow-x-auto" x-text="JSON.stringify(forensicResult, null, 2)"></pre>
                    </template>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button @click="printForensicResult()" class="bg-gray-100 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-200">Print</button>
                    <button @click="forensicResult = null" class="bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         TAB: AUDIT RUNS
         ======================================== -->
    <div x-show="activeTab === 'runs'" class="space-y-6">
        <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold">Reproducible Audit Runs</h3>
            <button @click="openNewRunModal()" 
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                New Audit Run
            </button>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Run ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Period</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Findings</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <!-- Empty state -->
                    <template x-if="auditRunsList.length === 0">
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                                <p class="mt-2 text-gray-500">No audit runs yet</p>
                                <p class="text-sm text-gray-400">Click "+ New Audit Run" to create your first reproducible audit</p>
                            </td>
                        </tr>
                    </template>
                    <template x-for="run in auditRunsList" :key="run.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="font-mono text-gray-900" x-text="run.run_id?.slice(0,8) || run.id?.slice(0,8) || '-'"></span>
                                <p class="text-xs text-gray-500 truncate max-w-[200px]" x-text="run.title"></p>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="capitalize" x-text="run.run_type?.replace(/_/g, ' ') || '-'"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full"
                                      :class="{
                                          'bg-green-100 text-green-800': run.status === 'completed',
                                          'bg-yellow-100 text-yellow-800': run.status === 'running' || run.status === 'pending',
                                          'bg-red-100 text-red-800': run.status === 'failed',
                                          'bg-gray-100 text-gray-800': !['completed', 'running', 'pending', 'failed'].includes(run.status)
                                      }"
                                      x-text="run.status || 'unknown'"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                <span x-text="(run.period_start || 'N/A') + ' - ' + (run.period_end || 'N/A')"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span x-show="run.critical_findings > 0" class="text-red-600 font-medium" x-text="run.critical_findings + ' critical'"></span>
                                <span x-show="run.critical_findings === 0 && run.total_findings > 0" class="text-yellow-600" x-text="run.total_findings + ' total'"></span>
                                <span x-show="!run.total_findings || run.total_findings === 0" class="text-gray-400">0 findings</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button @click="viewRunDetails(run)" class="text-indigo-600 hover:text-indigo-800 mr-3">View</button>
                                <button @click="reproduceRun(run.run_id || run.id)" class="text-green-600 hover:text-green-800">Reproduce</button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ========================================
         TAB: FINDINGS
         ======================================== -->
    <div x-show="activeTab === 'findings'" class="space-y-6">
        <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold">Audit Findings</h3>
            <div class="flex items-center space-x-4">
                <select x-model="findingsFilter.riskLevel" @change="loadFindings()"
                        class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <option value="">All Risk Levels</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
        </div>

        <div class="space-y-4">
            <template x-for="finding in findingsList" :key="finding.id">
                <div class="bg-white rounded-lg shadow p-6 border-l-4"
                     :class="{
                         'border-red-500': finding.risk_level === 'critical',
                         'border-orange-500': finding.risk_level === 'high',
                         'border-yellow-500': finding.risk_level === 'medium',
                         'border-blue-500': finding.risk_level === 'low'
                     }">
                    <div class="flex items-start justify-between">
                        <div>
                            <span class="text-xs font-mono text-gray-500" x-text="finding.finding_ref"></span>
                            <h4 class="text-lg font-semibold mt-1" x-text="finding.title"></h4>
                            <p class="text-sm text-gray-600 mt-2" x-text="finding.description"></p>
                        </div>
                        <span class="px-3 py-1 text-xs rounded-full font-medium"
                              :class="{
                                  'bg-red-100 text-red-800': finding.risk_level === 'critical',
                                  'bg-orange-100 text-orange-800': finding.risk_level === 'high',
                                  'bg-yellow-100 text-yellow-800': finding.risk_level === 'medium',
                                  'bg-blue-100 text-blue-800': finding.risk_level === 'low'
                              }"
                              x-text="finding.risk_level.toUpperCase()"></span>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <p class="text-sm"><strong>Impact:</strong> <span x-text="finding.impact"></span></p>
                        <p class="text-sm mt-1"><strong>Recommendation:</strong> <span x-text="finding.recommendation"></span></p>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- ========================================
         TAB: EVIDENCE
         ======================================== -->
    <div x-show="activeTab === 'evidence'" class="space-y-6">
        <!-- Header with Collection Options -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold">Immutable Evidence Collection</h3>
                        <p class="text-sm text-gray-600">All evidence is hash-verified, timestamped, and tamper-proof</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button @click="showCollectModal = 'document'" 
                                class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">
                            Document
                        </button>
                        <button @click="showCollectModal = 'screenshot'"
                                class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                            Screenshot
                        </button>
                        <button @click="showCollectModal = 'transaction'"
                                class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                            Transactions
                        </button>
                        <button @click="showCollectModal = 'calculation'"
                                class="px-3 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm">
                            Calculation
                        </button>
                        <button @click="showCollectModal = 'logs'"
                                class="px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm">
                            Logs
                        </button>
                        <button @click="showCollectModal = 'snapshot'"
                                class="px-3 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 text-sm">
                            Snapshot
                        </button>
                        <button @click="showCollectModal = 'confirmation'"
                                class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                            Confirm
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-4 gap-4 p-4 bg-gray-50">
                <div class="text-center">
                    <div class="text-2xl font-bold text-indigo-600" x-text="evidenceStats.total || 0"></div>
                    <div class="text-xs text-gray-500">Total Evidence</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" x-text="evidenceStats.verified || 0"></div>
                    <div class="text-xs text-gray-500">Verified</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-yellow-600" x-text="evidenceStats.pending || 0"></div>
                    <div class="text-xs text-gray-500">Pending</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" x-text="evidenceStats.documents || 0"></div>
                    <div class="text-xs text-gray-500">Documents</div>
                </div>
            </div>
            
            <!-- Auto-Collect Section -->
            <div class="px-4 py-3 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="text-sm font-medium text-gray-700">Auto-Collect from System Data</div>
                    <div class="flex flex-wrap gap-2">
                        <button @click="autoCollectBankTransactions()" 
                                :disabled="autoCollecting.bank"
                                :class="autoCollecting.bank ? 'opacity-50 cursor-wait' : 'hover:bg-blue-700'"
                                class="px-3 py-1.5 bg-blue-600 text-white rounded text-xs flex items-center gap-1">
                            <span x-show="autoCollecting.bank" class="animate-spin inline-block w-3 h-3 border-2 border-white border-t-transparent rounded-full"></span>
                            Bank Transactions
                        </button>
                        <button @click="autoCollectGLEntries()" 
                                :disabled="autoCollecting.gl"
                                :class="autoCollecting.gl ? 'opacity-50 cursor-wait' : 'hover:bg-green-700'"
                                class="px-3 py-1.5 bg-green-600 text-white rounded text-xs flex items-center gap-1">
                            <span x-show="autoCollecting.gl" class="animate-spin inline-block w-3 h-3 border-2 border-white border-t-transparent rounded-full"></span>
                            GL Entries
                        </button>
                        <button @click="autoCollectInventory()" 
                                :disabled="autoCollecting.inventory"
                                :class="autoCollecting.inventory ? 'opacity-50 cursor-wait' : 'hover:bg-amber-700'"
                                class="px-3 py-1.5 bg-amber-600 text-white rounded text-xs flex items-center gap-1">
                            <span x-show="autoCollecting.inventory" class="animate-spin inline-block w-3 h-3 border-2 border-white border-t-transparent rounded-full"></span>
                            Inventory
                        </button>
                        <button @click="autoCollectPayroll()" 
                                :disabled="autoCollecting.payroll"
                                :class="autoCollecting.payroll ? 'opacity-50 cursor-wait' : 'hover:bg-purple-700'"
                                class="px-3 py-1.5 bg-purple-600 text-white rounded text-xs flex items-center gap-1">
                            <span x-show="autoCollecting.payroll" class="animate-spin inline-block w-3 h-3 border-2 border-white border-t-transparent rounded-full"></span>
                            Payroll
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Pending Confirmations Section -->
            <div class="px-4 py-3 border-t border-gray-200" x-show="pendingConfirmations.length > 0">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm font-medium text-gray-700">Pending Confirmations (<span x-text="pendingConfirmations.length"></span>)</div>
                    <button @click="loadPendingConfirmations()" class="text-xs text-indigo-600 hover:text-indigo-800">Refresh</button>
                </div>
                <div class="max-h-40 overflow-y-auto">
                    <template x-for="conf in pendingConfirmations" :key="conf.id">
                        <div class="flex items-center justify-between p-2 bg-yellow-50 border border-yellow-200 rounded mb-1">
                            <div class="flex-1">
                                <span class="text-xs font-medium text-yellow-800" x-text="conf.evidence_ref"></span>
                                <span class="text-xs text-gray-600 ml-2" x-text="conf.content?.external_party_name || 'Unknown Party'"></span>
                                <span class="text-xs text-gray-500 ml-2">Due: <span x-text="conf.content?.due_date || 'N/A'"></span></span>
                            </div>
                            <button @click="openConfirmationResponseModal(conf)" 
                                    class="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700">
                                Record Response
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        
        <!-- Evidence Filter Tabs -->
        <div class="bg-white rounded-lg shadow">
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px px-4">
                    <button @click="evidenceFilter = 'all'; evidencePage = 1; loadEvidence()"
                            :class="evidenceFilter === 'all' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500'"
                            class="py-4 px-6 border-b-2 font-medium text-sm">
                        All
                    </button>
                    <button @click="evidenceFilter = 'document'; evidencePage = 1; loadEvidence()"
                            :class="evidenceFilter === 'document' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500'"
                            class="py-4 px-6 border-b-2 font-medium text-sm">
                        Documents
                    </button>
                    <button @click="evidenceFilter = 'transaction'; evidencePage = 1; loadEvidence()"
                            :class="evidenceFilter === 'transaction' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500'"
                            class="py-4 px-6 border-b-2 font-medium text-sm">
                        Transactions
                    </button>
                    <button @click="evidenceFilter = 'screenshot'; evidencePage = 1; loadEvidence()"
                            :class="evidenceFilter === 'screenshot' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500'"
                            class="py-4 px-6 border-b-2 font-medium text-sm">
                        Screenshots
                    </button>
                    <button @click="evidenceFilter = 'calculation'; evidencePage = 1; loadEvidence()"
                            :class="evidenceFilter === 'calculation' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500'"
                            class="py-4 px-6 border-b-2 font-medium text-sm">
                        Calculations
                    </button>
                    <button @click="evidenceFilter = 'external_confirmation'; evidencePage = 1; loadEvidence()"
                            :class="evidenceFilter === 'external_confirmation' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500'"
                            class="py-4 px-6 border-b-2 font-medium text-sm">
                        Confirmations
                    </button>
                    <button @click="evidenceFilter = 'log_extract'; evidencePage = 1; loadEvidence()"
                            :class="evidenceFilter === 'log_extract' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500'"
                            class="py-4 px-6 border-b-2 font-medium text-sm">
                        Logs
                    </button>
                    <button @click="evidenceFilter = 'database_snapshot'; evidencePage = 1; loadEvidence()"
                            :class="evidenceFilter === 'database_snapshot' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500'"
                            class="py-4 px-6 border-b-2 font-medium text-sm">
                        Snapshots
                    </button>
                </nav>
            </div>
            
            <!-- Search, Date Filter, and Pagination Controls -->
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <div class="flex flex-wrap gap-4 items-end">
                    <!-- Search Input -->
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-xs font-medium text-gray-500 mb-1">Search Evidence</label>
                        <div class="relative">
                            <input type="text" x-model="evidenceSearch" 
                                   @input.debounce.300ms="loadEvidence()"
                                   placeholder="Search by title, reference, description..."
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Date From -->
                    <div class="w-40">
                        <label class="block text-xs font-medium text-gray-500 mb-1">From Date</label>
                        <input type="date" x-model="evidenceDateFrom" @change="loadEvidence()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <!-- Date To -->
                    <div class="w-40">
                        <label class="block text-xs font-medium text-gray-500 mb-1">To Date</label>
                        <input type="date" x-model="evidenceDateTo" @change="loadEvidence()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <!-- Clear Filters -->
                    <button @click="evidenceSearch = ''; evidenceDateFrom = ''; evidenceDateTo = ''; evidenceFilter = 'all'; evidencePage = 1; loadEvidence();"
                            class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 border border-gray-300 rounded-lg hover:bg-gray-100">
                        Clear Filters
                    </button>
                    
                    <!-- Export Buttons -->
                    <div class="flex gap-2">
                        <button @click="exportEvidenceToPDF()" 
                                class="px-3 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            PDF
                        </button>
                        <button @click="exportEvidenceToExcel()" 
                                class="px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Excel
                        </button>
                    </div>
                </div>
                
                <!-- Pagination Info -->
                <div class="flex justify-between items-center mt-3 text-sm text-gray-600">
                    <div>
                        Showing <span class="font-medium" x-text="((evidencePage - 1) * evidencePageSize) + 1"></span> - 
                        <span class="font-medium" x-text="Math.min(evidencePage * evidencePageSize, evidenceTotal)"></span> 
                        of <span class="font-medium" x-text="evidenceTotal"></span> evidence items
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click="evidencePage = Math.max(1, evidencePage - 1); loadEvidence()" 
                                :disabled="evidencePage <= 1"
                                :class="evidencePage <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'"
                                class="px-3 py-1 border border-gray-300 rounded text-sm">
                            ← Previous
                        </button>
                        <span class="px-3">Page <span x-text="evidencePage"></span> of <span x-text="evidenceTotalPages"></span></span>
                        <button @click="evidencePage = Math.min(evidenceTotalPages, evidencePage + 1); loadEvidence()" 
                                :disabled="evidencePage >= evidenceTotalPages"
                                :class="evidencePage >= evidenceTotalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'"
                                class="px-3 py-1 border border-gray-300 rounded text-sm">
                            Next →
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Evidence Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reference</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hash</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Collected</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="ev in filteredEvidence" :key="ev.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="text-sm font-mono text-indigo-600" x-text="ev.evidence_ref"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full"
                                          :class="{
                                              'bg-blue-100 text-blue-800': ev.evidence_type === 'document',
                                              'bg-green-100 text-green-800': ev.evidence_type === 'transaction',
                                              'bg-purple-100 text-purple-800': ev.evidence_type === 'screenshot',
                                              'bg-yellow-100 text-yellow-800': ev.evidence_type === 'calculation',
                                              'bg-pink-100 text-pink-800': ev.evidence_type === 'external_confirmation',
                                              'bg-orange-100 text-orange-800': ev.evidence_type === 'log_extract',
                                              'bg-cyan-100 text-cyan-800': ev.evidence_type === 'database_snapshot',
                                              'bg-gray-100 text-gray-800': !['document','transaction','screenshot','calculation','external_confirmation','log_extract','database_snapshot'].includes(ev.evidence_type)
                                          }"
                                          x-text="ev.evidence_type.replace('_', ' ')"></span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm font-medium text-gray-900" x-text="ev.title || 'Untitled'"></div>
                                    <div class="text-xs text-gray-500" x-text="ev.description?.substring(0, 50) + '...' || ''"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="text-xs font-mono text-gray-500" x-text="ev.content_hash?.substring(0,12) + '...' || 'N/A'"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(ev.collected_at)"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span x-show="ev.is_verified" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        ✓ Verified
                                    </span>
                                    <span x-show="!ev.is_verified" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        Pending
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                    <button @click="viewEvidenceDetail(ev)" class="text-indigo-600 hover:text-indigo-900">View</button>
                                    <button @click="verifyEvidence(ev.id)" class="text-green-600 hover:text-green-900">Verify</button>
                                    <button x-show="ev.has_file || ev.file_path" @click="downloadEvidence(ev.id)" class="text-blue-600 hover:text-blue-900">Download</button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="filteredEvidence.length === 0">
                            <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                <div class="text-4xl mb-2 text-gray-300">—</div>
                                <div>No evidence found. Upload documents or collect evidence above.</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Document Upload Modal -->
        <div x-show="showCollectModal === 'document'" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:leave="transition ease-in duration-200"
             class="fixed inset-0 z-50 overflow-y-auto" @click.self="showCollectModal = null">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div class="fixed inset-0 bg-black opacity-50"></div>
                <div class="relative bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                    <h3 class="text-lg font-semibold mb-4">Upload Document Evidence</h3>
                    <form @submit.prevent="uploadDocument()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Title *</label>
                                <input type="text" x-model="documentUpload.title" required
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea x-model="documentUpload.description" rows="2"
                                          class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Document Type</label>
                                    <select x-model="documentUpload.document_type"
                                            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                        <option value="invoice">Invoice</option>
                                        <option value="receipt">Receipt</option>
                                        <option value="contract">Contract</option>
                                        <option value="bank_statement">Bank Statement</option>
                                        <option value="report">Report</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Link to Finding</label>
                                    <select x-model="documentUpload.finding_id"
                                            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                        <option value="">No Finding Selected</option>
                                        <template x-for="finding in findingsList" :key="finding.id">
                                            <option :value="finding.id" x-text="finding.finding_ref + ' - ' + (finding.title?.substring(0,30) || 'Untitled')"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Link to Audit Run</label>
                                <select x-model="documentUpload.audit_run_id"
                                        class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="">No Audit Run Selected</option>
                                    <template x-for="run in auditRunsList" :key="run.id">
                                        <option :value="run.id" x-text="run.run_ref + ' - ' + (run.title?.substring(0,30) || run.run_type)"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">File *</label>
                                <input type="file" @change="documentUpload.file = $event.target.files[0]"
                                       accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt,.jpg,.jpeg,.png"
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                <p class="text-xs text-gray-500 mt-1">Max 10MB. PDF, DOC, XLS, CSV, images.</p>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" @click="showCollectModal = null"
                                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" :disabled="!documentUpload.title || !documentUpload.file"
                                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                                Upload & Collect
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Screenshot Modal -->
        <div x-show="showCollectModal === 'screenshot'" 
             class="fixed inset-0 z-50 overflow-y-auto" @click.self="showCollectModal = null"
             @paste.window="handleClipboardPaste($event)">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div class="fixed inset-0 bg-black opacity-50"></div>
                <div class="relative bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                    <h3 class="text-lg font-semibold mb-4">Capture Screenshot Evidence</h3>
                    <form @submit.prevent="uploadScreenshot()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Title *</label>
                                <input type="text" x-model="screenshotUpload.title" required
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Source URL/System</label>
                                <input type="text" x-model="screenshotUpload.source_url"
                                       placeholder="e.g., https://banking.example.com/statement"
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            
                            <!-- Clipboard Paste Area -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center transition-colors"
                                 :class="{'border-green-500 bg-green-50': screenshotUpload.clipboardImage}"
                                 @dragover.prevent
                                 @drop.prevent="handleImageDrop($event)">
                                <template x-if="!screenshotUpload.clipboardImage">
                                    <div>
                                        <div class="text-4xl mb-2 text-gray-400">+</div>
                                        <p class="text-sm text-gray-600 font-medium">Press Ctrl+V to paste screenshot from clipboard</p>
                                        <p class="text-xs text-gray-500 mt-1">Or drag & drop an image here</p>
                                    </div>
                                </template>
                                <template x-if="screenshotUpload.clipboardImage">
                                    <div>
                                        <img :src="screenshotUpload.clipboardPreview" alt="Pasted screenshot" 
                                             class="max-h-32 mx-auto rounded border">
                                        <p class="text-sm text-green-600 mt-2">Screenshot captured from clipboard</p>
                                        <button type="button" @click="clearClipboardImage()" 
                                                class="text-xs text-red-600 hover:text-red-800 mt-1">Clear</button>
                                    </div>
                                </template>
                            </div>
                            
                            <div class="relative">
                                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">or upload file</span></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Screenshot File</label>
                                <input type="file" @change="screenshotUpload.file = $event.target.files[0]; screenshotUpload.clipboardImage = null; screenshotUpload.clipboardPreview = null;"
                                       accept="image/*"
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Description</label>
                                    <textarea x-model="screenshotUpload.description" rows="2"
                                              class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Link to Finding</label>
                                    <select x-model="screenshotUpload.finding_id"
                                            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                        <option value="">No Finding Selected</option>
                                        <template x-for="finding in findingsList" :key="finding.id">
                                            <option :value="finding.id" x-text="finding.finding_ref + ' - ' + (finding.title?.substring(0,25) || 'Untitled')"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" @click="showCollectModal = null"
                                    class="px-4 py-2 border border-gray-300 rounded-lg">Cancel</button>
                            <button type="submit" 
                                    :disabled="!screenshotUpload.title || (!screenshotUpload.file && !screenshotUpload.clipboardImage)"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
                                Capture & Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Transaction Collection Modal -->
        <div x-show="showCollectModal === 'transaction'" 
             class="fixed inset-0 z-50 overflow-y-auto" @click.self="showCollectModal = null">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div class="fixed inset-0 bg-black opacity-50"></div>
                <div class="relative bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                    <h3 class="text-lg font-semibold mb-4">Collect Transaction Evidence</h3>
                    <form @submit.prevent="collectTransactions()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Title *</label>
                                <input type="text" x-model="transactionCollect.title" required
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Start Date</label>
                                    <input type="date" x-model="transactionCollect.date_from"
                                           class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">End Date</label>
                                    <input type="date" x-model="transactionCollect.date_to"
                                           class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Min Amount</label>
                                    <input type="number" x-model="transactionCollect.min_amount"
                                           class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Max Amount</label>
                                    <input type="number" x-model="transactionCollect.max_amount"
                                           class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Transaction Type</label>
                                <select x-model="transactionCollect.transaction_type"
                                        class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="">All Types</option>
                                    <option value="income">Income</option>
                                    <option value="expense">Expense</option>
                                    <option value="transfer">Transfer</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Link to Finding</label>
                                <select x-model="transactionCollect.finding_id"
                                        class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="">No Finding Selected</option>
                                    <template x-for="finding in findingsList" :key="finding.id">
                                        <option :value="finding.id" x-text="finding.finding_ref + ' - ' + (finding.title?.substring(0,30) || 'Untitled')"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" @click="showCollectModal = null"
                                    class="px-4 py-2 border border-gray-300 rounded-lg">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Collect Transactions
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Confirmation Request Modal -->
        <div x-show="showCollectModal === 'confirmation'" 
             class="fixed inset-0 z-50 overflow-y-auto" @click.self="showCollectModal = null">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div class="fixed inset-0 bg-black opacity-50"></div>
                <div class="relative bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                    <h3 class="text-lg font-semibold mb-4">Third-Party Confirmation Request</h3>
                    <form @submit.prevent="createConfirmationRequest()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Title *</label>
                                <input type="text" x-model="confirmationRequest.title" required
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">External Party Name *</label>
                                <input type="text" x-model="confirmationRequest.external_party_name" required
                                       placeholder="e.g., First Bank of Nigeria"
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">External Party Email *</label>
                                <input type="email" x-model="confirmationRequest.external_party_email" required
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Confirmation Type</label>
                                <select x-model="confirmationRequest.confirmation_type"
                                        class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="balance">Balance Confirmation</option>
                                    <option value="transaction">Transaction Confirmation</option>
                                    <option value="vendor">Vendor Confirmation</option>
                                    <option value="customer">Customer Confirmation</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Due Date *</label>
                                <input type="date" x-model="confirmationRequest.due_date" required
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Notes</label>
                                    <textarea x-model="confirmationRequest.notes" rows="2"
                                              class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Link to Finding</label>
                                    <select x-model="confirmationRequest.finding_id"
                                            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                        <option value="">No Finding Selected</option>
                                        <template x-for="finding in findingsList" :key="finding.id">
                                            <option :value="finding.id" x-text="finding.finding_ref + ' - ' + (finding.title?.substring(0,25) || 'Untitled')"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" @click="showCollectModal = null"
                                    class="px-4 py-2 border border-gray-300 rounded-lg">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                Create Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Confirmation Response Modal -->
        <div x-show="showConfirmationResponseModal" 
             class="fixed inset-0 z-50 overflow-y-auto" @click.self="showConfirmationResponseModal = false">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div class="fixed inset-0 bg-black opacity-50"></div>
                <div class="relative bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                    <h3 class="text-lg font-semibold mb-4">Record Confirmation Response</h3>
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg" x-show="selectedConfirmation">
                        <p class="text-sm"><strong>Reference:</strong> <span x-text="selectedConfirmation?.evidence_ref"></span></p>
                        <p class="text-sm"><strong>Party:</strong> <span x-text="selectedConfirmation?.content?.external_party_name"></span></p>
                        <p class="text-sm"><strong>Type:</strong> <span x-text="selectedConfirmation?.content?.confirmation_type"></span></p>
                    </div>
                    <form @submit.prevent="submitConfirmationResponse()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Response Status *</label>
                                <select x-model="confirmationResponse.status" required
                                        class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="">Select Status...</option>
                                    <option value="confirmed">Confirmed - Agrees with Records</option>
                                    <option value="differs">Differs - Discrepancy Found</option>
                                    <option value="no_response">No Response Received</option>
                                    <option value="undeliverable">Undeliverable</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Response Received Date</label>
                                <input type="date" x-model="confirmationResponse.response_date"
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div x-show="confirmationResponse.status === 'differs'">
                                <label class="block text-sm font-medium text-gray-700">Reported Balance/Amount</label>
                                <input type="number" step="0.01" x-model="confirmationResponse.reported_amount"
                                       placeholder="Amount reported by third party"
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div x-show="confirmationResponse.status === 'differs'">
                                <label class="block text-sm font-medium text-gray-700">Difference Explanation</label>
                                <textarea x-model="confirmationResponse.difference_explanation" rows="2"
                                          placeholder="Explain the discrepancy..."
                                          class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Response Notes</label>
                                <textarea x-model="confirmationResponse.notes" rows="3"
                                          placeholder="Additional notes about the response..."
                                          class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Attach Response Document</label>
                                <input type="file" @change="confirmationResponse.file = $event.target.files[0]"
                                       accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                       class="mt-1 w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" @click="showConfirmationResponseModal = false; selectedConfirmation = null;"
                                    class="px-4 py-2 border border-gray-300 rounded-lg">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                Record Response
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Calculation Evidence Modal -->
        <div x-show="showCollectModal === 'calculation'" 
             class="fixed inset-0 z-50 overflow-y-auto" @click.self="showCollectModal = null">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div class="fixed inset-0 bg-black opacity-50"></div>
                <div class="relative bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                    <h3 class="text-lg font-semibold mb-4">Create Calculation Evidence</h3>
                    <form @submit.prevent="createCalculationEvidence()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Title *</label>
                                <input type="text" x-model="calculationForm.title" required
                                       placeholder="e.g., Materiality Calculation"
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Calculation Type</label>
                                <select x-model="calculationForm.calculation_type"
                                        class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="materiality">Materiality</option>
                                    <option value="variance">Variance Analysis</option>
                                    <option value="ratio">Financial Ratio</option>
                                    <option value="tax">Tax Computation</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Formula/Method</label>
                                <input type="text" x-model="calculationForm.formula"
                                       placeholder="e.g., 0.05 * min(revenue, assets)"
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Revenue</label>
                                    <input type="number" x-model="calculationForm.inputs.revenue"
                                           class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Net Income</label>
                                    <input type="number" x-model="calculationForm.inputs.net_income"
                                           class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Total Assets</label>
                                    <input type="number" x-model="calculationForm.inputs.total_assets"
                                           class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Description</label>
                                    <textarea x-model="calculationForm.description" rows="2"
                                              class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Link to Finding</label>
                                    <select x-model="calculationForm.finding_id"
                                            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                        <option value="">No Finding Selected</option>
                                        <template x-for="finding in findingsList" :key="finding.id">
                                            <option :value="finding.id" x-text="finding.finding_ref + ' - ' + (finding.title?.substring(0,25) || 'Untitled')"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" @click="showCollectModal = null"
                                    class="px-4 py-2 border border-gray-300 rounded-lg">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                                Compute & Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- System Logs Modal -->
        <div x-show="showCollectModal === 'logs'" 
             class="fixed inset-0 z-50 overflow-y-auto" @click.self="showCollectModal = null">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div class="fixed inset-0 bg-black opacity-50"></div>
                <div class="relative bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                    <h3 class="text-lg font-semibold mb-4">Extract System Logs</h3>
                    <form @submit.prevent="extractSystemLogs()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Title *</label>
                                <input type="text" x-model="logsForm.title" required
                                       placeholder="e.g., Q4 Audit Trail Extract"
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Start Date *</label>
                                    <input type="date" x-model="logsForm.date_from" required
                                           class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">End Date *</label>
                                    <input type="date" x-model="logsForm.date_to" required
                                           class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Action Filter</label>
                                <select x-model="logsForm.action_filter"
                                        class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="">All Actions</option>
                                    <option value="create">Create</option>
                                    <option value="update">Update</option>
                                    <option value="delete">Delete</option>
                                    <option value="login">Login</option>
                                    <option value="approve">Approve</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Max Records</label>
                                    <input type="number" x-model="logsForm.limit" placeholder="1000"
                                           class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Link to Finding</label>
                                    <select x-model="logsForm.finding_id"
                                            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                        <option value="">No Finding Selected</option>
                                        <template x-for="finding in findingsList" :key="finding.id">
                                            <option :value="finding.id" x-text="finding.finding_ref + ' - ' + (finding.title?.substring(0,25) || 'Untitled')"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" @click="showCollectModal = null"
                                    class="px-4 py-2 border border-gray-300 rounded-lg">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                                Extract Logs
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Database Snapshot Modal -->
        <div x-show="showCollectModal === 'snapshot'" 
             class="fixed inset-0 z-50 overflow-y-auto" @click.self="showCollectModal = null">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div class="fixed inset-0 bg-black opacity-50"></div>
                <div class="relative bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                    <h3 class="text-lg font-semibold mb-4">Create Database Snapshot</h3>
                    <form @submit.prevent="createDatabaseSnapshot()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Title *</label>
                                <input type="text" x-model="snapshotForm.title" required
                                       placeholder="e.g., Q4 2025 Chart of Accounts Snapshot"
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Table to Snapshot *</label>
                                <select x-model="snapshotForm.table_name" required
                                        class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                    <option value="">Select table...</option>
                                    <option value="chart_of_accounts">Chart of Accounts</option>
                                    <option value="general_ledger">General Ledger</option>
                                    <option value="journal_entries">Journal Entries</option>
                                    <option value="transactions">Transactions</option>
                                    <option value="invoices">Invoices</option>
                                    <option value="customers">Customers</option>
                                    <option value="vendors">Vendors</option>
                                    <option value="employees">Employees</option>
                                    <option value="payroll_runs">Payroll Runs</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Max Records</label>
                                <input type="number" x-model="snapshotForm.limit" placeholder="1000"
                                       class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Description</label>
                                    <textarea x-model="snapshotForm.description" rows="2"
                                              placeholder="Purpose of this snapshot"
                                              class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Link to Finding</label>
                                    <select x-model="snapshotForm.finding_id"
                                            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2">
                                        <option value="">No Finding Selected</option>
                                        <template x-for="finding in findingsList" :key="finding.id">
                                            <option :value="finding.id" x-text="finding.finding_ref + ' - ' + (finding.title?.substring(0,25) || 'Untitled')"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" @click="showCollectModal = null"
                                    class="px-4 py-2 border border-gray-300 rounded-lg">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700">
                                Create Snapshot
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Evidence Detail Modal -->
        <div x-show="selectedEvidence" 
             class="fixed inset-0 z-50 overflow-y-auto" @click.self="selectedEvidence = null">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div class="fixed inset-0 bg-black opacity-50"></div>
                <div class="relative bg-white rounded-lg shadow-xl max-w-3xl w-full p-6 max-h-[90vh] overflow-y-auto">
                    <template x-if="selectedEvidence">
                        <div>
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-lg font-semibold" x-text="selectedEvidence.title"></h3>
                                    <p class="text-sm text-indigo-600 font-mono" x-text="selectedEvidence.evidence_ref"></p>
                                </div>
                                <button @click="selectedEvidence = null" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Evidence Metadata -->
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm bg-gray-50 p-4 rounded-lg">
                                    <div>
                                        <span class="text-gray-500 block">Type</span>
                                        <span class="font-medium capitalize" x-text="selectedEvidence.evidence_type?.replace('_', ' ')"></span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500 block">Collected</span>
                                        <span x-text="formatDateTime(selectedEvidence.collected_at)"></span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500 block">Status</span>
                                        <span x-show="selectedEvidence.is_verified" class="text-green-600 font-medium">✓ Verified</span>
                                        <span x-show="!selectedEvidence.is_verified" class="text-yellow-600 font-medium">Pending</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500 block">Method</span>
                                        <span x-text="selectedEvidence.collection_method?.replace('_', ' ')"></span>
                                    </div>
                                </div>
                                
                                <!-- Description -->
                                <div x-show="selectedEvidence.description" class="bg-blue-50 p-4 rounded-lg">
                                    <span class="text-blue-700 text-sm font-medium block mb-1">Description</span>
                                    <p class="text-sm text-gray-700" x-text="selectedEvidence.description"></p>
                                </div>
                                
                                <!-- File Info (if has file) -->
                                <div x-show="selectedEvidence.file_path" class="bg-purple-50 p-4 rounded-lg">
                                    <span class="text-purple-700 text-sm font-medium block mb-2">Attached File</span>
                                    <div class="grid grid-cols-3 gap-2 text-sm">
                                        <div>
                                            <span class="text-gray-500">Type:</span>
                                            <span class="ml-1" x-text="selectedEvidence.file_mime_type || 'Unknown'"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Size:</span>
                                            <span class="ml-1" x-text="selectedEvidence.file_size_bytes ? (selectedEvidence.file_size_bytes / 1024).toFixed(1) + ' KB' : 'N/A'"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">File Hash:</span>
                                            <span class="ml-1 font-mono text-xs" x-text="selectedEvidence.file_hash?.substring(0,12) + '...' || 'N/A'"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- File Preview Section -->
                                    <div class="mt-3 border-t border-purple-200 pt-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-sm text-purple-600">Preview</span>
                                            <button @click="toggleFilePreview()" class="text-xs text-purple-700 hover:text-purple-900">
                                                <span x-show="!showFilePreview">Show Preview ▼</span>
                                                <span x-show="showFilePreview">Hide Preview ▲</span>
                                            </button>
                                        </div>
                                        <div x-show="showFilePreview" class="bg-white rounded border border-purple-200 p-2">
                                            <!-- Image Preview -->
                                            <template x-if="isImageFile(selectedEvidence.file_mime_type)">
                                                <img :src="`/api/evidence/${selectedEvidence.id}/preview?entity_id=${entityId}`" 
                                                     alt="Evidence Preview" 
                                                     class="max-w-full max-h-96 mx-auto rounded"
                                                     @error="$event.target.src='/static/images/preview-not-available.png'; $event.target.alt='Preview not available'">
                                            </template>
                                            
                                            <!-- PDF Preview (embed) -->
                                            <template x-if="selectedEvidence.file_mime_type === 'application/pdf'">
                                                <div class="w-full h-96">
                                                    <iframe :src="`/api/evidence/${selectedEvidence.id}/preview?entity_id=${entityId}`" 
                                                            class="w-full h-full rounded border"
                                                            frameborder="0">
                                                    </iframe>
                                                </div>
                                            </template>
                                            
                                            <!-- Text/JSON Preview -->
                                            <template x-if="isTextFile(selectedEvidence.file_mime_type)">
                                                <div x-data="{ previewContent: '' }" x-init="fetchTextPreview(selectedEvidence.id).then(t => previewContent = t)">
                                                    <pre class="text-xs whitespace-pre-wrap font-mono text-gray-700 max-h-64 overflow-auto bg-gray-50 p-2 rounded" x-text="previewContent"></pre>
                                                </div>
                                            </template>
                                            
                                            <!-- Unsupported format message -->
                                            <template x-if="!isImageFile(selectedEvidence.file_mime_type) && selectedEvidence.file_mime_type !== 'application/pdf' && !isTextFile(selectedEvidence.file_mime_type)">
                                                <div class="text-center py-8 text-gray-500">
                                                    <div class="text-4xl mb-2 text-gray-300">—</div>
                                                    <p>Preview not available for this file type</p>
                                                    <p class="text-xs text-gray-400" x-text="selectedEvidence.file_mime_type"></p>
                                                    <button @click="downloadEvidence(selectedEvidence.id)" class="mt-2 text-indigo-600 hover:text-indigo-800 text-sm">
                                                        Download to view
                                                    </button>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Content Hash (Immutability Proof) -->
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <span class="text-green-700 text-sm font-medium block mb-2">Immutability Verification (SHA-256)</span>
                                    <code class="text-xs font-mono break-all text-gray-600 bg-white px-2 py-1 rounded block" x-text="selectedEvidence.content_hash"></code>
                                </div>
                                
                                <!-- Evidence Content -->
                                <div x-show="selectedEvidence.content" class="bg-gray-50 p-4 rounded-lg">
                                    <span class="text-gray-700 text-sm font-medium block mb-2">Evidence Content</span>
                                    <div class="bg-white rounded border border-gray-200 p-3 max-h-64 overflow-auto">
                                        <pre class="text-xs whitespace-pre-wrap font-mono text-gray-700" x-text="JSON.stringify(selectedEvidence.content, null, 2)"></pre>
                                    </div>
                                </div>
                                
                                <!-- Audit Trail Info -->
                                <div x-show="selectedEvidence.collected_by || selectedEvidence.verified_by" class="grid grid-cols-2 gap-4 text-sm">
                                    <div x-show="selectedEvidence.collected_by" class="bg-gray-50 p-3 rounded">
                                        <span class="text-gray-500 block">Collected By</span>
                                        <span class="font-mono text-xs" x-text="selectedEvidence.collected_by"></span>
                                    </div>
                                    <div x-show="selectedEvidence.verified_by" class="bg-gray-50 p-3 rounded">
                                        <span class="text-gray-500 block">Verified By</span>
                                        <span class="font-mono text-xs" x-text="selectedEvidence.verified_by"></span>
                                        <span class="text-xs text-gray-400 block" x-text="formatDateTime(selectedEvidence.verified_at)"></span>
                                    </div>
                                </div>
                                
                                <!-- Chain of Custody Timeline -->
                                <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
                                    <div class="flex items-center justify-between mb-3">
                                        <span class="text-amber-700 text-sm font-medium">Chain of Custody</span>
                                        <button @click="loadCustodyHistory(selectedEvidence.id)" class="text-xs text-amber-600 hover:text-amber-800">
                                            Refresh
                                        </button>
                                    </div>
                                    <div class="space-y-3" x-data="{ custodyHistory: [] }" x-init="loadCustodyHistory(selectedEvidence.id).then(h => custodyHistory = h)">
                                        <template x-if="custodyHistory.length === 0">
                                            <div class="text-center py-3 text-gray-500 text-sm">
                                                <div>Loading custody history...</div>
                                            </div>
                                        </template>
                                        <template x-for="(event, idx) in custodyHistory" :key="idx">
                                            <div class="flex items-start">
                                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center"
                                                     :class="{
                                                         'bg-green-100 text-green-600': event.action === 'created' || event.action === 'collected',
                                                         'bg-blue-100 text-blue-600': event.action === 'verified',
                                                         'bg-yellow-100 text-yellow-600': event.action === 'accessed',
                                                         'bg-purple-100 text-purple-600': event.action === 'downloaded',
                                                         'bg-gray-100 text-gray-600': !['created', 'collected', 'verified', 'accessed', 'downloaded'].includes(event.action)
                                                     }">
                                                    <span x-text="event.action === 'created' || event.action === 'collected' ? '+' : event.action === 'verified' ? '✓' : event.action === 'downloaded' ? '↓' : '•'"></span>
                                                </div>
                                                <div class="ml-3 flex-1 border-l-2 border-amber-200 pl-3 pb-3" :class="{ 'border-transparent': idx === custodyHistory.length - 1 }">
                                                    <div class="text-sm font-medium text-gray-800 capitalize" x-text="event.action?.replace('_', ' ')"></div>
                                                    <div class="text-xs text-gray-600" x-text="event.user || 'System'"></div>
                                                    <div class="text-xs text-gray-400" x-text="formatDateTime(event.timestamp)"></div>
                                                    <div x-show="event.details" class="text-xs text-gray-500 mt-1" x-text="event.details"></div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                                <button @click="selectedEvidence = null"
                                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                    Close
                                </button>
                                <button @click="verifyEvidence(selectedEvidence.id)" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    Verify Integrity
                                </button>
                                <button x-show="selectedEvidence.has_file || selectedEvidence.file_path" @click="downloadEvidence(selectedEvidence.id)"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Download File
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         TAB: TAX EXPLAINABILITY
         ======================================== -->
    <div x-show="activeTab === 'explainability'" class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- PAYE Explainability -->
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                <h3 class="text-lg font-semibold mb-4">PAYE Tax Explainability</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Annual Gross Income (₦)</label>
                        <input type="number" x-model.number="payeInput.grossIncome"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Basic Salary (₦)</label>
                        <input type="number" x-model.number="payeInput.basicSalary"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                    <button @click="explainPAYE()" 
                            class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Generate Explanation
                    </button>
                </div>
            </div>

            <!-- VAT Explainability -->
            <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                <h3 class="text-lg font-semibold mb-4">VAT Explainability</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Output VAT Base (₦)</label>
                        <input type="number" x-model.number="vatInput.outputVatBase"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Input VAT Base (₦)</label>
                        <input type="number" x-model.number="vatInput.inputVatBase"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                    <button @click="explainVAT()" 
                            class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Generate Explanation
                    </button>
                </div>
            </div>
        </div>

        <!-- Explanation Result -->
        <div x-show="explainabilityResult" class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Tax Calculation Breakdown
            </h3>
            
            <!-- Tax Type Header -->
            <div class="mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-xs font-medium text-indigo-600 uppercase tracking-wider" 
                              x-text="explainabilityResult?.tax_type || 'Tax Calculation'"></span>
                        <h4 class="text-xl font-bold text-gray-900 mt-1" x-text="'₦' + formatNumber(explainabilityResult?.total_tax || explainabilityResult?.result?.net_vat_payable || 0)"></h4>
                        <p class="text-sm text-gray-600" x-text="explainabilityResult?.tax_period || 'Current Period'"></p>
                    </div>
                    <div class="text-right">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                              :class="explainabilityResult?.is_valid !== false ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                            <span x-text="explainabilityResult?.is_valid !== false ? '✓ Valid' : '✗ Invalid'"></span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Calculation Steps -->
            <div x-show="explainabilityResult?.steps?.length" class="mb-6">
                <h5 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Calculation Steps
                </h5>
                <div class="space-y-3">
                    <template x-for="(step, idx) in (explainabilityResult?.steps || [])" :key="idx">
                        <div class="flex items-start p-3 bg-gray-50 rounded-lg border-l-4 border-blue-400">
                            <span class="flex-shrink-0 w-6 h-6 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full text-sm font-bold mr-3" x-text="idx + 1"></span>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900" x-text="step.description || step.label || step"></p>
                                <p x-show="step.formula" class="text-sm text-gray-600 mt-1 font-mono bg-white px-2 py-1 rounded" x-text="step.formula"></p>
                                <p x-show="step.result !== undefined" class="text-sm font-semibold text-green-600 mt-1" x-text="'= ₦' + formatNumber(step.result)"></p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Input Values -->
            <div x-show="explainabilityResult?.inputs" class="mb-6">
                <h5 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                    </svg>
                    Input Values
                </h5>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <template x-for="(value, key) in (explainabilityResult?.inputs || {})" :key="key">
                        <div class="bg-amber-50 p-3 rounded-lg border border-amber-200">
                            <p class="text-xs text-amber-600 font-medium uppercase" x-text="key.replace(/_/g, ' ')"></p>
                            <p class="text-lg font-bold text-gray-900" x-text="typeof value === 'number' ? '₦' + formatNumber(value) : value"></p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Result Breakdown (for VAT) -->
            <div x-show="explainabilityResult?.result" class="mb-6">
                <h5 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    Result Summary
                </h5>
                <div class="overflow-hidden rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="(value, key) in (explainabilityResult?.result || {})" :key="key">
                                <tr>
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900 capitalize" x-text="key.replace(/_/g, ' ')"></td>
                                    <td class="px-4 py-3 text-sm text-right font-mono" x-text="typeof value === 'number' ? '₦' + formatNumber(value) : value"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Legal References -->
            <div x-show="explainabilityResult?.legal_references?.length || explainabilityResult?.regulatory_basis" class="mb-6">
                <h5 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                    Legal References
                </h5>
                <div class="space-y-2">
                    <template x-if="explainabilityResult?.regulatory_basis">
                        <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <p class="text-sm text-purple-800" x-text="explainabilityResult.regulatory_basis"></p>
                        </div>
                    </template>
                    <template x-for="ref in (explainabilityResult?.legal_references || [])" :key="ref.citation || ref">
                        <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <p class="text-sm font-medium text-purple-900" x-text="ref.citation || ref"></p>
                            <p x-show="ref.description" class="text-sm text-purple-700 mt-1" x-text="ref.description"></p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Warnings/Notes -->
            <div x-show="explainabilityResult?.warnings?.length" class="mb-4">
                <h5 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    Important Notes
                </h5>
                <div class="space-y-2">
                    <template x-for="warning in (explainabilityResult?.warnings || [])" :key="warning">
                        <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200 text-sm text-yellow-800" x-text="warning"></div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         TAB: AUDIT VAULT
         ======================================== -->
    <div x-show="activeTab === 'vault'" class="space-y-6">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white rounded-lg shadow p-6 text-center cursor-pointer hover:shadow-lg transition-shadow" @click="vaultFilter.retention_status = ''; loadVaultRecords()">
                <p class="text-3xl font-bold text-indigo-600" x-text="vaultStats.total_records || 0"></p>
                <p class="text-sm text-gray-600">Total Records</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6 text-center cursor-pointer hover:shadow-lg transition-shadow" @click="vaultFilter.retention_status = 'active'; loadVaultRecords()">
                <p class="text-3xl font-bold text-green-600" x-text="vaultStats.active_records || 0"></p>
                <p class="text-sm text-gray-600">Active</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6 text-center cursor-pointer hover:shadow-lg transition-shadow" @click="vaultFilter.retention_status = 'archived'; loadVaultRecords()">
                <p class="text-3xl font-bold text-gray-600" x-text="vaultStats.archived_records || 0"></p>
                <p class="text-sm text-gray-600">Archived</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6 text-center cursor-pointer hover:shadow-lg transition-shadow" @click="vaultFilter.retention_status = 'legal_hold'; loadVaultRecords()">
                <p class="text-3xl font-bold text-amber-600" x-text="vaultStats.legal_hold || 0"></p>
                <p class="text-sm text-gray-600">Legal Hold</p>
            </div>
        </div>

        <!-- Retention Timeline -->
        <div class="bg-white rounded-lg shadow p-6" x-show="vaultTimeline.length > 0">
            <h3 class="text-lg font-semibold mb-4">Retention Timeline</h3>
            <div class="flex items-end justify-between h-32 px-4">
                <template x-for="(item, index) in vaultTimeline" :key="index">
                    <div class="flex flex-col items-center flex-1">
                        <div class="w-full max-w-16 bg-indigo-100 rounded-t transition-all duration-300"
                             :style="'height: ' + (item.record_count > 0 ? Math.max(20, (item.record_count / Math.max(...vaultTimeline.map(t => t.record_count || 1))) * 100) : 5) + '%'"
                             :class="{'bg-red-200': item.status === 'current', 'bg-indigo-200': item.status === 'future'}">
                        </div>
                        <p class="text-xs text-gray-600 mt-2" x-text="item.expiry_year"></p>
                        <p class="text-xs font-semibold" x-text="item.record_count"></p>
                    </div>
                </template>
            </div>
            <p class="text-xs text-gray-500 mt-2 text-center">Records expiring by year (5-year retention)</p>
        </div>

        <!-- Actions Bar -->
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-3">
                    <button @click="verifyVaultIntegrity()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Verify Integrity
                    </button>
                    <button @click="verifyFiscalYear()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Verify Year
                    </button>
                    <button @click="showComplianceReport()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Compliance Report
                    </button>
                    <button @click="exportVaultRecords()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export for FIRS
                    </button>
                </div>
                <p class="text-sm text-gray-500">NTAA 2025: 5-Year Retention Compliance</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-4">
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fiscal Year</label>
                    <select x-model="vaultFilter.fiscal_year" @change="loadVaultRecords()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Years</option>
                        <template x-for="fy in vaultFiscalYears" :key="fy.year">
                            <option :value="fy.year" x-text="fy.year + ' (' + fy.record_count + ')'"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Document Type</label>
                    <select x-model="vaultFilter.document_type" @change="loadVaultRecords()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Types</option>
                        <option value="invoice">Invoice</option>
                        <option value="receipt">Receipt</option>
                        <option value="transaction">Transaction</option>
                        <option value="tax_filing">Tax Filing</option>
                        <option value="nrs_submission">NRS Submission</option>
                        <option value="credit_note">Credit Note</option>
                        <option value="fixed_asset">Fixed Asset</option>
                        <option value="payroll">Payroll</option>
                        <option value="bank_statement">Bank Statement</option>
                        <option value="supporting_doc">Supporting Doc</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select x-model="vaultFilter.retention_status" @change="loadVaultRecords()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="archived">Archived</option>
                        <option value="pending_purge">Pending Purge</option>
                        <option value="legal_hold">Legal Hold</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                    <input type="date" x-model="vaultFilter.start_date" @change="loadVaultRecords()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                    <input type="date" x-model="vaultFilter.end_date" @change="loadVaultRecords()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <input type="text" x-model="vaultFilter.search" @input.debounce.500ms="loadVaultRecords()" placeholder="Search records..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                </div>
            </div>
        </div>

        <!-- Vault Records Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Vault Records</h3>
                <span class="text-sm text-gray-500" x-text="'Showing ' + vaultRecords.length + ' of ' + vaultTotal + ' records'"></span>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Retention Until</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NRS</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="record in vaultRecords" :key="record.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-900 font-mono" x-text="record.id.substring(0, 8) + '...'"></td>
                                <td class="px-4 py-3 text-sm">
                                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800" x-text="record.document_type"></span>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-900" x-text="record.action"></td>
                                <td class="px-4 py-3 text-sm text-gray-500" x-text="formatDate(record.created_at)"></td>
                                <td class="px-4 py-3 text-sm">
                                    <span class="px-2 py-1 text-xs rounded-full"
                                          :class="{
                                              'bg-green-100 text-green-800': record.status === 'active',
                                              'bg-gray-100 text-gray-800': record.status === 'archived',
                                              'bg-red-100 text-red-800': record.status === 'pending_purge',
                                              'bg-amber-100 text-amber-800': record.status === 'legal_hold'
                                          }"
                                          x-text="record.status"></span>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-500" x-text="record.retention_until"></td>
                                <td class="px-4 py-3 text-sm">
                                    <span x-show="record.has_nrs_data" class="text-green-600" title="NRS Submitted">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                    </span>
                                    <span x-show="!record.has_nrs_data" class="text-gray-300">-</span>
                                </td>
                                <td class="px-4 py-3 text-sm">
                                    <div class="flex items-center space-x-2">
                                        <button @click="viewVaultRecord(record.id)" class="text-indigo-600 hover:text-indigo-800" title="View Details">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </button>
                                        <button @click="verifyVaultRecord(record.id)" class="text-green-600 hover:text-green-800" title="Verify Integrity">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                            </svg>
                                        </button>
                                        <button x-show="record.status !== 'legal_hold'" @click="setLegalHold(record.id, true)" class="text-amber-600 hover:text-amber-800" title="Set Legal Hold">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                            </svg>
                                        </button>
                                        <button x-show="record.status === 'legal_hold'" @click="setLegalHold(record.id, false)" class="text-red-600 hover:text-red-800" title="Remove Legal Hold">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            
            <!-- Empty State -->
            <div x-show="vaultRecords.length === 0 && !loading" class="p-8 text-center text-gray-500">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                </svg>
                <p class="mt-2">No vault records found</p>
                <p class="text-sm">Records are automatically added when audit events occur</p>
            </div>
            
            <!-- Pagination -->
            <div x-show="vaultRecords.length > 0" class="p-4 border-t border-gray-200 flex items-center justify-between">
                <p class="text-sm text-gray-600">
                    Page <span x-text="vaultPage"></span> of <span x-text="Math.ceil(vaultTotal / vaultLimit) || 1"></span>
                </p>
                <div class="flex space-x-2">
                    <button @click="vaultPage--; loadVaultRecords()" :disabled="vaultPage <= 1"
                            class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Previous
                    </button>
                    <button @click="vaultPage++; loadVaultRecords()" :disabled="vaultPage * vaultLimit >= vaultTotal"
                            class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Vault Record Detail Modal -->
    <div x-show="showVaultDetailModal" x-transition class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-xl font-bold text-gray-900">Vault Record Details</h3>
                <button @click="showVaultDetailModal = false" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6 space-y-6" x-show="selectedVaultRecord">
                <!-- Integrity Badge -->
                <div class="flex items-center justify-between p-4 rounded-lg"
                     :class="selectedVaultRecord?.integrity_verified ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                    <div class="flex items-center">
                        <svg x-show="selectedVaultRecord?.integrity_verified" class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <div>
                            <p class="font-semibold" :class="selectedVaultRecord?.integrity_verified ? 'text-green-800' : 'text-red-800'"
                               x-text="selectedVaultRecord?.integrity_verified ? 'Integrity Verified' : 'Integrity Check Failed'"></p>
                            <p class="text-xs text-gray-600 font-mono" x-text="'Hash: ' + (selectedVaultRecord?.integrity_hash || 'N/A').substring(0, 32) + '...'"></p>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-medium"
                          :class="{
                              'bg-green-100 text-green-800': selectedVaultRecord?.status === 'active',
                              'bg-gray-100 text-gray-800': selectedVaultRecord?.status === 'archived',
                              'bg-red-100 text-red-800': selectedVaultRecord?.status === 'pending_purge',
                              'bg-amber-100 text-amber-800': selectedVaultRecord?.status === 'legal_hold'
                          }"
                          x-text="selectedVaultRecord?.status"></span>
                </div>
                
                <!-- Basic Info -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase">Record ID</label>
                        <p class="text-sm font-mono" x-text="selectedVaultRecord?.id"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase">Document Type</label>
                        <p class="text-sm" x-text="selectedVaultRecord?.document_type"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase">Action</label>
                        <p class="text-sm" x-text="selectedVaultRecord?.action"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase">Reference ID</label>
                        <p class="text-sm font-mono" x-text="selectedVaultRecord?.reference_id || 'N/A'"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase">Created At</label>
                        <p class="text-sm" x-text="formatDateTime(selectedVaultRecord?.created_at)"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase">Fiscal Year</label>
                        <p class="text-sm" x-text="selectedVaultRecord?.fiscal_year"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase">Retention Until</label>
                        <p class="text-sm" x-text="selectedVaultRecord?.retention_until"></p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase">Days Until Expiry</label>
                        <p class="text-sm" x-text="selectedVaultRecord?.days_until_expiry + ' days'"></p>
                    </div>
                </div>
                
                <!-- User & Device Info -->
                <div class="border-t pt-4">
                    <h4 class="font-semibold text-gray-900 mb-3">Audit Trail</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 uppercase">User ID</label>
                            <p class="font-mono" x-text="selectedVaultRecord?.user_id || 'System'"></p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 uppercase">IP Address</label>
                            <p class="font-mono" x-text="selectedVaultRecord?.ip_address || 'N/A'"></p>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-medium text-gray-500 uppercase">User Agent</label>
                            <p class="text-xs text-gray-600 truncate" x-text="selectedVaultRecord?.user_agent || 'N/A'"></p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 uppercase">Device Fingerprint</label>
                            <p class="font-mono text-xs" x-text="selectedVaultRecord?.device_fingerprint || 'N/A'"></p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 uppercase">Session ID</label>
                            <p class="font-mono text-xs" x-text="selectedVaultRecord?.session_id || 'N/A'"></p>
                        </div>
                    </div>
                </div>
                
                <!-- NRS Data -->
                <div x-show="selectedVaultRecord?.nrs_irn" class="border-t pt-4">
                    <h4 class="font-semibold text-gray-900 mb-3">NRS Submission</h4>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm"><strong>IRN:</strong> <span x-text="selectedVaultRecord?.nrs_irn" class="font-mono"></span></p>
                        <div x-show="selectedVaultRecord?.nrs_response" class="mt-2">
                            <p class="text-xs font-medium text-gray-500 uppercase mb-1">Response</p>
                            <pre class="text-xs bg-white p-2 rounded overflow-x-auto" x-text="JSON.stringify(selectedVaultRecord?.nrs_response, null, 2)"></pre>
                        </div>
                    </div>
                </div>
                
                <!-- Changes -->
                <div x-show="selectedVaultRecord?.changes || selectedVaultRecord?.old_values || selectedVaultRecord?.new_values" class="border-t pt-4">
                    <h4 class="font-semibold text-gray-900 mb-3">Data Changes</h4>
                    <div class="space-y-3">
                        <div x-show="selectedVaultRecord?.old_values">
                            <p class="text-xs font-medium text-gray-500 uppercase mb-1">Old Values</p>
                            <pre class="text-xs bg-red-50 p-3 rounded overflow-x-auto" x-text="JSON.stringify(selectedVaultRecord?.old_values, null, 2)"></pre>
                        </div>
                        <div x-show="selectedVaultRecord?.new_values">
                            <p class="text-xs font-medium text-gray-500 uppercase mb-1">New Values</p>
                            <pre class="text-xs bg-green-50 p-3 rounded overflow-x-auto" x-text="JSON.stringify(selectedVaultRecord?.new_values, null, 2)"></pre>
                        </div>
                        <div x-show="selectedVaultRecord?.changes">
                            <p class="text-xs font-medium text-gray-500 uppercase mb-1">Changes Summary</p>
                            <pre class="text-xs bg-gray-50 p-3 rounded overflow-x-auto" x-text="JSON.stringify(selectedVaultRecord?.changes, null, 2)"></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button @click="verifyVaultRecord(selectedVaultRecord?.id)" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Verify Integrity
                </button>
                <button @click="showVaultDetailModal = false" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Compliance Report Modal -->
    <div x-show="showComplianceModal" x-transition class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-xl font-bold text-gray-900">Compliance Report - FY <span x-text="complianceReport?.fiscal_year"></span></h3>
                <button @click="showComplianceModal = false" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6 space-y-6" x-show="complianceReport">
                <!-- Compliance Status -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="p-4 rounded-lg text-center"
                         :class="complianceReport?.compliance_status?.records_retained ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                        <svg class="w-8 h-8 mx-auto mb-2" :class="complianceReport?.compliance_status?.records_retained ? 'text-green-600' : 'text-red-600'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                        </svg>
                        <p class="font-semibold" :class="complianceReport?.compliance_status?.records_retained ? 'text-green-800' : 'text-red-800'">Records Retained</p>
                        <p class="text-sm text-gray-600" x-text="complianceReport?.compliance_status?.records_retained ? 'Compliant' : 'Non-Compliant'"></p>
                    </div>
                    <div class="p-4 rounded-lg text-center"
                         :class="complianceReport?.compliance_status?.integrity_verified ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                        <svg class="w-8 h-8 mx-auto mb-2" :class="complianceReport?.compliance_status?.integrity_verified ? 'text-green-600' : 'text-red-600'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <p class="font-semibold" :class="complianceReport?.compliance_status?.integrity_verified ? 'text-green-800' : 'text-red-800'">Integrity Verified</p>
                        <p class="text-sm text-gray-600" x-text="complianceReport?.compliance_status?.integrity_verified ? 'Compliant' : 'Non-Compliant'"></p>
                    </div>
                    <div class="p-4 rounded-lg text-center"
                         :class="complianceReport?.compliance_status?.nrs_integration_active ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'">
                        <svg class="w-8 h-8 mx-auto mb-2" :class="complianceReport?.compliance_status?.nrs_integration_active ? 'text-green-600' : 'text-yellow-600'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                        <p class="font-semibold" :class="complianceReport?.compliance_status?.nrs_integration_active ? 'text-green-800' : 'text-yellow-800'">NRS Integration</p>
                        <p class="text-sm text-gray-600" x-text="complianceReport?.compliance_status?.nrs_integration_active ? 'Active' : 'No Submissions'"></p>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="grid grid-cols-4 gap-4">
                    <div class="bg-indigo-50 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-indigo-600" x-text="complianceReport?.summary?.total_records || 0"></p>
                        <p class="text-sm text-gray-600">Total Records</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-green-600" x-text="complianceReport?.summary?.nrs_submissions || 0"></p>
                        <p class="text-sm text-gray-600">NRS Submissions</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold text-blue-600" x-text="complianceReport?.summary?.unique_users || 0"></p>
                        <p class="text-sm text-gray-600">Unique Users</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg text-center">
                        <p class="text-lg font-bold text-purple-600" x-text="complianceReport?.retention_policy || '5 years'"></p>
                        <p class="text-sm text-gray-600">Retention Policy</p>
                    </div>
                </div>
                
                <!-- Date Range -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-900 mb-2">Activity Period</h4>
                    <p class="text-sm text-gray-600">
                        <span class="font-medium">First Record:</span> <span x-text="formatDateTime(complianceReport?.summary?.date_range?.first) || 'N/A'"></span>
                        <span class="mx-2">|</span>
                        <span class="font-medium">Last Record:</span> <span x-text="formatDateTime(complianceReport?.summary?.date_range?.last) || 'N/A'"></span>
                    </p>
                </div>
                
                <!-- Activity by Action -->
                <div x-show="Object.keys(complianceReport?.by_action || {}).length > 0">
                    <h4 class="font-semibold text-gray-900 mb-3">Activity by Action Type</h4>
                    <div class="grid grid-cols-4 gap-2">
                        <template x-for="(count, action) in (complianceReport?.by_action || {})" :key="action">
                            <div class="bg-gray-100 p-3 rounded text-center">
                                <p class="font-bold text-gray-700" x-text="count"></p>
                                <p class="text-xs text-gray-500" x-text="action"></p>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Activity by Month -->
                <div x-show="Object.keys(complianceReport?.by_month || {}).length > 0">
                    <h4 class="font-semibold text-gray-900 mb-3">Monthly Activity</h4>
                    <div class="flex items-end justify-between h-32 px-4 bg-gray-50 rounded-lg">
                        <template x-for="month in [1,2,3,4,5,6,7,8,9,10,11,12]" :key="month">
                            <div class="flex flex-col items-center flex-1">
                                <div class="w-full max-w-8 bg-indigo-400 rounded-t transition-all duration-300"
                                     :style="'height: ' + ((complianceReport?.by_month?.[month] || 0) / Math.max(...Object.values(complianceReport?.by_month || {1: 1})) * 100) + '%'">
                                </div>
                                <p class="text-xs text-gray-500 mt-1" x-text="['J','F','M','A','M','J','J','A','S','O','N','D'][month-1]"></p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200 flex justify-between">
                <div>
                    <p class="text-xs text-gray-500">Generated: <span x-text="formatDateTime(complianceReport?.generated_at)"></span></p>
                    <p class="text-xs text-gray-500">Standard: <span x-text="complianceReport?.compliance_standard"></span></p>
                </div>
                <div class="flex space-x-3">
                    <button @click="exportComplianceReport()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        Export Report
                    </button>
                    <button @click="showComplianceModal = false" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         TAB: PAYROLL DECISIONS
         ======================================== -->
    <div x-show="activeTab === 'payroll-decisions'" class="space-y-6">
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
                <p class="text-xs font-medium text-gray-600">Total Decisions</p>
                <p class="text-2xl font-bold text-gray-900" x-text="payrollDecisionSummary?.total_logs || 0"></p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
                <p class="text-xs font-medium text-gray-600">Approvals</p>
                <p class="text-2xl font-bold text-blue-600" x-text="payrollDecisionSummary?.by_type?.approval || 0"></p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-amber-500">
                <p class="text-xs font-medium text-gray-600">Adjustments</p>
                <p class="text-2xl font-bold text-amber-600" x-text="payrollDecisionSummary?.by_type?.adjustment || 0"></p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
                <p class="text-xs font-medium text-gray-600">Locked (Immutable)</p>
                <p class="text-2xl font-bold text-purple-600" x-text="payrollDecisionSummary?.locked_count || 0"></p>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Payroll Run</label>
                    <select x-model="payrollDecisionFilter.payroll_run_id" @change="loadPayrollDecisions()" 
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Runs</option>
                        <template x-for="run in payrollRuns" :key="run.id">
                            <option :value="run.id" x-text="run.name + ' (' + run.period_start + ')'"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Decision Type</label>
                    <select x-model="payrollDecisionFilter.decision_type" @change="loadPayrollDecisions()" 
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Types</option>
                        <option value="approval">Approval</option>
                        <option value="adjustment">Adjustment</option>
                        <option value="override">Override</option>
                        <option value="exception">Exception</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select x-model="payrollDecisionFilter.category" @change="loadPayrollDecisions()" 
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Categories</option>
                        <option value="salary">Salary</option>
                        <option value="allowance">Allowance</option>
                        <option value="deduction">Deduction</option>
                        <option value="bonus">Bonus</option>
                        <option value="tax">Tax</option>
                        <option value="pension">Pension</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button @click="exportPayrollDecisions()" 
                            class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">
                        Export to CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Decision Logs List -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold">Payroll Decision Audit Trail</h3>
                <p class="text-sm text-gray-500">Immutable record of all payroll decisions, approvals, and adjustments</p>
            </div>
            
            <div x-show="payrollDecisionLogs.length > 0" class="divide-y divide-gray-200">
                <template x-for="log in payrollDecisionLogs" :key="log.id">
                    <div class="p-4 hover:bg-gray-50">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                          :class="{
                                              'bg-green-100 text-green-800': log.decision_type === 'approval',
                                              'bg-amber-100 text-amber-800': log.decision_type === 'adjustment',
                                              'bg-red-100 text-red-800': log.decision_type === 'override',
                                              'bg-purple-100 text-purple-800': log.decision_type === 'exception'
                                          }"
                                          x-text="log.decision_type"></span>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800"
                                          x-text="log.category"></span>
                                    <span x-show="log.is_locked" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                        Locked
                                    </span>
                                </div>
                                <p class="mt-2 text-sm text-gray-900 font-medium" x-text="log.description"></p>
                                <div class="mt-1 text-xs text-gray-500 space-x-4">
                                    <span>Employee: <span x-text="log.employee_name || 'N/A'" class="font-medium"></span></span>
                                    <span x-show="log.original_value !== undefined">Original: <span class="font-medium" x-text="formatCurrency(log.original_value)"></span></span>
                                    <span x-show="log.new_value !== undefined">New: <span class="font-medium" x-text="formatCurrency(log.new_value)"></span></span>
                                </div>
                            </div>
                            <div class="text-right text-sm text-gray-500">
                                <p x-text="formatDateTime(log.created_at)"></p>
                                <p class="text-xs" x-text="'by ' + (log.created_by_name || 'System')"></p>
                            </div>
                        </div>
                        <!-- Justification -->
                        <div x-show="log.justification" class="mt-3 p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs font-medium text-gray-600 mb-1">Justification</p>
                            <p class="text-sm text-gray-700" x-text="log.justification"></p>
                        </div>
                        <!-- Impact Preview -->
                        <div x-show="log.impact_preview" class="mt-2">
                            <button @click="log.showImpact = !log.showImpact" class="text-xs text-indigo-600 hover:text-indigo-800">
                                <span x-text="log.showImpact ? 'Hide Impact' : 'Show Impact'"></span>
                            </button>
                            <div x-show="log.showImpact" class="mt-2 p-3 bg-indigo-50 rounded-lg text-xs">
                                <pre x-text="JSON.stringify(log.impact_preview, null, 2)" class="whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <div x-show="payrollDecisionLogs.length === 0" class="p-8 text-center text-gray-500">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="mt-2">No payroll decisions found</p>
            </div>
            
            <!-- Pagination -->
            <div x-show="payrollDecisionLogs.length > 0" class="p-4 border-t border-gray-200 flex items-center justify-between">
                <p class="text-sm text-gray-600">
                    Showing <span x-text="((payrollDecisionPage - 1) * 20) + 1"></span> to 
                    <span x-text="Math.min(payrollDecisionPage * 20, payrollDecisionTotal)"></span> of 
                    <span x-text="payrollDecisionTotal"></span> decisions
                </p>
                <div class="flex space-x-2">
                    <button @click="payrollDecisionPage--; loadPayrollDecisions()" 
                            :disabled="payrollDecisionPage <= 1"
                            class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50">
                        Previous
                    </button>
                    <button @click="payrollDecisionPage++; loadPayrollDecisions()" 
                            :disabled="payrollDecisionPage * 20 >= payrollDecisionTotal"
                            class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Integrity Modal -->
    <div x-show="showIntegrityModal" x-transition class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
        <div class="relative w-full max-w-lg mx-auto bg-white rounded-xl shadow-lg p-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900">Data Integrity Result</h3>
                <button @click="showIntegrityModal = false" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Status Banner -->
            <div :class="{
                    'bg-green-50 border-green-200': integrity.verified && integrity.badge !== 'yellow',
                    'bg-yellow-50 border-yellow-200': integrity.badge === 'yellow',
                    'bg-red-50 border-red-200': !integrity.verified && integrity.badge !== 'yellow'
                 }" 
                 class="p-4 rounded-lg border mb-4">
                <div class="flex items-center">
                    <template x-if="integrity.verified && integrity.badge !== 'yellow'">
                        <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </template>
                    <template x-if="integrity.badge === 'yellow'">
                        <svg class="w-6 h-6 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </template>
                    <template x-if="!integrity.verified && integrity.badge !== 'yellow'">
                        <svg class="w-6 h-6 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </template>
                    <div>
                        <p :class="{
                               'text-green-800': integrity.verified && integrity.badge !== 'yellow',
                               'text-yellow-800': integrity.badge === 'yellow',
                               'text-red-800': !integrity.verified && integrity.badge !== 'yellow'
                           }" 
                           class="font-semibold" x-text="integrity.message"></p>
                    </div>
                </div>
            </div>
            
            <div class="max-h-[40vh] overflow-y-auto">
                <ul class="space-y-2 text-sm">
                    <li><strong>Status:</strong> <span :class="{
                           'text-green-600': integrity.verified,
                           'text-yellow-600': integrity.badge === 'yellow',
                           'text-red-600': !integrity.verified && integrity.badge !== 'yellow'
                        }" class="font-medium" x-text="integrity.status"></span></li>
                    <li><strong>Verified:</strong> <span x-text="integrity.verified ? 'Yes' : 'No'"></span></li>
                    <li><strong>Last Check:</strong> <span x-text="integrity.lastCheck"></span></li>
                    <li><strong>Records Verified:</strong> <span x-text="integrity.recordCount || 'N/A'"></span></li>
                    <li x-show="integrity.dataSource"><strong>Data Source:</strong> <span x-text="integrity.dataSource === 'journal_entries' ? 'Journal Entries' : 'Immutable Ledger'"></span></li>
                    <li x-show="integrity.totalDebit"><strong>Total Debits:</strong> <span x-text="'₦' + Number(integrity.totalDebit || 0).toLocaleString()"></span></li>
                    <li x-show="integrity.totalCredit"><strong>Total Credits:</strong> <span x-text="'₦' + Number(integrity.totalCredit || 0).toLocaleString()"></span></li>
                </ul>
                
                <!-- Issues Details (shown when issues found) -->
                <template x-if="!integrity.verified && integrity.issues && integrity.issues.length > 0">
                    <div class="mt-4">
                        <h4 class="font-semibold text-red-800 mb-2">Issues Found (<span x-text="integrity.issues.length"></span>):</h4>
                        <div class="space-y-2">
                            <template x-for="(issue, index) in integrity.issues" :key="index">
                                <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-sm">
                                    <p class="font-medium text-red-800" x-text="issue.message || issue.type"></p>
                                    <template x-if="issue.sequence_number">
                                        <p class="text-red-600 text-xs mt-1">Sequence #<span x-text="issue.sequence_number"></span></p>
                                    </template>
                                    <template x-if="issue.details">
                                        <p class="text-red-600 text-xs mt-1" x-text="issue.details"></p>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
                
                <!-- Note about data source -->
                <template x-if="integrity.note">
                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-blue-800 text-sm"><span x-text="integrity.note"></span></p>
                    </div>
                </template>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button x-show="integrity.dataSource === 'journal_entries'" 
                        @click="syncLedger()" 
                        :disabled="loading"
                        class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                    Sync to Immutable Ledger
                </button>
                <button @click="showIntegrityModal = false" class="bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

<!-- ========================================
     MODAL: NEW AUDIT RUN
     ======================================== -->
<div x-show="showNewRunModal" x-transition 
     @keydown.escape.window="closeNewRunModal()"
     class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50"
     style="display: none;">
    <!-- Click outside to close -->
    <div class="absolute inset-0" @click="closeNewRunModal()"></div>
    
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto relative z-10" @click.stop>
        <div class="p-6 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
            <h3 class="text-xl font-bold text-gray-900 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                </svg>
                Create New Audit Run
            </h3>
            <button @click="closeNewRunModal()" class="text-gray-500 hover:text-gray-700 p-2 hover:bg-gray-100 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="p-6 space-y-6">
            <!-- Info Banner -->
            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div class="flex">
                    <svg class="w-5 h-5 text-blue-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-sm text-blue-700">
                        Audit runs are fully reproducible. All parameters and data snapshots are captured for future reference and comparison.
                    </p>
                </div>
            </div>
            
            <!-- Audit Type -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Audit Type <span class="text-red-500">*</span></label>
                <select x-model="newRunForm.run_type" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Select audit type...</option>
                    <option value="tax_compliance">Tax Compliance Audit</option>
                    <option value="financial_statement">Financial Statement Audit</option>
                    <option value="vat_audit">VAT Audit</option>
                    <option value="wht_audit">WHT Audit</option>
                    <option value="custom">Custom Audit</option>
                </select>
            </div>
            
            <!-- Title -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Audit Title <span class="text-red-500">*</span></label>
                <input type="text" x-model="newRunForm.title" 
                       placeholder="e.g., Q1 2026 Tax Compliance Review"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            
            <!-- Description -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea x-model="newRunForm.description" 
                          rows="3"
                          placeholder="Describe the scope and objectives of this audit..."
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            
            <!-- Date Range -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Period Start <span class="text-red-500">*</span></label>
                    <input type="date" x-model="newRunForm.date_range_start" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Period End <span class="text-red-500">*</span></label>
                    <input type="date" x-model="newRunForm.date_range_end" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            
            <!-- Quick Date Range Buttons -->
            <div class="flex flex-wrap gap-2">
                <button type="button" @click="setDateRange('Q1')" 
                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">Q1 2026</button>
                <button type="button" @click="setDateRange('Q2')" 
                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">Q2 2026</button>
                <button type="button" @click="setDateRange('Q3')" 
                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">Q3 2026</button>
                <button type="button" @click="setDateRange('Q4')" 
                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">Q4 2026</button>
                <button type="button" @click="setDateRange('YTD')" 
                        class="px-3 py-1 text-sm bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded-lg">Year-to-Date</button>
                <button type="button" @click="setDateRange('FY2025')" 
                        class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">FY 2025</button>
            </div>
            
            <!-- Advanced Options Accordion -->
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <button @click="showAdvancedOptions = !showAdvancedOptions" 
                        class="w-full px-4 py-3 bg-gray-50 flex justify-between items-center hover:bg-gray-100">
                    <span class="font-medium text-gray-700">Advanced Options</span>
                    <svg class="w-5 h-5 transform transition-transform" :class="showAdvancedOptions ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div x-show="showAdvancedOptions" x-transition class="p-4 space-y-4 bg-white">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Materiality Threshold (₦)</label>
                        <input type="number" x-model="newRunForm.parameters.materiality_threshold" 
                               placeholder="50000"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Risk Focus</label>
                        <select x-model="newRunForm.parameters.risk_focus" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">All risk levels</option>
                            <option value="critical">Critical only</option>
                            <option value="high">High and above</option>
                            <option value="medium">Medium and above</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" x-model="newRunForm.parameters.include_recommendations" 
                                   class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 text-sm text-gray-700">Include recommendations</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" x-model="newRunForm.parameters.include_evidence" 
                                   class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 text-sm text-gray-700">Collect evidence</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Validation Errors -->
            <div x-show="newRunErrors.length > 0" class="p-4 bg-red-50 rounded-lg border border-red-200">
                <h4 class="text-red-800 font-medium mb-2">Please fix the following errors:</h4>
                <ul class="list-disc list-inside text-sm text-red-700 space-y-1">
                    <template x-for="error in newRunErrors" :key="error">
                        <li x-text="error"></li>
                    </template>
                </ul>
            </div>
        </div>
        
        <div class="p-6 border-t border-gray-200 bg-gray-50 flex justify-end gap-3 sticky bottom-0">
            <button @click="closeNewRunModal()" 
                    class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">
                Cancel
            </button>
            <button @click="createAuditRun()" 
                    :disabled="creatingRun"
                    class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 flex items-center font-medium">
                <svg x-show="creatingRun" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span x-text="creatingRun ? 'Creating...' : 'Create Audit Run'"></span>
            </button>
        </div>
    </div>
</div>
<!-- End of New Audit Run Modal -->

<!-- ========================================
     MODAL: AUDIT RUN DETAILS
     ======================================== -->
<div x-show="showRunDetailsModal" x-transition 
     @keydown.escape.window="closeRunDetailsModal()"
     class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50"
     style="display: none;">
    <div class="absolute inset-0" @click="closeRunDetailsModal()"></div>
    
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto relative z-10" @click.stop>
        <!-- Header -->
        <div class="p-6 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
            <h3 class="text-xl font-bold text-gray-900 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                Audit Run Details
            </h3>
            <button @click="closeRunDetailsModal()" class="text-gray-500 hover:text-gray-700 p-2 hover:bg-gray-100 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <template x-if="selectedRun">
            <div class="p-6 space-y-6">
                <!-- Run Title and Status -->
                <div class="flex items-start justify-between">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900" x-text="selectedRun.title || 'Untitled Audit Run'"></h4>
                        <p class="text-sm text-gray-500 font-mono mt-1" x-text="selectedRun.run_id || selectedRun.id"></p>
                    </div>
                    <span class="px-3 py-1 text-sm font-medium rounded-full capitalize"
                          :class="getStatusClass(selectedRun.status)"
                          x-text="selectedRun.status || 'unknown'"></span>
                </div>
                
                <!-- Info Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Audit Type</p>
                        <p class="text-sm font-semibold text-gray-900 mt-1" x-text="formatRunType(selectedRun.run_type)"></p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Rule Version</p>
                        <p class="text-sm font-semibold text-gray-900 mt-1" x-text="selectedRun.rule_version || 'N/A'"></p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Period Start</p>
                        <p class="text-sm font-semibold text-gray-900 mt-1" x-text="selectedRun.period_start || 'N/A'"></p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Period End</p>
                        <p class="text-sm font-semibold text-gray-900 mt-1" x-text="selectedRun.period_end || 'N/A'"></p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Created</p>
                        <p class="text-sm font-semibold text-gray-900 mt-1" x-text="selectedRun.created_at ? new Date(selectedRun.created_at).toLocaleString() : 'N/A'"></p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</p>
                        <p class="text-sm font-semibold text-gray-900 mt-1" x-text="selectedRun.completed_at ? new Date(selectedRun.completed_at).toLocaleString() : 'Not yet'"></p>
                    </div>
                </div>
                
                <!-- Findings Summary -->
                <div class="border rounded-lg overflow-hidden">
                    <div class="px-4 py-3 bg-gray-50 border-b">
                        <h5 class="font-semibold text-gray-900">Findings Summary</h5>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-5 gap-3 text-center">
                            <div class="bg-red-50 rounded-lg p-3 border border-red-200">
                                <p class="text-2xl font-bold text-red-600" x-text="selectedRun.critical_findings || 0"></p>
                                <p class="text-xs text-red-700 font-medium">Critical</p>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-3 border border-orange-200">
                                <p class="text-2xl font-bold text-orange-600" x-text="selectedRun.high_findings || 0"></p>
                                <p class="text-xs text-orange-700 font-medium">High</p>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-3 border border-yellow-200">
                                <p class="text-2xl font-bold text-yellow-600" x-text="selectedRun.medium_findings || 0"></p>
                                <p class="text-xs text-yellow-700 font-medium">Medium</p>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                                <p class="text-2xl font-bold text-blue-600" x-text="selectedRun.low_findings || 0"></p>
                                <p class="text-xs text-blue-700 font-medium">Low</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3 border border-gray-300">
                                <p class="text-2xl font-bold text-gray-700" x-text="selectedRun.total_findings || 0"></p>
                                <p class="text-xs text-gray-600 font-medium">Total</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Execution Summary (if available) -->
                <div x-show="selectedRun.execution_summary" class="border rounded-lg overflow-hidden">
                    <div class="px-4 py-3 bg-gray-50 border-b">
                        <h5 class="font-semibold text-gray-900">Execution Summary</h5>
                    </div>
                    <div class="p-4">
                        <div class="text-sm text-gray-700 space-y-2">
                            <template x-if="selectedRun.execution_summary?.records_analyzed">
                                <p><span class="font-medium">Records Analyzed:</span> <span x-text="selectedRun.execution_summary.records_analyzed.toLocaleString()"></span></p>
                            </template>
                            <template x-if="selectedRun.execution_summary?.checks_performed">
                                <div>
                                    <p class="font-medium mb-1">Checks Performed:</p>
                                    <ul class="list-disc list-inside pl-2 text-gray-600">
                                        <template x-for="check in selectedRun.execution_summary.checks_performed" :key="check">
                                            <li x-text="check"></li>
                                        </template>
                                    </ul>
                                </div>
                            </template>
                            <template x-if="selectedRun.execution_summary?.data_sources">
                                <div>
                                    <p class="font-medium mb-1">Data Sources:</p>
                                    <ul class="list-disc list-inside pl-2 text-gray-600">
                                        <template x-for="source in selectedRun.execution_summary.data_sources" :key="source">
                                            <li x-text="source"></li>
                                        </template>
                                    </ul>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- Footer Actions -->
        <div class="p-6 border-t border-gray-200 bg-gray-50 flex justify-between items-center sticky bottom-0">
            <div class="flex gap-2">
                <button @click="reproduceRun(selectedRun?.run_id || selectedRun?.id)" 
                        :disabled="reproducingRun"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 flex items-center font-medium">
                    <svg x-show="reproducingRun" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <svg x-show="!reproducingRun" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <span x-text="reproducingRun ? 'Reproducing...' : 'Reproduce'"></span>
                </button>
            </div>
            <div class="flex gap-2">
                <!-- Export Buttons -->
                <button @click="viewFullReport(selectedRun?.run_id || selectedRun?.id)" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center font-medium">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Full Report
                </button>
                <button @click="exportToPDF(selectedRun?.run_id || selectedRun?.id)" 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center font-medium">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    PDF
                </button>
                <button @click="exportToCSV(selectedRun?.run_id || selectedRun?.id)" 
                        class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 flex items-center font-medium">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                    </svg>
                    CSV
                </button>
                <button @click="closeRunDetailsModal()" 
                        class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
<!-- End of Audit Run Details Modal -->

<!-- Full Report Modal -->
<div x-show="showFullReportModal" 
     x-cloak
     class="fixed inset-0 z-50 overflow-y-auto"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="showFullReportModal = false"></div>
        
        <div class="relative inline-block w-full max-w-6xl overflow-hidden text-left align-middle transition-all transform bg-white rounded-xl shadow-2xl dark:bg-gray-800">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-blue-100 dark:bg-blue-900">
                        <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Full Audit Report</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400" x-text="fullReport?.run_id || 'N/A'"></p>
                    </div>
                </div>
                <button @click="showFullReportModal = false" class="p-2 text-gray-400 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="px-6 py-4 max-h-[70vh] overflow-y-auto">
                <template x-if="fullReport">
                    <div class="space-y-6">
                        <!-- Executive Summary -->
                        <div class="p-4 rounded-lg bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Executive Summary</h4>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-gray-900 dark:text-white" x-text="fullReport.summary?.total_findings || 0"></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Total Findings</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-red-600 dark:text-red-400" x-text="fullReport.summary?.critical_count || 0"></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Critical</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-orange-600 dark:text-orange-400" x-text="fullReport.summary?.high_count || 0"></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">High Risk</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600 dark:text-green-400" x-text="fullReport.run_status || 'N/A'"></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Status</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Financial Impact -->
                        <template x-if="fullReport.summary?.total_impact">
                            <div class="p-4 border border-yellow-200 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 dark:border-yellow-800">
                                <h4 class="text-md font-semibold text-yellow-800 dark:text-yellow-300 mb-2">
                                    <svg class="inline w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Total Financial Impact
                                </h4>
                                <div class="text-2xl font-bold text-yellow-900 dark:text-yellow-100" x-text="'₦' + formatNumber(fullReport.summary.total_impact)"></div>
                            </div>
                        </template>
                        
                        <!-- Findings Detail -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Findings Detail</h4>
                            <div class="space-y-4">
                                <template x-for="finding in (fullReport.findings || [])" :key="finding.finding_ref">
                                    <div class="p-4 border rounded-lg" 
                                         :class="{
                                             'border-red-200 bg-red-50 dark:border-red-800 dark:bg-red-900/20': finding.risk_level === 'CRITICAL',
                                             'border-orange-200 bg-orange-50 dark:border-orange-800 dark:bg-orange-900/20': finding.risk_level === 'HIGH',
                                             'border-yellow-200 bg-yellow-50 dark:border-yellow-800 dark:bg-yellow-900/20': finding.risk_level === 'MEDIUM',
                                             'border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-900/20': finding.risk_level === 'LOW'
                                         }">
                                        <div class="flex items-start justify-between mb-2">
                                            <div>
                                                <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                                      :class="{
                                                          'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100': finding.risk_level === 'CRITICAL',
                                                          'bg-orange-100 text-orange-800 dark:bg-orange-800 dark:text-orange-100': finding.risk_level === 'HIGH',
                                                          'bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100': finding.risk_level === 'MEDIUM',
                                                          'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100': finding.risk_level === 'LOW'
                                                      }"
                                                      x-text="finding.risk_level"></span>
                                                <span class="ml-2 text-xs text-gray-500 dark:text-gray-400" x-text="finding.finding_ref"></span>
                                            </div>
                                            <span class="px-2 py-1 text-xs rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300" x-text="finding.category || 'General'"></span>
                                        </div>
                                        <h5 class="font-semibold text-gray-900 dark:text-white mb-2" x-text="finding.title"></h5>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" x-text="finding.description"></p>
                                        
                                        <template x-if="finding.financial_impact">
                                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Financial Impact: <span class="text-red-600 dark:text-red-400" x-text="'₦' + formatNumber(finding.financial_impact)"></span>
                                            </div>
                                        </template>
                                        
                                        <template x-if="finding.recommendation">
                                            <div class="mt-3 p-3 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700">
                                                <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">RECOMMENDATION</div>
                                                <p class="text-sm text-gray-700 dark:text-gray-300" x-text="finding.recommendation"></p>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                
                                <template x-if="!fullReport.findings || fullReport.findings.length === 0">
                                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                                        <svg class="w-12 h-12 mx-auto mb-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <p>No findings were identified in this audit run.</p>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Run Metadata -->
                        <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                            <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">Run Metadata</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <div class="text-gray-500 dark:text-gray-400">Run ID</div>
                                    <div class="font-medium text-gray-900 dark:text-white" x-text="fullReport.run_id"></div>
                                </div>
                                <div>
                                    <div class="text-gray-500 dark:text-gray-400">Type</div>
                                    <div class="font-medium text-gray-900 dark:text-white" x-text="fullReport.run_type"></div>
                                </div>
                                <div>
                                    <div class="text-gray-500 dark:text-gray-400">Generated</div>
                                    <div class="font-medium text-gray-900 dark:text-white" x-text="new Date(fullReport.generated_at).toLocaleString()"></div>
                                </div>
                                <div>
                                    <div class="text-gray-500 dark:text-gray-400">Entity</div>
                                    <div class="font-medium text-gray-900 dark:text-white truncate" x-text="fullReport.entity_id"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <button @click="exportToPDF(fullReport?.run_id)" 
                        class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export PDF
                </button>
                <button @click="exportToCSV(fullReport?.run_id)" 
                        class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export CSV
                </button>
                <button @click="showFullReportModal = false" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
<!-- End of Full Report Modal -->

</div>
<!-- End of x-data container -->

<script>
function unifiedAudit() {
    return {
        entityId: '{{ entity_id }}',
        activeTab: 'dashboard',
        loading: false,
        forensicLoading: false,
        
        // Stats
        integrity: { verified: false, status: 'Not Checked', message: '', lastCheck: null, recordCount: 0, issues: [] },
        nrsCompliance: { rate: 0, missing: 0 },
        anomalies: { total: 0, critical: 0, warning: 0 },
        auditRuns: { total: 0 },
        findings: { open: 0 },
        
        // Data
        recentLogs: [],
        auditLogs: [],
        auditRunsList: [],
        findingsList: [],
        evidenceList: [],
        evidenceFilter: 'all',
        evidenceStats: { total: 0, verified: 0, pending: 0, documents: 0 },
        showCollectModal: null,
        selectedEvidence: null,
        
        // Evidence Search, Filter, Pagination
        evidenceSearch: '',
        evidenceDateFrom: '',
        evidenceDateTo: '',
        evidencePage: 1,
        evidencePageSize: 20,
        evidenceTotalPages: 1,
        evidenceTotal: 0,
        pendingConfirmations: [],
        autoCollecting: { bank: false, gl: false, inventory: false, payroll: false },
        showConfirmationResponseModal: false,
        selectedConfirmation: null,
        confirmationResponse: { status: '', response_date: '', reported_amount: '', difference_explanation: '', notes: '', file: null },
        showFilePreview: false,
        
        // Evidence Collection Forms
        documentUpload: { title: '', description: '', document_type: 'invoice', file: null, finding_id: '', audit_run_id: '' },
        screenshotUpload: { title: '', description: '', source_url: '', file: null, clipboardImage: null, clipboardPreview: null, finding_id: '' },
        transactionCollect: { title: '', date_from: '', date_to: '', min_amount: '', max_amount: '', transaction_type: '', finding_id: '' },
        confirmationRequest: { title: '', external_party_name: '', external_party_email: '', confirmation_type: 'balance', due_date: '', notes: '', finding_id: '' },
        calculationForm: { title: '', calculation_type: 'materiality', formula: '0.05 * min(revenue, net_income, total_assets)', description: '', inputs: { revenue: null, net_income: null, total_assets: null }, finding_id: '' },
        logsForm: { title: '', date_from: '', date_to: '', action_filter: '', limit: 1000, finding_id: '' },
        snapshotForm: { title: '', table_name: '', limit: 1000, description: '', finding_id: '' },
        
        forensicResult: null,
        explainabilityResult: null,
        vaultStats: {},
        
        // Vault Records Browser
        vaultRecords: [],
        vaultTotal: 0,
        vaultPage: 1,
        vaultLimit: 20,
        vaultFiscalYears: [],
        vaultTimeline: [],
        vaultFilter: {
            fiscal_year: '',
            document_type: '',
            retention_status: '',
            start_date: '',
            end_date: '',
            search: ''
        },
        selectedVaultRecord: null,
        showVaultDetailModal: false,
        showComplianceModal: false,
        complianceReport: null,
        
        // Payroll Decisions Data
        payrollDecisionLogs: [],
        payrollDecisionSummary: null,
        payrollDecisionTotal: 0,
        payrollDecisionPage: 1,
        payrollDecisionPages: 0,
        payrollRuns: [],
        payrollDecisionFilter: {
            payroll_run_id: '',
            decision_type: '',
            category: ''
        },
        
        // Filters
        logsFilter: { action: '', startDate: '' },
        findingsFilter: { riskLevel: '' },
        
        // Inputs
        payeInput: { grossIncome: 0, basicSalary: 0 },
        vatInput: { outputVatBase: 0, inputVatBase: 0 },
        
        // Modals
        showNewRunModal: false,
        showIntegrityModal: false,
        showRunDetailsModal: false,
        showAdvancedOptions: false,
        showFullReportModal: false,
        creatingRun: false,
        reproducingRun: false,
        selectedRun: null,
        fullReport: null,
        
        // New Audit Run Form
        newRunForm: {
            run_type: '',
            title: '',
            description: '',
            date_range_start: '',
            date_range_end: '',
            parameters: {
                materiality_threshold: null,
                risk_focus: '',
                include_recommendations: true,
                include_evidence: true
            }
        },
        newRunErrors: [],
        
        // Toast notification state
        toast: {
            show: false,
            message: '',
            runId: '',
            type: 'success'
        },
        
        // Helper function for formatting numbers with commas
        formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return parseFloat(num).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },
        
        // Show success toast notification
        showSuccessToast(message, runId = '') {
            this.toast = { show: true, message, runId, type: 'success' };
            // Auto-hide after 5 seconds
            setTimeout(() => {
                this.toast.show = false;
            }, 5000);
        },
        
        // Show error toast notification
        showErrorToast(message) {
            this.toast = { show: true, message, runId: '', type: 'error' };
            setTimeout(() => {
                this.toast.show = false;
            }, 5000);
        },
        
        async init() {
            // Reset modal states on init to prevent stuck modals
            this.showNewRunModal = false;
            this.creatingRun = false;
            this.showIntegrityModal = false;
            this.toast = { show: false, message: '', runId: '', type: 'success' };
            
            // Check for tab parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            if (tabParam) {
                // Map URL tab param to activeTab values
                const tabMap = {
                    'logs': 'logs',
                    'forensic': 'forensic',
                    'advanced': 'forensic',  // Advanced audit maps to forensic
                    'worm': 'vault',          // WORM storage maps to vault
                    'vault': 'vault',
                    'runs': 'runs',
                    'findings': 'findings',
                    'evidence': 'evidence',
                    'explainability': 'explainability',
                    'payroll-decisions': 'payroll-decisions'
                };
                if (tabMap[tabParam]) {
                    this.activeTab = tabMap[tabParam];
                }
            }
            
            await this.loadDashboardData();
            
            // Load tab-specific data if needed
            if (this.activeTab === 'logs') {
                await this.loadAuditLogs();
            } else if (this.activeTab === 'vault') {
                await this.loadVaultStats();
            } else if (this.activeTab === 'runs') {
                await this.loadAuditRuns();
            }
        },
        
        async loadDashboardData() {
            try {
                // Load audit summary
                const summaryRes = await authFetch(`/api/v1/entities/${this.entityId}/forensic-audit/audit-summary/${new Date().getFullYear()}`);
                if (summaryRes.ok) {
                    const data = await summaryRes.json();
                    this.nrsCompliance = { rate: data.nrs_compliance?.rate || 0, missing: data.nrs_compliance?.missing || 0 };
                    this.anomalies = data.anomalies || { total: 0, critical: 0, warning: 0 };
                }
                
                // Load recent logs
                const logsRes = await authFetch(`/api/v1/entities/${this.entityId}/audit/logs?limit=10`);
                if (logsRes.ok) {
                    const data = await logsRes.json();
                    this.recentLogs = data.items || [];
                }
                
                // Load dashboard stats
                const statsRes = await authFetch('/api/audit-system/dashboard/stats');
                if (statsRes.ok) {
                    const data = await statsRes.json();
                    this.auditRuns = { total: data.audit_runs || 0 };
                    this.findings = { open: data.open_findings || 0 };
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        },
        
        async verifyIntegrity() {
            this.loading = true;
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/forensic-audit/verify-integrity`, { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    this.integrity = {
                        verified: data.verified || data.valid,
                        status: data.status || (data.verified || data.valid ? 'Verified' : 'Issues Found'),
                        badge: data.badge || (data.verified ? 'green' : 'red'),
                        message: data.message || (data.verified || data.valid ? 'All records verified successfully' : 'Data integrity issues detected'),
                        lastCheck: new Date().toLocaleString(),
                        recordCount: data.records_checked || data.record_count || 0,
                        issues: data.discrepancies || [],
                        dataSource: data.data_source || null,
                        totalDebit: data.total_debit || null,
                        totalCredit: data.total_credit || null,
                        note: data.note || null
                    };
                    this.showIntegrityModal = true;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    this.integrity = {
                        verified: false,
                        status: 'Check Failed',
                        badge: 'red',
                        message: errorData.detail || 'Unable to verify data integrity. Please try again.',
                        lastCheck: new Date().toLocaleString(),
                        recordCount: 0,
                        issues: []
                    };
                    this.showIntegrityModal = true;
                }
            } catch (error) {
                console.error('Error verifying integrity:', error);
                this.integrity = {
                    verified: false,
                    status: 'Error',
                    badge: 'red',
                    message: 'Network error while verifying integrity. Please check your connection.',
                    lastCheck: new Date().toLocaleString(),
                    recordCount: 0,
                    issues: []
                };
                this.showIntegrityModal = true;
            } finally {
                this.loading = false;
            }
        },
        
        async syncLedger() {
            this.loading = true;
            const fiscalYear = new Date().getFullYear();
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/forensic-audit/sync-ledger?fiscal_year=${fiscalYear}`, { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    alert(`${data.message}\n\nSynced: ${data.synced_count} entries\nErrors: ${data.error_count}`);
                    this.showIntegrityModal = false;
                    // Re-verify to show updated status
                    await this.verifyIntegrity();
                } else {
                    const err = await response.json().catch(() => ({}));
                    alert(err.detail || 'Failed to sync ledger. Please try again.');
                }
            } catch (error) {
                console.error('Error syncing ledger:', error);
                alert('Network error while syncing. Please check your connection.');
            } finally {
                this.loading = false;
            }
        },
        
        async loadAuditLogs() {
            try {
                let url = `/api/v1/entities/${this.entityId}/audit/logs?limit=100`;
                if (this.logsFilter.action) url += `&action=${this.logsFilter.action}`;
                if (this.logsFilter.startDate) url += `&start_date=${this.logsFilter.startDate}`;
                
                const response = await authFetch(url);
                if (response.ok) {
                    const data = await response.json();
                    this.auditLogs = data.items || [];
                }
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        },
        
        async runBenfordsLaw() {
            this.forensicLoading = true;
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/forensic-audit/benfords-law?fiscal_year=${new Date().getFullYear()}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Check if insufficient data
                    if (data.status === 'insufficient_data') {
                        data._analysisType = 'benfords_insufficient';
                    } else {
                        data._analysisType = 'benfords';
                    }
                    this.forensicResult = data;
                } else {
                    const err = await response.json().catch(() => ({}));
                    alert(err.detail || 'Failed to run Benford\'s Law analysis');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error running analysis');
            } finally {
                this.forensicLoading = false;
            }
        },
        
        async runAnomalyDetection() {
            this.forensicLoading = true;
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/forensic-audit/anomaly-detection?fiscal_year=${new Date().getFullYear()}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Check if insufficient data
                    if (data.status === 'insufficient_data') {
                        data._analysisType = 'anomaly_insufficient';
                    } else {
                        data._analysisType = 'anomaly';
                    }
                    this.forensicResult = data;
                } else {
                    const err = await response.json().catch(() => ({}));
                    alert(err.detail || 'Failed to run anomaly detection. Please ensure you have transaction data in the system.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error running analysis');
            } finally {
                this.forensicLoading = false;
            }
        },
        
        async runNRSGapAnalysis() {
            this.forensicLoading = true;
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/forensic-audit/nrs-gap-analysis/${new Date().getFullYear()}`);
                if (response.ok) {
                    const data = await response.json();
                    data._analysisType = 'nrs_gap';
                    this.forensicResult = data;
                } else {
                    const err = await response.json().catch(() => ({}));
                    alert(err.detail || 'Failed to run NRS Gap Analysis');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error running analysis');
            } finally {
                this.forensicLoading = false;
            }
        },
        
        async loadAuditRuns() {
            try {
                console.log('Loading audit runs...');
                const response = await authFetch('/api/audit-system/runs/list');
                console.log('Audit runs response status:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Audit runs data:', data);
                    this.auditRunsList = data.runs || [];
                    // Update the stats
                    this.auditRuns.total = this.auditRunsList.length;
                } else {
                    console.error('Failed to load audit runs:', response.status);
                }
            } catch (error) {
                console.error('Error loading runs:', error);
            }
        },
        
        setDateRange(period) {
            const year = 2026;
            const ranges = {
                'Q1': { start: `${year}-01-01`, end: `${year}-03-31` },
                'Q2': { start: `${year}-04-01`, end: `${year}-06-30` },
                'Q3': { start: `${year}-07-01`, end: `${year}-09-30` },
                'Q4': { start: `${year}-10-01`, end: `${year}-12-31` },
                'YTD': { start: `${year}-01-01`, end: new Date().toISOString().split('T')[0] },
                'FY2025': { start: '2025-01-01', end: '2025-12-31' }
            };
            const range = ranges[period];
            if (range) {
                this.newRunForm.date_range_start = range.start;
                this.newRunForm.date_range_end = range.end;
            }
        },
        
        validateNewRunForm() {
            this.newRunErrors = [];
            
            if (!this.newRunForm.run_type) {
                this.newRunErrors.push('Please select an audit type');
            }
            if (!this.newRunForm.title || this.newRunForm.title.length < 5) {
                this.newRunErrors.push('Title must be at least 5 characters');
            }
            if (!this.newRunForm.date_range_start) {
                this.newRunErrors.push('Please select a period start date');
            }
            if (!this.newRunForm.date_range_end) {
                this.newRunErrors.push('Please select a period end date');
            }
            if (this.newRunForm.date_range_start && this.newRunForm.date_range_end) {
                if (new Date(this.newRunForm.date_range_start) > new Date(this.newRunForm.date_range_end)) {
                    this.newRunErrors.push('Period start date must be before end date');
                }
            }
            
            return this.newRunErrors.length === 0;
        },
        
        openNewRunModal() {
            console.log('openNewRunModal called');
            // Reset form state
            this.newRunErrors = [];
            this.creatingRun = false;
            this.newRunForm = {
                run_type: '',
                title: '',
                description: '',
                date_range_start: '',
                date_range_end: '',
                parameters: {
                    materiality_threshold: null,
                    risk_focus: '',
                    include_recommendations: true,
                    include_evidence: true
                }
            };
            // Show the modal
            this.showNewRunModal = true;
            console.log('showNewRunModal set to:', this.showNewRunModal);
        },
        
        closeNewRunModal() {
            console.log('closeNewRunModal called');
            // Force close the modal and reset all states
            this.showNewRunModal = false;
            this.creatingRun = false;
            this.newRunErrors = [];
        },
        
        async createAuditRun() {
            console.log('createAuditRun called');
            if (!this.validateNewRunForm()) {
                console.log('Validation failed:', this.newRunErrors);
                return;
            }
            
            this.creatingRun = true;
            this.newRunErrors = [];
            
            try {
                const payload = {
                    run_type: this.newRunForm.run_type,
                    title: this.newRunForm.title,
                    description: this.newRunForm.description || null,
                    date_range_start: this.newRunForm.date_range_start,
                    date_range_end: this.newRunForm.date_range_end,
                    parameters: {
                        ...this.newRunForm.parameters,
                        materiality_threshold: this.newRunForm.parameters.materiality_threshold 
                            ? parseFloat(this.newRunForm.parameters.materiality_threshold) 
                            : null
                    }
                };
                
                console.log('Sending payload:', payload);
                const response = await authFetch('/api/audit-system/runs/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('Response status:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Success! Data:', data);
                    // Reset form
                    this.newRunForm = {
                        run_type: '',
                        title: '',
                        description: '',
                        date_range_start: '',
                        date_range_end: '',
                        parameters: {
                            materiality_threshold: null,
                            risk_focus: '',
                            include_recommendations: true,
                            include_evidence: true
                        }
                    };
                    this.showNewRunModal = false;
                    this.newRunErrors = [];
                    
                    // Refresh the runs list
                    await this.loadAuditRuns();
                    
                    // Show success toast notification
                    this.showSuccessToast(`Audit run "${data.title || data.run_id}" created successfully!`, data.run_id);
                    
                    // Switch to runs tab to see the new run
                    this.activeTab = 'runs';
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    this.newRunErrors.push(errorData.detail || errorData.error?.message || 'Failed to create audit run. Please try again.');
                }
            } catch (error) {
                console.error('Error creating audit run:', error);
                this.newRunErrors.push('Network error: Could not connect to server. Please check your connection.');
            } finally {
                this.creatingRun = false;
            }
        },
        
        async loadFindings() {
            try {
                let url = '/api/audit-system/findings/list';
                if (this.findingsFilter.riskLevel) url += `?risk_level=${this.findingsFilter.riskLevel}`;
                
                const response = await authFetch(url);
                if (response.ok) {
                    const data = await response.json();
                    this.findingsList = data.findings || [];
                }
            } catch (error) {
                console.error('Error loading findings:', error);
            }
        },
        
        async loadEvidence() {
            try {
                // Build query params with search, filter, and pagination
                let url = `/api/evidence/list?entity_id=${this.entityId}`;
                url += `&page=${this.evidencePage}&page_size=${this.evidencePageSize}`;
                
                // Add type filter (if not 'all')
                if (this.evidenceFilter && this.evidenceFilter !== 'all') {
                    url += `&evidence_type=${this.evidenceFilter}`;
                }
                
                // Add search term
                if (this.evidenceSearch && this.evidenceSearch.trim()) {
                    url += `&search=${encodeURIComponent(this.evidenceSearch.trim())}`;
                }
                
                // Add date filters
                if (this.evidenceDateFrom) {
                    url += `&date_from=${this.evidenceDateFrom}`;
                }
                if (this.evidenceDateTo) {
                    url += `&date_to=${this.evidenceDateTo}`;
                }
                
                const response = await authFetch(url);
                if (response.ok) {
                    const data = await response.json();
                    this.evidenceList = data.evidence || [];
                    
                    // Update pagination info from response
                    if (data.pagination) {
                        this.evidenceTotal = data.pagination.total || 0;
                        this.evidenceTotalPages = data.pagination.pages || 1;
                        this.evidencePage = data.pagination.page || 1;
                    } else {
                        this.evidenceTotal = this.evidenceList.length;
                        this.evidenceTotalPages = 1;
                    }
                    
                    // Update stats from real data
                    this.evidenceStats.total = this.evidenceTotal;
                    this.evidenceStats.verified = this.evidenceList.filter(e => e.is_verified).length;
                    this.evidenceStats.pending = this.evidenceList.filter(e => !e.is_verified).length;
                    this.evidenceStats.documents = this.evidenceList.filter(e => e.evidence_type === 'document').length;
                }
                
                // Also load findings and audit runs for linking dropdowns
                if (this.findingsList.length === 0) {
                    await this.loadFindings();
                }
                if (this.auditRunsList.length === 0) {
                    await this.loadAuditRuns();
                }
                
                // Load pending confirmations
                await this.loadPendingConfirmations();
            } catch (error) {
                console.error('Error loading evidence:', error);
            }
        },
        
        async verifyEvidence(evidenceId) {
            try {
                const response = await authFetch(`/api/evidence/${evidenceId}/verify?entity_id=${this.entityId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.is_valid) {
                        alert(`Evidence Integrity VERIFIED\n\nReference: ${data.evidence_ref}\nStored Hash: ${data.stored_hash?.substring(0,16)}...\nComputed Hash: ${data.computed_hash?.substring(0,16)}...\n\nEvidence has NOT been tampered with.`);
                    } else {
                        alert(`Evidence Integrity FAILED\n\nHash mismatch detected!\nStored: ${data.stored_hash?.substring(0,16)}...\nComputed: ${data.computed_hash?.substring(0,16)}...\n\nEvidence may have been modified.`);
                    }
                    // Reload to update verification status
                    await this.loadEvidence();
                    // Also update selected evidence if viewing detail
                    if (this.selectedEvidence && this.selectedEvidence.id === evidenceId) {
                        this.selectedEvidence.is_verified = data.is_valid;
                    }
                }
            } catch (error) {
                console.error('Error verifying evidence:', error);
                alert('Error verifying evidence integrity');
            }
        },
        
        async viewEvidenceDetail(evidence) {
            // Fetch full evidence details including content
            try {
                const response = await authFetch(`/api/evidence/${evidence.id}?entity_id=${this.entityId}`);
                if (response.ok) {
                    const fullEvidence = await response.json();
                    this.selectedEvidence = fullEvidence;
                } else {
                    // Fallback to list data if detail fetch fails
                    this.selectedEvidence = evidence;
                }
            } catch (error) {
                console.error('Error fetching evidence detail:', error);
                this.selectedEvidence = evidence;
            }
        },
        
        async downloadEvidence(evidenceId) {
            try {
                const response = await authFetch(`/api/evidence/${evidenceId}/download?entity_id=${this.entityId}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('content-disposition');
                    let filename = `evidence_${evidenceId}`;
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="?([^"]+)"?/);
                        if (match) filename = match[1];
                    }
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Error: Could not download evidence file');
                }
            } catch (error) {
                console.error('Error downloading evidence:', error);
                alert('Error downloading evidence file');
            }
        },
        
        // Export Evidence to PDF
        async exportEvidenceToPDF() {
            try {
                // Build export URL with current filters
                let url = `/api/evidence/export/pdf?entity_id=${this.entityId}`;
                if (this.evidenceFilter && this.evidenceFilter !== 'all') {
                    url += `&evidence_type=${this.evidenceFilter}`;
                }
                if (this.evidenceSearch && this.evidenceSearch.trim()) {
                    url += `&search=${encodeURIComponent(this.evidenceSearch.trim())}`;
                }
                if (this.evidenceDateFrom) {
                    url += `&date_from=${this.evidenceDateFrom}`;
                }
                if (this.evidenceDateTo) {
                    url += `&date_to=${this.evidenceDateTo}`;
                }
                
                const response = await authFetch(url);
                if (response.ok) {
                    const blob = await response.blob();
                    const pdfUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = pdfUrl;
                    a.download = `evidence_export_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(pdfUrl);
                    document.body.removeChild(a);
                    alert('Evidence exported to PDF successfully!');
                } else {
                    // Fallback: generate client-side report
                    this.generateClientSidePDFReport();
                }
            } catch (error) {
                console.error('Error exporting to PDF:', error);
                // Fallback: generate client-side report
                this.generateClientSidePDFReport();
            }
        },
        
        // Generate client-side PDF report (fallback)
        generateClientSidePDFReport() {
            const printContent = this.generateEvidenceReportHTML();
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        },
        
        // Generate HTML report for printing/PDF
        generateEvidenceReportHTML() {
            const dateStr = new Date().toLocaleDateString();
            let html = `<!DOCTYPE html>
            <html>
            <head>
                <title>Evidence Report - ${dateStr}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    h1 { color: #4338ca; border-bottom: 2px solid #4338ca; padding-bottom: 10px; }
                    h2 { color: #6366f1; margin-top: 30px; }
                    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                    th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
                    th { background-color: #f3f4f6; font-weight: bold; }
                    .badge { padding: 3px 8px; border-radius: 4px; font-size: 12px; }
                    .verified { background-color: #d1fae5; color: #065f46; }
                    .pending { background-color: #fef3c7; color: #92400e; }
                    .meta { color: #6b7280; font-size: 12px; margin-top: 5px; }
                    @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                </style>
            </head>
            <body>
                <h1>Audit Evidence Report</h1>
                <p class="meta">Generated: ${new Date().toLocaleString()}</p>
                <p class="meta">Filter: ${this.evidenceFilter || 'All'} | Search: ${this.evidenceSearch || 'None'}</p>
                
                <h2>Summary</h2>
                <table>
                    <tr><th>Total Evidence</th><td>${this.evidenceTotal}</td></tr>
                    <tr><th>Verified</th><td>${this.evidenceStats.verified}</td></tr>
                    <tr><th>Pending Verification</th><td>${this.evidenceStats.pending}</td></tr>
                </table>
                
                <h2>Evidence Items</h2>
                <table>
                    <tr>
                        <th>Reference</th>
                        <th>Type</th>
                        <th>Title</th>
                        <th>Status</th>
                        <th>Collected</th>
                        <th>Collected By</th>
                    </tr>`;
            
            this.evidenceList.forEach(ev => {
                html += `<tr>
                    <td><strong>${ev.evidence_ref || 'N/A'}</strong></td>
                    <td>${ev.evidence_type || 'N/A'}</td>
                    <td>${ev.title || 'Untitled'}</td>
                    <td><span class="badge ${ev.is_verified ? 'verified' : 'pending'}">${ev.is_verified ? 'Verified' : 'Pending'}</span></td>
                    <td>${ev.collected_at ? new Date(ev.collected_at).toLocaleDateString() : 'N/A'}</td>
                    <td>${ev.collected_by || 'System'}</td>
                </tr>`;
            });
            
            html += `</table>
            </body></html>`;
            return html;
        },
        
        // Export Evidence to Excel/CSV
        async exportEvidenceToExcel() {
            try {
                // Build export URL with current filters
                let url = `/api/evidence/export/excel?entity_id=${this.entityId}`;
                if (this.evidenceFilter && this.evidenceFilter !== 'all') {
                    url += `&evidence_type=${this.evidenceFilter}`;
                }
                if (this.evidenceSearch && this.evidenceSearch.trim()) {
                    url += `&search=${encodeURIComponent(this.evidenceSearch.trim())}`;
                }
                if (this.evidenceDateFrom) {
                    url += `&date_from=${this.evidenceDateFrom}`;
                }
                if (this.evidenceDateTo) {
                    url += `&date_to=${this.evidenceDateTo}`;
                }
                
                const response = await authFetch(url);
                if (response.ok) {
                    const blob = await response.blob();
                    const excelUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = excelUrl;
                    a.download = `evidence_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(excelUrl);
                    document.body.removeChild(a);
                    alert('Evidence exported to Excel successfully!');
                } else {
                    // Fallback: generate CSV
                    this.generateClientSideCSV();
                }
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                // Fallback: generate CSV
                this.generateClientSideCSV();
            }
        },
        
        // Generate client-side CSV (fallback)
        generateClientSideCSV() {
            let csv = 'Reference,Type,Title,Description,Status,Collected At,Collected By,Hash\n';
            this.evidenceList.forEach(ev => {
                const row = [
                    ev.evidence_ref || '',
                    ev.evidence_type || '',
                    (ev.title || '').replace(/"/g, '""'),
                    (ev.description || '').replace(/"/g, '""'),
                    ev.is_verified ? 'Verified' : 'Pending',
                    ev.collected_at ? new Date(ev.collected_at).toISOString() : '',
                    ev.collected_by || '',
                    ev.integrity_hash || ''
                ];
                csv += row.map(v => `"${v}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const csvUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = csvUrl;
            a.download = `evidence_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(csvUrl);
            document.body.removeChild(a);
            alert('Evidence exported to CSV successfully!');
        },
        
        // Auto-Collect Bank Transactions
        async autoCollectBankTransactions() {
            this.autoCollecting.bank = true;
            try {
                // Calculate date range (last 90 days)
                const dateTo = new Date().toISOString().split('T')[0];
                const dateFrom = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const payload = {
                    title: `Bank Transactions Auto-Collected ${dateTo}`,
                    date_from: dateFrom,
                    date_to: dateTo,
                    transaction_type: 'all'
                };
                
                const response = await authFetch(`/api/evidence/transaction/collect?entity_id=${this.entityId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Bank transactions collected!\n\nReference: ${data.evidence_ref}\nPeriod: ${dateFrom} to ${dateTo}`);
                    await this.loadEvidence();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail || 'Failed to collect bank transactions'}`);
                }
            } catch (error) {
                console.error('Error auto-collecting bank transactions:', error);
                alert('Error collecting bank transactions');
            } finally {
                this.autoCollecting.bank = false;
            }
        },
        
        // Auto-Collect GL Entries
        async autoCollectGLEntries() {
            this.autoCollecting.gl = true;
            try {
                // Calculate date range (last 90 days)
                const dateTo = new Date().toISOString().split('T')[0];
                const dateFrom = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const payload = {
                    title: `GL Entries Auto-Collected ${dateTo}`,
                    date_from: dateFrom,
                    date_to: dateTo,
                    transaction_type: 'journal_entries'
                };
                
                const response = await authFetch(`/api/evidence/transaction/collect?entity_id=${this.entityId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`GL entries collected!\n\nReference: ${data.evidence_ref}\nPeriod: ${dateFrom} to ${dateTo}`);
                    await this.loadEvidence();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail || 'Failed to collect GL entries'}`);
                }
            } catch (error) {
                console.error('Error auto-collecting GL entries:', error);
                alert('Error collecting GL entries');
            } finally {
                this.autoCollecting.gl = false;
            }
        },
        
        // Auto-Collect Inventory Data
        async autoCollectInventory() {
            this.autoCollecting.inventory = true;
            try {
                const payload = {
                    title: `Inventory Snapshot ${new Date().toISOString().split('T')[0]}`,
                    table_name: 'inventory_items',
                    limit: 5000,
                    description: 'Auto-collected inventory data for audit evidence'
                };
                
                const response = await authFetch(`/api/evidence/snapshot/database?entity_id=${this.entityId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Inventory snapshot collected!\n\nReference: ${data.evidence_ref}`);
                    await this.loadEvidence();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail || 'Failed to collect inventory'}`);
                }
            } catch (error) {
                console.error('Error auto-collecting inventory:', error);
                alert('Error collecting inventory data');
            } finally {
                this.autoCollecting.inventory = false;
            }
        },
        
        // Auto-Collect Payroll Data
        async autoCollectPayroll() {
            this.autoCollecting.payroll = true;
            try {
                const payload = {
                    title: `Payroll Data ${new Date().toISOString().split('T')[0]}`,
                    table_name: 'payroll_runs',
                    limit: 1000,
                    description: 'Auto-collected payroll data for audit evidence'
                };
                
                const response = await authFetch(`/api/evidence/snapshot/database?entity_id=${this.entityId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Payroll data collected!\n\nReference: ${data.evidence_ref}`);
                    await this.loadEvidence();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail || 'Failed to collect payroll data'}`);
                }
            } catch (error) {
                console.error('Error auto-collecting payroll:', error);
                alert('Error collecting payroll data');
            } finally {
                this.autoCollecting.payroll = false;
            }
        },
        
        async uploadDocument() {
            if (!this.documentUpload.file || !this.documentUpload.title) {
                alert('Please provide a title and select a file');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('file', this.documentUpload.file);
                formData.append('title', this.documentUpload.title);
                formData.append('description', this.documentUpload.description || '');
                formData.append('document_type', this.documentUpload.document_type);
                if (this.documentUpload.finding_id) {
                    formData.append('finding_id', this.documentUpload.finding_id);
                }
                if (this.documentUpload.audit_run_id) {
                    formData.append('audit_run_id', this.documentUpload.audit_run_id);
                }
                
                const token = localStorage.getItem('accessToken');
                const response = await fetch(`/api/evidence/document/upload?entity_id=${this.entityId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Document uploaded successfully!\n\nReference: ${data.evidence_ref}`);
                    this.showCollectModal = null;
                    this.documentUpload = { title: '', description: '', document_type: 'invoice', file: null, finding_id: '', audit_run_id: '' };
                    await this.loadEvidence();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to upload document'));
                }
            } catch (error) {
                console.error('Error uploading document:', error);
                alert('Error uploading document');
            }
        },
        
        async uploadScreenshot() {
            if (!this.screenshotUpload.title) {
                alert('Please provide a title for the screenshot');
                return;
            }
            
            if (!this.screenshotUpload.file && !this.screenshotUpload.clipboardImage) {
                alert('Please select a file or paste a screenshot from clipboard');
                return;
            }
            
            try {
                const token = localStorage.getItem('accessToken');
                let response;
                
                if (this.screenshotUpload.clipboardImage) {
                    // Use clipboard paste endpoint with base64 data
                    const formData = new FormData();
                    formData.append('image_data', this.screenshotUpload.clipboardImage);
                    formData.append('title', this.screenshotUpload.title);
                    formData.append('description', this.screenshotUpload.description || '');
                    if (this.screenshotUpload.source_url) {
                        formData.append('source_url', this.screenshotUpload.source_url);
                    }
                    if (this.screenshotUpload.finding_id) {
                        formData.append('finding_id', this.screenshotUpload.finding_id);
                    }
                    
                    response = await fetch(`/api/evidence/screenshot/paste?entity_id=${this.entityId}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                } else {
                    // Use regular file upload endpoint
                    const formData = new FormData();
                    formData.append('file', this.screenshotUpload.file);
                    formData.append('title', this.screenshotUpload.title);
                    formData.append('description', this.screenshotUpload.description || '');
                    formData.append('source_url', this.screenshotUpload.source_url || '');
                    if (this.screenshotUpload.finding_id) {
                        formData.append('finding_id', this.screenshotUpload.finding_id);
                    }
                    
                    response = await fetch(`/api/evidence/screenshot/upload?entity_id=${this.entityId}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                }
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Screenshot captured successfully!\n\nReference: ${data.evidence_ref}`);
                    this.showCollectModal = null;
                    this.screenshotUpload = { title: '', description: '', source_url: '', file: null, clipboardImage: null, clipboardPreview: null, finding_id: '' };
                    await this.loadEvidence();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to capture screenshot'));
                }
            } catch (error) {
                console.error('Error uploading screenshot:', error);
                alert('Error capturing screenshot');
            }
        },
        
        // Clipboard paste handler for screenshots
        handleClipboardPaste(event) {
            if (this.showCollectModal !== 'screenshot') return;
            
            const items = event.clipboardData?.items;
            if (!items) return;
            
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    event.preventDefault();
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        this.screenshotUpload.clipboardImage = e.target.result;
                        this.screenshotUpload.clipboardPreview = e.target.result;
                        this.screenshotUpload.file = null; // Clear file input if clipboard used
                    };
                    
                    reader.readAsDataURL(blob);
                    break;
                }
            }
        },
        
        // Handle drag and drop for images
        handleImageDrop(event) {
            const files = event.dataTransfer?.files;
            if (!files || files.length === 0) return;
            
            const file = files[0];
            if (!file.type.startsWith('image/')) {
                alert('Please drop an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                this.screenshotUpload.clipboardImage = e.target.result;
                this.screenshotUpload.clipboardPreview = e.target.result;
                this.screenshotUpload.file = null;
            };
            reader.readAsDataURL(file);
        },
        
        // Clear clipboard image
        clearClipboardImage() {
            this.screenshotUpload.clipboardImage = null;
            this.screenshotUpload.clipboardPreview = null;
        },
        
        async collectTransactions() {
            if (!this.transactionCollect.title) {
                alert('Please provide a title for the transaction collection');
                return;
            }
            
            try {
                const payload = {
                    title: this.transactionCollect.title,
                    date_from: this.transactionCollect.date_from || null,
                    date_to: this.transactionCollect.date_to || null,
                    description: `Transaction collection${this.transactionCollect.transaction_type ? ' for ' + this.transactionCollect.transaction_type : ''}`,
                };
                if (this.transactionCollect.finding_id) {
                    payload.finding_id = this.transactionCollect.finding_id;
                }
                
                const response = await authFetch(`/api/evidence/transaction/collect?entity_id=${this.entityId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Transactions collected successfully!\n\nReference: ${data.evidence_ref}\nRecords: ${data.records_collected || 0}`);
                    this.showCollectModal = null;
                    this.transactionCollect = { title: '', date_from: '', date_to: '', min_amount: '', max_amount: '', transaction_type: '', finding_id: '' };
                    await this.loadEvidence();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to collect transactions'));
                }
            } catch (error) {
                console.error('Error collecting transactions:', error);
                alert('Error collecting transactions');
            }
        },
        
        async createConfirmationRequest() {
            if (!this.confirmationRequest.title || !this.confirmationRequest.external_party_name || !this.confirmationRequest.external_party_email) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const payload = {
                    title: this.confirmationRequest.title,
                    external_party_name: this.confirmationRequest.external_party_name,
                    external_party_email: this.confirmationRequest.external_party_email,
                    confirmation_type: this.confirmationRequest.confirmation_type,
                    items_to_confirm: [{
                        type: this.confirmationRequest.confirmation_type,
                        description: this.confirmationRequest.notes || `${this.confirmationRequest.confirmation_type} confirmation request`
                    }],
                    due_date: this.confirmationRequest.due_date || null,
                    notes: this.confirmationRequest.notes || null
                };
                if (this.confirmationRequest.finding_id) {
                    payload.finding_id = this.confirmationRequest.finding_id;
                }
                
                const response = await authFetch(`/api/evidence/confirmation/request?entity_id=${this.entityId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Confirmation request created!\n\nReference: ${data.evidence_ref}\nSent to: ${this.confirmationRequest.external_party_email}`);
                    this.showCollectModal = null;
                    this.confirmationRequest = { title: '', external_party_name: '', external_party_email: '', confirmation_type: 'balance', due_date: '', notes: '', finding_id: '' };
                    await this.loadEvidence();
                    await this.loadPendingConfirmations();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to create confirmation request'));
                }
            } catch (error) {
                console.error('Error creating confirmation request:', error);
                alert('Error creating confirmation request');
            }
        },
        
        // Load pending confirmations awaiting response
        async loadPendingConfirmations() {
            try {
                const response = await authFetch(`/api/evidence/list?entity_id=${this.entityId}&evidence_type=external_confirmation&page_size=100`);
                if (response.ok) {
                    const data = await response.json();
                    // Filter for pending (not responded) confirmations
                    this.pendingConfirmations = (data.evidence || []).filter(e => {
                        const status = e.content?.response_status || e.content?.status;
                        return !status || status === 'sent' || status === 'pending';
                    });
                }
            } catch (error) {
                console.error('Error loading pending confirmations:', error);
            }
        },
        
        // Open confirmation response modal
        openConfirmationResponseModal(confirmation) {
            this.selectedConfirmation = confirmation;
            this.confirmationResponse = { 
                status: '', 
                response_date: new Date().toISOString().split('T')[0], 
                reported_amount: '', 
                difference_explanation: '', 
                notes: '', 
                file: null 
            };
            this.showConfirmationResponseModal = true;
        },
        
        // Submit confirmation response
        async submitConfirmationResponse() {
            if (!this.confirmationResponse.status) {
                alert('Please select a response status');
                return;
            }
            
            try {
                const payload = {
                    response_status: this.confirmationResponse.status,
                    response_date: this.confirmationResponse.response_date || new Date().toISOString().split('T')[0],
                    notes: this.confirmationResponse.notes || ''
                };
                
                if (this.confirmationResponse.status === 'differs') {
                    payload.reported_amount = parseFloat(this.confirmationResponse.reported_amount) || 0;
                    payload.difference_explanation = this.confirmationResponse.difference_explanation || '';
                }
                
                // Try to update the evidence with the response
                const response = await authFetch(`/api/evidence/${this.selectedConfirmation.id}/update?entity_id=${this.entityId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: {
                            ...this.selectedConfirmation.content,
                            response_status: payload.response_status,
                            response_date: payload.response_date,
                            response_notes: payload.notes,
                            reported_amount: payload.reported_amount,
                            difference_explanation: payload.difference_explanation
                        }
                    })
                });
                
                if (response.ok) {
                    alert(`Confirmation response recorded!\n\nStatus: ${this.confirmationResponse.status}`);
                    this.showConfirmationResponseModal = false;
                    this.selectedConfirmation = null;
                    await this.loadEvidence();
                    await this.loadPendingConfirmations();
                } else {
                    // Fallback: Create a note/update locally
                    alert(`Response recorded locally (${this.confirmationResponse.status}). Backend update may require additional API support.`);
                    this.showConfirmationResponseModal = false;
                    this.selectedConfirmation = null;
                }
            } catch (error) {
                console.error('Error submitting confirmation response:', error);
                alert('Error recording confirmation response');
            }
        },
        
        async createCalculationEvidence() {
            if (!this.calculationForm.title) {
                alert('Please provide a title');
                return;
            }
            
            try {
                // Compute a simple result based on inputs
                const inputs = this.calculationForm.inputs;
                let result = 0;
                if (this.calculationForm.calculation_type === 'materiality') {
                    const values = [inputs.revenue, inputs.net_income, inputs.total_assets].filter(v => v != null && v > 0);
                    if (values.length > 0) {
                        result = 0.05 * Math.min(...values);
                    }
                } else {
                    result = Object.values(inputs).filter(v => v != null).reduce((a, b) => a + parseFloat(b), 0);
                }
                
                const payload = {
                    title: this.calculationForm.title,
                    calculation_type: this.calculationForm.calculation_type,
                    formula: this.calculationForm.formula,
                    inputs: this.calculationForm.inputs,
                    result: result,
                    description: this.calculationForm.description
                };
                if (this.calculationForm.finding_id) {
                    payload.finding_id = this.calculationForm.finding_id;
                }
                
                const response = await authFetch(`/api/evidence/calculation/record?entity_id=${this.entityId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Calculation evidence created!\n\nReference: ${data.evidence_ref}\nResult: ${result.toFixed(2)}`);
                    this.showCollectModal = null;
                    this.calculationForm = { title: '', calculation_type: 'materiality', formula: '0.05 * min(revenue, net_income, total_assets)', description: '', inputs: { revenue: null, net_income: null, total_assets: null }, finding_id: '' };
                    await this.loadEvidence();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to create calculation evidence'));
                }
            } catch (error) {
                console.error('Error creating calculation evidence:', error);
                alert('Error creating calculation evidence');
            }
        },
        
        async extractSystemLogs() {
            if (!this.logsForm.title || !this.logsForm.date_from || !this.logsForm.date_to) {
                alert('Please provide a title and date range');
                return;
            }
            
            try {
                const payload = {
                    title: this.logsForm.title,
                    date_from: this.logsForm.date_from + 'T00:00:00',
                    date_to: this.logsForm.date_to + 'T23:59:59',
                    event_types: this.logsForm.action_filter ? [this.logsForm.action_filter] : null,
                    description: `Audit log extraction from ${this.logsForm.date_from} to ${this.logsForm.date_to}`
                };
                if (this.logsForm.finding_id) {
                    payload.finding_id = this.logsForm.finding_id;
                }
                
                const response = await authFetch(`/api/evidence/log/extract?entity_id=${this.entityId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`System logs extracted!\n\nReference: ${data.evidence_ref}\nLogs: ${data.logs_extracted || 0}`);
                    this.showCollectModal = null;
                    this.logsForm = { title: '', date_from: '', date_to: '', action_filter: '', limit: 1000, finding_id: '' };
                    await this.loadEvidence();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to extract system logs'));
                }
            } catch (error) {
                console.error('Error extracting system logs:', error);
                alert('Error extracting system logs');
            }
        },
        
        async createDatabaseSnapshot() {
            if (!this.snapshotForm.title || !this.snapshotForm.table_name) {
                alert('Please provide a title and select a table');
                return;
            }
            
            try {
                const payload = {
                    title: this.snapshotForm.title,
                    snapshot_type: this.snapshotForm.table_name,
                    include_balances: true,
                    description: this.snapshotForm.description
                };
                if (this.snapshotForm.finding_id) {
                    payload.finding_id = this.snapshotForm.finding_id;
                }
                
                const response = await authFetch(`/api/evidence/snapshot/create?entity_id=${this.entityId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Database snapshot created!\n\nReference: ${data.evidence_ref}`);
                    this.showCollectModal = null;
                    this.snapshotForm = { title: '', table_name: '', limit: 1000, description: '', finding_id: '' };
                    await this.loadEvidence();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to create database snapshot'));
                }
            } catch (error) {
                console.error('Error creating database snapshot:', error);
                alert('Error creating database snapshot');
            }
        },
        
        async explainPAYE() {
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/advanced-audit/explainability/paye`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        gross_annual_income: this.payeInput.grossIncome,
                        basic_salary: this.payeInput.basicSalary,
                        period_year: new Date().getFullYear()
                    })
                });
                if (response.ok) {
                    const data = await response.json();
                    // Extract the explanation object and map fields for display
                    if (data.explanation) {
                        this.explainabilityResult = {
                            ...data.explanation,
                            total_tax: data.explanation.final_tax_amount,
                            tax_period: data.explanation.period ? 
                                `${data.explanation.period.start} to ${data.explanation.period.end}` : 
                                `Year ${new Date().getFullYear()}`,
                            is_valid: true
                        };
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }
        },
        
        async explainVAT() {
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/advanced-audit/explainability/vat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        output_vat_base: this.vatInput.outputVatBase,
                        input_vat_base: this.vatInput.inputVatBase,
                        wren_compliant_input: this.vatInput.inputVatBase,
                        non_compliant_input: 0,
                        period_month: new Date().getMonth() + 1,
                        period_year: new Date().getFullYear()
                    })
                });
                if (response.ok) {
                    const data = await response.json();
                    // Extract the explanation object and map fields for display
                    if (data.explanation) {
                        this.explainabilityResult = {
                            ...data.explanation,
                            total_tax: data.explanation.final_tax_amount,
                            tax_period: data.explanation.period ? 
                                `${data.explanation.period.start} to ${data.explanation.period.end}` : 
                                `Year ${new Date().getFullYear()}`,
                            is_valid: true
                        };
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }
        },
        
        async loadVaultStats() {
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/statistics`);
                if (response.ok) {
                    this.vaultStats = await response.json();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        },
        
        async loadVaultFiscalYears() {
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/fiscal-years`);
                if (response.ok) {
                    const data = await response.json();
                    this.vaultFiscalYears = data.fiscal_years || [];
                }
            } catch (error) {
                console.error('Error loading fiscal years:', error);
            }
        },
        
        async loadVaultTimeline() {
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/retention-timeline`);
                if (response.ok) {
                    const data = await response.json();
                    this.vaultTimeline = data.timeline || [];
                }
            } catch (error) {
                console.error('Error loading retention timeline:', error);
            }
        },
        
        async loadVaultRecords() {
            this.loading = true;
            try {
                const params = new URLSearchParams();
                params.append('skip', (this.vaultPage - 1) * this.vaultLimit);
                params.append('limit', this.vaultLimit);
                
                if (this.vaultFilter.fiscal_year) params.append('fiscal_year', this.vaultFilter.fiscal_year);
                if (this.vaultFilter.document_type) params.append('document_type', this.vaultFilter.document_type);
                if (this.vaultFilter.retention_status) params.append('retention_status', this.vaultFilter.retention_status);
                if (this.vaultFilter.search) params.append('search', this.vaultFilter.search);
                if (this.vaultFilter.start_date) params.append('start_date', this.vaultFilter.start_date);
                if (this.vaultFilter.end_date) params.append('end_date', this.vaultFilter.end_date);
                
                const response = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/records?${params.toString()}`);
                if (response.ok) {
                    const data = await response.json();
                    this.vaultRecords = data.items || [];
                    this.vaultTotal = data.total || 0;
                }
            } catch (error) {
                console.error('Error loading vault records:', error);
            } finally {
                this.loading = false;
            }
        },
        
        async viewVaultRecord(recordId) {
            this.loading = true;
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/records/${recordId}`);
                if (response.ok) {
                    this.selectedVaultRecord = await response.json();
                    this.showVaultDetailModal = true;
                } else {
                    alert('Failed to load record details');
                }
            } catch (error) {
                console.error('Error loading vault record:', error);
                alert('Error loading record details');
            } finally {
                this.loading = false;
            }
        },
        
        async verifyVaultRecord(recordId) {
            this.loading = true;
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/verify/${recordId}`, { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.verified) {
                        alert(`Record Verified Successfully\n\nRecord ID: ${data.record_id}\nHash: ${data.integrity_hash}\nVerified at: ${data.verification_time}`);
                    } else {
                        alert(`Verification Failed\n\n${data.error || 'Record integrity could not be verified'}`);
                    }
                } else {
                    const err = await response.json().catch(() => ({}));
                    alert(err.detail || 'Verification failed');
                }
            } catch (error) {
                console.error('Error verifying record:', error);
                alert('Error verifying record');
            } finally {
                this.loading = false;
            }
        },
        
        async verifyFiscalYear() {
            const year = this.vaultFilter.fiscal_year || new Date().getFullYear();
            if (!confirm(`Verify integrity of all records for fiscal year ${year}?`)) return;
            
            this.loading = true;
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/verify-year/${year}`, { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    let message = `Fiscal Year ${data.fiscal_year} Verification\n`;
                    message += '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';
                    message += `Status: ${data.verified ? 'VERIFIED' : 'FAILED'}\n`;
                    message += `Records Checked: ${data.record_count}\n`;
                    if (data.chain_hash) {
                        message += `Chain Hash: ${data.chain_hash.substring(0, 32)}...\n`;
                    }
                    if (data.first_record) {
                        message += `\nPeriod: ${data.first_record} to ${data.last_record}\n`;
                    }
                    message += `\nVerified at: ${data.verification_time}`;
                    alert(message);
                } else {
                    const err = await response.json().catch(() => ({}));
                    alert(err.detail || 'Fiscal year verification failed');
                }
            } catch (error) {
                console.error('Error verifying fiscal year:', error);
                alert('Error verifying fiscal year');
            } finally {
                this.loading = false;
            }
        },
        
        async showComplianceReport() {
            const year = this.vaultFilter.fiscal_year || new Date().getFullYear();
            this.loading = true;
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/compliance-report/${year}`);
                if (response.ok) {
                    this.complianceReport = await response.json();
                    this.showComplianceModal = true;
                } else {
                    const err = await response.json().catch(() => ({}));
                    alert(err.detail || 'Failed to load compliance report');
                }
            } catch (error) {
                console.error('Error loading compliance report:', error);
                alert('Error loading compliance report');
            } finally {
                this.loading = false;
            }
        },
        
        exportComplianceReport() {
            const year = this.complianceReport?.fiscal_year || new Date().getFullYear();
            window.location.href = `/api/v1/entities/${this.entityId}/audit/vault/export/${year}?include_full_data=true`;
        },
        
        async setLegalHold(recordId, enable) {
            const action = enable ? 'set' : 'remove';
            if (!confirm(`Are you sure you want to ${action} legal hold on this record?`)) return;
            
            this.loading = true;
            try {
                const response = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/legal-hold/${recordId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enable })
                });
                if (response.ok) {
                    alert(`Legal hold ${enable ? 'set' : 'removed'} successfully`);
                    await this.loadVaultRecords();
                    await this.loadVaultStats();
                } else {
                    const err = await response.json().catch(() => ({}));
                    alert(err.detail || `Failed to ${action} legal hold`);
                }
            } catch (error) {
                console.error('Error setting legal hold:', error);
                alert(`Error ${action}ing legal hold`);
            } finally {
                this.loading = false;
            }
        },
        
        async verifyVaultIntegrity() {
            this.loading = true;
            try {
                // Call the verify-integrity endpoint to check vault integrity
                const response = await authFetch(`/api/v1/entities/${this.entityId}/forensic-audit/verify-integrity`, { method: 'POST' });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Format a comprehensive result message
                    let message = 'Vault Integrity Verification Results\n';
                    message += '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';
                    
                    if (data.verified || data.valid) {
                        message += 'Status: VERIFIED\n\n';
                    } else {
                        message += 'Status: ISSUES DETECTED\n\n';
                    }
                    
                    message += `Records Checked: ${(data.records_checked || data.record_count || 0).toLocaleString()}\n`;
                    message += `Data Source: ${data.data_source || 'Database'}\n`;
                    
                    if (data.total_debit !== undefined && data.total_credit !== undefined) {
                        message += `\nFinancial Summary:\n`;
                        message += `   Total Debits:  ₦${parseFloat(data.total_debit).toLocaleString()}\n`;
                        message += `   Total Credits: ₦${parseFloat(data.total_credit).toLocaleString()}\n`;
                        
                        const diff = Math.abs(parseFloat(data.total_debit) - parseFloat(data.total_credit));
                        if (diff < 0.01) {
                            message += `   Balance: Balanced\n`;
                        } else {
                            message += `   Balance: Variance of ₦${diff.toLocaleString()}\n`;
                        }
                    }
                    
                    if (data.note) {
                        message += `\nNote: ${data.note}\n`;
                    }
                    
                    if (data.discrepancies && data.discrepancies.length > 0) {
                        message += `\nIssues Found (${data.discrepancies.length}):\n`;
                        data.discrepancies.slice(0, 5).forEach((issue, i) => {
                            message += `   ${i + 1}. ${issue.description || JSON.stringify(issue)}\n`;
                        });
                        if (data.discrepancies.length > 5) {
                            message += `   ... and ${data.discrepancies.length - 5} more\n`;
                        }
                    }
                    
                    message += '\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n';
                    message += `Verified: ${new Date().toLocaleString()}\n`;
                    message += `Compliance: NTAA 2025 5-Year Retention`;
                    
                    alert(message);
                    
                    // Refresh vault stats
                    await this.loadVaultStats();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    alert('Vault Verification Failed\n\n' + (errorData.detail || 'Unable to verify vault integrity. Please try again.'));
                }
            } catch (error) {
                console.error('Error verifying vault integrity:', error);
                alert('Network Error\n\nUnable to connect to the server. Please check your connection.');
            } finally {
                this.loading = false;
            }
        },
        
        async exportVaultRecords() {
            window.location.href = `/api/v1/entities/${this.entityId}/audit/vault/export/${new Date().getFullYear()}?format=xlsx`;
        },
        
        viewLogDetails(log) {
            alert(`Log Details:\n\nAction: ${log.action}\nEntity: ${log.target_entity_type}\nID: ${log.target_entity_id}\nUser: ${log.user_id || 'System'}\nIP: ${log.ip_address || 'N/A'}\n\nChanges: ${JSON.stringify(log.changes, null, 2)}`);
        },
        
        viewRunDetails(run) {
            this.selectedRun = run;
            this.showRunDetailsModal = true;
        },
        
        closeRunDetailsModal() {
            this.showRunDetailsModal = false;
            this.selectedRun = null;
        },
        
        getStatusClass(status) {
            const statusClasses = {
                'completed': 'bg-green-100 text-green-800',
                'running': 'bg-blue-100 text-blue-800',
                'pending': 'bg-yellow-100 text-yellow-800',
                'failed': 'bg-red-100 text-red-800'
            };
            return statusClasses[status] || 'bg-gray-100 text-gray-800';
        },
        
        formatRunType(type) {
            if (!type) return 'Unknown';
            return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        },
        
        async reproduceRun(runId) {
            if (this.reproducingRun) return;
            
            this.reproducingRun = true;
            try {
                const response = await authFetch(`/api/audit-system/runs/${runId}/reproduce`, { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    this.showSuccessToast(`Audit run reproduced successfully! New Run ID: ${data.new_run_id}`, data.new_run_id);
                    await this.loadAuditRuns();
                    this.closeRunDetailsModal();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    this.showErrorToast(errorData.detail || 'Failed to reproduce audit run');
                }
            } catch (error) {
                console.error('Error reproducing run:', error);
                this.showErrorToast('Network error: Could not connect to server');
            } finally {
                this.reproducingRun = false;
            }
        },
        
        async viewFullReport(runId) {
            if (!runId) {
                this.showErrorToast('No audit run selected');
                return;
            }
            try {
                const response = await authFetch(`/api/audit-system/report/run/${runId}/full`);
                if (response.ok) {
                    const report = await response.json();
                    // Store report and show in a modal or new section
                    this.fullReport = report;
                    this.showFullReportModal = true;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    this.showErrorToast(errorData.detail || errorData.message || 'Failed to load report');
                }
            } catch (error) {
                console.error('Error loading report:', error);
                this.showErrorToast('Network error: Could not load report');
            }
        },
        
        async exportToPDF(runId) {
            if (!runId) {
                this.showErrorToast('No audit run selected');
                return;
            }
            try {
                // Open the PDF download in a new window
                window.open(`/api/audit-system/report/run/${runId}/pdf-download`, '_blank');
                this.showSuccessToast('PDF report download started');
            } catch (error) {
                console.error('Error exporting PDF:', error);
                this.showErrorToast('Failed to export PDF');
            }
        },
        
        async exportToCSV(runId) {
            if (!runId) {
                this.showErrorToast('No audit run selected');
                return;
            }
            try {
                // Open the CSV download
                window.open(`/api/audit-system/export/run/${runId}/csv`, '_blank');
                this.showSuccessToast('CSV export download started');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                this.showErrorToast('Failed to export CSV');
            }
        },
        
        exportLogs() {
            window.location.href = `/api/v1/entities/${this.entityId}/audit/logs/export?format=csv`;
        },
        
        // Payroll Decisions Methods
        async loadPayrollDecisions() {
            try {
                // Load payroll runs for filter dropdown
                if (this.payrollRuns.length === 0) {
                    await this.loadPayrollRuns();
                }
                
                // Build query params - use page/per_page to match API
                const params = new URLSearchParams();
                params.append('page', this.payrollDecisionPage.toString());
                params.append('per_page', '20');
                
                if (this.payrollDecisionFilter.payroll_run_id) {
                    params.append('payroll_run_id', this.payrollDecisionFilter.payroll_run_id);
                }
                if (this.payrollDecisionFilter.decision_type) {
                    params.append('decision_type', this.payrollDecisionFilter.decision_type);
                }
                if (this.payrollDecisionFilter.category) {
                    params.append('category', this.payrollDecisionFilter.category);
                }
                
                const response = await authFetch(`/api/v1/payroll/advanced/decision-logs?${params.toString()}`);
                
                if (response.ok) {
                    const data = await response.json();
                    this.payrollDecisionLogs = (data.logs || []).map(log => ({...log, showImpact: false}));
                    this.payrollDecisionTotal = data.total || 0;
                    this.payrollDecisionPages = data.pages || 0;
                }
                
                // Also load summary
                const summaryParams = this.payrollDecisionFilter.payroll_run_id 
                    ? `?payroll_run_id=${this.payrollDecisionFilter.payroll_run_id}` 
                    : '';
                const summaryResponse = await authFetch(`/api/v1/payroll/advanced/decision-logs/summary${summaryParams}`);
                if (summaryResponse.ok) {
                    this.payrollDecisionSummary = await summaryResponse.json();
                }
            } catch (error) {
                console.error('Error loading payroll decisions:', error);
            }
        },
        
        async loadPayrollRuns() {
            try {
                const response = await authFetch(`/api/v1/payroll/runs?entity_id=${this.entityId}&limit=50`);
                if (response.ok) {
                    const data = await response.json();
                    this.payrollRuns = data.runs || data || [];
                }
            } catch (error) {
                console.error('Error loading payroll runs:', error);
            }
        },
        
        async exportPayrollDecisions() {
            const params = new URLSearchParams();
            params.append('entity_id', this.entityId);
            if (this.payrollDecisionFilter.payroll_run_id) {
                params.append('payroll_run_id', this.payrollDecisionFilter.payroll_run_id);
            }
            if (this.payrollDecisionFilter.decision_type) {
                params.append('decision_type', this.payrollDecisionFilter.decision_type);
            }
            window.location.href = `/api/v1/payroll/advanced/decision-logs/export?${params.toString()}`;
        },
        
        // Export forensic results to CSV
        exportForensicResult() {
            if (!this.forensicResult) return;
            
            let csv = '';
            const type = this.forensicResult._analysisType;
            
            if (type === 'nrs_gap') {
                csv = 'NRS Gap Analysis Report\n';
                csv += `Fiscal Year,${this.forensicResult.fiscal_year || new Date().getFullYear()}\n`;
                csv += `Compliance Rate,${(this.forensicResult.compliance_rate || 0).toFixed(1)}%\n\n`;
                
                if (this.forensicResult.gaps?.length) {
                    csv += 'Identified Gaps\n';
                    csv += 'Area,Description,Severity\n';
                    this.forensicResult.gaps.forEach(gap => {
                        const area = gap.area || gap.nrs_section || gap;
                        const desc = gap.description || '';
                        const sev = gap.severity || '';
                        csv += `"${area}","${desc}","${sev}"\n`;
                    });
                    csv += '\n';
                }
                
                if (this.forensicResult.recommendations?.length) {
                    csv += 'Recommendations\n';
                    this.forensicResult.recommendations.forEach((rec, i) => {
                        const text = rec.action || rec.recommendation || rec;
                        csv += `${i + 1},"${text}"\n`;
                    });
                }
            } else if (type === 'anomaly') {
                csv = 'Anomaly Detection Report\n\n';
                csv += 'Date,Amount,Z-Score,Risk Level\n';
                (this.forensicResult.anomalies || []).forEach(a => {
                    const date = a.date || a.transaction_date || '-';
                    const amount = a.amount || 0;
                    const zscore = (a.z_score || 0).toFixed(2);
                    const risk = Math.abs(a.z_score || 0) > 3 ? 'High' : 'Medium';
                    csv += `${date},${amount},${zscore},${risk}\n`;
                });
            } else if (type === 'benfords') {
                csv = 'Benford\'s Law Analysis\n';
                csv += `Conforms to Benford's Law,${this.forensicResult.conforms_to_benfords ? 'Yes' : 'No'}\n`;
                csv += `Chi-Square Value,${(this.forensicResult.chi_square || 0).toFixed(4)}\n\n`;
                csv += 'Digit,Expected %,Actual %\n';
                (this.forensicResult.digit_distribution || []).forEach((item, digit) => {
                    csv += `${digit + 1},${((item.expected || 0) * 100).toFixed(1)},${((item.actual || 0) * 100).toFixed(1)}\n`;
                });
            } else {
                csv = JSON.stringify(this.forensicResult, null, 2);
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `forensic_analysis_${type || 'results'}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        },
        
        // Print forensic results
        printForensicResult() {
            const printContents = document.querySelector('[x-show="forensicResult"]').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Forensic Analysis Report</title>
                    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
                    <style>
                        body { padding: 20px; font-family: system-ui, -apple-system, sans-serif; }
                        @media print { button { display: none !important; } }
                    </style>
                </head>
                <body>
                    <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">Forensic Analysis Report</h1>
                    <p style="color: gray; margin-bottom: 20px;">Generated: ${new Date().toLocaleString()}</p>
                    <pre style="background: #f3f4f6; padding: 16px; border-radius: 8px; overflow: auto;">${JSON.stringify(this.forensicResult, null, 2)}</pre>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 500);
        },
        
        // File Preview Helpers
        toggleFilePreview() {
            this.showFilePreview = !this.showFilePreview;
        },
        
        isImageFile(mimeType) {
            if (!mimeType) return false;
            return mimeType.startsWith('image/');
        },
        
        isTextFile(mimeType) {
            if (!mimeType) return false;
            const textTypes = ['text/plain', 'text/csv', 'application/json', 'text/html', 'text/xml', 'application/xml'];
            return textTypes.includes(mimeType) || mimeType.startsWith('text/');
        },
        
        async fetchTextPreview(evidenceId) {
            try {
                const response = await authFetch(`/api/evidence/${evidenceId}/preview?entity_id=${this.entityId}`);
                if (response.ok) {
                    const text = await response.text();
                    return text.substring(0, 5000) + (text.length > 5000 ? '\n\n... (truncated)' : '');
                }
                return 'Preview not available';
            } catch (error) {
                console.error('Error fetching text preview:', error);
                return 'Error loading preview';
            }
        },
        
        // Load Chain of Custody History
        async loadCustodyHistory(evidenceId) {
            try {
                // Try to fetch custody history from backend
                const response = await authFetch(`/api/evidence/${evidenceId}/custody?entity_id=${this.entityId}`);
                if (response.ok) {
                    const data = await response.json();
                    // Map backend response to expected format
                    const chain = data.custody_chain || data.history || [];
                    return chain.map(event => ({
                        action: event.event || event.action || 'unknown',
                        timestamp: event.timestamp,
                        user: event.user_name || event.user || 'System',
                        details: typeof event.details === 'object' 
                            ? (event.details.method || event.details.source || JSON.stringify(event.details))
                            : event.details
                    }));
                } else {
                    // Fallback: Build basic history from evidence metadata
                    return this.buildBasicCustodyHistory();
                }
            } catch (error) {
                console.error('Error loading custody history:', error);
                // Fallback: Build basic history from evidence metadata
                return this.buildBasicCustodyHistory();
            }
        },
        
        // Build basic custody history from evidence metadata
        buildBasicCustodyHistory() {
            if (!this.selectedEvidence) return [];
            
            const history = [];
            
            // Created event
            if (this.selectedEvidence.collected_at) {
                history.push({
                    action: 'created',
                    timestamp: this.selectedEvidence.collected_at,
                    user: this.selectedEvidence.collected_by || 'System',
                    details: `Evidence collected via ${this.selectedEvidence.collection_method || 'manual entry'}`
                });
            }
            
            // Verified event
            if (this.selectedEvidence.verified_at && this.selectedEvidence.is_verified) {
                history.push({
                    action: 'verified',
                    timestamp: this.selectedEvidence.verified_at,
                    user: this.selectedEvidence.verified_by || 'System',
                    details: 'Evidence integrity verified successfully'
                });
            }
            
            // If no events, show placeholder
            if (history.length === 0) {
                history.push({
                    action: 'created',
                    timestamp: this.selectedEvidence.created_at || new Date().toISOString(),
                    user: 'System',
                    details: 'Evidence record created'
                });
            }
            
            return history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        },
        
        formatCurrency(value) {
            if (!value && value !== 0) return '₦0.00';
            return '₦' + Number(value).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },
        
        formatDateTime(dateStr) {
            if (!dateStr) return 'N/A';
            return new Date(dateStr).toLocaleString('en-NG');
        },
        
        formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            return new Date(dateStr).toLocaleDateString('en-NG', { year: 'numeric', month: 'short', day: 'numeric' });
        },
        
        get filteredEvidence() {
            if (this.evidenceFilter === 'all') return this.evidenceList;
            return this.evidenceList.filter(e => e.evidence_type === this.evidenceFilter);
        }
    };
}
</script>
{% endblock %}

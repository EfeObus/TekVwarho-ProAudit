{% extends "base.html" %}

{% block title %}Payroll - TekVwarho ProAudit{% endblock %}

{% block content %}
<div x-data="payrollPage()" x-init="init()">
    <!-- Toast Notification -->
    <div x-show="toast.show" 
         x-transition:enter="transform ease-out duration-300 transition"
         x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2"
         x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0"
         x-transition:leave="transition ease-in duration-100"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-4 right-4 z-50"
         @click="toast.show = false">
        <div :class="{
            'bg-green-50 border-green-400 text-green-800': toast.type === 'success',
            'bg-red-50 border-red-400 text-red-800': toast.type === 'error',
            'bg-yellow-50 border-yellow-400 text-yellow-800': toast.type === 'warning',
            'bg-blue-50 border-blue-400 text-blue-800': toast.type === 'info'
        }" class="flex items-center p-4 rounded-lg shadow-lg border min-w-[320px] max-w-md">
            <!-- Success Icon -->
            <template x-if="toast.type === 'success'">
                <svg class="w-6 h-6 mr-3 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </template>
            <!-- Error Icon -->
            <template x-if="toast.type === 'error'">
                <svg class="w-6 h-6 mr-3 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </template>
            <!-- Warning Icon -->
            <template x-if="toast.type === 'warning'">
                <svg class="w-6 h-6 mr-3 text-yellow-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </template>
            <!-- Info Icon -->
            <template x-if="toast.type === 'info'">
                <svg class="w-6 h-6 mr-3 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </template>
            <div class="flex-1">
                <p class="font-medium" x-text="toast.title"></p>
                <p x-show="toast.message" class="text-sm mt-1 opacity-90" x-text="toast.message"></p>
            </div>
            <button @click.stop="toast.show = false" class="ml-4 text-gray-400 hover:text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Payroll Management</h1>
            <p class="text-gray-600">Nigerian-compliant payroll with PAYE, Pension, NHF & statutory deductions</p>
        </div>
        <div class="flex items-center space-x-3 mt-4 sm:mt-0">
            <button @click="showCalculatorModal = true" class="inline-flex items-center px-4 py-2 border border-green-600 text-green-600 rounded-lg hover:bg-green-50 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                Salary Calculator
            </button>
            <button @click="showRunPayrollModal = true" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Run Payroll
            </button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-8 overflow-x-auto">
            <button @click="activeTab = 'dashboard'" :class="activeTab === 'dashboard' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm">
                Dashboard
            </button>
            <button @click="activeTab = 'employees'; loadEmployees()" :class="activeTab === 'employees' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm">
                Employees
            </button>
            <button @click="activeTab = 'payroll-runs'; loadPayrollRuns()" :class="activeTab === 'payroll-runs' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm">
                Payroll Runs
            </button>
            <button @click="activeTab = 'remittances'" :class="activeTab === 'remittances' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm">
                Remittances
            </button>
            <button @click="activeTab = 'compliance'; loadComplianceStatus()" :class="activeTab === 'compliance' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                Compliance Status
            </button>
            <button @click="activeTab = 'impact-preview'; loadImpactPreview()" :class="activeTab === 'impact-preview' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                Impact Preview
            </button>
            <button @click="activeTab = 'exceptions'; loadExceptions()" :class="activeTab === 'exceptions' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                Exceptions
                <span x-show="exceptionSummary?.unacknowledged_count > 0" class="ml-1 px-1.5 py-0.5 text-xs bg-red-100 text-red-800 rounded-full" x-text="exceptionSummary?.unacknowledged_count"></span>
            </button>
            <button @click="activeTab = 'decision-logs'; loadDecisionLogs()" :class="activeTab === 'decision-logs' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Decision Logs
            </button>
            <button @click="activeTab = 'ytd-ledger'; loadYTDLedger()" :class="activeTab === 'ytd-ledger' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                YTD Ledger
            </button>
            <button @click="activeTab = 'ctc'; loadCTCData()" :class="activeTab === 'ctc' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                CTC Analytics
            </button>
            <button @click="activeTab = 'simulations'; loadSimulations()" :class="activeTab === 'simulations' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                What-If Simulations
            </button>
            <button @click="activeTab = 'ghost-detection'; loadGhostDetections()" :class="activeTab === 'ghost-detection' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                Ghost Detection
            </button>
            <button @click="activeTab = 'loans'" :class="activeTab === 'loans' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm">
                Loans & Advances
            </button>
        </nav>
    </div>

    <!-- Dashboard Tab -->
    <div x-show="activeTab === 'dashboard'" x-transition>
        <!-- 2026 PAYE Compliance Banner -->
        <div class="bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-semibold text-orange-800">2026 PAYE Tax Reform Active</h3>
                    <p class="text-sm text-orange-700">Progressive bands with ₦800,000 tax-free threshold. Rent Relief (20% up to ₦500K) now applies.</p>
                </div>
                <div class="ml-auto">
                    <span class="px-3 py-1 bg-orange-100 text-orange-800 text-xs rounded-full font-medium">Filing Due: 10th Monthly</span>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Employees -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Active Employees</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.active_employees || 0"></p>
                    </div>
                </div>
            </div>

            <!-- Monthly Gross -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Monthly Gross</p>
                        <p class="text-2xl font-bold text-gray-900">₦<span x-text="formatCurrency(stats.total_monthly_payroll || 0)"></span></p>
                    </div>
                </div>
            </div>

            <!-- Monthly PAYE -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-orange-100 text-orange-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Current Month PAYE</p>
                        <p class="text-2xl font-bold text-gray-900">₦<span x-text="formatCurrency(stats.current_month_paye || 0)"></span></p>
                    </div>
                </div>
            </div>

            <!-- Pending Remittances -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Pending Remittances</p>
                        <p class="text-2xl font-bold text-red-600" x-text="stats.pending_remittances?.length || 0"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statutory Summary -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Current Month Breakdown -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Current Month Statutory Summary</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="text-center p-4 bg-orange-50 rounded-lg">
                        <p class="text-2xl font-bold text-orange-600">₦<span x-text="formatCompact(stats.current_month_paye || 0)"></span></p>
                        <p class="text-xs text-gray-600 mt-1">PAYE Tax</p>
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-2xl font-bold text-blue-600">₦<span x-text="formatCompact(stats.current_month_pension || 0)"></span></p>
                        <p class="text-xs text-gray-600 mt-1">Pension</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <p class="text-2xl font-bold text-green-600">₦<span x-text="formatCompact(stats.current_month_nhf || 0)"></span></p>
                        <p class="text-xs text-gray-600 mt-1">NHF (2.5%)</p>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <p class="text-2xl font-bold text-purple-600">₦<span x-text="formatCompact(stats.current_month_nsitf || 0)"></span></p>
                        <p class="text-xs text-gray-600 mt-1">NSITF (1%)</p>
                    </div>
                    <div class="text-center p-4 bg-indigo-50 rounded-lg">
                        <p class="text-2xl font-bold text-indigo-600">₦<span x-text="formatCompact(stats.current_month_itf || 0)"></span></p>
                        <p class="text-xs text-gray-600 mt-1">ITF (1%)</p>
                    </div>
                </div>
            </div>

            <!-- Department Breakdown -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">By Department</h3>
                <div class="space-y-3 max-h-48 overflow-y-auto">
                    <template x-for="dept in stats.department_breakdown || []" :key="dept.department">
                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                            <div>
                                <p class="text-sm font-medium text-gray-900" x-text="dept.department"></p>
                                <p class="text-xs text-gray-500"><span x-text="dept.employee_count"></span> employees</p>
                            </div>
                            <p class="text-sm font-semibold text-gray-700">₦<span x-text="formatCompact(dept.total_salary)"></span></p>
                        </div>
                    </template>
                    <template x-if="!stats.department_breakdown || stats.department_breakdown.length === 0">
                        <p class="text-sm text-gray-500 text-center py-4">No department data</p>
                    </template>
                </div>
            </div>
        </div>

        <!-- Recent Payroll Runs & Pending Remittances -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Recent Payroll Runs -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Recent Payroll Runs</h3>
                    <button @click="activeTab = 'payroll-runs'" class="text-sm text-green-600 hover:text-green-700">View All →</button>
                </div>
                <div class="space-y-3">
                    <template x-for="run in stats.recent_payroll_runs || []" :key="run.id">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="text-sm font-medium text-gray-900" x-text="run.name"></p>
                                <p class="text-xs text-gray-500" x-text="run.payroll_code"></p>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 text-xs rounded-full font-medium"
                                      :class="{
                                          'bg-gray-100 text-gray-800': run.status === 'draft',
                                          'bg-yellow-100 text-yellow-800': run.status === 'pending_approval',
                                          'bg-blue-100 text-blue-800': run.status === 'approved',
                                          'bg-green-100 text-green-800': run.status === 'completed' || run.status === 'paid'
                                      }"
                                      x-text="run.status.replace('_', ' ').toUpperCase()"></span>
                                <p class="text-sm font-semibold text-gray-700 mt-1">₦<span x-text="formatCurrency(run.total_net_pay)"></span></p>
                            </div>
                        </div>
                    </template>
                    <template x-if="!stats.recent_payroll_runs || stats.recent_payroll_runs.length === 0">
                        <p class="text-sm text-gray-500 text-center py-4">No payroll runs yet</p>
                    </template>
                </div>
            </div>

            <!-- Pending Remittances -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Pending Remittances</h3>
                    <button @click="activeTab = 'remittances'" class="text-sm text-green-600 hover:text-green-700">View All →</button>
                </div>
                <div class="space-y-3">
                    <template x-for="rem in stats.pending_remittances || []" :key="rem.id">
                        <div class="flex items-center justify-between p-3 border rounded-lg"
                             :class="new Date(rem.due_date) < new Date() ? 'border-red-200 bg-red-50' : 'border-gray-200 bg-gray-50'">
                            <div>
                                <p class="text-sm font-medium text-gray-900 uppercase" x-text="rem.remittance_type"></p>
                                <p class="text-xs text-gray-500">Due: <span x-text="formatDate(rem.due_date)"></span></p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-gray-700">₦<span x-text="formatCurrency(rem.amount_due)"></span></p>
                                <span x-show="new Date(rem.due_date) < new Date()" class="text-xs text-red-600 font-medium">OVERDUE</span>
                            </div>
                        </div>
                    </template>
                    <template x-if="!stats.pending_remittances || stats.pending_remittances.length === 0">
                        <div class="text-center py-4">
                            <svg class="w-12 h-12 mx-auto text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-sm text-gray-500 mt-2">All remittances up to date!</p>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Employees Tab -->
    <div x-show="activeTab === 'employees'" x-transition>
        <!-- Search & Add -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <div class="flex-1">
                <input type="text" x-model="employeeSearch" @input="searchEmployees()" placeholder="Search employees by name, ID, or email..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
            </div>
            <div class="flex gap-2">
                <select x-model="departmentFilter" @change="loadEmployees()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    <option value="">All Departments</option>
                    <template x-for="dept in departments" :key="dept">
                        <option :value="dept" x-text="dept"></option>
                    </template>
                </select>
                <button @click="showEmployeeModal = true; resetEmployeeForm()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                    Add Employee
                </button>
            </div>
        </div>

        <!-- Employees Table -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly Gross</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TIN</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="emp in employees" :key="emp.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                                            <span class="text-green-600 font-semibold" x-text="emp.full_name?.charAt(0)?.toUpperCase() || 'E'"></span>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900" x-text="emp.full_name"></div>
                                            <div class="text-sm text-gray-500" x-text="emp.employee_id + ' • ' + (emp.job_title || 'No title')"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="emp.department || '-'"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">₦<span x-text="formatCurrency(emp.monthly_gross)"></span></div>
                                    <div class="text-xs text-gray-500">Basic: ₦<span x-text="formatCurrency(emp.basic_salary)"></span></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span x-text="emp.tin || 'Not provided'" class="text-sm" :class="emp.tin ? 'text-gray-900' : 'text-gray-400'"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span :class="{
                                        'bg-green-100 text-green-800': emp.employment_status === 'active',
                                        'bg-gray-100 text-gray-800': emp.employment_status === 'inactive',
                                        'bg-yellow-100 text-yellow-800': emp.employment_status === 'probation' || emp.employment_status === 'on_leave',
                                        'bg-red-100 text-red-800': emp.employment_status === 'terminated' || emp.employment_status === 'resigned'
                                    }" class="px-2 py-1 text-xs font-medium rounded-full" x-text="emp.employment_status?.replace('_', ' ').toUpperCase() || 'ACTIVE'"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                                    <div class="relative" x-data="{ open: false }">
                                        <button @click="open = !open" class="inline-flex items-center px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-700 bg-white hover:bg-gray-50">
                                            Actions <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                                        </button>
                                        <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10">
                                            <button @click="editEmployee(emp); open = false" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                                Edit
                                            </button>
                                            <button @click="viewPayslips(emp.id); open = false" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                                View Payslips
                                            </button>
                                            <button @click="viewLoans(emp.id); open = false" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                                Loans & Advances
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <template x-if="employees.length === 0">
                <div class="text-center py-12">
                    <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">No employees yet</h3>
                    <p class="mt-2 text-gray-500">Add your first employee to get started with payroll.</p>
                    <button @click="showEmployeeModal = true; resetEmployeeForm()" class="mt-4 inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Add Employee
                    </button>
                </div>
            </template>

            <!-- Pagination -->
            <div x-show="employees.length > 0" class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
                <p class="text-sm text-gray-700">
                    Showing <span x-text="((employeePage - 1) * employeePerPage) + 1"></span> to <span x-text="Math.min(employeePage * employeePerPage, employeeTotal)"></span> of <span x-text="employeeTotal"></span> employees
                </p>
                <div class="flex space-x-2">
                    <button @click="employeePage > 1 && (employeePage--, loadEmployees())" :disabled="employeePage <= 1" class="px-3 py-1 border rounded text-sm disabled:opacity-50">Previous</button>
                    <button @click="employeePage < employeePages && (employeePage++, loadEmployees())" :disabled="employeePage >= employeePages" class="px-3 py-1 border rounded text-sm disabled:opacity-50">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payroll Runs Tab -->
    <div x-show="activeTab === 'payroll-runs'" x-transition>
        <!-- Filter -->
        <div class="flex gap-4 mb-6">
            <select x-model="payrollYear" @change="loadPayrollRuns()" class="px-4 py-2 border border-gray-300 rounded-lg">
                <template x-for="y in [2026, 2025, 2024]" :key="y">
                    <option :value="y" x-text="y"></option>
                </template>
            </select>
            <select x-model="payrollStatusFilter" @change="loadPayrollRuns()" class="px-4 py-2 border border-gray-300 rounded-lg">
                <option value="">All Status</option>
                <option value="draft">Draft</option>
                <option value="approved">Approved</option>
                <option value="completed">Completed</option>
                <option value="paid">Paid</option>
            </select>
        </div>

        <!-- Payroll Runs List -->
        <div class="space-y-4">
            <template x-for="run in payrollRuns" :key="run.id">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="flex items-center space-x-3">
                                <h3 class="text-lg font-semibold text-gray-900" x-text="run.name"></h3>
                                <span class="px-2 py-1 text-xs rounded-full font-medium"
                                      :class="{
                                          'bg-gray-100 text-gray-800': run.status === 'draft',
                                          'bg-yellow-100 text-yellow-800': run.status === 'pending_approval',
                                          'bg-blue-100 text-blue-800': run.status === 'approved',
                                          'bg-purple-100 text-purple-800': run.status === 'processing',
                                          'bg-green-100 text-green-800': run.status === 'completed',
                                          'bg-emerald-100 text-emerald-800': run.status === 'paid'
                                      }"
                                      x-text="run.status.replace('_', ' ').toUpperCase()"></span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">
                                <span x-text="run.payroll_code"></span> • 
                                Period: <span x-text="formatDate(run.period_start)"></span> - <span x-text="formatDate(run.period_end)"></span>
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            <button @click="viewPayrollDetails(run.id)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">View Details</button>
                            <template x-if="run.status === 'draft'">
                                <button @click="approvePayroll(run.id)" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Approve</button>
                            </template>
                            <template x-if="run.status === 'approved'">
                                <button @click="processPayroll(run.id)" class="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700">Process</button>
                            </template>
                            <template x-if="run.status === 'completed'">
                                <button @click="markPayrollPaid(run.id)" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700">Mark Paid</button>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Summary -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4 pt-4 border-t border-gray-100">
                        <div>
                            <p class="text-xs text-gray-500">Employees</p>
                            <p class="text-lg font-semibold text-gray-900" x-text="run.total_employees"></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Gross Pay</p>
                            <p class="text-lg font-semibold text-gray-900">₦<span x-text="formatCurrency(run.total_gross_pay)"></span></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Deductions</p>
                            <p class="text-lg font-semibold text-red-600">₦<span x-text="formatCurrency(run.total_deductions)"></span></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Net Pay</p>
                            <p class="text-lg font-semibold text-green-600">₦<span x-text="formatCurrency(run.total_net_pay)"></span></p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Payment Date</p>
                            <p class="text-lg font-semibold text-gray-900" x-text="formatDate(run.payment_date)"></p>
                        </div>
                    </div>
                </div>
            </template>

            <template x-if="payrollRuns.length === 0">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
                    <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">No payroll runs yet</h3>
                    <p class="mt-2 text-gray-500">Create your first payroll run to process employee salaries.</p>
                    <button @click="showRunPayrollModal = true" class="mt-4 inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Run Payroll
                    </button>
                </div>
            </template>
        </div>
    </div>

    <!-- Remittances Tab -->
    <div x-show="activeTab === 'remittances'" x-transition>
        <div class="flex gap-4 mb-6">
            <select x-model="remittanceType" @change="loadRemittances()" class="px-4 py-2 border border-gray-300 rounded-lg">
                <option value="">All Types</option>
                <option value="paye">PAYE</option>
                <option value="pension">Pension</option>
                <option value="nhf">NHF</option>
                <option value="nsitf">NSITF</option>
                <option value="itf">ITF</option>
            </select>
            <select x-model="remittancePaid" @change="loadRemittances()" class="px-4 py-2 border border-gray-300 rounded-lg">
                <option value="">All Status</option>
                <option value="false">Pending</option>
                <option value="true">Paid</option>
            </select>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Period</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount Due</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Due Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    <template x-for="rem in remittances" :key="rem.id">
                        <tr :class="!rem.is_paid && new Date(rem.due_date) < new Date() ? 'bg-red-50' : ''">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-medium rounded uppercase"
                                      :class="{
                                          'bg-orange-100 text-orange-800': rem.remittance_type === 'paye',
                                          'bg-blue-100 text-blue-800': rem.remittance_type === 'pension',
                                          'bg-green-100 text-green-800': rem.remittance_type === 'nhf',
                                          'bg-purple-100 text-purple-800': rem.remittance_type === 'nsitf',
                                          'bg-indigo-100 text-indigo-800': rem.remittance_type === 'itf'
                                      }"
                                      x-text="rem.remittance_type"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="getMonthName(rem.period_month) + ' ' + rem.period_year"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">₦<span x-text="formatCurrency(rem.amount_due)"></span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm" :class="!rem.is_paid && new Date(rem.due_date) < new Date() ? 'text-red-600 font-medium' : 'text-gray-900'" x-text="formatDate(rem.due_date)"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="rem.is_paid ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'" class="px-2 py-1 text-xs font-medium rounded-full" x-text="rem.is_paid ? 'Paid' : 'Pending'"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <template x-if="!rem.is_paid">
                                    <button @click="markRemittancePaid(rem)" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700">Mark Paid</button>
                                </template>
                                <template x-if="rem.is_paid">
                                    <span class="text-sm text-gray-500">Paid: <span x-text="formatDate(rem.payment_date)"></span></span>
                                </template>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Compliance Status Tab -->
    <div x-show="activeTab === 'compliance'" x-transition>
        <!-- Compliance Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Statutory Compliance Status</h2>
                <p class="text-sm text-gray-500">PAYE, Pension, NHF, NSITF & ITF remittance tracking with penalty estimates</p>
            </div>
            <div class="flex space-x-3">
                <select x-model="complianceYear" @change="loadComplianceCalendar()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <template x-for="y in [2026, 2025, 2024]" :key="y">
                        <option :value="y" x-text="y"></option>
                    </template>
                </select>
                <button @click="refreshComplianceSnapshot()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Overall Status Banner -->
        <div x-show="complianceData" class="mb-6">
            <div :class="{
                'bg-green-50 border-green-200': complianceData?.overall_status === 'compliant',
                'bg-yellow-50 border-yellow-200': complianceData?.overall_status === 'at_risk',
                'bg-red-50 border-red-200': complianceData?.overall_status === 'overdue'
            }" class="rounded-lg border p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <template x-if="complianceData?.overall_status === 'compliant'">
                            <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </template>
                        <template x-if="complianceData?.overall_status === 'at_risk'">
                            <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </template>
                        <template x-if="complianceData?.overall_status === 'overdue'">
                            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </template>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 :class="{
                            'text-green-800': complianceData?.overall_status === 'compliant',
                            'text-yellow-800': complianceData?.overall_status === 'at_risk',
                            'text-red-800': complianceData?.overall_status === 'overdue'
                        }" class="font-semibold" x-text="complianceData?.current_period?.snapshot?.summary_message || 'Loading...'"></h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Period: <span x-text="getMonthName(complianceData?.current_period?.month)"></span> <span x-text="complianceData?.current_period?.year"></span>
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Total Penalty Exposure</p>
                        <p :class="{
                            'text-green-700': complianceData?.current_period?.snapshot?.total_penalty_exposure === 0,
                            'text-red-700 font-bold': complianceData?.current_period?.snapshot?.total_penalty_exposure > 0
                        }" class="text-xl">₦<span x-text="formatCurrency(complianceData?.current_period?.snapshot?.total_penalty_exposure || 0)"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Period Remittance Cards -->
        <div x-show="complianceData?.current_period?.snapshot" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <!-- PAYE Card -->
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-gray-900">PAYE</h4>
                    <span :class="{
                        'bg-green-100 text-green-800': complianceData?.current_period?.snapshot?.paye_status?.status === 'on_time',
                        'bg-gray-100 text-gray-800': complianceData?.current_period?.snapshot?.paye_status?.status === 'not_due',
                        'bg-yellow-100 text-yellow-800': complianceData?.current_period?.snapshot?.paye_status?.status === 'penalty_risk' || complianceData?.current_period?.snapshot?.paye_status?.status === 'partially_paid',
                        'bg-red-100 text-red-800': complianceData?.current_period?.snapshot?.paye_status?.status === 'overdue'
                    }" class="px-2 py-1 text-xs rounded-full font-medium" x-text="complianceData?.current_period?.snapshot?.paye_status?.status?.replace('_', ' ') || '-'"></span>
                </div>
                <p class="text-2xl font-bold text-gray-900">₦<span x-text="formatCompact(complianceData?.current_period?.snapshot?.paye_status?.amount_due || 0)"></span></p>
                <p class="text-xs text-gray-500 mt-1">
                    Paid: ₦<span x-text="formatCompact(complianceData?.current_period?.snapshot?.paye_status?.amount_paid || 0)"></span>
                </p>
                <p class="text-xs text-gray-400 mt-2" x-text="complianceData?.current_period?.snapshot?.paye_status?.human_message"></p>
            </div>

            <!-- Pension Card -->
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-gray-900">Pension</h4>
                    <span :class="{
                        'bg-green-100 text-green-800': complianceData?.current_period?.snapshot?.pension_status?.status === 'on_time',
                        'bg-gray-100 text-gray-800': complianceData?.current_period?.snapshot?.pension_status?.status === 'not_due',
                        'bg-yellow-100 text-yellow-800': complianceData?.current_period?.snapshot?.pension_status?.status === 'penalty_risk' || complianceData?.current_period?.snapshot?.pension_status?.status === 'partially_paid',
                        'bg-red-100 text-red-800': complianceData?.current_period?.snapshot?.pension_status?.status === 'overdue'
                    }" class="px-2 py-1 text-xs rounded-full font-medium" x-text="complianceData?.current_period?.snapshot?.pension_status?.status?.replace('_', ' ') || '-'"></span>
                </div>
                <p class="text-2xl font-bold text-gray-900">₦<span x-text="formatCompact(complianceData?.current_period?.snapshot?.pension_status?.amount_due || 0)"></span></p>
                <p class="text-xs text-gray-500 mt-1">
                    Paid: ₦<span x-text="formatCompact(complianceData?.current_period?.snapshot?.pension_status?.amount_paid || 0)"></span>
                </p>
                <p class="text-xs text-gray-400 mt-2" x-text="complianceData?.current_period?.snapshot?.pension_status?.human_message"></p>
            </div>

            <!-- NHF Card -->
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-gray-900">NHF</h4>
                    <span :class="{
                        'bg-green-100 text-green-800': complianceData?.current_period?.snapshot?.nhf_status?.status === 'on_time',
                        'bg-gray-100 text-gray-800': complianceData?.current_period?.snapshot?.nhf_status?.status === 'not_due',
                        'bg-yellow-100 text-yellow-800': complianceData?.current_period?.snapshot?.nhf_status?.status === 'penalty_risk' || complianceData?.current_period?.snapshot?.nhf_status?.status === 'partially_paid',
                        'bg-red-100 text-red-800': complianceData?.current_period?.snapshot?.nhf_status?.status === 'overdue'
                    }" class="px-2 py-1 text-xs rounded-full font-medium" x-text="complianceData?.current_period?.snapshot?.nhf_status?.status?.replace('_', ' ') || '-'"></span>
                </div>
                <p class="text-2xl font-bold text-gray-900">₦<span x-text="formatCompact(complianceData?.current_period?.snapshot?.nhf_status?.amount_due || 0)"></span></p>
                <p class="text-xs text-gray-500 mt-1">
                    Paid: ₦<span x-text="formatCompact(complianceData?.current_period?.snapshot?.nhf_status?.amount_paid || 0)"></span>
                </p>
                <p class="text-xs text-gray-400 mt-2" x-text="complianceData?.current_period?.snapshot?.nhf_status?.human_message"></p>
            </div>

            <!-- NSITF Card -->
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-gray-900">NSITF</h4>
                    <span :class="{
                        'bg-green-100 text-green-800': complianceData?.current_period?.snapshot?.nsitf_status?.status === 'on_time',
                        'bg-gray-100 text-gray-800': complianceData?.current_period?.snapshot?.nsitf_status?.status === 'not_due',
                        'bg-yellow-100 text-yellow-800': complianceData?.current_period?.snapshot?.nsitf_status?.status === 'partially_paid',
                        'bg-red-100 text-red-800': complianceData?.current_period?.snapshot?.nsitf_status?.status === 'overdue'
                    }" class="px-2 py-1 text-xs rounded-full font-medium" x-text="complianceData?.current_period?.snapshot?.nsitf_status?.status?.replace('_', ' ') || '-'"></span>
                </div>
                <p class="text-2xl font-bold text-gray-900">₦<span x-text="formatCompact(complianceData?.current_period?.snapshot?.nsitf_status?.amount_due || 0)"></span></p>
                <p class="text-xs text-gray-500 mt-1">
                    Paid: ₦<span x-text="formatCompact(complianceData?.current_period?.snapshot?.nsitf_status?.amount_paid || 0)"></span>
                </p>
            </div>

            <!-- ITF Card -->
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-gray-900">ITF</h4>
                    <span :class="{
                        'bg-green-100 text-green-800': complianceData?.current_period?.snapshot?.itf_status?.status === 'on_time',
                        'bg-gray-100 text-gray-800': complianceData?.current_period?.snapshot?.itf_status?.status === 'not_due',
                        'bg-yellow-100 text-yellow-800': complianceData?.current_period?.snapshot?.itf_status?.status === 'partially_paid',
                        'bg-red-100 text-red-800': complianceData?.current_period?.snapshot?.itf_status?.status === 'overdue'
                    }" class="px-2 py-1 text-xs rounded-full font-medium" x-text="complianceData?.current_period?.snapshot?.itf_status?.status?.replace('_', ' ') || '-'"></span>
                </div>
                <p class="text-2xl font-bold text-gray-900">₦<span x-text="formatCompact(complianceData?.current_period?.snapshot?.itf_status?.amount_due || 0)"></span></p>
                <p class="text-xs text-gray-500 mt-1">
                    Paid: ₦<span x-text="formatCompact(complianceData?.current_period?.snapshot?.itf_status?.amount_paid || 0)"></span>
                </p>
            </div>
        </div>

        <!-- YTD Summary -->
        <div x-show="complianceData?.ytd_summary" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Year-to-Date Summary</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="text-gray-600">PAYE Due / Paid</span>
                        <div class="text-right">
                            <span class="font-medium">₦<span x-text="formatCompact(complianceData?.ytd_summary?.paye_due || 0)"></span></span>
                            <span class="text-gray-400">/</span>
                            <span class="text-green-600">₦<span x-text="formatCompact(complianceData?.ytd_summary?.paye_paid || 0)"></span></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="text-gray-600">Pension Due / Paid</span>
                        <div class="text-right">
                            <span class="font-medium">₦<span x-text="formatCompact(complianceData?.ytd_summary?.pension_due || 0)"></span></span>
                            <span class="text-gray-400">/</span>
                            <span class="text-green-600">₦<span x-text="formatCompact(complianceData?.ytd_summary?.pension_paid || 0)"></span></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="text-gray-600">NHF Due / Paid</span>
                        <div class="text-right">
                            <span class="font-medium">₦<span x-text="formatCompact(complianceData?.ytd_summary?.nhf_due || 0)"></span></span>
                            <span class="text-gray-400">/</span>
                            <span class="text-green-600">₦<span x-text="formatCompact(complianceData?.ytd_summary?.nhf_paid || 0)"></span></span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-2 pt-4 border-t-2 border-gray-300">
                        <span class="font-semibold text-gray-900">Total Penalty Exposure</span>
                        <span :class="complianceData?.ytd_summary?.total_penalty_exposure > 0 ? 'text-red-600 font-bold' : 'text-green-600 font-bold'">
                            ₦<span x-text="formatCurrency(complianceData?.ytd_summary?.total_penalty_exposure || 0)"></span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Compliance Calendar -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Compliance Calendar <span x-text="complianceYear"></span></h3>
                <div class="grid grid-cols-4 gap-2">
                    <template x-for="m in complianceCalendar?.months || []" :key="m.month">
                        <div :class="{
                            'bg-green-100 border-green-300': m.status === 'reviewed' && !m.has_penalty && (m.paye_status === 'on_time' || m.paye_status === 'not_due'),
                            'bg-yellow-100 border-yellow-300': m.status === 'reviewed' && (m.paye_status === 'partially_paid' || m.paye_status === 'penalty_risk'),
                            'bg-red-100 border-red-300': m.status === 'reviewed' && (m.paye_status === 'overdue' || m.has_penalty),
                            'bg-gray-100 border-gray-300': m.status === 'pending',
                            'bg-gray-50 border-gray-200': m.status === 'future'
                        }" class="p-3 rounded-lg border text-center cursor-pointer hover:shadow" @click="viewComplianceMonth(m.month)">
                            <p class="text-sm font-medium" x-text="getMonthName(m.month)"></p>
                            <template x-if="m.status === 'reviewed'">
                                <p class="text-xs mt-1">₦<span x-text="formatCompact(m.paye_amount || 0)"></span></p>
                            </template>
                            <template x-if="m.status === 'future'">
                                <p class="text-xs mt-1 text-gray-400">Future</p>
                            </template>
                            <template x-if="m.status === 'pending'">
                                <p class="text-xs mt-1 text-gray-500">Pending</p>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="!complianceData" class="bg-white rounded-lg shadow-sm border p-8 text-center">
            <div class="animate-spin w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-gray-500">Loading compliance status...</p>
        </div>
    </div>

    <!-- Impact Preview Tab -->
    <div x-show="activeTab === 'impact-preview'" x-transition>
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Payroll Impact Preview</h2>
                <p class="text-sm text-gray-500 mt-1">Compare current vs. previous payroll runs with variance analysis</p>
            </div>
            <div class="flex items-center gap-3">
                <select x-model="impactPreviewYear" @change="loadImpactPreviewHistory()" class="rounded-lg border-gray-300 text-sm">
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                    <option value="2017">2017</option>
                    <option value="2016">2016</option>
                    <option value="2015">2015</option>
                </select>
                <button @click="refreshImpactPreview()" :disabled="impactLoading" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
                    <svg :class="impactLoading ? 'animate-spin' : ''" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Impact Preview History (Yearly) -->
        <div x-show="impactPreviewHistory.length > 0" class="mb-6">
            <div class="bg-white rounded-lg border shadow-sm">
                <div class="px-4 py-3 border-b bg-gray-50">
                    <h3 class="font-semibold text-gray-900">Impact Review History - <span x-text="impactPreviewYear"></span></h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Period</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Gross Payroll</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Net Payroll</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">PAYE Tax</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Variance</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Employees</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <template x-for="preview in impactPreviewHistory" :key="preview.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900" x-text="preview.payroll_run_name || preview.period_name || formatDate(preview.generated_at)"></td>
                                    <td class="px-4 py-3 text-sm text-right text-gray-900">₦<span x-text="formatNumber(preview.current_gross || 0)"></span></td>
                                    <td class="px-4 py-3 text-sm text-right text-gray-900">₦<span x-text="formatNumber(preview.current_net || 0)"></span></td>
                                    <td class="px-4 py-3 text-sm text-right text-gray-600">₦<span x-text="formatNumber(preview.current_paye || 0)"></span></td>
                                    <td class="px-4 py-3 text-sm text-right">
                                        <span :class="(preview.gross_variance || 0) >= 0 ? 'text-red-600' : 'text-green-600'">
                                            <span x-text="(preview.gross_variance || 0) >= 0 ? '+' : ''"></span>₦<span x-text="formatNumber(Math.abs(preview.gross_variance || 0))"></span>
                                            (<span x-text="((preview.gross_variance_percent || 0) >= 0 ? '+' : '') + (preview.gross_variance_percent || 0).toFixed(1)"></span>%)
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-center text-gray-600" x-text="preview.current_employee_count || 0"></td>
                                    <td class="px-4 py-3 text-center">
                                        <button @click="viewImpactPreviewDetails(preview)" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg" title="View Details">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                        <!-- Yearly Totals Row -->
                        <tfoot class="bg-gray-100">
                            <tr>
                                <td class="px-4 py-3 text-sm font-bold text-gray-900">Year Total (<span x-text="impactPreviewHistory.length"></span> payrolls)</td>
                                <td class="px-4 py-3 text-sm text-right font-bold text-gray-900">₦<span x-text="formatNumber(impactPreviewHistory.reduce((sum, p) => sum + (p.current_gross || 0), 0))"></span></td>
                                <td class="px-4 py-3 text-sm text-right font-bold text-gray-900">₦<span x-text="formatNumber(impactPreviewHistory.reduce((sum, p) => sum + (p.current_net || 0), 0))"></span></td>
                                <td class="px-4 py-3 text-sm text-right font-bold text-gray-600">₦<span x-text="formatNumber(impactPreviewHistory.reduce((sum, p) => sum + (p.current_paye || 0), 0))"></span></td>
                                <td class="px-4 py-3 text-sm text-right font-bold">
                                    <span :class="impactPreviewHistory.reduce((sum, p) => sum + (p.gross_variance || 0), 0) >= 0 ? 'text-red-600' : 'text-green-600'">
                                        ₦<span x-text="formatNumber(Math.abs(impactPreviewHistory.reduce((sum, p) => sum + (p.gross_variance || 0), 0)))"></span>
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-sm text-center font-bold text-gray-600">-</td>
                                <td class="px-4 py-3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Impact Preview Content -->
        <div x-show="impactPreview && impactPreview.has_preview !== false">
            <!-- Summary Card -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 p-6 mb-6">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-lg font-semibold text-gray-900">Impact Summary</h3>
                        <p class="mt-2 text-gray-700" x-text="impactPreview?.impact_summary || 'No summary available'"></p>
                        <p class="mt-2 text-sm text-gray-500" x-show="impactPreview?.generated_at">
                            Generated: <span x-text="formatDateTime(impactPreview?.generated_at)"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Variance Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Gross Variance -->
                <div class="bg-white rounded-lg border shadow-sm p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Gross Payroll</p>
                            <p class="text-2xl font-bold text-gray-900">₦<span x-text="formatNumber(impactPreview?.current_gross || 0)"></span></p>
                        </div>
                        <div :class="(impactPreview?.gross_variance || 0) >= 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'" class="px-2 py-1 rounded-full text-xs font-medium flex items-center">
                            <svg x-show="(impactPreview?.gross_variance || 0) >= 0" class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                            <svg x-show="(impactPreview?.gross_variance || 0) < 0" class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span x-text="((impactPreview?.gross_variance_percent || 0) >= 0 ? '+' : '') + (impactPreview?.gross_variance_percent || 0).toFixed(1) + '%'"></span>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-gray-500">
                        Variance: ₦<span x-text="formatNumber(Math.abs(impactPreview?.gross_variance || 0))"></span>
                        <span :class="(impactPreview?.gross_variance || 0) >= 0 ? 'text-red-600' : 'text-green-600'" x-text="(impactPreview?.gross_variance || 0) >= 0 ? '↑' : '↓'"></span>
                    </p>
                </div>

                <!-- Net Variance -->
                <div class="bg-white rounded-lg border shadow-sm p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Net Payroll</p>
                            <p class="text-2xl font-bold text-gray-900">₦<span x-text="formatNumber(impactPreview?.current_net || 0)"></span></p>
                        </div>
                        <div :class="(impactPreview?.net_variance || 0) >= 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'" class="px-2 py-1 rounded-full text-xs font-medium">
                            <span x-text="(impactPreview?.net_variance || 0) >= 0 ? '+₦' + formatNumber(impactPreview?.net_variance || 0) : '-₦' + formatNumber(Math.abs(impactPreview?.net_variance || 0))"></span>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-gray-500">
                        Previous: ₦<span x-text="formatNumber(impactPreview?.previous_net || 0)"></span>
                    </p>
                </div>

                <!-- PAYE Variance -->
                <div class="bg-white rounded-lg border shadow-sm p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">PAYE Tax</p>
                            <p class="text-2xl font-bold text-gray-900">₦<span x-text="formatNumber(impactPreview?.current_paye || 0)"></span></p>
                        </div>
                        <div :class="(impactPreview?.paye_variance || 0) >= 0 ? 'bg-amber-100 text-amber-800' : 'bg-green-100 text-green-800'" class="px-2 py-1 rounded-full text-xs font-medium">
                            <span x-text="(impactPreview?.paye_variance || 0) >= 0 ? '+₦' + formatNumber(impactPreview?.paye_variance || 0) : '-₦' + formatNumber(Math.abs(impactPreview?.paye_variance || 0))"></span>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-gray-500">
                        Previous: ₦<span x-text="formatNumber(impactPreview?.previous_paye || 0)"></span>
                    </p>
                </div>

                <!-- Employer Cost Variance -->
                <div class="bg-white rounded-lg border shadow-sm p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Employer Cost</p>
                            <p class="text-2xl font-bold text-gray-900">₦<span x-text="formatNumber(impactPreview?.current_employer_cost || 0)"></span></p>
                        </div>
                        <div :class="(impactPreview?.employer_cost_variance || 0) >= 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'" class="px-2 py-1 rounded-full text-xs font-medium">
                            <span x-text="(impactPreview?.employer_cost_variance || 0) >= 0 ? '+₦' + formatNumber(impactPreview?.employer_cost_variance || 0) : '-₦' + formatNumber(Math.abs(impactPreview?.employer_cost_variance || 0))"></span>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-gray-500">
                        Previous: ₦<span x-text="formatNumber(impactPreview?.previous_employer_cost || 0)"></span>
                    </p>
                </div>
            </div>

            <!-- Headcount & Variance Drivers -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Headcount Changes -->
                <div class="bg-white rounded-lg border shadow-sm">
                    <div class="px-4 py-3 border-b bg-gray-50">
                        <h3 class="font-semibold text-gray-900">Headcount Changes</h3>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Current vs Previous -->
                            <div class="bg-blue-50 rounded-lg p-4 text-center">
                                <p class="text-3xl font-bold text-blue-600" x-text="impactPreview?.current_employee_count || 0"></p>
                                <p class="text-sm text-gray-600 mt-1">Current Employees</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4 text-center">
                                <p class="text-3xl font-bold text-gray-600" x-text="impactPreview?.previous_employee_count || 0"></p>
                                <p class="text-sm text-gray-600 mt-1">Previous Employees</p>
                            </div>
                            <!-- New Hires -->
                            <div class="bg-green-50 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-2xl font-bold text-green-600" x-text="impactPreview?.new_hires_count || 0"></p>
                                        <p class="text-sm text-gray-600">New Hires</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-medium text-green-600">+₦<span x-text="formatNumber(impactPreview?.new_hires_cost || 0)"></span></p>
                                        <p class="text-xs text-gray-500">Added Cost</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Terminations -->
                            <div class="bg-red-50 rounded-lg p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-2xl font-bold text-red-600" x-text="impactPreview?.terminations_count || 0"></p>
                                        <p class="text-sm text-gray-600">Terminations</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-medium text-green-600">-₦<span x-text="formatNumber(impactPreview?.terminations_savings || 0)"></span></p>
                                        <p class="text-xs text-gray-500">Savings</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Variance Drivers -->
                <div class="bg-white rounded-lg border shadow-sm">
                    <div class="px-4 py-3 border-b bg-gray-50">
                        <h3 class="font-semibold text-gray-900">Top Variance Drivers</h3>
                    </div>
                    <div class="p-4">
                        <template x-if="impactPreview?.variance_drivers && impactPreview.variance_drivers.length > 0">
                            <div class="space-y-3">
                                <template x-for="(driver, index) in impactPreview.variance_drivers" :key="index">
                                    <div class="flex items-center justify-between p-3 rounded-lg" :class="driver.amount >= 0 ? 'bg-red-50' : 'bg-green-50'">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3" :class="driver.amount >= 0 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'">
                                                <span x-text="index + 1" class="font-bold text-sm"></span>
                                            </div>
                                            <div>
                                                <p class="font-medium text-gray-900" x-text="driver.description"></p>
                                                <p class="text-xs text-gray-500"><span x-text="driver.affected_employees || 0"></span> employee(s) affected</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-semibold" :class="driver.amount >= 0 ? 'text-red-600' : 'text-green-600'">
                                                <span x-text="driver.amount >= 0 ? '+' : '-'"></span>₦<span x-text="formatNumber(Math.abs(driver.amount))"></span>
                                            </p>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="!impactPreview?.variance_drivers || impactPreview.variance_drivers.length === 0">
                            <div class="text-center py-6 text-gray-500">
                                <svg class="w-12 h-12 mx-auto text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <p>No variance drivers identified</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Period Comparison Table -->
            <div class="bg-white rounded-lg border shadow-sm">
                <div class="px-4 py-3 border-b bg-gray-50">
                    <h3 class="font-semibold text-gray-900">Period-over-Period Comparison</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Metric</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Previous Period</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Current Period</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Variance</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">Gross Payroll</td>
                                <td class="px-4 py-3 text-sm text-right text-gray-600">₦<span x-text="formatNumber(impactPreview?.previous_gross || 0)"></span></td>
                                <td class="px-4 py-3 text-sm text-right text-gray-900 font-medium">₦<span x-text="formatNumber(impactPreview?.current_gross || 0)"></span></td>
                                <td class="px-4 py-3 text-sm text-right" :class="(impactPreview?.gross_variance || 0) >= 0 ? 'text-red-600' : 'text-green-600'">
                                    <span x-text="(impactPreview?.gross_variance || 0) >= 0 ? '+' : ''"></span>₦<span x-text="formatNumber(impactPreview?.gross_variance || 0)"></span>
                                </td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">Net Payroll</td>
                                <td class="px-4 py-3 text-sm text-right text-gray-600">₦<span x-text="formatNumber(impactPreview?.previous_net || 0)"></span></td>
                                <td class="px-4 py-3 text-sm text-right text-gray-900 font-medium">₦<span x-text="formatNumber(impactPreview?.current_net || 0)"></span></td>
                                <td class="px-4 py-3 text-sm text-right" :class="(impactPreview?.net_variance || 0) >= 0 ? 'text-red-600' : 'text-green-600'">
                                    <span x-text="(impactPreview?.net_variance || 0) >= 0 ? '+' : ''"></span>₦<span x-text="formatNumber(impactPreview?.net_variance || 0)"></span>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">PAYE Tax</td>
                                <td class="px-4 py-3 text-sm text-right text-gray-600">₦<span x-text="formatNumber(impactPreview?.previous_paye || 0)"></span></td>
                                <td class="px-4 py-3 text-sm text-right text-gray-900 font-medium">₦<span x-text="formatNumber(impactPreview?.current_paye || 0)"></span></td>
                                <td class="px-4 py-3 text-sm text-right" :class="(impactPreview?.paye_variance || 0) >= 0 ? 'text-amber-600' : 'text-green-600'">
                                    <span x-text="(impactPreview?.paye_variance || 0) >= 0 ? '+' : ''"></span>₦<span x-text="formatNumber(impactPreview?.paye_variance || 0)"></span>
                                </td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">Employer Cost</td>
                                <td class="px-4 py-3 text-sm text-right text-gray-600">₦<span x-text="formatNumber(impactPreview?.previous_employer_cost || 0)"></span></td>
                                <td class="px-4 py-3 text-sm text-right text-gray-900 font-medium">₦<span x-text="formatNumber(impactPreview?.current_employer_cost || 0)"></span></td>
                                <td class="px-4 py-3 text-sm text-right" :class="(impactPreview?.employer_cost_variance || 0) >= 0 ? 'text-red-600' : 'text-green-600'">
                                    <span x-text="(impactPreview?.employer_cost_variance || 0) >= 0 ? '+' : ''"></span>₦<span x-text="formatNumber(impactPreview?.employer_cost_variance || 0)"></span>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">Employee Count</td>
                                <td class="px-4 py-3 text-sm text-right text-gray-600" x-text="impactPreview?.previous_employee_count || 0"></td>
                                <td class="px-4 py-3 text-sm text-right text-gray-900 font-medium" x-text="impactPreview?.current_employee_count || 0"></td>
                                <td class="px-4 py-3 text-sm text-right" :class="((impactPreview?.current_employee_count || 0) - (impactPreview?.previous_employee_count || 0)) >= 0 ? 'text-green-600' : 'text-red-600'">
                                    <span x-text="((impactPreview?.current_employee_count || 0) - (impactPreview?.previous_employee_count || 0)) >= 0 ? '+' : ''"></span><span x-text="(impactPreview?.current_employee_count || 0) - (impactPreview?.previous_employee_count || 0)"></span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- No Preview State - Show when no latest preview but check for history -->
        <div x-show="(!impactPreview || impactPreview.has_preview === false) && impactPreviewHistory.length === 0 && !impactLoading" class="bg-white rounded-lg border shadow-sm p-8 text-center">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Impact Preview for <span x-text="impactPreviewYear"></span></h3>
            <p class="text-gray-500 mb-4">Run a payroll first to generate impact analysis comparing current vs. previous periods, or select a different year.</p>
            <div class="flex justify-center gap-3">
                <button @click="activeTab = 'payroll-runs'" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Go to Payroll Runs
                </button>
                <button @click="showRunPayrollModal = true; initPayrollDates()" class="inline-flex items-center px-4 py-2 border border-green-600 text-green-600 rounded-lg hover:bg-green-50">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Create Payroll Run
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="impactLoading" class="bg-white rounded-lg shadow-sm border p-8 text-center">
            <div class="animate-spin w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-gray-500">Loading impact preview...</p>
        </div>
    </div>

    <!-- Exceptions Tab -->
    <div x-show="activeTab === 'exceptions'" x-transition>
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Payroll Exceptions</h2>
                <p class="text-sm text-gray-500 mt-1">Review and acknowledge validation exceptions before payroll approval</p>
            </div>
            <div class="flex items-center space-x-3">
                <select x-model="exceptionPayrollRunId" @change="loadExceptionsForRun()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <option value="">Select Payroll Run</option>
                    <template x-for="run in payrollRuns" :key="run.id">
                        <option :value="run.id" x-text="formatPayrollRunLabel(run)"></option>
                    </template>
                </select>
                <button @click="validatePayrollRun()" :disabled="!exceptionPayrollRunId || exceptionsLoading" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Run Validation
                </button>
            </div>
        </div>

        <!-- Exception Summary Cards -->
        <div x-show="exceptionSummary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <!-- Total Exceptions -->
            <div class="bg-white rounded-lg border shadow-sm p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Total Exceptions</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="exceptionSummary?.total_exceptions || 0"></p>
                    </div>
                    <div class="p-3 bg-gray-100 rounded-full">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Critical -->
            <div class="bg-white rounded-lg border shadow-sm p-4" :class="exceptionSummary?.critical_count > 0 ? 'border-red-300 bg-red-50' : ''">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Critical</p>
                        <p class="text-2xl font-bold" :class="exceptionSummary?.critical_count > 0 ? 'text-red-600' : 'text-gray-900'" x-text="exceptionSummary?.critical_count || 0"></p>
                    </div>
                    <div class="p-3 rounded-full" :class="exceptionSummary?.critical_count > 0 ? 'bg-red-100' : 'bg-gray-100'">
                        <svg class="w-6 h-6" :class="exceptionSummary?.critical_count > 0 ? 'text-red-600' : 'text-gray-600'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <p x-show="exceptionSummary?.critical_count > 0" class="mt-1 text-xs text-red-600">Blocks approval</p>
            </div>

            <!-- Warnings -->
            <div class="bg-white rounded-lg border shadow-sm p-4" :class="exceptionSummary?.warning_count > 0 ? 'border-amber-300 bg-amber-50' : ''">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Warnings</p>
                        <p class="text-2xl font-bold" :class="exceptionSummary?.warning_count > 0 ? 'text-amber-600' : 'text-gray-900'" x-text="exceptionSummary?.warning_count || 0"></p>
                    </div>
                    <div class="p-3 rounded-full" :class="exceptionSummary?.warning_count > 0 ? 'bg-amber-100' : 'bg-gray-100'">
                        <svg class="w-6 h-6" :class="exceptionSummary?.warning_count > 0 ? 'text-amber-600' : 'text-gray-600'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Info -->
            <div class="bg-white rounded-lg border shadow-sm p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Info</p>
                        <p class="text-2xl font-bold text-blue-600" x-text="exceptionSummary?.info_count || 0"></p>
                    </div>
                    <div class="p-3 bg-blue-100 rounded-full">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Approval Status -->
            <div class="bg-white rounded-lg border shadow-sm p-4" :class="exceptionSummary?.can_approve ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Approval Status</p>
                        <p class="text-lg font-bold" :class="exceptionSummary?.can_approve ? 'text-green-600' : 'text-red-600'" x-text="exceptionSummary?.can_approve ? 'Can Approve' : 'Blocked'"></p>
                    </div>
                    <div class="p-3 rounded-full" :class="exceptionSummary?.can_approve ? 'bg-green-100' : 'bg-red-100'">
                        <svg x-show="exceptionSummary?.can_approve" class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <svg x-show="!exceptionSummary?.can_approve" class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                        </svg>
                    </div>
                </div>
                <p class="mt-1 text-xs" :class="exceptionSummary?.can_approve ? 'text-green-600' : 'text-red-600'" x-text="exceptionSummary?.unacknowledged_count + ' unacknowledged'"></p>
            </div>
        </div>

        <!-- Filter Toolbar -->
        <div x-show="exceptions.length > 0" class="bg-white rounded-lg border shadow-sm p-4 mb-6">
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center space-x-2">
                    <label class="text-sm text-gray-600">Severity:</label>
                    <select x-model="exceptionSeverityFilter" @change="filterExceptions()" class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm">
                        <option value="">All</option>
                        <option value="critical">Critical</option>
                        <option value="warning">Warning</option>
                        <option value="info">Info</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <label class="text-sm text-gray-600">Status:</label>
                    <select x-model="exceptionAcknowledgedFilter" @change="filterExceptions()" class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm">
                        <option value="">All</option>
                        <option value="false">Unacknowledged</option>
                        <option value="true">Acknowledged</option>
                    </select>
                </div>
                <div class="flex-1"></div>
                <button @click="bulkAcknowledgeExceptions()" x-show="selectedExceptions.length > 0" class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Acknowledge Selected (<span x-text="selectedExceptions.length"></span>)
                </button>
            </div>
        </div>

        <!-- Exceptions List -->
        <div x-show="filteredExceptions.length > 0" class="space-y-4">
            <template x-for="exception in filteredExceptions" :key="exception.id">
                <div class="bg-white rounded-lg border shadow-sm overflow-hidden" :class="{
                    'border-l-4 border-l-red-500': exception.severity === 'critical',
                    'border-l-4 border-l-amber-500': exception.severity === 'warning',
                    'border-l-4 border-l-blue-500': exception.severity === 'info'
                }">
                    <div class="p-4">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-3">
                                <input type="checkbox" :value="exception.id" x-model="selectedExceptions" class="mt-1 rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <div>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-0.5 text-xs font-medium rounded-full" :class="{
                                            'bg-red-100 text-red-800': exception.severity === 'critical',
                                            'bg-amber-100 text-amber-800': exception.severity === 'warning',
                                            'bg-blue-100 text-blue-800': exception.severity === 'info'
                                        }" x-text="exception.severity.toUpperCase()"></span>
                                        <span class="text-xs text-gray-500 font-mono" x-text="exception.exception_code"></span>
                                        <span x-show="exception.is_acknowledged" class="px-2 py-0.5 text-xs bg-green-100 text-green-800 rounded-full">Acknowledged</span>
                                        <span x-show="exception.is_resolved" class="px-2 py-0.5 text-xs bg-gray-100 text-gray-800 rounded-full">Resolved</span>
                                    </div>
                                    <h4 class="mt-1 font-semibold text-gray-900" x-text="exception.title"></h4>
                                    <p class="mt-1 text-sm text-gray-600" x-text="exception.description"></p>
                                    
                                    <!-- Field Details -->
                                    <div x-show="exception.related_field" class="mt-2 p-2 bg-gray-50 rounded text-sm">
                                        <span class="text-gray-500">Field:</span> <span class="font-mono text-gray-700" x-text="exception.related_field"></span>
                                        <span x-show="exception.current_value" class="ml-3"><span class="text-gray-500">Current:</span> <span class="text-red-600 font-mono" x-text="exception.current_value"></span></span>
                                        <span x-show="exception.expected_value" class="ml-3"><span class="text-gray-500">Expected:</span> <span class="text-green-600 font-mono" x-text="exception.expected_value"></span></span>
                                    </div>
                                    
                                    <!-- Acknowledgement Info -->
                                    <div x-show="exception.is_acknowledged" class="mt-2 text-xs text-gray-500">
                                        Acknowledged by <span x-text="exception.acknowledged_by_name || 'User'"></span> on <span x-text="formatDateTime(exception.acknowledged_at)"></span>
                                        <span x-show="exception.acknowledgement_note" class="block mt-1 italic" x-text="'Note: ' + exception.acknowledgement_note"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button x-show="!exception.is_acknowledged" @click="acknowledgeException(exception.id)" class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Acknowledge
                                </button>
                                <button x-show="exception.is_acknowledged && !exception.is_resolved" @click="resolveException(exception.id)" class="inline-flex items-center px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Resolve
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- No Exceptions State -->
        <div x-show="exceptionPayrollRunId && !exceptionsLoading && filteredExceptions.length === 0" class="bg-white rounded-lg border shadow-sm p-8 text-center">
            <svg class="w-16 h-16 mx-auto text-green-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Exceptions Found</h3>
            <p class="text-gray-500">This payroll run has no validation exceptions. You can proceed with approval.</p>
        </div>

        <!-- Select Payroll Run State -->
        <div x-show="!exceptionPayrollRunId && !exceptionsLoading" class="bg-white rounded-lg border shadow-sm p-8 text-center">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Select a Payroll Run</h3>
            <p class="text-gray-500">Choose a payroll run from the dropdown above to view its exceptions.</p>
        </div>

        <!-- Loading State -->
        <div x-show="exceptionsLoading" class="bg-white rounded-lg shadow-sm border p-8 text-center">
            <div class="animate-spin w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-gray-500">Loading exceptions...</p>
        </div>
    </div>

    <!-- Decision Logs Tab -->
    <div x-show="activeTab === 'decision-logs'" x-transition>
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Payroll Decision Logs</h2>
                <p class="text-sm text-gray-500 mt-1">Immutable audit trail of payroll decisions, approvals, and adjustments</p>
            </div>
            <button @click="showNewLogModal = true" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Add Log Entry
            </button>
        </div>

        <!-- Summary Cards -->
        <div x-show="decisionLogSummary" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg border shadow-sm p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-2xl font-bold text-gray-900" x-text="decisionLogSummary?.total_logs || 0"></p>
                        <p class="text-sm text-gray-500">Total Logs</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg border shadow-sm p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-2xl font-bold text-gray-900" x-text="decisionLogSummary?.by_type?.approval || 0"></p>
                        <p class="text-sm text-gray-500">Approvals</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg border shadow-sm p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-amber-100 rounded-lg">
                        <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-2xl font-bold text-gray-900" x-text="decisionLogSummary?.by_type?.adjustment || 0"></p>
                        <p class="text-sm text-gray-500">Adjustments</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg border shadow-sm p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-gray-100 rounded-lg">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-2xl font-bold text-gray-900" x-text="decisionLogSummary?.locked_count || 0"></p>
                        <p class="text-sm text-gray-500">Locked</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg border shadow-sm p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Payroll Run</label>
                    <select x-model="logPayrollRunFilter" @change="loadDecisionLogs()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Payroll Runs</option>
                        <template x-for="run in payrollRuns" :key="run.id">
                            <option :value="run.id" x-text="formatPayrollRunLabel(run)"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Decision Type</label>
                    <select x-model="logTypeFilter" @change="loadDecisionLogs()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Types</option>
                        <option value="approval">Approval</option>
                        <option value="adjustment">Adjustment</option>
                        <option value="exception_override">Exception Override</option>
                        <option value="note">Note</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select x-model="logCategoryFilter" @change="loadDecisionLogs()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Categories</option>
                        <option value="payroll">Payroll</option>
                        <option value="salary">Salary</option>
                        <option value="deduction">Deduction</option>
                        <option value="exception">Exception</option>
                        <option value="approval">Approval</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button @click="resetLogFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50">
                        Reset Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Logs List -->
        <div x-show="decisionLogs.length > 0" class="space-y-4">
            <template x-for="log in decisionLogs" :key="log.id">
                <div class="bg-white rounded-lg border shadow-sm p-4 hover:border-green-300 transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <!-- Type Badge -->
                                <span class="px-2 py-1 text-xs font-medium rounded-full"
                                    :class="{
                                        'bg-green-100 text-green-800': log.decision_type === 'approval',
                                        'bg-amber-100 text-amber-800': log.decision_type === 'adjustment',
                                        'bg-red-100 text-red-800': log.decision_type === 'exception_override',
                                        'bg-blue-100 text-blue-800': log.decision_type === 'note'
                                    }"
                                    x-text="log.decision_type?.replace('_', ' ').toUpperCase()">
                                </span>
                                <!-- Category Badge -->
                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700" x-text="log.category?.toUpperCase()"></span>
                                <!-- Lock Badge -->
                                <span x-show="log.is_locked" class="px-2 py-1 text-xs font-medium rounded-full bg-gray-800 text-white flex items-center">
                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                    Locked
                                </span>
                            </div>
                            <h4 class="font-semibold text-gray-900" x-text="log.title"></h4>
                            <p class="text-sm text-gray-600 mt-1" x-text="log.description"></p>
                            <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    <span x-text="log.created_by_name"></span>
                                    <span class="ml-1 text-gray-400" x-text="'(' + log.created_by_role + ')'"></span>
                                </span>
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <span x-text="formatDateTime(log.created_at)"></span>
                                </span>
                            </div>
                        </div>
                        <div class="ml-4 flex items-center gap-2">
                            <button @click="viewLogDetails(log)" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100" title="View Details">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </button>
                            <button @click="verifyLogIntegrity(log.id)" class="p-2 text-gray-400 hover:text-green-600 rounded-lg hover:bg-green-50" title="Verify Integrity">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Pagination -->
            <div class="flex justify-between items-center mt-6">
                <p class="text-sm text-gray-500">
                    Showing <span x-text="((logPage - 1) * logPerPage) + 1"></span> to <span x-text="Math.min(logPage * logPerPage, logTotal)"></span> of <span x-text="logTotal"></span> logs
                </p>
                <div class="flex gap-2">
                    <button @click="logPage > 1 && (logPage--, loadDecisionLogs())" :disabled="logPage <= 1" class="px-3 py-1 border rounded text-sm disabled:opacity-50">Previous</button>
                    <button @click="logPage < logPages && (logPage++, loadDecisionLogs())" :disabled="logPage >= logPages" class="px-3 py-1 border rounded text-sm disabled:opacity-50">Next</button>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div x-show="decisionLogs.length === 0 && !decisionLogsLoading" class="bg-white rounded-lg border shadow-sm p-8 text-center">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Decision Logs Found</h3>
            <p class="text-gray-500 mb-4">Start recording payroll decisions to maintain an audit trail.</p>
            <button @click="showNewLogModal = true" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                Create First Log
            </button>
        </div>

        <!-- Loading State -->
        <div x-show="decisionLogsLoading" class="bg-white rounded-lg shadow-sm border p-8 text-center">
            <div class="animate-spin w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-gray-500">Loading decision logs...</p>
        </div>
    </div>

    <!-- New Log Modal -->
    <div x-show="showNewLogModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="showNewLogModal = false"></div>
            <div class="relative bg-white rounded-lg max-w-lg w-full p-6 z-10">
                <h3 class="text-lg font-semibold mb-4">Add Decision Log Entry</h3>
                <form @submit.prevent="createDecisionLog()">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Decision Type *</label>
                                <select x-model="newLog.decision_type" required class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">Select Type</option>
                                    <option value="approval">Approval</option>
                                    <option value="adjustment">Adjustment</option>
                                    <option value="exception_override">Exception Override</option>
                                    <option value="note">Note</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                                <select x-model="newLog.category" required class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">Select Category</option>
                                    <option value="payroll">Payroll</option>
                                    <option value="salary">Salary</option>
                                    <option value="deduction">Deduction</option>
                                    <option value="exception">Exception</option>
                                    <option value="approval">Approval</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                            <input type="text" x-model="newLog.title" required maxlength="255" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="Brief title for the decision">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description *</label>
                            <textarea x-model="newLog.description" required rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="Detailed description of the decision or note"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Related Payroll Run (Optional)</label>
                            <select x-model="newLog.payroll_run_id" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="">None</option>
                                <template x-for="run in payrollRuns" :key="run.id">
                                    <option :value="run.id" x-text="formatPayrollRunLabel(run)"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" @click="showNewLogModal = false" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Create Log</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Decision Log Detail Modal -->
    <div x-show="showLogDetailModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="showLogDetailModal = false"></div>
            <div class="relative bg-white rounded-lg max-w-2xl w-full z-10 shadow-xl">
                <!-- Header -->
                <div class="flex items-center justify-between px-6 py-4 border-b bg-gray-50 rounded-t-lg">
                    <div class="flex items-center gap-3">
                        <div class="p-2 rounded-lg" :class="{
                            'bg-green-100 text-green-600': selectedLog?.decision_type === 'approval',
                            'bg-amber-100 text-amber-600': selectedLog?.decision_type === 'adjustment',
                            'bg-red-100 text-red-600': selectedLog?.decision_type === 'exception_override',
                            'bg-blue-100 text-blue-600': selectedLog?.decision_type === 'note'
                        }">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Decision Log Details</h3>
                            <p class="text-sm text-gray-500" x-text="selectedLog?.decision_type?.replace('_', ' ').toUpperCase() + ' - ' + selectedLog?.category?.toUpperCase()"></p>
                        </div>
                    </div>
                    <button @click="showLogDetailModal = false" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Body -->
                <div class="px-6 py-4 space-y-4">
                    <!-- Title -->
                    <div>
                        <h4 class="text-xl font-semibold text-gray-900" x-text="selectedLog?.title"></h4>
                        <div class="flex items-center gap-3 mt-2">
                            <span class="px-2 py-1 text-xs font-medium rounded-full"
                                :class="{
                                    'bg-green-100 text-green-800': selectedLog?.decision_type === 'approval',
                                    'bg-amber-100 text-amber-800': selectedLog?.decision_type === 'adjustment',
                                    'bg-red-100 text-red-800': selectedLog?.decision_type === 'exception_override',
                                    'bg-blue-100 text-blue-800': selectedLog?.decision_type === 'note'
                                }"
                                x-text="selectedLog?.decision_type?.replace('_', ' ')">
                            </span>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700" x-text="selectedLog?.category"></span>
                            <span x-show="selectedLog?.is_locked" class="px-2 py-1 text-xs font-medium rounded-full bg-gray-800 text-white flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                Locked
                            </span>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm font-medium text-gray-500 mb-2">Description</p>
                        <p class="text-gray-700 whitespace-pre-wrap" x-text="selectedLog?.description"></p>
                    </div>

                    <!-- Metadata -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 rounded-lg p-3">
                            <p class="text-xs font-medium text-blue-600 mb-1">Created By</p>
                            <p class="text-sm font-medium text-gray-900" x-text="selectedLog?.created_by_name"></p>
                            <p class="text-xs text-gray-500" x-text="selectedLog?.created_by_role"></p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-xs font-medium text-gray-600 mb-1">Created At</p>
                            <p class="text-sm font-medium text-gray-900" x-text="formatDateTime(selectedLog?.created_at)"></p>
                        </div>
                    </div>

                    <!-- Context Data (if any) -->
                    <div x-show="selectedLog?.context_data && Object.keys(selectedLog.context_data).length > 0" class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm font-medium text-gray-500 mb-2">Context Data</p>
                        <pre class="text-xs text-gray-600 overflow-auto max-h-40 bg-white rounded p-2 border" x-text="JSON.stringify(selectedLog?.context_data, null, 2)"></pre>
                    </div>

                    <!-- Hash Verification -->
                    <div class="bg-gradient-to-r from-gray-50 to-green-50 rounded-lg p-4 border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-700">Integrity Hash</p>
                                <p class="text-xs font-mono text-gray-500 mt-1" x-text="selectedLog?.content_hash ? selectedLog.content_hash.substring(0, 32) + '...' : 'No hash'"></p>
                            </div>
                            <button @click="verifyLogIntegrity(selectedLog?.id)" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 inline-flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                                Verify
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 border-t bg-gray-50 rounded-b-lg flex justify-end">
                    <button @click="showLogDetailModal = false" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Integrity Verification Result Modal -->
    <div x-show="showIntegrityModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="showIntegrityModal = false"></div>
            <div class="relative bg-white rounded-lg max-w-md w-full z-10 shadow-xl">
                <!-- Header -->
                <div class="px-6 py-4 border-b" :class="integrityResult?.has_hash ? 'bg-green-50' : 'bg-amber-50'">
                    <div class="flex items-center gap-3">
                        <div class="p-2 rounded-full" :class="integrityResult?.has_hash ? 'bg-green-100 text-green-600' : 'bg-amber-100 text-amber-600'">
                            <svg x-show="integrityResult?.has_hash" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            <svg x-show="!integrityResult?.has_hash" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold" :class="integrityResult?.has_hash ? 'text-green-800' : 'text-amber-800'" x-text="integrityResult?.has_hash ? 'Integrity Verified' : 'Verification Warning'"></h3>
                        </div>
                    </div>
                </div>

                <!-- Body -->
                <div class="px-6 py-4 space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-600">Hash Status</span>
                            <span class="px-2 py-1 text-xs font-medium rounded-full" :class="integrityResult?.has_hash ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'" x-text="integrityResult?.has_hash ? 'Valid' : 'Not Found'"></span>
                        </div>
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-600">Lock Status</span>
                            <span class="px-2 py-1 text-xs font-medium rounded-full" :class="integrityResult?.is_locked ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-600'" x-text="integrityResult?.is_locked ? 'Locked' : 'Unlocked'"></span>
                        </div>
                        <div x-show="integrityResult?.content_hash" class="mt-3 pt-3 border-t">
                            <p class="text-xs font-medium text-gray-500 mb-1">Content Hash</p>
                            <p class="text-xs font-mono text-gray-600 break-all bg-white p-2 rounded border" x-text="integrityResult?.content_hash"></p>
                        </div>
                    </div>

                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="text-sm text-blue-700" x-text="integrityResult?.verification_note || 'No additional notes'"></p>
                    </div>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 border-t bg-gray-50 rounded-b-lg flex justify-end">
                    <button @click="showIntegrityModal = false" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- YTD Ledger Tab -->
    <div x-show="activeTab === 'ytd-ledger'" x-transition>
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-semibold text-gray-900">Year-to-Date Payroll Ledger</h2>
            <div class="flex items-center space-x-4">
                <select x-model="ytdYear" @change="loadYTDLedger()" class="rounded-lg border-gray-300 text-sm">
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                </select>
                <button @click="loadYTDLedger()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Refresh
                </button>
            </div>
        </div>

        <!-- YTD Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" x-show="ytdSummary">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <p class="text-sm text-gray-500">Total Employees</p>
                <p class="text-2xl font-bold text-gray-900" x-text="ytdSummary?.total_employees || 0"></p>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <p class="text-sm text-gray-500">YTD Gross</p>
                <p class="text-2xl font-bold text-green-600">₦<span x-text="(ytdSummary?.total_ytd_gross || 0).toLocaleString()"></span></p>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <p class="text-sm text-gray-500">YTD PAYE</p>
                <p class="text-2xl font-bold text-red-600">₦<span x-text="(ytdSummary?.total_ytd_paye || 0).toLocaleString()"></span></p>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <p class="text-sm text-gray-500">YTD Net</p>
                <p class="text-2xl font-bold text-blue-600">₦<span x-text="(ytdSummary?.total_ytd_net || 0).toLocaleString()"></span></p>
            </div>
        </div>

        <!-- YTD Ledger Table -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div x-show="ytdLoading" class="p-8 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
                <p class="mt-2 text-gray-500">Loading YTD data...</p>
            </div>
            <table x-show="!ytdLoading && ytdLedgers.length > 0" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">YTD Gross</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">YTD PAYE</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">YTD Pension</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">YTD Net</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Months</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="ledger in ytdLedgers" :key="ledger.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="ledger.employee_name || ledger.employee_id"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">₦<span x-text="ledger.ytd_gross.toLocaleString()"></span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600">₦<span x-text="ledger.ytd_paye.toLocaleString()"></span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-600">₦<span x-text="ledger.ytd_pension_employee.toLocaleString()"></span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-green-600 font-medium">₦<span x-text="ledger.ytd_net.toLocaleString()"></span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500" x-text="ledger.months_processed"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="!ytdLoading && ytdLedgers.length === 0" class="p-8 text-center text-gray-500">
                No YTD data available for this year.
            </div>
        </div>
    </div>

    <!-- CTC Analytics Tab -->
    <div x-show="activeTab === 'ctc'" x-transition>
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-semibold text-gray-900">Cost-to-Company Analytics</h2>
            <button @click="generateCTCSnapshot()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                Generate Snapshot
            </button>
        </div>

        <!-- CTC Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" x-show="ctcSnapshot">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <p class="text-sm text-gray-500">Total Employees</p>
                <p class="text-2xl font-bold text-gray-900" x-text="ctcSnapshot?.total_employees || 0"></p>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <p class="text-sm text-gray-500">Total Gross Salary</p>
                <p class="text-2xl font-bold text-blue-600">₦<span x-text="(ctcSnapshot?.total_gross_salary || 0).toLocaleString()"></span></p>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <p class="text-sm text-gray-500">Total CTC</p>
                <p class="text-2xl font-bold text-green-600">₦<span x-text="(ctcSnapshot?.total_ctc || 0).toLocaleString()"></span></p>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <p class="text-sm text-gray-500">Avg CTC per Employee</p>
                <p class="text-2xl font-bold text-purple-600">₦<span x-text="(ctcSnapshot?.average_ctc_per_employee || 0).toLocaleString()"></span></p>
            </div>
        </div>

        <!-- CTC Breakdown -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6" x-show="ctcSnapshot">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Cost Breakdown</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-3 bg-blue-50 rounded-lg">
                    <p class="text-sm text-gray-600">Gross Salary</p>
                    <p class="text-lg font-semibold text-blue-600">₦<span x-text="(ctcSnapshot?.total_gross_salary || 0).toLocaleString()"></span></p>
                </div>
                <div class="text-center p-3 bg-green-50 rounded-lg">
                    <p class="text-sm text-gray-600">Employer Pension</p>
                    <p class="text-lg font-semibold text-green-600">₦<span x-text="(ctcSnapshot?.total_pension_employer || 0).toLocaleString()"></span></p>
                </div>
                <div class="text-center p-3 bg-orange-50 rounded-lg">
                    <p class="text-sm text-gray-600">NSITF</p>
                    <p class="text-lg font-semibold text-orange-600">₦<span x-text="(ctcSnapshot?.total_nsitf || 0).toLocaleString()"></span></p>
                </div>
                <div class="text-center p-3 bg-purple-50 rounded-lg">
                    <p class="text-sm text-gray-600">ITF</p>
                    <p class="text-lg font-semibold text-purple-600">₦<span x-text="(ctcSnapshot?.total_itf || 0).toLocaleString()"></span></p>
                </div>
            </div>
        </div>

        <!-- CTC Trend -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">CTC Trend (Last 12 Months)</h3>
            <div x-show="ctcLoading" class="p-8 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
            </div>
            <div x-show="!ctcLoading && ctcTrend.length > 0" class="space-y-2">
                <template x-for="period in ctcTrend" :key="`${period.month}-${period.year}`">
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span class="text-sm text-gray-600" x-text="`${period.month}/${period.year}`"></span>
                        <span class="text-sm font-medium text-gray-900">₦<span x-text="period.total_ctc.toLocaleString()"></span></span>
                        <span class="text-xs text-gray-500" x-text="`${period.employee_count} employees`"></span>
                    </div>
                </template>
            </div>
            <div x-show="!ctcLoading && ctcTrend.length === 0" class="text-center text-gray-500 py-4">
                No CTC trend data available.
            </div>
        </div>
    </div>

    <!-- What-If Simulations Tab -->
    <div x-show="activeTab === 'simulations'" x-transition>
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-semibold text-gray-900">What-If Simulations</h2>
            <button @click="showSimulationModal = true" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                New Simulation
            </button>
        </div>

        <!-- Recent Simulations -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div x-show="simulationsLoading" class="p-8 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
            </div>
            <table x-show="!simulationsLoading && simulations.length > 0" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">CTC Impact</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="sim in simulations" :key="sim.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="sim.simulation_name"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800" x-text="sim.scenario_type.replace('_', ' ')"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right" :class="sim.ctc_impact >= 0 ? 'text-red-600' : 'text-green-600'">
                                <span x-text="sim.ctc_impact >= 0 ? '+' : ''"></span>₦<span x-text="Math.abs(sim.ctc_impact).toLocaleString()"></span>
                                <span class="text-xs text-gray-500">(<span x-text="sim.ctc_impact_percent"></span>%)</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500" x-text="formatDate(sim.created_at)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                <button @click="viewSimulation(sim)" class="text-blue-600 hover:text-blue-800 mr-2">View</button>
                                <button @click="deleteSimulation(sim.id)" class="text-red-600 hover:text-red-800">Delete</button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="!simulationsLoading && simulations.length === 0" class="p-8 text-center text-gray-500">
                <svg class="w-12 h-12 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <p>No simulations yet. Create one to see the impact of payroll changes.</p>
            </div>
        </div>

        <!-- Simulation Modal -->
        <div x-show="showSimulationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 p-6">
                <h3 class="text-lg font-semibold mb-4">New Salary Increase Simulation</h3>
                <form @submit.prevent="runSalarySimulation()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Simulation Name</label>
                            <input type="text" x-model="newSimulation.name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="e.g., Q2 2026 Salary Review">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Increase Type</label>
                                <select x-model="newSimulation.increase_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="percentage">Percentage</option>
                                    <option value="flat_amount">Flat Amount</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Value</label>
                                <input type="number" x-model="newSimulation.increase_value" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" :placeholder="newSimulation.increase_type === 'percentage' ? '10' : '50000'">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Apply To</label>
                            <select x-model="newSimulation.apply_to" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option value="all">All Employees</option>
                                <option value="department">Specific Department</option>
                            </select>
                        </div>
                        <div x-show="newSimulation.apply_to === 'department'">
                            <label class="block text-sm font-medium text-gray-700">Department</label>
                            <input type="text" x-model="newSimulation.department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="e.g., Engineering">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" x-model="newSimulation.save" id="saveSimulation" class="rounded border-gray-300 text-green-600">
                            <label for="saveSimulation" class="ml-2 text-sm text-gray-700">Save simulation for later reference</label>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" @click="showSimulationModal = false" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Run Simulation</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Salary Calculator Modal -->
    <div x-show="showCalculatorModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 py-6">
            <div class="fixed inset-0 bg-black/50" @click="showCalculatorModal = false"></div>
            <div class="relative bg-white rounded-xl max-w-4xl w-full p-6 z-10 shadow-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Nigerian Salary Calculator</h3>
                    <button @click="showCalculatorModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Input Form -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-800 border-b pb-2">Salary Components</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Basic Salary (Monthly) *</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">₦</span>
                                <input type="number" x-model.number="calcForm.basic_salary" min="1" required 
                                    class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    placeholder="e.g., 500000">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Housing Allowance</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">₦</span>
                                    <input type="number" x-model.number="calcForm.housing_allowance" min="0"
                                        class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                        placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Transport Allowance</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">₦</span>
                                    <input type="number" x-model.number="calcForm.transport_allowance" min="0"
                                        class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                        placeholder="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Meal Allowance</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">₦</span>
                                    <input type="number" x-model.number="calcForm.meal_allowance" min="0"
                                        class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                        placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Utility Allowance</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">₦</span>
                                    <input type="number" x-model.number="calcForm.utility_allowance" min="0"
                                        class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                        placeholder="0">
                                </div>
                            </div>
                        </div>
                        
                        <h4 class="font-semibold text-gray-800 border-b pb-2 mt-6">Statutory Options</h4>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pension Contribution %</label>
                                <input type="number" x-model.number="calcForm.pension_percentage" min="0" max="20" step="0.5"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                    placeholder="8">
                            </div>
                            <div class="flex flex-col justify-end">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" x-model="calcForm.is_pension_exempt" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                    <span class="text-sm text-gray-700">Pension Exempt</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" x-model="calcForm.is_nhf_exempt" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <span class="text-sm text-gray-700">NHF Exempt</span>
                            </label>
                        </div>
                        
                        <button @click="calculateSalary()" :disabled="!calcForm.basic_salary || calcForm.basic_salary <= 0"
                            class="w-full mt-4 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium transition-colors">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            Calculate Breakdown
                        </button>
                    </div>
                    
                    <!-- Results Display -->
                    <div>
                        <template x-if="!calcResult">
                            <div class="h-full flex items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200 p-8">
                                <div class="text-center">
                                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <p class="text-gray-500">Enter salary details and click Calculate to see the breakdown</p>
                                </div>
                            </div>
                        </template>
                        
                        <template x-if="calcResult">
                            <div class="space-y-4">
                                <!-- Net Pay Highlight -->
                                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg p-4 text-center">
                                    <p class="text-sm opacity-90">Monthly Net Pay</p>
                                    <p class="text-3xl font-bold">₦<span x-text="formatNumber(calcResult.monthly_net_pay)"></span></p>
                                    <p class="text-xs opacity-75 mt-1">Annual: ₦<span x-text="formatNumber(calcResult.annual_net_pay)"></span></p>
                                </div>
                                
                                <!-- Earnings -->
                                <div class="bg-white border border-gray-200 rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                        Earnings (Monthly)
                                    </h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span class="text-gray-600">Basic Salary</span><span class="font-medium">₦<span x-text="formatNumber(calcResult.basic_salary)"></span></span></div>
                                        <div class="flex justify-between" x-show="calcResult.housing_allowance > 0"><span class="text-gray-600">Housing</span><span>₦<span x-text="formatNumber(calcResult.housing_allowance)"></span></span></div>
                                        <div class="flex justify-between" x-show="calcResult.transport_allowance > 0"><span class="text-gray-600">Transport</span><span>₦<span x-text="formatNumber(calcResult.transport_allowance)"></span></span></div>
                                        <div class="flex justify-between" x-show="calcResult.meal_allowance > 0"><span class="text-gray-600">Meal</span><span>₦<span x-text="formatNumber(calcResult.meal_allowance)"></span></span></div>
                                        <div class="flex justify-between" x-show="calcResult.utility_allowance > 0"><span class="text-gray-600">Utility</span><span>₦<span x-text="formatNumber(calcResult.utility_allowance)"></span></span></div>
                                        <div class="flex justify-between font-semibold border-t pt-2"><span>Gross Pay</span><span class="text-green-600">₦<span x-text="formatNumber(calcResult.monthly_gross)"></span></span></div>
                                    </div>
                                </div>
                                
                                <!-- Deductions -->
                                <div class="bg-white border border-gray-200 rounded-lg p-4">
                                    <h5 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                                        Deductions (Monthly)
                                    </h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span class="text-gray-600">PAYE Tax</span><span class="text-red-600">-₦<span x-text="formatNumber(calcResult.monthly_paye)"></span></span></div>
                                        <div class="flex justify-between" x-show="calcResult.pension_employee > 0"><span class="text-gray-600">Pension (Employee)</span><span class="text-red-600">-₦<span x-text="formatNumber(calcResult.pension_employee)"></span></span></div>
                                        <div class="flex justify-between" x-show="calcResult.nhf > 0"><span class="text-gray-600">NHF</span><span class="text-red-600">-₦<span x-text="formatNumber(calcResult.nhf)"></span></span></div>
                                        <div class="flex justify-between font-semibold border-t pt-2"><span>Total Deductions</span><span class="text-red-600">-₦<span x-text="formatNumber(calcResult.total_monthly_deductions)"></span></span></div>
                                    </div>
                                </div>
                                
                                <!-- Tax Info -->
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h5 class="font-semibold text-blue-800 mb-2">Tax Summary</h5>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <p class="text-blue-600">Effective Tax Rate</p>
                                            <p class="font-semibold text-blue-900"><span x-text="calcResult.effective_tax_rate?.toFixed(2) || 0"></span>%</p>
                                        </div>
                                        <div>
                                            <p class="text-blue-600">Annual PAYE</p>
                                            <p class="font-semibold text-blue-900">₦<span x-text="formatNumber(calcResult.annual_paye)"></span></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Employer Cost -->
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                    <h5 class="font-semibold text-purple-800 mb-2">Employer Contributions (Monthly)</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between" x-show="calcResult.pension_employer > 0"><span class="text-purple-600">Pension (Employer)</span><span>₦<span x-text="formatNumber(calcResult.pension_employer)"></span></span></div>
                                        <div class="flex justify-between" x-show="calcResult.nsitf > 0"><span class="text-purple-600">NSITF</span><span>₦<span x-text="formatNumber(calcResult.nsitf)"></span></span></div>
                                        <div class="flex justify-between font-semibold border-t pt-2"><span>Total Employer Cost</span><span class="text-purple-900">₦<span x-text="formatNumber(calcResult.total_employer_cost)"></span></span></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ghost Worker Detection Tab -->
    <div x-show="activeTab === 'ghost-detection'" x-transition>
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-semibold text-gray-900">Ghost Worker Detection</h2>
            <button @click="runGhostScan()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                Run Scan
            </button>
        </div>

        <!-- Scan Results Summary -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" x-show="ghostScanResult">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <p class="text-sm text-gray-500">Employees Scanned</p>
                <p class="text-2xl font-bold text-gray-900" x-text="ghostScanResult?.total_employees_scanned || 0"></p>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <p class="text-sm text-gray-500">Detections Found</p>
                <p class="text-2xl font-bold" :class="ghostScanResult?.detections_found > 0 ? 'text-red-600' : 'text-green-600'" x-text="ghostScanResult?.detections_found || 0"></p>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <p class="text-sm text-gray-500">Critical Issues</p>
                <p class="text-2xl font-bold text-red-600" x-text="ghostScanResult?.critical_detections || 0"></p>
            </div>
        </div>

        <!-- Detections List -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div x-show="ghostLoading" class="p-8 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-600 mx-auto"></div>
                <p class="mt-2 text-gray-500">Scanning for duplicates...</p>
            </div>
            <table x-show="!ghostLoading && ghostDetections.length > 0" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duplicate Field</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Value</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Severity</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="detection in ghostDetections" :key="detection.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="detection.detection_type.replace('_', ' ')"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="detection.duplicate_field"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="detection.duplicate_value"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <span class="px-2 py-1 text-xs rounded-full" :class="detection.severity === 'critical' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'" x-text="detection.severity"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <span x-show="detection.is_resolved" class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Resolved</span>
                                <span x-show="!detection.is_resolved" class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Unresolved</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                <button x-show="!detection.is_resolved" @click="resolveGhostDetection(detection.id)" class="text-green-600 hover:text-green-800">Resolve</button>
                                <span x-show="detection.is_resolved" class="text-gray-400">-</span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="!ghostLoading && ghostDetections.length === 0" class="p-8 text-center">
                <svg class="w-16 h-16 mx-auto text-green-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 class="text-lg font-medium text-gray-900">No Ghost Workers Detected</h3>
                <p class="text-gray-500 mt-1">All employee records appear to be unique.</p>
            </div>
        </div>
    </div>

    <!-- Loans Tab -->
    <div x-show="activeTab === 'loans'" x-transition>
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-semibold text-gray-900">Employee Loans & Salary Advances</h2>
            <button @click="showLoanModal = true" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                New Loan/Advance
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
            <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            <h3 class="mt-4 text-lg font-medium text-gray-900">Loan Management</h3>
            <p class="mt-2 text-gray-500">Track employee loans and salary advances with automatic payroll deductions.</p>
        </div>
    </div>

    <!-- Include Modals -->
    {% include "partials/payroll/employee_modal.html" %}
    {% include "partials/payroll/run_payroll_modal.html" %}
    {% include "partials/payroll/salary_calculator_modal.html" %}
    {% include "partials/payroll/payslip_modal.html" %}
    {% include "partials/payroll/loan_modal.html" %}
</div>

<script>
function payrollPage() {
    return {
        activeTab: 'dashboard',
        
        // Toast Notification
        toast: {
            show: false,
            type: 'success',
            title: '',
            message: ''
        },
        
        // Dashboard
        stats: {},
        
        // Employees
        employees: [],
        employeeSearch: '',
        departmentFilter: '',
        departments: [],
        employeePage: 1,
        employeePerPage: 20,
        employeeTotal: 0,
        employeePages: 1,
        
        // Payroll Runs
        payrollRuns: [],
        payrollYear: new Date().getFullYear(),
        payrollStatusFilter: '',
        
        // Remittances
        remittances: [],
        remittanceType: '',
        remittancePaid: '',
        
        // Compliance Status
        complianceData: null,
        complianceCalendar: null,
        complianceYear: new Date().getFullYear(),
        
        // Impact Preview
        impactPreview: null,
        impactLoading: false,
        
        // Exceptions
        exceptions: [],
        filteredExceptions: [],
        exceptionSummary: null,
        exceptionsLoading: false,
        exceptionPayrollRunId: '',
        exceptionSeverityFilter: '',
        exceptionAcknowledgedFilter: '',
        selectedExceptions: [],
        
        // Loans & Advances
        showLoanModal: false,
        showEmployeeLoansModal: false,
        employeeLoans: [],
        employeeLoansLoading: false,
        selectedLoanEmployee: null,
        loanSaving: false,
        loanForm: {
            id: null,
            employee_id: '',
            loan_type: 'loan',
            principal_amount: '',
            interest_rate: '0',
            tenure_months: '',
            start_date: '',
            description: '',
            notes: '',
        },
        
        // Decision Logs
        decisionLogs: [],
        decisionLogSummary: null,
        decisionLogsLoading: false,
        logPayrollRunFilter: '',
        logTypeFilter: '',
        logCategoryFilter: '',
        logPage: 1,
        logPerPage: 20,
        logTotal: 0,
        logPages: 0,
        showNewLogModal: false,
        newLog: {
            decision_type: '',
            category: '',
            title: '',
            description: '',
            payroll_run_id: '',
        },
        
        // YTD Ledger
        ytdLedgers: [],
        ytdSummary: null,
        ytdLoading: false,
        ytdYear: new Date().getFullYear(),
        
        // CTC Analytics
        ctcSnapshot: null,
        ctcTrend: [],
        ctcLoading: false,
        
        // Simulations
        simulations: [],
        simulationsLoading: false,
        showSimulationModal: false,
        newSimulation: {
            name: '',
            increase_type: 'percentage',
            increase_value: 10,
            apply_to: 'all',
            department: '',
            save: false,
        },
        
        // Ghost Worker Detection
        ghostDetections: [],
        ghostScanResult: null,
        ghostLoading: false,
        
        // Decision Log Detail Modal
        showLogDetailModal: false,
        selectedLog: null,
        showIntegrityModal: false,
        integrityResult: null,
        
        // Impact Preview
        impactPreviewYear: new Date().getFullYear(),
        impactPreviewHistory: [],
        
        // Modals
        showEmployeeModal: false,
        showRunPayrollModal: false,
        showCalculatorModal: false,
        showLoanModal: false,
        showPayslipModal: false,
        selectedPayslip: null,
        
        // Forms
        employeeForm: {},
        payrollForm: {
            name: '',
            payroll_type: 'monthly',
            period_month: new Date().getMonth() + 1,
            period_year: new Date().getFullYear(),
            period_start: '',
            period_end: '',
            payment_date: '',
            department: '',
            include_all_employees: true
        },
        editingEmployee: null,
        
        // Calculator
        calcResult: null,
        calcForm: {
            basic_salary: 0,
            housing_allowance: 0,
            transport_allowance: 0,
            meal_allowance: 0,
            utility_allowance: 0,
            other_allowances: {},
            pension_percentage: 8,
            is_pension_exempt: false,
            is_nhf_exempt: false
        },
        
        async init() {
            await this.loadDashboard();
            await this.loadDepartments();
            await this.loadEmployees();
            await this.loadPayrollRuns();
        },
        
        showToast(type, title, message = '', duration = 4000) {
            this.toast = { show: true, type, title, message };
            if (duration > 0) {
                setTimeout(() => { this.toast.show = false; }, duration);
            }
        },
        
        initPayrollDates() {
            const year = this.payrollForm.period_year;
            const month = this.payrollForm.period_month;
            const lastDay = new Date(year, month, 0).getDate();
            this.payrollForm.period_start = `${year}-${String(month).padStart(2, '0')}-01`;
            this.payrollForm.period_end = `${year}-${String(month).padStart(2, '0')}-${lastDay}`;
            this.payrollForm.payment_date = this.payrollForm.period_end;
            this.payrollForm.name = `Payroll - ${['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][month]} ${year}`;
        },
        
        async loadDashboard() {
            try {
                const response = await authFetch('/api/v1/payroll/dashboard', { credentials: 'include' });
                if (response.ok) {
                    this.stats = await response.json();
                } else {
                    const error = await response.json();
                    console.error('Dashboard API error:', response.status, error);
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        },
        
        async loadDepartments() {
            try {
                const response = await authFetch('/api/v1/payroll/employees/departments', { credentials: 'include' });
                if (response.ok) {
                    this.departments = await response.json();
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        },
        
        async loadEmployees() {
            try {
                const params = new URLSearchParams({
                    page: this.employeePage,
                    per_page: this.employeePerPage
                });
                if (this.employeeSearch) params.append('search', this.employeeSearch);
                if (this.departmentFilter) params.append('department', this.departmentFilter);
                
                const response = await authFetch(`/api/v1/payroll/employees?${params}`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    this.employees = data.items;
                    this.employeeTotal = data.total;
                    this.employeePages = data.pages;
                }
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        },
        
        searchEmployees: Alpine.debounce(function() {
            this.employeePage = 1;
            this.loadEmployees();
        }, 300),
        
        async loadPayrollRuns() {
            try {
                const params = new URLSearchParams({ year: this.payrollYear });
                if (this.payrollStatusFilter) params.append('status', this.payrollStatusFilter);
                
                const response = await authFetch(`/api/v1/payroll/payroll-runs?${params}`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    this.payrollRuns = data.items || [];
                }
            } catch (error) {
                console.error('Error loading payroll runs:', error);
            }
        },
        
        async loadRemittances() {
            try {
                const params = new URLSearchParams();
                if (this.remittanceType) params.append('remittance_type', this.remittanceType);
                if (this.remittancePaid) params.append('is_paid', this.remittancePaid);
                
                const response = await authFetch(`/api/v1/payroll/remittances?${params}`, { credentials: 'include' });
                if (response.ok) {
                    this.remittances = await response.json();
                }
            } catch (error) {
                console.error('Error loading remittances:', error);
            }
        },
        
        resetEmployeeForm() {
            this.editingEmployee = null;
            this.employeeForm = {
                employee_id: '',
                first_name: '',
                last_name: '',
                email: '',
                phone_number: '',
                department: '',
                job_title: '',
                hire_date: new Date().toISOString().split('T')[0],
                basic_salary: 0,
                housing_allowance: 0,
                transport_allowance: 0,
                meal_allowance: 0,
                utility_allowance: 0,
                employment_type: 'full_time',
                tin: '',
                pension_pin: '',
                pfa: '',
                nhf_number: '',
                bank_name: '',
                account_number: '',
                account_name: ''
            };
        },
        
        editEmployee(emp) {
            this.editingEmployee = emp;
            this.employeeForm = { ...emp };
            this.showEmployeeModal = true;
        },
        
        async saveEmployee() {
            try {
                const url = this.editingEmployee 
                    ? `/api/v1/payroll/employees/${this.editingEmployee.id}`
                    : '/api/v1/payroll/employees';
                const method = this.editingEmployee ? 'PATCH' : 'POST';
                
                const response = await authFetch(url, {
                    method,
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.employeeForm)
                });
                
                if (response.ok) {
                    this.showEmployeeModal = false;
                    this.loadEmployees();
                    this.loadDashboard();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to save employee');
                }
            } catch (error) {
                console.error('Error saving employee:', error);
            }
        },
        
        async approvePayroll(id) {
            if (!confirm('Approve this payroll run?')) return;
            try {
                const response = await authFetch(`/api/v1/payroll/payroll-runs/${id}/approve`, { method: 'POST', credentials: 'include' });
                if (response.ok) this.loadPayrollRuns();
            } catch (error) {
                console.error('Error approving payroll:', error);
            }
        },
        
        async processPayroll(id) {
            if (!confirm('Process this payroll? This will create statutory remittance records.')) return;
            try {
                const response = await authFetch(`/api/v1/payroll/payroll-runs/${id}/process`, { method: 'POST', credentials: 'include' });
                if (response.ok) {
                    this.loadPayrollRuns();
                    this.loadRemittances();
                }
            } catch (error) {
                console.error('Error processing payroll:', error);
            }
        },
        
        async markPayrollPaid(id) {
            if (!confirm('Mark this payroll as paid?')) return;
            try {
                const response = await authFetch(`/api/v1/payroll/payroll-runs/${id}/mark-paid`, { method: 'POST', credentials: 'include' });
                if (response.ok) this.loadPayrollRuns();
            } catch (error) {
                console.error('Error marking payroll paid:', error);
            }
        },
        
        async createPayrollRun() {
            try {
                // Validate required fields
                if (!this.payrollForm.name || !this.payrollForm.period_start || !this.payrollForm.period_end || !this.payrollForm.payment_date) {
                    alert('Please fill in all required payroll details');
                    return;
                }
                
                const response = await authFetch('/api/v1/payroll/payroll-runs', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.payrollForm)
                });
                
                if (response.ok) {
                    const newRun = await response.json();
                    this.showRunPayrollModal = false;
                    this.loadPayrollRuns();
                    this.loadDashboard();
                    // Navigate to the new payroll run details
                    window.location.href = `/payroll/runs/${newRun.id}`;
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to create payroll run');
                }
            } catch (error) {
                console.error('Error creating payroll run:', error);
            }
        },
        
        async calculateSalary() {
            try {
                // Ensure basic_salary is a valid number greater than 0
                if (!this.calcForm.basic_salary || this.calcForm.basic_salary <= 0) {
                    this.showToast('warning', 'Invalid Input', 'Basic salary must be greater than 0');
                    return;
                }
                
                const response = await authFetch('/api/v1/payroll/calculate-salary', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.calcForm)
                });
                if (response.ok) {
                    this.calcResult = await response.json();
                } else {
                    const error = await response.json();
                    this.showToast('error', 'Calculation Error', error.detail || 'Failed to calculate salary breakdown');
                }
            } catch (error) {
                console.error('Error calculating salary:', error);
                this.showToast('error', 'Error', 'An unexpected error occurred');
            }
        },
        
        formatCurrency(value) {
            return new Intl.NumberFormat('en-NG', { minimumFractionDigits: 2 }).format(value || 0);
        },
        
        formatNumber(value) {
            return new Intl.NumberFormat('en-NG', { minimumFractionDigits: 2 }).format(value || 0);
        },
        
        formatCompact(value) {
            if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
            if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
            return value?.toFixed(0) || '0';
        },
        
        formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('en-NG', { day: 'numeric', month: 'short', year: 'numeric' });
        },
        
        getMonthName(month) {
            const months = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[month] || '';
        },
        
        viewPayslips(empId) {
            // Navigate or show modal
            window.location.href = `/payroll/employees/${empId}/payslips`;
        },
        
        viewLoans(empId) {
            // Find the employee
            const emp = this.employees.find(e => e.id === empId);
            this.selectedLoanEmployee = emp;
            this.loanForm.employee_id = empId;
            this.showEmployeeLoansModal = true;
            this.loadEmployeeLoans(empId);
        },
        
        async loadEmployeeLoans(empId) {
            this.employeeLoansLoading = true;
            try {
                const response = await authFetch(`/api/v1/payroll/employees/${empId}/loans`, { credentials: 'include' });
                if (response.ok) {
                    this.employeeLoans = await response.json();
                }
            } catch (error) {
                console.error('Error loading loans:', error);
            } finally {
                this.employeeLoansLoading = false;
            }
        },
        
        openNewLoanForEmployee() {
            this.resetLoanForm();
            this.loanForm.employee_id = this.selectedLoanEmployee?.id || '';
            this.showLoanModal = true;
        },
        
        resetLoanForm() {
            this.loanForm = {
                id: null,
                employee_id: '',
                loan_type: 'loan',
                principal_amount: '',
                interest_rate: '0',
                tenure_months: '',
                start_date: new Date().toISOString().split('T')[0],
                description: '',
                notes: '',
            };
        },
        
        calculateLoanInterest() {
            const principal = parseFloat(this.loanForm.principal_amount) || 0;
            const rate = parseFloat(this.loanForm.interest_rate) || 0;
            const months = parseInt(this.loanForm.tenure_months) || 0;
            return Math.round((principal * rate * months) / (100 * 12));
        },
        
        calculateLoanTotal() {
            const principal = parseFloat(this.loanForm.principal_amount) || 0;
            return principal + this.calculateLoanInterest();
        },
        
        calculateMonthlyDeduction() {
            const total = this.calculateLoanTotal();
            const months = parseInt(this.loanForm.tenure_months) || 1;
            return Math.round(total / months);
        },
        
        formatLoanType(type) {
            const types = {
                'loan': 'Loan',
                'salary_advance': 'Salary Advance',
                'cooperative': 'Cooperative Loan',
                'equipment': 'Equipment Loan',
                'educational': 'Educational Loan',
                'emergency': 'Emergency Loan',
                'other': 'Other'
            };
            return types[type] || type;
        },
        
        async saveLoan() {
            if (!this.loanForm.employee_id || !this.loanForm.principal_amount || !this.loanForm.tenure_months) {
                alert('Please fill in all required fields');
                return;
            }
            
            this.loanSaving = true;
            try {
                const payload = {
                    employee_id: this.loanForm.employee_id,
                    loan_type: this.loanForm.loan_type,
                    principal_amount: parseFloat(this.loanForm.principal_amount),
                    interest_rate: parseFloat(this.loanForm.interest_rate) || 0,
                    tenure_months: parseInt(this.loanForm.tenure_months),
                    start_date: this.loanForm.start_date,
                    description: this.loanForm.description || null,
                    notes: this.loanForm.notes || null,
                };
                
                const response = await authFetch('/api/v1/payroll/loans', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                
                if (response.ok) {
                    this.showLoanModal = false;
                    if (this.selectedLoanEmployee) {
                        await this.loadEmployeeLoans(this.selectedLoanEmployee.id);
                        this.showEmployeeLoansModal = true;
                    }
                    this.resetLoanForm();
                } else {
                    const error = await response.json();
                    alert('Error creating loan: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving loan:', error);
                alert('Error saving loan');
            } finally {
                this.loanSaving = false;
            }
        },
        
        async approveLoan(loanId) {
            if (!confirm('Approve this loan?')) return;
            
            try {
                const response = await authFetch(`/api/v1/payroll/loans/${loanId}/approve`, {
                    method: 'POST',
                    credentials: 'include',
                });
                
                if (response.ok) {
                    if (this.selectedLoanEmployee) {
                        await this.loadEmployeeLoans(this.selectedLoanEmployee.id);
                    }
                } else {
                    alert('Error approving loan');
                }
            } catch (error) {
                console.error('Error approving loan:', error);
            }
        },
        
        async cancelLoan(loanId) {
            if (!confirm('Are you sure you want to cancel this loan?')) return;
            
            try {
                const response = await authFetch(`/api/v1/payroll/loans/${loanId}/cancel`, {
                    method: 'POST',
                    credentials: 'include',
                });
                
                if (response.ok) {
                    if (this.selectedLoanEmployee) {
                        await this.loadEmployeeLoans(this.selectedLoanEmployee.id);
                    }
                } else {
                    alert('Error cancelling loan');
                }
            } catch (error) {
                console.error('Error cancelling loan:', error);
            }
        },
        
        viewPayrollDetails(id) {
            window.location.href = `/payroll/runs/${id}`;
        },
        
        markRemittancePaid(rem) {
            // Show modal to enter payment details
            const paymentRef = prompt('Enter payment reference:');
            if (!paymentRef) return;
            
            const today = new Date().toISOString().split('T')[0];
            authFetch(`/api/v1/payroll/remittances/${rem.id}/mark-paid?payment_date=${today}&payment_reference=${paymentRef}`, {
                method: 'POST',
                credentials: 'include'
            }).then(res => {
                if (res.ok) this.loadRemittances();
            });
        },
        
        // ===========================================
        // COMPLIANCE STATUS METHODS
        // ===========================================
        
        async loadComplianceStatus() {
            try {
                const response = await authFetch('/api/v1/payroll/advanced/compliance/current', {
                    credentials: 'include'
                });
                if (response.ok) {
                    this.complianceData = await response.json();
                    // Also load calendar
                    await this.loadComplianceCalendar();
                } else {
                    console.error('Failed to load compliance status');
                }
            } catch (error) {
                console.error('Error loading compliance status:', error);
            }
        },
        
        async loadComplianceCalendar() {
            try {
                const response = await authFetch(`/api/v1/payroll/advanced/compliance/calendar/${this.complianceYear}`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    this.complianceCalendar = await response.json();
                }
            } catch (error) {
                console.error('Error loading compliance calendar:', error);
            }
        },
        
        async refreshComplianceSnapshot() {
            try {
                const today = new Date();
                const response = await authFetch('/api/v1/payroll/advanced/compliance/snapshots', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        period_month: today.getMonth() + 1,
                        period_year: today.getFullYear()
                    })
                });
                if (response.ok) {
                    await this.loadComplianceStatus();
                    this.showToast('success', 'Compliance Snapshot Refreshed', 'The compliance status has been successfully updated.');
                } else {
                    const error = await response.json();
                    this.showToast('error', 'Refresh Failed', error.detail || 'Failed to refresh compliance snapshot');
                }
            } catch (error) {
                console.error('Error refreshing compliance:', error);
                this.showToast('error', 'Error', 'An unexpected error occurred while refreshing compliance.');
            }
        },
        
        async viewComplianceMonth(month) {
            try {
                const response = await authFetch(`/api/v1/payroll/advanced/compliance/snapshots/${month}/${this.complianceYear}`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const snapshot = await response.json();
                    // Show details in modal or update current view
                    alert(`${this.getMonthName(month)} ${this.complianceYear}\n\nPAYE Due: ₦${this.formatCurrency(snapshot.paye_status?.amount_due || 0)}\nPAYE Paid: ₦${this.formatCurrency(snapshot.paye_status?.amount_paid || 0)}\nStatus: ${snapshot.paye_status?.status}\n\n${snapshot.summary_message}`);
                } else if (response.status === 404) {
                    // Generate snapshot for this month
                    if (confirm(`No snapshot exists for ${this.getMonthName(month)} ${this.complianceYear}. Generate now?`)) {
                        const genResponse = await authFetch('/api/v1/payroll/advanced/compliance/snapshots', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                period_month: month,
                                period_year: this.complianceYear
                            })
                        });
                        if (genResponse.ok) {
                            await this.loadComplianceCalendar();
                        }
                    }
                }
            } catch (error) {
                console.error('Error viewing compliance month:', error);
            }
        },
        
        // ========================================
        // IMPACT PREVIEW METHODS
        // ========================================
        
        async loadImpactPreview() {
            this.impactLoading = true;
            try {
                // Load latest preview
                const response = await authFetch('/api/v1/payroll/advanced/impact-preview/latest', { credentials: 'include' });
                if (response.ok) {
                    this.impactPreview = await response.json();
                } else {
                    this.impactPreview = { has_preview: false };
                }
                
                // Also load history for the selected year
                await this.loadImpactPreviewHistory();
            } catch (error) {
                console.error('Error loading impact preview:', error);
                this.impactPreview = { has_preview: false };
            } finally {
                this.impactLoading = false;
            }
        },
        
        async loadImpactPreviewHistory() {
            try {
                const response = await authFetch(`/api/v1/payroll/advanced/impact-preview/history?year=${this.impactPreviewYear}&per_page=50`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    this.impactPreviewHistory = data.items || [];
                } else {
                    this.impactPreviewHistory = [];
                }
            } catch (error) {
                console.error('Error loading impact preview history:', error);
                this.impactPreviewHistory = [];
            }
        },
        
        viewImpactPreviewDetails(preview) {
            this.impactPreview = preview;
            this.impactPreview.has_preview = true;
        },
        
        async refreshImpactPreview() {
            if (!this.impactPreview?.payroll_run_id) {
                this.showToast('warning', 'No Payroll Run', 'Select a payroll run or create one first to generate impact preview.');
                return;
            }
            
            this.impactLoading = true;
            try {
                const response = await authFetch(`/api/v1/payroll/advanced/impact-preview/${this.impactPreview.payroll_run_id}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    this.impactPreview = await response.json();
                    this.impactPreview.has_preview = true;
                    await this.loadImpactPreviewHistory();
                    this.showToast('success', 'Impact Preview Refreshed', 'The impact preview has been successfully regenerated.');
                } else {
                    const error = await response.json();
                    this.showToast('error', 'Refresh Failed', error.detail || 'Failed to refresh impact preview');
                }
            } catch (error) {
                console.error('Error refreshing impact preview:', error);
                this.showToast('error', 'Error', 'An unexpected error occurred.');
            } finally {
                this.impactLoading = false;
            }
        },
        
        async generateImpactPreviewForRun(payrollRunId) {
            this.impactLoading = true;
            try {
                const response = await authFetch(`/api/v1/payroll/advanced/impact-preview/${payrollRunId}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    this.impactPreview = await response.json();
                    this.activeTab = 'impact-preview';
                    return true;
                } else {
                    const error = await response.json();
                    console.error('Failed to generate impact preview:', error);
                    return false;
                }
            } catch (error) {
                console.error('Error generating impact preview:', error);
                return false;
            } finally {
                this.impactLoading = false;
            }
        },
        
        formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleString('en-NG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        // ========================================
        // EXCEPTION MANAGEMENT METHODS
        // ========================================
        
        async loadExceptions() {
            // Load payroll runs for selector if not already loaded
            if (this.payrollRuns.length === 0) {
                await this.loadPayrollRuns();
            }
            
            // If a payroll run is selected, load its exceptions
            if (this.exceptionPayrollRunId) {
                await this.loadExceptionsForRun();
            }
        },
        
        async loadExceptionsForRun() {
            if (!this.exceptionPayrollRunId) return;
            
            this.exceptionsLoading = true;
            this.selectedExceptions = [];
            
            try {
                // Load summary
                const summaryResponse = await authFetch(`/api/v1/payroll/advanced/exceptions/${this.exceptionPayrollRunId}/summary`, { credentials: 'include' });
                if (summaryResponse.ok) {
                    this.exceptionSummary = await summaryResponse.json();
                    this.exceptions = this.exceptionSummary.exceptions || [];
                    this.filterExceptions();
                }
            } catch (error) {
                console.error('Error loading exceptions:', error);
            } finally {
                this.exceptionsLoading = false;
            }
        },
        
        filterExceptions() {
            let filtered = [...this.exceptions];
            
            if (this.exceptionSeverityFilter) {
                filtered = filtered.filter(e => e.severity === this.exceptionSeverityFilter);
            }
            
            if (this.exceptionAcknowledgedFilter !== '') {
                const isAcknowledged = this.exceptionAcknowledgedFilter === 'true';
                filtered = filtered.filter(e => e.is_acknowledged === isAcknowledged);
            }
            
            this.filteredExceptions = filtered;
        },
        
        async validatePayrollRun() {
            if (!this.exceptionPayrollRunId) return;
            
            this.exceptionsLoading = true;
            
            try {
                const response = await authFetch(`/api/v1/payroll/advanced/exceptions/${this.exceptionPayrollRunId}/validate`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Validation complete. ${result.exceptions_created} exception(s) found.`);
                    await this.loadExceptionsForRun();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Validation failed');
                }
            } catch (error) {
                console.error('Error validating payroll:', error);
                alert('Validation failed');
            } finally {
                this.exceptionsLoading = false;
            }
        },
        
        async acknowledgeException(exceptionId, note = null) {
            try {
                const response = await authFetch(`/api/v1/payroll/advanced/exceptions/${exceptionId}/acknowledge`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ acknowledgement_note: note })
                });
                
                if (response.ok) {
                    await this.loadExceptionsForRun();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to acknowledge exception');
                }
            } catch (error) {
                console.error('Error acknowledging exception:', error);
            }
        },
        
        async bulkAcknowledgeExceptions() {
            if (this.selectedExceptions.length === 0) return;
            
            const note = prompt('Enter acknowledgement note (optional):');
            
            try {
                const response = await authFetch('/api/v1/payroll/advanced/exceptions/bulk-acknowledge', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        exception_ids: this.selectedExceptions,
                        acknowledgement_note: note
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`${result.acknowledged_count} exception(s) acknowledged.`);
                    this.selectedExceptions = [];
                    await this.loadExceptionsForRun();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Bulk acknowledge failed');
                }
            } catch (error) {
                console.error('Error bulk acknowledging:', error);
            }
        },
        
        async resolveException(exceptionId) {
            try {
                const response = await authFetch(`/api/v1/payroll/advanced/exceptions/${exceptionId}/resolve`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    await this.loadExceptionsForRun();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to resolve exception');
                }
            } catch (error) {
                console.error('Error resolving exception:', error);
            }
        },
        
        formatPayrollRunLabel(run) {
            if (!run) return '';
            // Use name if available, otherwise format period
            if (run.name) {
                return `${run.name} (${(run.status || 'Draft').replace('_', ' ')})`;
            }
            const startDate = run.period_start ? new Date(run.period_start).toLocaleDateString('en-NG', { month: 'short', year: 'numeric' }) : '';
            const status = (run.status || 'Draft').replace('_', ' ');
            return `${startDate} Payroll (${status})`;
        },
        
        // ========================================
        // DECISION LOG METHODS
        // ========================================
        
        async loadDecisionLogs() {
            // Load payroll runs for filter if not already loaded
            if (this.payrollRuns.length === 0) {
                await this.loadPayrollRuns();
            }
            
            this.decisionLogsLoading = true;
            
            try {
                // Build query params
                const params = new URLSearchParams({
                    page: this.logPage.toString(),
                    per_page: this.logPerPage.toString(),
                });
                
                if (this.logPayrollRunFilter) params.append('payroll_run_id', this.logPayrollRunFilter);
                if (this.logTypeFilter) params.append('decision_type', this.logTypeFilter);
                if (this.logCategoryFilter) params.append('category', this.logCategoryFilter);
                
                // Load logs
                const logsResponse = await authFetch(`/api/v1/payroll/advanced/decision-logs?${params}`, { credentials: 'include' });
                if (logsResponse.ok) {
                    const data = await logsResponse.json();
                    this.decisionLogs = data.logs || [];
                    this.logTotal = data.total || 0;
                    this.logPages = data.pages || 0;
                }
                
                // Load summary
                const summaryParams = this.logPayrollRunFilter ? `?payroll_run_id=${this.logPayrollRunFilter}` : '';
                const summaryResponse = await authFetch(`/api/v1/payroll/advanced/decision-logs/summary${summaryParams}`, { credentials: 'include' });
                if (summaryResponse.ok) {
                    this.decisionLogSummary = await summaryResponse.json();
                }
            } catch (error) {
                console.error('Error loading decision logs:', error);
            } finally {
                this.decisionLogsLoading = false;
            }
        },
        
        resetLogFilters() {
            this.logPayrollRunFilter = '';
            this.logTypeFilter = '';
            this.logCategoryFilter = '';
            this.logPage = 1;
            this.loadDecisionLogs();
        },
        
        async createDecisionLog() {
            if (!this.newLog.decision_type || !this.newLog.category || !this.newLog.title || !this.newLog.description) {
                this.showToast('warning', 'Missing Fields', 'Please fill in all required fields.');
                return;
            }
            
            try {
                const response = await authFetch('/api/v1/payroll/advanced/decision-logs', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        decision_type: this.newLog.decision_type,
                        category: this.newLog.category,
                        title: this.newLog.title,
                        description: this.newLog.description,
                        payroll_run_id: this.newLog.payroll_run_id || null,
                    })
                });
                
                if (response.ok) {
                    this.showNewLogModal = false;
                    this.newLog = { decision_type: '', category: '', title: '', description: '', payroll_run_id: '' };
                    await this.loadDecisionLogs();
                    this.showToast('success', 'Log Created', 'Decision log has been created successfully.');
                } else {
                    const error = await response.json();
                    this.showToast('error', 'Error', error.detail || 'Failed to create decision log');
                }
            } catch (error) {
                console.error('Error creating decision log:', error);
                this.showToast('error', 'Error', 'Failed to create decision log');
            }
        },
        
        viewLogDetails(log) {
            this.selectedLog = log;
            this.showLogDetailModal = true;
        },
        
        async verifyLogIntegrity(logId) {
            try {
                const response = await authFetch(`/api/v1/payroll/advanced/decision-logs/${logId}/verify`, { credentials: 'include' });
                if (response.ok) {
                    const result = await response.json();
                    this.integrityResult = result;
                    this.showIntegrityModal = true;
                } else {
                    this.showToast('error', 'Verification Failed', 'Failed to verify log integrity');
                }
            } catch (error) {
                console.error('Error verifying log:', error);
                this.showToast('error', 'Error', 'An error occurred while verifying integrity');
            }
        },
        
        // ========================================
        // YTD LEDGER METHODS
        // ========================================
        
        async loadYTDLedger() {
            this.ytdLoading = true;
            try {
                // Load summary
                const summaryResponse = await authFetch(`/api/v1/payroll/advanced/ytd-ledger/summary?tax_year=${this.ytdYear}`, { credentials: 'include' });
                if (summaryResponse.ok) {
                    this.ytdSummary = await summaryResponse.json();
                }
                
                // Load ledgers
                const response = await authFetch(`/api/v1/payroll/advanced/ytd-ledger?tax_year=${this.ytdYear}`, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    this.ytdLedgers = data.items || [];
                }
            } catch (error) {
                console.error('Error loading YTD ledger:', error);
            } finally {
                this.ytdLoading = false;
            }
        },
        
        // ========================================
        // CTC ANALYTICS METHODS
        // ========================================
        
        async loadCTCData() {
            this.ctcLoading = true;
            try {
                const now = new Date();
                const month = now.getMonth() + 1;
                const year = now.getFullYear();
                
                // Load current snapshot
                const snapshotResponse = await authFetch(`/api/v1/payroll/advanced/ctc/snapshots/${month}/${year}`, { credentials: 'include' });
                if (snapshotResponse.ok) {
                    this.ctcSnapshot = await snapshotResponse.json();
                }
                
                // Load trend
                const trendResponse = await authFetch('/api/v1/payroll/advanced/ctc/trend?months=12', { credentials: 'include' });
                if (trendResponse.ok) {
                    const data = await trendResponse.json();
                    this.ctcTrend = data.periods || [];
                }
            } catch (error) {
                console.error('Error loading CTC data:', error);
            } finally {
                this.ctcLoading = false;
            }
        },
        
        async generateCTCSnapshot() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            
            try {
                const response = await authFetch(`/api/v1/payroll/advanced/ctc/snapshots?month=${month}&year=${year}`, {
                    method: 'POST',
                    credentials: 'include',
                });
                if (response.ok) {
                    const data = await response.json();
                    this.ctcSnapshot = data.snapshot;
                    await this.loadCTCData();
                    alert('CTC snapshot generated successfully!');
                }
            } catch (error) {
                console.error('Error generating CTC snapshot:', error);
            }
        },
        
        // ========================================
        // SIMULATION METHODS
        // ========================================
        
        async loadSimulations() {
            this.simulationsLoading = true;
            try {
                const response = await authFetch('/api/v1/payroll/advanced/simulations', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    this.simulations = data.items || [];
                }
            } catch (error) {
                console.error('Error loading simulations:', error);
            } finally {
                this.simulationsLoading = false;
            }
        },
        
        async runSalarySimulation() {
            try {
                const response = await authFetch('/api/v1/payroll/advanced/simulations/salary-increase', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        simulation_name: this.newSimulation.name,
                        scenario_type: 'salary_increase',
                        save_simulation: this.newSimulation.save,
                        salary_increase: {
                            increase_type: this.newSimulation.increase_type,
                            increase_value: parseFloat(this.newSimulation.increase_value),
                            apply_to: this.newSimulation.apply_to,
                            department: this.newSimulation.department || null,
                        }
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.showSimulationModal = false;
                    await this.loadSimulations();
                    
                    const sim = data.simulation;
                    alert(`Simulation Complete!\n\n${sim.impact_summary}\n\nBaseline CTC: ₦${sim.baseline_ctc.toLocaleString()}\nProjected CTC: ₦${sim.projected_ctc.toLocaleString()}\nImpact: ₦${sim.ctc_impact.toLocaleString()} (${sim.ctc_impact_percent}%)`);
                }
            } catch (error) {
                console.error('Error running simulation:', error);
            }
        },
        
        viewSimulation(sim) {
            alert(`${sim.simulation_name}\n\nType: ${sim.scenario_type}\n\n${sim.impact_summary}\n\nBaseline CTC: ₦${sim.baseline_ctc.toLocaleString()}\nProjected CTC: ₦${sim.projected_ctc.toLocaleString()}\nImpact: ₦${sim.ctc_impact.toLocaleString()} (${sim.ctc_impact_percent}%)`);
        },
        
        async deleteSimulation(simId) {
            if (!confirm('Delete this simulation?')) return;
            
            try {
                const response = await authFetch(`/api/v1/payroll/advanced/simulations/${simId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                });
                if (response.ok) {
                    await this.loadSimulations();
                }
            } catch (error) {
                console.error('Error deleting simulation:', error);
            }
        },
        
        // ========================================
        // GHOST WORKER DETECTION METHODS
        // ========================================
        
        async loadGhostDetections() {
            this.ghostLoading = true;
            try {
                const response = await authFetch('/api/v1/payroll/advanced/ghost-worker/detections', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    this.ghostDetections = data.items || [];
                }
            } catch (error) {
                console.error('Error loading ghost detections:', error);
            } finally {
                this.ghostLoading = false;
            }
        },
        
        async runGhostScan() {
            this.ghostLoading = true;
            try {
                const response = await authFetch('/api/v1/payroll/advanced/ghost-worker/scan', {
                    method: 'POST',
                    credentials: 'include',
                });
                if (response.ok) {
                    this.ghostScanResult = await response.json();
                    this.ghostDetections = this.ghostScanResult.detections || [];
                    
                    if (this.ghostScanResult.detections_found === 0) {
                        alert('✅ Scan Complete\n\nNo ghost workers detected. All employee records appear to be unique.');
                    } else {
                        alert(`⚠️ Scan Complete\n\nFound ${this.ghostScanResult.detections_found} potential issues:\n- ${this.ghostScanResult.critical_detections} critical\n\nPlease review the detections below.`);
                    }
                }
            } catch (error) {
                console.error('Error running ghost scan:', error);
            } finally {
                this.ghostLoading = false;
            }
        },
        
        async resolveGhostDetection(detectionId) {
            const note = prompt('Please provide a resolution note (min 10 characters):');
            if (!note || note.length < 10) {
                alert('Resolution note must be at least 10 characters.');
                return;
            }
            
            try {
                const response = await authFetch(`/api/v1/payroll/advanced/ghost-worker/detections/${detectionId}/resolve`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ resolution_note: note }),
                });
                if (response.ok) {
                    await this.loadGhostDetections();
                    alert('Detection resolved successfully!');
                }
            } catch (error) {
                console.error('Error resolving detection:', error);
            }
        }
    };
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Checkout - TekVwarho ProAudit{% endblock %}

{% block head %}
<style>
    .tier-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .price-display {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
    }
    .checkout-card {
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }
    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-12"
     x-data="checkoutPage()"
     x-init="init()">
    
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumb -->
        <nav class="flex items-center space-x-2 text-sm mb-8">
            <a href="/pricing" class="text-gray-500 hover:text-gray-700">Pricing</a>
            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
            <span class="text-gray-900 font-medium">Checkout</span>
        </nav>

        <div class="grid lg:grid-cols-5 gap-8">
            <!-- Checkout Form - 3 columns -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-2xl checkout-card p-8">
                    <h1 class="text-2xl font-bold text-gray-900 mb-6">Complete Your Upgrade</h1>
                    
                    <!-- Step 1: Select Plan -->
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-sm flex items-center justify-center mr-2">1</span>
                            Select Your Plan
                        </h2>
                        
                        <div class="space-y-3">
                            <!-- Core Plan -->
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="selectedTier === 'core' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="selectTier('core')">
                                <input type="radio" name="tier" value="core" x-model="selectedTier" class="sr-only">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900">Core</span>
                                    <span class="text-gray-500 text-sm ml-2">Essential accounting</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-bold text-gray-900" x-text="billingCycle === 'monthly' ? '₦50,000' : '₦480,000'"></span>
                                    <span class="text-gray-500 text-sm" x-text="billingCycle === 'monthly' ? '/month' : '/year'"></span>
                                </div>
                            </label>
                            
                            <!-- Professional Plan -->
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition relative"
                                   :class="selectedTier === 'professional' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="selectTier('professional')">
                                <div class="absolute -top-2 right-4 px-2 py-0.5 bg-green-500 text-white text-xs font-medium rounded">
                                    Most Popular
                                </div>
                                <input type="radio" name="tier" value="professional" x-model="selectedTier" class="sr-only">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900">Professional</span>
                                    <span class="text-gray-500 text-sm ml-2">Growing businesses</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-bold text-gray-900" x-text="billingCycle === 'monthly' ? '₦200,000' : '₦1,920,000'"></span>
                                    <span class="text-gray-500 text-sm" x-text="billingCycle === 'monthly' ? '/month' : '/year'"></span>
                                </div>
                            </label>
                            
                            <!-- Enterprise Plan -->
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="selectedTier === 'enterprise' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="selectTier('enterprise')">
                                <input type="radio" name="tier" value="enterprise" x-model="selectedTier" class="sr-only">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900">Enterprise</span>
                                    <span class="text-gray-500 text-sm ml-2">Large organizations</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-bold text-gray-900" x-text="billingCycle === 'monthly' ? '₦2,000,000' : '₦19,200,000'"></span>
                                    <span class="text-gray-500 text-sm" x-text="billingCycle === 'monthly' ? '/month' : '/year'"></span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Step 2: Billing Cycle -->
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-sm flex items-center justify-center mr-2">2</span>
                            Billing Cycle
                        </h2>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <label class="flex flex-col items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="billingCycle === 'monthly' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="billingCycle = 'monthly'">
                                <input type="radio" name="billing" value="monthly" x-model="billingCycle" class="sr-only">
                                <span class="font-semibold text-gray-900">Monthly</span>
                                <span class="text-gray-500 text-sm">Pay each month</span>
                            </label>
                            
                            <label class="flex flex-col items-center p-4 border-2 rounded-lg cursor-pointer transition relative"
                                   :class="billingCycle === 'annual' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="billingCycle = 'annual'">
                                <div class="absolute -top-2 right-4 px-2 py-0.5 bg-green-500 text-white text-xs font-medium rounded">
                                    Save 20%
                                </div>
                                <input type="radio" name="billing" value="annual" x-model="billingCycle" class="sr-only">
                                <span class="font-semibold text-gray-900">Annual</span>
                                <span class="text-gray-500 text-sm">Pay once a year</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Step 3: Intelligence Add-on -->
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-sm flex items-center justify-center mr-2">3</span>
                            Intelligence Add-on
                            <span class="text-gray-400 text-sm font-normal ml-2">(Optional)</span>
                        </h2>
                        
                        <div class="space-y-3">
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="!intelligenceAddon ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="intelligenceAddon = null">
                                <input type="radio" name="addon" value="" x-model="intelligenceAddon" class="sr-only">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900">No Add-on</span>
                                    <span class="text-gray-500 text-sm ml-2">Basic intelligence included</span>
                                </div>
                                <span class="text-gray-500">Free</span>
                            </label>
                            
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="intelligenceAddon === 'standard' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="intelligenceAddon = 'standard'">
                                <input type="radio" name="addon" value="standard" x-model="intelligenceAddon" class="sr-only">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900">Standard Intelligence</span>
                                    <p class="text-gray-500 text-sm">Anomaly detection, cash flow forecasting</p>
                                </div>
                                <span class="font-medium text-gray-900">+₦250,000/mo</span>
                            </label>
                            
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="intelligenceAddon === 'advanced' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="intelligenceAddon = 'advanced'">
                                <input type="radio" name="addon" value="advanced" x-model="intelligenceAddon" class="sr-only">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900">Advanced Intelligence</span>
                                    <p class="text-gray-500 text-sm">AI-powered fraud detection, predictive analytics</p>
                                </div>
                                <span class="font-medium text-gray-900">+₦500,000/mo</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Step 4: Additional Users -->
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-sm flex items-center justify-center mr-2">4</span>
                            Additional Users
                            <span class="text-gray-400 text-sm font-normal ml-2">(Optional)</span>
                        </h2>
                        
                        <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <p class="text-gray-700">
                                    <span x-text="getBaseUsers()"></span> users included in your plan.
                                    Additional users: <strong>₦5,000/user/month</strong>
                                </p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button @click="additionalUsers = Math.max(0, additionalUsers - 1)"
                                        class="w-8 h-8 rounded-full bg-white border border-gray-300 text-gray-600 hover:bg-gray-100 flex items-center justify-center">
                                    -
                                </button>
                                <input type="number" x-model.number="additionalUsers" min="0" max="100"
                                       class="w-16 text-center border border-gray-300 rounded-lg py-1">
                                <button @click="additionalUsers = Math.min(100, additionalUsers + 1)"
                                        class="w-8 h-8 rounded-full bg-white border border-gray-300 text-gray-600 hover:bg-gray-100 flex items-center justify-center">
                                    +
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Summary - 2 columns -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl checkout-card p-6 sticky top-8">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Order Summary</h2>
                    
                    <!-- Current Plan Badge -->
                    {% if sku %}
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">Current Plan</p>
                        <p class="font-semibold text-gray-900">{{ sku.tier_display_name }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- Price Breakdown -->
                    <div class="space-y-3 mb-6 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">
                                <span x-text="getTierName()"></span> Plan
                                <span class="text-gray-400" x-text="billingCycle === 'monthly' ? '(Monthly)' : '(Annual)'"></span>
                            </span>
                            <span class="font-medium" x-text="formatPrice(getBasePlanPrice())"></span>
                        </div>
                        
                        <div class="flex justify-between" x-show="intelligenceAddon">
                            <span class="text-gray-600" x-text="intelligenceAddon === 'standard' ? 'Standard Intelligence' : 'Advanced Intelligence'"></span>
                            <span class="font-medium" x-text="formatPrice(getIntelligencePrice())"></span>
                        </div>
                        
                        <div class="flex justify-between" x-show="additionalUsers > 0">
                            <span class="text-gray-600">
                                <span x-text="additionalUsers"></span> Additional Users
                            </span>
                            <span class="font-medium" x-text="formatPrice(getAdditionalUsersPrice())"></span>
                        </div>
                        
                        <div class="flex justify-between text-green-600" x-show="billingCycle === 'annual'">
                            <span>Annual Discount (20%)</span>
                            <span x-text="'-' + formatPrice(getAnnualDiscount())"></span>
                        </div>
                        
                        <hr class="border-gray-200">
                        
                        <div class="flex justify-between text-lg font-bold">
                            <span class="text-gray-900">Total</span>
                            <span class="text-gray-900" x-text="formatPrice(getTotalPrice())"></span>
                        </div>
                        
                        <p class="text-xs text-gray-500" x-show="billingCycle === 'annual'">
                            Billed annually. Equivalent to <span x-text="formatPrice(getTotalPrice() / 12)"></span>/month
                        </p>
                    </div>
                    
                    <!-- Checkout Button -->
                    <button @click="proceedToPayment()"
                            :disabled="isLoading"
                            class="w-full py-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
                        <span x-show="!isLoading">Proceed to Payment</span>
                        <span x-show="isLoading" class="flex items-center">
                            <div class="loading-spinner mr-2"></div>
                            <span>Processing...</span>
                        </span>
                    </button>
                    
                    <p class="text-xs text-gray-500 text-center mt-3">
                        Secure payment powered by 
                        <img src="https://assets.paystack.co/assets/img/logos/paystack-logo-icon.png" alt="Paystack" class="inline h-4 ml-1">
                    </p>
                    
                    <!-- Guarantees -->
                    <div class="mt-6 space-y-2 text-xs text-gray-500">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>30-day money-back guarantee</span>
                        </div>
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>Cancel anytime</span>
                        </div>
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>24/7 customer support</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Error Display -->
        <div x-show="error" x-cloak
             class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <span x-text="error"></span>
            </div>
        </div>
    </div>
</div>

<script>
function checkoutPage() {
    return {
        selectedTier: '{{ tier|default("professional") }}',
        billingCycle: '{{ billing_cycle|default("monthly") }}',
        intelligenceAddon: null,
        additionalUsers: 0,
        isLoading: false,
        error: null,
        
        // Price constants (in Naira)
        prices: {
            core: { monthly: 50000, annual: 480000 },
            professional: { monthly: 200000, annual: 1920000 },
            enterprise: { monthly: 2000000, annual: 19200000 }
        },
        intelligencePrices: {
            standard: 250000,
            advanced: 500000
        },
        userPrice: 5000,
        
        init() {
            // Parse URL params if present
            const params = new URLSearchParams(window.location.search);
            if (params.has('tier')) this.selectedTier = params.get('tier');
            if (params.has('billing')) this.billingCycle = params.get('billing');
        },
        
        selectTier(tier) {
            this.selectedTier = tier;
        },
        
        getTierName() {
            const names = {
                'core': 'Core',
                'professional': 'Professional',
                'enterprise': 'Enterprise'
            };
            return names[this.selectedTier] || 'Professional';
        },
        
        getBaseUsers() {
            const users = {
                'core': 5,
                'professional': 25,
                'enterprise': 'Unlimited'
            };
            return users[this.selectedTier] || 25;
        },
        
        getBasePlanPrice() {
            const tierPrices = this.prices[this.selectedTier] || this.prices.professional;
            return this.billingCycle === 'monthly' ? tierPrices.monthly : tierPrices.annual;
        },
        
        getIntelligencePrice() {
            if (!this.intelligenceAddon) return 0;
            const monthly = this.intelligencePrices[this.intelligenceAddon] || 0;
            return this.billingCycle === 'monthly' ? monthly : monthly * 12;
        },
        
        getAdditionalUsersPrice() {
            const monthly = this.additionalUsers * this.userPrice;
            return this.billingCycle === 'monthly' ? monthly : monthly * 12;
        },
        
        getAnnualDiscount() {
            if (this.billingCycle !== 'annual') return 0;
            // Annual already has 20% discount baked in, calculate what was saved
            const tierPrices = this.prices[this.selectedTier] || this.prices.professional;
            const monthlyTotal = tierPrices.monthly * 12;
            return monthlyTotal - tierPrices.annual;
        },
        
        getTotalPrice() {
            return this.getBasePlanPrice() + this.getIntelligencePrice() + this.getAdditionalUsersPrice();
        },
        
        formatPrice(amount) {
            return '₦' + amount.toLocaleString('en-NG');
        },
        
        async proceedToPayment() {
            this.isLoading = true;
            this.error = null;
            
            try {
                const response = await authFetch('/api/v1/billing/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCsrfToken()
                    },
                    body: JSON.stringify({
                        tier: this.selectedTier,
                        billing_cycle: this.billingCycle,
                        intelligence_addon: this.intelligenceAddon,
                        additional_users: this.additionalUsers,
                        callback_url: window.location.origin + '/payment-success'
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to create checkout session');
                }
                
                // Redirect to Paystack checkout
                if (data.authorization_url) {
                    window.location.href = data.authorization_url;
                } else {
                    throw new Error('No payment URL received');
                }
                
            } catch (err) {
                console.error('Checkout error:', err);
                this.error = err.message || 'An error occurred. Please try again.';
            } finally {
                this.isLoading = false;
            }
        }
    };
}
</script>
{% endblock %}

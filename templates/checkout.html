{% extends "base.html" %}

{% block title %}Checkout - TekVwarho ProAudit{% endblock %}

{% block head %}
<style>
    .tier-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .price-display {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
    }
    .checkout-card {
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }
    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-12"
     x-data="checkoutPage()"
     x-init="init()">
    
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumb -->
        <nav class="flex items-center space-x-2 text-sm mb-8">
            <a href="/pricing" class="text-gray-500 hover:text-gray-700">Pricing</a>
            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
            <span class="text-gray-900 font-medium">Checkout</span>
        </nav>

        <div class="grid lg:grid-cols-5 gap-8">
            <!-- Checkout Form - 3 columns -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-2xl checkout-card p-8">
                    <h1 class="text-2xl font-bold text-gray-900 mb-6">Complete Your Upgrade</h1>
                    
                    <!-- Step 1: Select Plan -->
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-sm flex items-center justify-center mr-2">1</span>
                            Select Your Plan
                        </h2>
                        
                        <div class="space-y-3">
                            <!-- Core Plan -->
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="selectedTier === 'core' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="selectTier('core')">
                                <input type="radio" name="tier" value="core" x-model="selectedTier" class="sr-only">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900" x-text="pricingData.core?.name || 'Core'"></span>
                                    <span class="text-gray-500 text-sm ml-2" x-text="pricingData.core?.tagline || 'Essential accounting'"></span>
                                </div>
                                <div class="text-right">
                                    <span class="font-bold text-gray-900" x-text="billingCycle === 'monthly' ? pricingData.core?.monthly_formatted : pricingData.core?.annual_formatted"></span>
                                    <span class="text-gray-500 text-sm" x-text="billingCycle === 'monthly' ? '/month' : '/year'"></span>
                                </div>
                            </label>
                            
                            <!-- Professional Plan -->
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition relative"
                                   :class="selectedTier === 'professional' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="selectTier('professional')">
                                <div class="absolute -top-2 right-4 px-2 py-0.5 bg-green-500 text-white text-xs font-medium rounded">
                                    Most Popular
                                </div>
                                <input type="radio" name="tier" value="professional" x-model="selectedTier" class="sr-only">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900" x-text="pricingData.professional?.name || 'Professional'"></span>
                                    <span class="text-gray-500 text-sm ml-2" x-text="pricingData.professional?.tagline || 'Growing businesses'"></span>
                                </div>
                                <div class="text-right">
                                    <span class="font-bold text-gray-900" x-text="billingCycle === 'monthly' ? pricingData.professional?.monthly_formatted : pricingData.professional?.annual_formatted"></span>
                                    <span class="text-gray-500 text-sm" x-text="billingCycle === 'monthly' ? '/month' : '/year'"></span>
                                </div>
                            </label>
                            
                            <!-- Enterprise Plan -->
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="selectedTier === 'enterprise' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="selectTier('enterprise')">
                                <input type="radio" name="tier" value="enterprise" x-model="selectedTier" class="sr-only">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900" x-text="pricingData.enterprise?.name || 'Enterprise'"></span>
                                    <span class="text-gray-500 text-sm ml-2" x-text="pricingData.enterprise?.tagline || 'Large organizations'"></span>
                                </div>
                                <div class="text-right">
                                    <span class="font-bold text-gray-900" x-text="billingCycle === 'monthly' ? pricingData.enterprise?.monthly_formatted : pricingData.enterprise?.annual_formatted"></span>
                                    <span class="text-gray-500 text-sm" x-text="billingCycle === 'monthly' ? '/month' : '/year'"></span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Step 2: Billing Cycle -->
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-sm flex items-center justify-center mr-2">2</span>
                            Billing Cycle
                        </h2>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <label class="flex flex-col items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="billingCycle === 'monthly' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="billingCycle = 'monthly'">
                                <input type="radio" name="billing" value="monthly" x-model="billingCycle" class="sr-only">
                                <span class="font-semibold text-gray-900">Monthly</span>
                                <span class="text-gray-500 text-sm">Pay each month</span>
                            </label>
                            
                            <label class="flex flex-col items-center p-4 border-2 rounded-lg cursor-pointer transition relative"
                                   :class="billingCycle === 'annual' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="billingCycle = 'annual'">
                                <div class="absolute -top-2 right-4 px-2 py-0.5 bg-green-500 text-white text-xs font-medium rounded">
                                    Save 20%
                                </div>
                                <input type="radio" name="billing" value="annual" x-model="billingCycle" class="sr-only">
                                <span class="font-semibold text-gray-900">Annual</span>
                                <span class="text-gray-500 text-sm">Pay once a year</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Step 3: Intelligence Add-on -->
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-sm flex items-center justify-center mr-2">3</span>
                            Intelligence Add-on
                            <span class="text-gray-400 text-sm font-normal ml-2">(Optional)</span>
                        </h2>
                        
                        <div class="space-y-3">
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="!intelligenceAddon ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="intelligenceAddon = null">
                                <input type="radio" name="addon" value="" x-model="intelligenceAddon" class="sr-only">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900">No Add-on</span>
                                    <span class="text-gray-500 text-sm ml-2">Basic intelligence included</span>
                                </div>
                                <span class="text-gray-500">Free</span>
                            </label>
                            
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="intelligenceAddon === 'standard' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="intelligenceAddon = 'standard'">
                                <input type="radio" name="addon" value="standard" x-model="intelligenceAddon" class="sr-only">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900">Standard Intelligence</span>
                                    <p class="text-gray-500 text-sm">Anomaly detection, cash flow forecasting</p>
                                </div>
                                <span class="font-medium text-gray-900">+₦250,000/mo</span>
                            </label>
                            
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition"
                                   :class="intelligenceAddon === 'advanced' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'"
                                   @click="intelligenceAddon = 'advanced'">
                                <input type="radio" name="addon" value="advanced" x-model="intelligenceAddon" class="sr-only">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900">Advanced Intelligence</span>
                                    <p class="text-gray-500 text-sm">AI-powered fraud detection, predictive analytics</p>
                                </div>
                                <span class="font-medium text-gray-900">+₦500,000/mo</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Step 4: Additional Users -->
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-sm flex items-center justify-center mr-2">4</span>
                            Additional Users
                            <span class="text-gray-400 text-sm font-normal ml-2">(Optional)</span>
                        </h2>
                        
                        <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <p class="text-gray-700">
                                    <span x-text="getBaseUsers()"></span> users included in your plan.
                                    Additional users: <strong>₦5,000/user/month</strong>
                                </p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button @click="additionalUsers = Math.max(0, additionalUsers - 1)"
                                        class="w-8 h-8 rounded-full bg-white border border-gray-300 text-gray-600 hover:bg-gray-100 flex items-center justify-center">
                                    -
                                </button>
                                <input type="number" x-model.number="additionalUsers" min="0" max="100"
                                       class="w-16 text-center border border-gray-300 rounded-lg py-1">
                                <button @click="additionalUsers = Math.min(100, additionalUsers + 1)"
                                        class="w-8 h-8 rounded-full bg-white border border-gray-300 text-gray-600 hover:bg-gray-100 flex items-center justify-center">
                                    +
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Summary - 2 columns -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl checkout-card p-6 sticky top-8">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Order Summary</h2>
                    
                    <!-- Current Plan Badge -->
                    {% if sku %}
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">Current Plan</p>
                        <p class="font-semibold text-gray-900">{{ sku.tier_display_name }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- Price Breakdown -->
                    <div class="space-y-3 mb-6 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">
                                <span x-text="getTierName()"></span> Plan
                                <span class="text-gray-400" x-text="billingCycle === 'monthly' ? '(Monthly)' : '(Annual)'"></span>
                            </span>
                            <span class="font-medium" x-text="formatPrice(getBasePlanPrice())"></span>
                        </div>
                        
                        <div class="flex justify-between" x-show="intelligenceAddon">
                            <span class="text-gray-600" x-text="intelligenceAddon === 'standard' ? 'Standard Intelligence' : 'Advanced Intelligence'"></span>
                            <span class="font-medium" x-text="formatPrice(getIntelligencePrice())"></span>
                        </div>
                        
                        <div class="flex justify-between" x-show="additionalUsers > 0">
                            <span class="text-gray-600">
                                <span x-text="additionalUsers"></span> Additional Users
                            </span>
                            <span class="font-medium" x-text="formatPrice(getAdditionalUsersPrice())"></span>
                        </div>
                        
                        <div class="flex justify-between text-green-600" x-show="billingCycle === 'annual'">
                            <span>Annual Discount (20%)</span>
                            <span x-text="'-' + formatPrice(getAnnualDiscount())"></span>
                        </div>
                        
                        <hr class="border-gray-200">
                        
                        <div class="flex justify-between text-lg font-bold">
                            <span class="text-gray-900">Total</span>
                            <span class="text-gray-900" x-text="formatPrice(getTotalPrice())"></span>
                        </div>
                        
                        <p class="text-xs text-gray-500" x-show="billingCycle === 'annual'">
                            Billed annually. Equivalent to <span x-text="formatPrice(getTotalPrice() / 12)"></span>/month
                        </p>
                    </div>
                    
                    <!-- Checkout Button -->
                    <button @click="showConfirmation()"
                            :disabled="isLoading || pricingLoading"
                            class="w-full py-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
                        <span x-show="!isLoading && !pricingLoading">Review & Proceed to Payment</span>
                        <span x-show="pricingLoading" class="flex items-center">
                            <div class="loading-spinner mr-2"></div>
                            <span>Loading pricing...</span>
                        </span>
                        <span x-show="isLoading && !pricingLoading" class="flex items-center">
                            <div class="loading-spinner mr-2"></div>
                            <span>Processing...</span>
                        </span>
                    </button>
                    
                    <p class="text-xs text-gray-500 text-center mt-3">
                        Secure payment powered by 
                        <img src="https://assets.paystack.co/assets/img/logos/paystack-logo-icon.png" alt="Paystack" class="inline h-4 ml-1">
                    </p>
                    
                    <!-- Guarantees -->
                    <div class="mt-6 space-y-2 text-xs text-gray-500">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>30-day money-back guarantee</span>
                        </div>
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>Cancel anytime</span>
                        </div>
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>24/7 customer support</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Error Display -->
        <div x-show="error" x-cloak
             class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <span x-text="error"></span>
            </div>
        </div>
    </div>
    
    <!-- Upgrade Confirmation Modal -->
    <div x-show="showUpgradeModal" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showUpgradeModal = false"></div>
            
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            
            <!-- Modal content -->
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
                
                <!-- Loading state -->
                <template x-if="prorationLoading">
                    <div class="flex items-center justify-center py-8">
                        <svg class="animate-spin h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="ml-2 text-gray-600">Calculating...</span>
                    </div>
                </template>
                
                <!-- Confirmation content -->
                <template x-if="!prorationLoading">
                    <div>
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        
                        <div class="mt-3 text-center sm:mt-5">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                Confirm Your Subscription
                            </h3>
                            <div class="mt-4 text-left">
                                <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Plan</span>
                                        <span class="font-semibold" x-text="getTierName()"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Billing Cycle</span>
                                        <span class="font-semibold capitalize" x-text="billingCycle"></span>
                                    </div>
                                    <template x-if="intelligenceAddon">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Intelligence Add-on</span>
                                            <span class="font-semibold capitalize" x-text="intelligenceAddon"></span>
                                        </div>
                                    </template>
                                    <template x-if="additionalUsers > 0">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Additional Users</span>
                                            <span class="font-semibold" x-text="additionalUsers"></span>
                                        </div>
                                    </template>
                                    
                                    <hr class="border-gray-200">
                                    
                                    <!-- Proration details (if upgrading) -->
                                    <template x-if="prorationData?.is_upgrade">
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between text-gray-500">
                                                <span>Current Plan Credit</span>
                                                <span x-text="'-' + (prorationData.remaining_credit_formatted || formatPrice(0))"></span>
                                            </div>
                                            <div class="flex justify-between text-gray-500">
                                                <span>New Plan (prorated)</span>
                                                <span x-text="prorationData.prorated_new_formatted || formatPrice(getTotalPrice())"></span>
                                            </div>
                                            <div class="flex justify-between font-semibold text-blue-600">
                                                <span>Due Today (Prorated)</span>
                                                <span x-text="prorationData.amount_due_formatted || formatPrice(prorationData.amount_due_naira || getTotalPrice())"></span>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-2">
                                                * Prorated amount calculated based on remaining days in your current billing cycle
                                            </p>
                                        </div>
                                    </template>
                                    
                                    <!-- Regular payment (new subscription or no proration) -->
                                    <template x-if="!prorationData?.is_upgrade">
                                        <div class="flex justify-between text-lg font-bold">
                                            <span>Total Due</span>
                                            <span x-text="formatPrice(getTotalPrice())"></span>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Terms notice -->
                                <p class="mt-4 text-xs text-gray-500 text-center">
                                    By proceeding, you agree to our 
                                    <a href="/legal/terms" class="text-blue-600 hover:underline">Terms of Service</a> 
                                    and <a href="/legal/privacy" class="text-blue-600 hover:underline">Privacy Policy</a>.
                                    <span x-show="billingCycle === 'annual'">
                                        Annual subscriptions are non-refundable after 30 days.
                                    </span>
                                </p>
                            </div>
                        </div>
                        
                        <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                            <button type="button"
                                    @click="proceedToPayment()"
                                    :disabled="isLoading"
                                    class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:col-start-2 sm:text-sm disabled:opacity-50">
                                <span x-show="!isLoading">Confirm & Pay</span>
                                <span x-show="isLoading" class="flex items-center">
                                    <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Processing...
                                </span>
                            </button>
                            <button type="button"
                                    @click="showUpgradeModal = false"
                                    class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                                Go Back
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

<script>
function checkoutPage() {
    return {
        selectedTier: '{{ tier|default("professional") }}',
        billingCycle: '{{ billing_cycle|default("monthly") }}',
        intelligenceAddon: null,
        additionalUsers: 0,
        isLoading: false,
        error: null,
        pricingLoading: true,
        
        // Dynamic pricing data from API
        pricingData: {
            core: null,
            professional: null,
            enterprise: null
        },
        
        // Intelligence add-on prices (fetched separately if needed)
        intelligencePrices: {
            standard: 250000,
            advanced: 500000
        },
        userPrice: 5000,
        
        // Upgrade confirmation modal
        showUpgradeModal: false,
        prorationData: null,
        prorationLoading: false,
        
        async init() {
            // Parse URL params if present
            const params = new URLSearchParams(window.location.search);
            if (params.has('tier')) this.selectedTier = params.get('tier');
            if (params.has('billing')) this.billingCycle = params.get('billing');
            
            // Fetch dynamic pricing from API
            await this.loadPricing();
        },
        
        async loadPricing() {
            this.pricingLoading = true;
            try {
                const response = await fetch('/api/v1/billing/pricing');
                if (response.ok) {
                    const data = await response.json();
                    // Convert array to object keyed by tier
                    data.forEach(tier => {
                        this.pricingData[tier.tier] = tier;
                    });
                    // Update user price from API data
                    if (this.pricingData.core) {
                        this.userPrice = this.pricingData.core.per_user_amount;
                    }
                }
            } catch (e) {
                console.error('Failed to load pricing:', e);
            } finally {
                this.pricingLoading = false;
            }
        },
        
        selectTier(tier) {
            this.selectedTier = tier;
        },
        
        getTierName() {
            const tier = this.pricingData[this.selectedTier];
            if (tier) {
                return tier.name.replace('ProAudit ', '');
            }
            const names = {
                'core': 'Core',
                'professional': 'Professional',
                'enterprise': 'Enterprise'
            };
            return names[this.selectedTier] || 'Professional';
        },
        
        getBaseUsers() {
            const tier = this.pricingData[this.selectedTier];
            if (tier) {
                return this.selectedTier === 'enterprise' ? 'Unlimited' : tier.base_users;
            }
            const users = {
                'core': 5,
                'professional': 25,
                'enterprise': 'Unlimited'
            };
            return users[this.selectedTier] || 25;
        },
        
        getBasePlanPrice() {
            const tier = this.pricingData[this.selectedTier];
            if (tier) {
                return this.billingCycle === 'monthly' ? tier.monthly_amount : tier.annual_amount;
            }
            // Fallback to correct values
            const prices = {
                core: { monthly: 25000, annual: 255000 },
                professional: { monthly: 150000, annual: 1530000 },
                enterprise: { monthly: 1000000, annual: 10200000 }
            };
            const tierPrices = prices[this.selectedTier] || prices.professional;
            return this.billingCycle === 'monthly' ? tierPrices.monthly : tierPrices.annual;
        },
        
        getIntelligencePrice() {
            if (!this.intelligenceAddon) return 0;
            const monthly = this.intelligencePrices[this.intelligenceAddon] || 0;
            return this.billingCycle === 'monthly' ? monthly : monthly * 12;
        },
        
        getAdditionalUsersPrice() {
            const tier = this.pricingData[this.selectedTier];
            const pricePerUser = tier ? tier.per_user_amount : this.userPrice;
            const monthly = this.additionalUsers * pricePerUser;
            return this.billingCycle === 'monthly' ? monthly : monthly * 12;
        },
        
        getAnnualDiscount() {
            if (this.billingCycle !== 'annual') return 0;
            const tier = this.pricingData[this.selectedTier];
            if (tier) {
                return tier.annual_savings || 0;
            }
            return 0;
        },
        
        getTotalPrice() {
            return this.getBasePlanPrice() + this.getIntelligencePrice() + this.getAdditionalUsersPrice();
        },
        
        formatPrice(amount) {
            return '₦' + amount.toLocaleString('en-NG');
        },
        
        async loadProrationData() {
            this.prorationLoading = true;
            try {
                const response = await authFetch('/api/v1/billing/calculate-proration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCsrfToken()
                    },
                    body: JSON.stringify({
                        target_tier: this.selectedTier,
                        target_intelligence: this.intelligenceAddon
                    })
                });
                
                if (response.ok) {
                    this.prorationData = await response.json();
                } else {
                    // Not an upgrade or no existing subscription - proceed without proration
                    this.prorationData = null;
                }
            } catch (e) {
                console.error('Failed to load proration:', e);
                this.prorationData = null;
            } finally {
                this.prorationLoading = false;
            }
        },
        
        async showConfirmation() {
            // Load proration data to show upgrade details
            await this.loadProrationData();
            this.showUpgradeModal = true;
        },
        
        async proceedToPayment() {
            this.isLoading = true;
            this.error = null;
            this.showUpgradeModal = false;
            
            try {
                const response = await authFetch('/api/v1/billing/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCsrfToken()
                    },
                    body: JSON.stringify({
                        tier: this.selectedTier,
                        billing_cycle: this.billingCycle,
                        intelligence_addon: this.intelligenceAddon,
                        additional_users: this.additionalUsers,
                        callback_url: window.location.origin + '/payment-success',
                        is_upgrade: this.prorationData?.is_upgrade || false
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to create checkout session');
                }
                
                // Redirect to Paystack checkout
                if (data.authorization_url) {
                    window.location.href = data.authorization_url;
                } else {
                    throw new Error('No payment URL received');
                }
                
            } catch (err) {
                console.error('Checkout error:', err);
                this.error = err.message || 'An error occurred. Please try again.';
            } finally {
                this.isLoading = false;
            }
        }
    };
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}2026 Tax Reform - TekVwarho ProAudit{% endblock %}

{% block content %}
<div x-data="tax2026Dashboard()" x-init="init()">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">2026 Tax Reform Hub</h1>
                <p class="text-gray-600">Nigeria Tax Administration Act 2026 Compliance Dashboard</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center space-x-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                    <span class="w-2 h-2 mr-2 bg-green-500 rounded-full animate-pulse"></span>
                    NRS Connected
                </span>
                <button @click="refreshAll()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                    Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Tax Regime Indicator -->
    <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl shadow-lg p-6 mb-8 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h2 class="text-xl font-bold mb-1">Your Tax Regime</h2>
                <p class="text-green-100 text-sm">Based on your business structure and turnover</p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <p class="text-3xl font-bold" x-text="businessType.tax_regime || 'PIT'">PIT</p>
                <p class="text-green-100 text-sm" x-text="businessType.entity_name || 'Select Entity'"></p>
            </div>
        </div>
        <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white/10 rounded-lg p-3">
                <p class="text-green-100 text-xs">Business Type</p>
                <p class="font-semibold" x-text="formatBusinessType(businessType.business_type)">-</p>
            </div>
            <div class="bg-white/10 rounded-lg p-3">
                <p class="text-green-100 text-xs">Annual Turnover</p>
                <p class="font-semibold" x-text="formatCurrency(businessType.annual_turnover || 0)">‚Ç¶0</p>
            </div>
            <div class="bg-white/10 rounded-lg p-3">
                <p class="text-green-100 text-xs">Fixed Assets</p>
                <p class="font-semibold" x-text="formatCurrency(businessType.fixed_assets_value || 0)">‚Ç¶0</p>
            </div>
            <div class="bg-white/10 rounded-lg p-3">
                <p class="text-green-100 text-xs">Dev. Levy Status</p>
                <p class="font-semibold" x-text="businessType.is_development_levy_exempt ? 'Exempt' : 'Liable'">-</p>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden">
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px overflow-x-auto" aria-label="Tabs">
                <button @click="activeTab = 'buyer-review'" 
                        :class="activeTab === 'buyer-review' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition flex items-center space-x-2">
                    <span>üïê</span>
                    <span>72-Hour Buyer Review</span>
                    <span x-show="pendingReviews.length > 0" class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800" x-text="pendingReviews.length"></span>
                </button>
                <button @click="activeTab = 'vat-recovery'" 
                        :class="activeTab === 'vat-recovery' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition flex items-center space-x-2">
                    <span>üìä</span>
                    <span>VAT Recovery</span>
                </button>
                <button @click="activeTab = 'development-levy'" 
                        :class="activeTab === 'development-levy' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition flex items-center space-x-2">
                    <span>üí∞</span>
                    <span>Development Levy (4%)</span>
                </button>
                <button @click="activeTab = 'pit-relief'" 
                        :class="activeTab === 'pit-relief' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition flex items-center space-x-2">
                    <span>üìÑ</span>
                    <span>PIT Reliefs</span>
                </button>
                <button @click="activeTab = 'credit-notes'" 
                        :class="activeTab === 'credit-notes' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition flex items-center space-x-2">
                    <span>üìù</span>
                    <span>Credit Notes</span>
                </button>
                <button @click="activeTab = 'tin-validation'" 
                        :class="activeTab === 'tin-validation' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition flex items-center space-x-2">
                    <span>üîç</span>
                    <span>TIN Validation</span>
                </button>
                <button @click="activeTab = 'zero-rated'" 
                        :class="activeTab === 'zero-rated' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition flex items-center space-x-2">
                    <span>üè∑Ô∏è</span>
                    <span>Zero-Rated VAT</span>
                </button>
                <button @click="activeTab = 'minimum-etr'" 
                        :class="activeTab === 'minimum-etr' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition flex items-center space-x-2">
                    <span>üìä</span>
                    <span>Minimum ETR (15%)</span>
                </button>
                <button @click="activeTab = 'cgt'" 
                        :class="activeTab === 'cgt' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition flex items-center space-x-2">
                    <span>üíé</span>
                    <span>CGT (30%)</span>
                </button>
                <button @click="activeTab = 'paye'" 
                        :class="activeTab === 'paye' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition flex items-center space-x-2">
                    <span>üíº</span>
                    <span>Progressive PAYE</span>
                </button>
                <button @click="activeTab = 'b2c-reporting'" 
                        :class="activeTab === 'b2c-reporting' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition flex items-center space-x-2">
                    <span>üì°</span>
                    <span>B2C Reporting</span>
                    <span x-show="b2cPending.length > 0" class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800" x-text="b2cPending.length"></span>
                </button>
                <button @click="activeTab = 'penalties'" 
                        :class="activeTab === 'penalties' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition flex items-center space-x-2">
                    <span>‚ö†Ô∏è</span>
                    <span>Penalties</span>
                    <span x-show="penaltySummary.total_outstanding > 0" class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800" x-text="formatCurrency(penaltySummary.total_outstanding)"></span>
                </button>
            </nav>
        </div>
    </div>

    <!-- Tab Content -->
    <div>
        <!-- 72-Hour Buyer Review Tab -->
        <div x-show="activeTab === 'buyer-review'" x-transition>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Summary Cards -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Pending Review</h3>
                        <span class="p-2 bg-yellow-100 rounded-lg">‚è≥</span>
                    </div>
                    <p class="text-3xl font-bold text-yellow-600" x-text="pendingReviews.length">0</p>
                    <p class="text-sm text-gray-500 mt-1">Awaiting buyer confirmation</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Overdue</h3>
                        <span class="p-2 bg-red-100 rounded-lg">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-3xl font-bold text-red-600" x-text="overdueReviews.length">0</p>
                    <p class="text-sm text-gray-500 mt-1">72-hour window expired</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Auto-Confirmed</h3>
                        <span class="p-2 bg-green-100 rounded-lg">‚úÖ</span>
                    </div>
                    <p class="text-3xl font-bold text-green-600" x-text="autoAcceptedReviews.length">0</p>
                    <p class="text-sm text-gray-500 mt-1">Deemed accepted by law</p>
                </div>
            </div>

            <!-- Info Banner -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">2026 Tax Reform: 72-Hour Buyer Review</h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <p>Under the 2026 Tax Administration Act, buyers have <strong>72 hours</strong> to review and dispute e-invoices. If no response is received within this window, the invoice is <strong>deemed accepted</strong>. Disputed invoices require automatic Credit Note generation.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Poll NRS Button -->
            <div class="flex justify-end mb-4">
                <button @click="pollNRS()" 
                        :disabled="polling"
                        class="bg-green-600 hover:bg-green-700 disabled:opacity-50 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center space-x-2">
                    <span x-show="!polling">üîÑ Poll NRS for Responses</span>
                    <span x-show="polling" class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Polling...
                    </span>
                </button>
            </div>

            <!-- Pending Reviews Table -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Invoices Pending Buyer Review</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice #</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deadline</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time Left</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="review in pendingReviews" :key="review.invoice_id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-sm font-medium text-gray-900" x-text="review.invoice_number"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                              :class="getStatusClass(review.buyer_status)"
                                              x-text="formatStatus(review.buyer_status)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDateTime(review.dispute_deadline)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-sm font-medium" 
                                              :class="getTimeLeftClass(review.dispute_deadline)"
                                              x-text="getTimeLeft(review.dispute_deadline)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button @click="viewInvoice(review.invoice_id)" class="text-green-600 hover:text-green-900 mr-3">View</button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="pendingReviews.length === 0">
                                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                    No invoices pending buyer review üéâ
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VAT Recovery Tab -->
        <div x-show="activeTab === 'vat-recovery'" x-transition>
            <!-- VAT Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">Total Recoverable VAT</h3>
                    <p class="text-2xl font-bold text-green-600" x-text="formatCurrency(vatSummary.total_recoverable || 0)">‚Ç¶0</p>
                    <p class="text-xs text-gray-400 mt-1">With valid vendor IRN</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">Non-Recoverable VAT</h3>
                    <p class="text-2xl font-bold text-red-600" x-text="formatCurrency(vatSummary.total_non_recoverable || 0)">‚Ç¶0</p>
                    <p class="text-xs text-gray-400 mt-1">Missing or invalid IRN</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">Total Input VAT</h3>
                    <p class="text-2xl font-bold text-blue-600" x-text="formatCurrency(vatSummary.total_input_vat || 0)">‚Ç¶0</p>
                    <p class="text-xs text-gray-400 mt-1">This period</p>
                </div>
            </div>

            <!-- Info Banner -->
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-amber-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-amber-800">2026 Tax Reform: Expanded VAT Recovery</h3>
                        <div class="mt-2 text-sm text-amber-700">
                            <p>The 2026 Act now allows recovery of VAT on <strong>services</strong> and <strong>capital assets</strong> (previously restricted to stock-in-trade). However, recovery is <strong>ONLY permitted</strong> when the vendor provides a valid NRS Invoice Reference Number (IRN).</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VAT Recovery by Type Chart -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">VAT Recovery by Type</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-600">Stock-in-Trade</span>
                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Standard</span>
                        </div>
                        <p class="text-xl font-bold text-gray-900" x-text="formatCurrency(vatSummary.by_type?.stock_in_trade || 0)">‚Ç¶0</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-600">Services</span>
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">NEW 2026</span>
                        </div>
                        <p class="text-xl font-bold text-gray-900" x-text="formatCurrency(vatSummary.by_type?.services || 0)">‚Ç¶0</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-600">Capital Expenditure</span>
                            <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">NEW 2026</span>
                        </div>
                        <p class="text-xl font-bold text-gray-900" x-text="formatCurrency(vatSummary.by_type?.capital_expenditure || 0)">‚Ç¶0</p>
                    </div>
                </div>
            </div>

            <!-- Record New VAT Recovery -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Record VAT Recovery</h3>
                <form @submit.prevent="recordVATRecovery()" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Recovery Type</label>
                        <select x-model="vatForm.recovery_type" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <option value="stock_in_trade">Stock-in-Trade</option>
                            <option value="services">Services (2026)</option>
                            <option value="capital_expenditure">Capital Expenditure (2026)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">VAT Amount (‚Ç¶)</label>
                        <input type="number" step="0.01" x-model="vatForm.vat_amount" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="0.00" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Vendor IRN <span class="text-red-500">*</span></label>
                        <input type="text" x-model="vatForm.vendor_irn" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="NRS Invoice Reference Number" required>
                        <p class="text-xs text-gray-500 mt-1">Required for VAT recovery under 2026 law</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Date</label>
                        <input type="date" x-model="vatForm.transaction_date" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Vendor Name</label>
                        <input type="text" x-model="vatForm.vendor_name" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="Vendor name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Vendor TIN</label>
                        <input type="text" x-model="vatForm.vendor_tin" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="Tax Identification Number">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea x-model="vatForm.description" rows="2" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="Description of the purchase/service"></textarea>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition">
                            Record VAT Recovery
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Development Levy Tab -->
        <div x-show="activeTab === 'development-levy'" x-transition>
            <!-- Info Banner -->
            <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-purple-800">2026 Tax Reform: Development Levy (4%)</h3>
                        <div class="mt-2 text-sm text-purple-700">
                            <p>The 2026 Act consolidates multiple levies (Tertiary Education Tax, Police Fund, etc.) into a single <strong>4% Development Levy</strong> on assessable profit.</p>
                            <p class="mt-1"><strong>Exemption:</strong> Businesses with annual turnover ‚â§ ‚Ç¶100M AND fixed assets ‚â§ ‚Ç¶250M are exempt.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Levy Calculator -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Calculate Development Levy</h3>
                <form @submit.prevent="calculateLevy()" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fiscal Year</label>
                            <select x-model="levyForm.fiscal_year" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                <option value="2026">2026</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Assessable Profit (‚Ç¶)</label>
                            <input type="number" step="0.01" x-model="levyForm.assessable_profit" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="Enter assessable profit" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Annual Turnover (‚Ç¶) <span class="text-gray-400">(for exemption check)</span></label>
                            <input type="number" step="0.01" x-model="levyForm.turnover" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="Optional">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fixed Assets Value (‚Ç¶) <span class="text-gray-400">(for exemption check)</span></label>
                            <input type="number" step="0.01" x-model="levyForm.fixed_assets" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="Optional">
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium transition">
                            Calculate Levy
                        </button>
                    </div>
                </form>
            </div>

            <!-- Calculation Result -->
            <div x-show="levyResult" class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Calculation Result</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center py-2 border-b">
                            <span class="text-gray-600">Fiscal Year</span>
                            <span class="font-semibold" x-text="levyResult?.fiscal_year || '-'"></span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b">
                            <span class="text-gray-600">Assessable Profit</span>
                            <span class="font-semibold" x-text="formatCurrency(levyResult?.assessable_profit || 0)"></span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b">
                            <span class="text-gray-600">Levy Rate</span>
                            <span class="font-semibold text-purple-600" x-text="levyResult?.levy_rate_percentage || '4%'"></span>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-6 text-center">
                        <p class="text-sm text-gray-500 mb-2">Development Levy Payable</p>
                        <p class="text-3xl font-bold" :class="levyResult?.is_exempt ? 'text-green-600' : 'text-purple-600'" x-text="levyResult?.is_exempt ? 'EXEMPT' : formatCurrency(levyResult?.levy_amount || 0)">‚Ç¶0</p>
                        <p x-show="levyResult?.is_exempt" class="text-sm text-green-600 mt-2" x-text="levyResult?.exemption_reason"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PIT Relief Tab -->
        <div x-show="activeTab === 'pit-relief'" x-transition>
            <!-- Info Banner -->
            <div class="bg-teal-50 border border-teal-200 rounded-xl p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-teal-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-teal-800">2026 Tax Reform: PIT Reliefs (CRA Abolished)</h3>
                        <div class="mt-2 text-sm text-teal-700">
                            <p>The 2026 Act <strong>abolishes the Consolidated Relief Allowance (CRA)</strong> and replaces it with specific, document-based reliefs:</p>
                            <ul class="list-disc list-inside mt-1">
                                <li><strong>Rent Relief:</strong> 20% of actual rent paid (max ‚Ç¶500,000)</li>
                                <li><strong>Life Insurance:</strong> Actual premium paid</li>
                                <li><strong>Pension, NHF, NHIS:</strong> Actual contributions</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relief Summary -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <template x-for="relief in pitReliefs" :key="relief.id">
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-600" x-text="formatReliefType(relief.relief_type)"></span>
                            <span class="text-xs px-2 py-1 rounded-full"
                                  :class="relief.status === 'approved' ? 'bg-green-100 text-green-700' : relief.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'"
                                  x-text="relief.status"></span>
                        </div>
                        <p class="text-lg font-bold text-gray-900" x-text="formatCurrency(relief.claimed_amount)">‚Ç¶0</p>
                        <p class="text-xs text-gray-400" x-text="'FY ' + relief.fiscal_year"></p>
                    </div>
                </template>
                <div x-show="pitReliefs.length === 0" class="md:col-span-4 bg-gray-50 rounded-xl p-8 text-center text-gray-500">
                    No relief documents yet. Add your first relief claim below.
                </div>
            </div>

            <!-- Add Relief Form -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Claim PIT Relief</h3>
                <form @submit.prevent="claimRelief()" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Relief Type</label>
                        <select x-model="reliefForm.relief_type" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <option value="rent">Rent Relief (20%, max ‚Ç¶500k)</option>
                            <option value="life_insurance">Life Insurance Premium</option>
                            <option value="pension">Pension Contribution</option>
                            <option value="nhf">National Housing Fund (NHF)</option>
                            <option value="nhis">National Health Insurance (NHIS)</option>
                            <option value="gratuity">Gratuity Contribution</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fiscal Year</label>
                        <select x-model="reliefForm.fiscal_year" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Claimed Amount (‚Ç¶)</label>
                        <input type="number" step="0.01" x-model="reliefForm.claimed_amount" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="Amount to claim" required>
                    </div>
                    <div x-show="reliefForm.relief_type === 'rent'">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Annual Rent Paid (‚Ç¶)</label>
                        <input type="number" step="0.01" x-model="reliefForm.annual_rent" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="Total annual rent">
                        <p class="text-xs text-gray-500 mt-1">Relief = 20% of rent, max ‚Ç¶500,000</p>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded-lg font-medium transition">
                            Submit Relief Claim
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Credit Notes Tab -->
        <div x-show="activeTab === 'credit-notes'" x-transition>
            <!-- Info Banner -->
            <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-orange-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-orange-800">2026 Tax Reform: Credit Notes</h3>
                        <div class="mt-2 text-sm text-orange-700">
                            <p>When a buyer disputes an invoice within the 72-hour window, the system automatically generates a <strong>Credit Note</strong>. Credit Notes must be submitted to NRS within <strong>30 days</strong> of the original invoice date.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Credit Notes Table -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Credit Notes</h3>
                    <div class="flex space-x-2">
                        <select x-model="creditNoteFilter" class="text-sm rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="submitted">Submitted</option>
                            <option value="accepted">Accepted</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Credit Note #</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Original Invoice</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issue Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="note in filteredCreditNotes" :key="note.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-sm font-medium text-gray-900" x-text="note.credit_note_number"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="note.original_invoice_id ? '...' + String(note.original_invoice_id).slice(-8) : '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(note.issue_date)"></td>
                                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" x-text="note.reason"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <span class="text-sm font-semibold text-red-600" x-text="formatCurrency(note.total_amount)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                              :class="note.status === 'accepted' ? 'bg-green-100 text-green-800' : note.status === 'submitted' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'"
                                              x-text="note.status"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button x-show="note.status === 'draft'" @click="submitCreditNote(note.id)" class="text-green-600 hover:text-green-900">Submit to NRS</button>
                                        <span x-show="note.status !== 'draft'" class="text-gray-400" x-text="note.nrs_irn ? 'IRN: ' + note.nrs_irn.slice(0,12) + '...' : ''"></span>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="creditNotes.length === 0">
                                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                    No credit notes found
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TIN Validation Tab -->
        <div x-show="activeTab === 'tin-validation'" x-transition>
            <!-- Info Banner -->
            <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-purple-800">2026 Compliance: TIN Validation</h3>
                        <div class="mt-2 text-sm text-purple-700">
                            <p>Under the 2026 Tax Administration Act, all vendors/suppliers must have valid TINs before contracts can be awarded. Failure to validate can result in a <strong>‚Ç¶5,000,000 penalty</strong>. Validate TINs via the <a href="https://taxid.nrs.gov.ng/" target="_blank" class="underline">NRS TaxID Portal</a>.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- TIN Validation Form -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Validate TIN</h3>
                    <form @submit.prevent="validateTIN()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tax Identification Number (TIN) *</label>
                                <input type="text" x-model="tinForm.tin" required 
                                       placeholder="1234567890 or 12345-67890-0001"
                                       class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                <p class="mt-1 text-xs text-gray-500">10-14 digits, hyphens allowed</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Entity Type (Optional)</label>
                                <select x-model="tinForm.entity_type" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                    <option value="">Auto-detect</option>
                                    <option value="individual">Individual (NIN-based)</option>
                                    <option value="business_name">Business Name (Sole Proprietorship)</option>
                                    <option value="company">Limited Liability Company</option>
                                    <option value="incorporated_trustee">Incorporated Trustee (NGO/Church)</option>
                                    <option value="limited_partnership">Limited Partnership</option>
                                    <option value="llp">Limited Liability Partnership</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Search Term (Optional)</label>
                                <input type="text" x-model="tinForm.search_term" 
                                       placeholder="NIN for individuals, or business name"
                                       class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            </div>
                            <button type="submit" 
                                    :disabled="tinValidating || !tinForm.tin"
                                    class="w-full bg-purple-600 hover:bg-purple-700 disabled:opacity-50 text-white px-4 py-2 rounded-lg font-medium transition">
                                <span x-show="!tinValidating">üîç Validate TIN</span>
                                <span x-show="tinValidating">Validating...</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Validation Result -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Validation Result</h3>
                    <template x-if="!tinResult">
                        <div class="text-center py-8 text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p>Enter a TIN and click "Validate TIN" to check its status</p>
                        </div>
                    </template>
                    <template x-if="tinResult">
                        <div>
                            <!-- Status Badge -->
                            <div class="mb-4">
                                <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium"
                                      :class="tinResult.is_valid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                    <span x-text="tinResult.is_valid ? '‚úÖ Valid TIN' : '‚ùå Invalid TIN'"></span>
                                </span>
                            </div>
                            
                            <!-- Result Details -->
                            <dl class="space-y-3">
                                <div class="flex justify-between">
                                    <dt class="text-sm text-gray-500">TIN</dt>
                                    <dd class="text-sm font-medium text-gray-900" x-text="tinResult.tin"></dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-sm text-gray-500">Status</dt>
                                    <dd class="text-sm font-medium" :class="tinResult.is_valid ? 'text-green-600' : 'text-red-600'" x-text="tinResult.status"></dd>
                                </div>
                                <template x-if="tinResult.registered_name">
                                    <div class="flex justify-between">
                                        <dt class="text-sm text-gray-500">Registered Name</dt>
                                        <dd class="text-sm font-medium text-gray-900" x-text="tinResult.registered_name"></dd>
                                    </div>
                                </template>
                                <template x-if="tinResult.entity_type">
                                    <div class="flex justify-between">
                                        <dt class="text-sm text-gray-500">Entity Type</dt>
                                        <dd class="text-sm font-medium text-gray-900" x-text="tinResult.entity_type"></dd>
                                    </div>
                                </template>
                                <template x-if="tinResult.rc_number">
                                    <div class="flex justify-between">
                                        <dt class="text-sm text-gray-500">RC Number</dt>
                                        <dd class="text-sm font-medium text-gray-900" x-text="tinResult.rc_number"></dd>
                                    </div>
                                </template>
                                <template x-if="tinResult.tax_office">
                                    <div class="flex justify-between">
                                        <dt class="text-sm text-gray-500">Tax Office</dt>
                                        <dd class="text-sm font-medium text-gray-900" x-text="tinResult.tax_office"></dd>
                                    </div>
                                </template>
                                <template x-if="tinResult.vat_registered !== null">
                                    <div class="flex justify-between">
                                        <dt class="text-sm text-gray-500">VAT Registered</dt>
                                        <dd class="text-sm font-medium" :class="tinResult.vat_registered ? 'text-green-600' : 'text-gray-600'" 
                                            x-text="tinResult.vat_registered ? 'Yes' : 'No'"></dd>
                                    </div>
                                </template>
                                <div class="border-t pt-3">
                                    <dt class="text-sm text-gray-500 mb-1">Message</dt>
                                    <dd class="text-sm text-gray-700 bg-gray-50 p-2 rounded" x-text="tinResult.message"></dd>
                                </div>
                                <template x-if="tinResult.validated_at">
                                    <div class="text-xs text-gray-400 text-right">
                                        Validated: <span x-text="new Date(tinResult.validated_at).toLocaleString()"></span>
                                    </div>
                                </template>
                            </dl>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Bulk Validation Section -->
            <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Bulk TIN Validation</h3>
                <p class="text-sm text-gray-500 mb-4">Validate multiple TINs at once. Enter one TIN per line (maximum 50).</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <textarea x-model="bulkTins" rows="10" placeholder="1234567890
9876543210
5678901234"
                                  class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 font-mono text-sm"></textarea>
                        <button @click="validateBulkTINs()" 
                                :disabled="bulkValidating || !bulkTins.trim()"
                                class="mt-3 w-full bg-purple-600 hover:bg-purple-700 disabled:opacity-50 text-white px-4 py-2 rounded-lg font-medium transition">
                            <span x-show="!bulkValidating">üîç Validate All TINs</span>
                            <span x-show="bulkValidating">Validating...</span>
                        </button>
                    </div>
                    <div>
                        <template x-if="bulkResults">
                            <div>
                                <div class="flex space-x-4 mb-4">
                                    <div class="bg-gray-50 rounded-lg p-3 flex-1 text-center">
                                        <p class="text-2xl font-bold text-gray-900" x-text="bulkResults.total">0</p>
                                        <p class="text-xs text-gray-500">Total</p>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-3 flex-1 text-center">
                                        <p class="text-2xl font-bold text-green-600" x-text="bulkResults.valid_count">0</p>
                                        <p class="text-xs text-gray-500">Valid</p>
                                    </div>
                                    <div class="bg-red-50 rounded-lg p-3 flex-1 text-center">
                                        <p class="text-2xl font-bold text-red-600" x-text="bulkResults.invalid_count">0</p>
                                        <p class="text-xs text-gray-500">Invalid</p>
                                    </div>
                                </div>
                                <div class="max-h-64 overflow-y-auto">
                                    <template x-for="result in bulkResults.results" :key="result.tin">
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="font-mono text-sm" x-text="result.tin"></span>
                                            <span class="text-sm" :class="result.is_valid ? 'text-green-600' : 'text-red-600'"
                                                  x-text="result.is_valid ? '‚úì Valid' : '‚úï Invalid'"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                        <template x-if="!bulkResults">
                            <div class="text-center py-8 text-gray-500">
                                <p>Enter TINs in the textarea and click "Validate All" to see results</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zero-Rated VAT Tab -->
        <div x-show="activeTab === 'zero-rated'" x-transition>
            <!-- Info Banner -->
            <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-emerald-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-emerald-800">2026 Reform: Zero-Rated VAT Input Credit</h3>
                        <div class="mt-2 text-sm text-emerald-700">
                            <p>Suppliers of <strong>zero-rated goods</strong> (basic food, education materials, healthcare, exports) can claim <strong>input VAT refunds</strong>. Unlike exempt supplies, zero-rated allows recovery of VAT paid on purchases. Only purchases with valid NRS IRN qualify for refund.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Zero-Rated Categories -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Zero-Rated Categories</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg">
                            <span class="text-sm font-medium text-emerald-700">üçû Basic Food</span>
                            <span class="text-xs text-emerald-600">0% VAT</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg">
                            <span class="text-sm font-medium text-emerald-700">üìö Educational Materials</span>
                            <span class="text-xs text-emerald-600">0% VAT</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg">
                            <span class="text-sm font-medium text-emerald-700">üíä Medical Supplies</span>
                            <span class="text-xs text-emerald-600">0% VAT</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg">
                            <span class="text-sm font-medium text-emerald-700">üö¢ Exported Goods</span>
                            <span class="text-xs text-emerald-600">0% VAT</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg">
                            <span class="text-sm font-medium text-emerald-700">üåæ Agricultural Inputs</span>
                            <span class="text-xs text-emerald-600">0% VAT</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg">
                            <span class="text-sm font-medium text-emerald-700">üë∂ Baby Products</span>
                            <span class="text-xs text-emerald-600">0% VAT</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Zero-rated ‚â† Exempt. Zero-rated suppliers can claim input VAT refunds.</p>
                </div>

                <!-- Record Zero-Rated Sale -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Record Zero-Rated Sale</h3>
                    <form @submit.prevent="recordZeroRatedSale()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                                <select x-model="zeroRatedForm.category" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500">
                                    <option value="">Select category</option>
                                    <option value="basic_food">Basic Food</option>
                                    <option value="educational_materials">Educational Materials</option>
                                    <option value="medical_supplies">Medical Supplies</option>
                                    <option value="exported_goods">Exported Goods</option>
                                    <option value="agricultural_inputs">Agricultural Inputs</option>
                                    <option value="baby_products">Baby Products</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Sale Amount (‚Ç¶) *</label>
                                <input type="number" step="0.01" x-model="zeroRatedForm.sale_amount" required
                                       placeholder="0.00"
                                       class="w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Date *</label>
                                <input type="date" x-model="zeroRatedForm.transaction_date" required
                                       class="w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea x-model="zeroRatedForm.description" rows="2"
                                          placeholder="Description of the sale"
                                          class="w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500"></textarea>
                            </div>
                            <button type="submit" 
                                    class="w-full bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium transition">
                                Record Zero-Rated Sale
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Input VAT for Refund -->
            <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Record Input VAT for Refund Claim</h3>
                <p class="text-sm text-gray-500 mb-4">Record input VAT paid on purchases. Only purchases with valid vendor IRN qualify for refund.</p>
                <form @submit.prevent="recordInputVATForRefund()" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Purchase Amount (‚Ç¶) *</label>
                        <input type="number" step="0.01" x-model="inputVATForm.purchase_amount" required
                               placeholder="0.00"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">VAT Amount (‚Ç¶) *</label>
                        <input type="number" step="0.01" x-model="inputVATForm.vat_amount" required
                               placeholder="0.00"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Date *</label>
                        <input type="date" x-model="inputVATForm.transaction_date" required
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Vendor TIN *</label>
                        <input type="text" x-model="inputVATForm.vendor_tin" required
                               placeholder="Vendor Tax ID"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Vendor IRN <span class="text-emerald-600">(Required for refund)</span></label>
                        <input type="text" x-model="inputVATForm.vendor_irn"
                               placeholder="NRS Invoice Reference"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <input type="text" x-model="inputVATForm.description"
                               placeholder="Purchase description"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500">
                    </div>
                    <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                        <button type="submit" 
                                class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium transition">
                            Record Input VAT
                        </button>
                    </div>
                </form>
            </div>

            <!-- Refund Claim Summary -->
            <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Refund Claim Summary</h3>
                    <button @click="loadRefundClaim()" class="text-emerald-600 hover:text-emerald-700 text-sm font-medium">
                        Refresh
                    </button>
                </div>
                <template x-if="refundClaim">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-gray-900" x-text="formatCurrency(refundClaim.total_zero_rated_sales)">‚Ç¶0</p>
                            <p class="text-xs text-gray-500">Zero-Rated Sales</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-gray-900" x-text="formatCurrency(refundClaim.total_input_vat_paid)">‚Ç¶0</p>
                            <p class="text-xs text-gray-500">Total Input VAT</p>
                        </div>
                        <div class="bg-emerald-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-emerald-600" x-text="formatCurrency(refundClaim.refundable_input_vat)">‚Ç¶0</p>
                            <p class="text-xs text-emerald-700">Refundable (with IRN)</p>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-red-600" x-text="formatCurrency(refundClaim.non_refundable_vat)">‚Ç¶0</p>
                            <p class="text-xs text-red-700">Non-Refundable (no IRN)</p>
                        </div>
                    </div>
                </template>
                <template x-if="!refundClaim">
                    <div class="text-center py-8 text-gray-500">
                        <p>No refund claim data. Record zero-rated sales and input VAT to calculate.</p>
                    </div>
                </template>
            </div>
        </div>

        <!-- Minimum ETR (15%) Tab -->
        <div x-show="activeTab === 'minimum-etr'" x-transition>
            <!-- Info Banner -->
            <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-purple-800">2026 Reform: 15% Minimum Effective Tax Rate</h3>
                        <p class="mt-1 text-sm text-purple-700">
                            Companies with turnover ‚â• ‚Ç¶50 billion or MNE constituents with group revenue ‚â• ‚Ç¨750M must pay at least 15% effective tax rate.
                            If your ETR is below 15%, a top-up tax applies.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ETR Thresholds Card -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Applicability Thresholds</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-purple-50 rounded-lg p-4">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-2">üè¢</span>
                            <span class="font-semibold text-purple-900">Large Nigerian Companies</span>
                        </div>
                        <p class="text-purple-700 text-sm">Annual Turnover ‚â• ‚Ç¶50,000,000,000</p>
                        <p class="text-xs text-purple-600 mt-1">(‚Ç¶50 billion threshold)</p>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-2">üåç</span>
                            <span class="font-semibold text-purple-900">MNE Constituents</span>
                        </div>
                        <p class="text-purple-700 text-sm">Group Revenue ‚â• ‚Ç¨750,000,000</p>
                        <p class="text-xs text-purple-600 mt-1">(‚Ç¨750 million threshold)</p>
                    </div>
                </div>
            </div>

            <!-- ETR Calculator -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Calculate Minimum ETR & Top-Up Tax</h3>
                <form @submit.prevent="calculateMinimumETR()" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Annual Turnover (‚Ç¶) *</label>
                        <input type="number" x-model="etrForm.annual_turnover" min="0" step="1000000" required
                               placeholder="e.g., 60000000000"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Assessable Profit (‚Ç¶) *</label>
                        <input type="number" x-model="etrForm.assessable_profit" min="0" step="1000000" required
                               placeholder="e.g., 10000000000"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Regular Tax Paid (‚Ç¶) *</label>
                        <input type="number" x-model="etrForm.regular_tax_paid" min="0" step="1000000" required
                               placeholder="e.g., 1000000000"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" x-model="etrForm.is_mne_constituent" id="is_mne" 
                               class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                        <label for="is_mne" class="ml-2 block text-sm text-gray-700">MNE Constituent</label>
                    </div>
                    <div x-show="etrForm.is_mne_constituent">
                        <label class="block text-sm font-medium text-gray-700 mb-1">MNE Group Revenue (‚Ç¨)</label>
                        <input type="number" x-model="etrForm.mne_group_revenue_eur" min="0" step="1000000"
                               placeholder="e.g., 800000000"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                    </div>
                    <div class="flex items-end">
                        <button type="submit" 
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium transition">
                            Calculate ETR
                        </button>
                    </div>
                </form>
            </div>

            <!-- ETR Result -->
            <template x-if="etrResult">
                <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Calculation Result</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold" :class="etrResult.is_subject_to_minimum_etr ? 'text-purple-600' : 'text-gray-600'" 
                               x-text="etrResult.calculated_etr_percentage">0%</p>
                            <p class="text-xs text-gray-500">Calculated ETR</p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-purple-600" x-text="etrResult.minimum_etr_percentage">15%</p>
                            <p class="text-xs text-purple-700">Minimum ETR</p>
                        </div>
                        <div class="rounded-lg p-4 text-center" :class="etrResult.top_up_tax > 0 ? 'bg-red-50' : 'bg-green-50'">
                            <p class="text-2xl font-bold" :class="etrResult.top_up_tax > 0 ? 'text-red-600' : 'text-green-600'" 
                               x-text="formatCurrency(etrResult.top_up_tax)">‚Ç¶0</p>
                            <p class="text-xs" :class="etrResult.top_up_tax > 0 ? 'text-red-700' : 'text-green-700'">Top-Up Tax</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-gray-900" x-text="formatCurrency(etrResult.total_tax)">‚Ç¶0</p>
                            <p class="text-xs text-gray-500">Total Tax</p>
                        </div>
                    </div>
                    <div class="mt-4 p-4 rounded-lg" :class="etrResult.is_subject_to_minimum_etr ? 'bg-purple-50' : 'bg-gray-50'">
                        <p class="text-sm" :class="etrResult.is_subject_to_minimum_etr ? 'text-purple-800' : 'text-gray-700'" x-text="etrResult.compliance_note"></p>
                    </div>
                </div>
            </template>
        </div>

        <!-- CGT (30%) Tab -->
        <div x-show="activeTab === 'cgt'" x-transition>
            <!-- Info Banner -->
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-amber-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-amber-800">2026 Reform: Capital Gains Tax at 30%</h3>
                        <p class="mt-1 text-sm text-amber-700">
                            CGT rate increased from 10% to 30% for large companies. Small companies (turnover ‚â§ ‚Ç¶100M AND assets ‚â§ ‚Ç¶250M) are exempt.
                            Indexation allowance available for inflation adjustment on long-held assets.
                        </p>
                    </div>
                </div>
            </div>

            <!-- CGT Thresholds Card -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">CGT Rates & Exemptions</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-amber-50 rounded-lg p-4 text-center">
                        <p class="text-3xl font-bold text-amber-600">30%</p>
                        <p class="text-sm text-amber-800 font-medium">Large Company Rate</p>
                        <p class="text-xs text-amber-600 mt-1">Turnover > ‚Ç¶100M OR Assets > ‚Ç¶250M</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center">
                        <p class="text-3xl font-bold text-green-600">0%</p>
                        <p class="text-sm text-green-800 font-medium">Small Company Rate</p>
                        <p class="text-xs text-green-600 mt-1">Turnover ‚â§ ‚Ç¶100M AND Assets ‚â§ ‚Ç¶250M</p>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 text-center">
                        <p class="text-3xl font-bold text-blue-600">~15%</p>
                        <p class="text-sm text-blue-800 font-medium">Avg. Inflation Allowance</p>
                        <p class="text-xs text-blue-600 mt-1">Indexation for long-held assets</p>
                    </div>
                </div>
            </div>

            <!-- Check Exemption -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Check Small Company Exemption</h3>
                <form @submit.prevent="checkCGTExemption()" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Annual Turnover (‚Ç¶)</label>
                        <input type="number" x-model="cgtExemptionForm.annual_turnover" min="0" step="1000000"
                               placeholder="e.g., 50000000"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fixed Assets Value (‚Ç¶)</label>
                        <input type="number" x-model="cgtExemptionForm.fixed_assets_value" min="0" step="1000000"
                               placeholder="e.g., 100000000"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500">
                    </div>
                    <div class="flex items-end">
                        <button type="submit" 
                                class="w-full bg-amber-500 hover:bg-amber-600 text-white px-6 py-2 rounded-lg font-medium transition">
                            Check Exemption
                        </button>
                    </div>
                </form>
                <template x-if="cgtExemptionResult">
                    <div class="mt-4 p-4 rounded-lg" :class="cgtExemptionResult.is_exempt ? 'bg-green-50' : 'bg-amber-50'">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2" x-text="cgtExemptionResult.is_exempt ? '‚úÖ' : '‚ö†Ô∏è'"></span>
                            <div>
                                <p class="font-medium" :class="cgtExemptionResult.is_exempt ? 'text-green-800' : 'text-amber-800'" 
                                   x-text="cgtExemptionResult.is_exempt ? 'Small Company - CGT Exempt' : 'Large Company - Subject to 30% CGT'"></p>
                                <p class="text-sm" :class="cgtExemptionResult.is_exempt ? 'text-green-600' : 'text-amber-600'" 
                                   x-text="cgtExemptionResult.exemption_reason"></p>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- CGT Calculator -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Calculate CGT on Asset Disposal</h3>
                <form @submit.prevent="calculateCGT()" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Asset Cost (‚Ç¶) *</label>
                        <input type="number" x-model="cgtForm.asset_cost" min="0" step="1000" required
                               placeholder="Original purchase price"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sale Proceeds (‚Ç¶) *</label>
                        <input type="number" x-model="cgtForm.sale_proceeds" min="0" step="1000" required
                               placeholder="Disposal/sale amount"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Annual Turnover (‚Ç¶) *</label>
                        <input type="number" x-model="cgtForm.annual_turnover" min="0" step="1000000" required
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fixed Assets Value (‚Ç¶) *</label>
                        <input type="number" x-model="cgtForm.fixed_assets_value" min="0" step="1000000" required
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Acquisition Date</label>
                        <input type="date" x-model="cgtForm.acquisition_date"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Disposal Date</label>
                        <input type="date" x-model="cgtForm.disposal_date"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" x-model="cgtForm.apply_indexation" id="apply_indexation" 
                               class="h-4 w-4 text-amber-600 focus:ring-amber-500 border-gray-300 rounded">
                        <label for="apply_indexation" class="ml-2 block text-sm text-gray-700">Apply Indexation Allowance</label>
                    </div>
                    <div class="md:col-span-2 lg:col-span-1 flex items-end">
                        <button type="submit" 
                                class="w-full bg-amber-600 hover:bg-amber-700 text-white px-6 py-2 rounded-lg font-medium transition">
                            Calculate CGT
                        </button>
                    </div>
                </form>
            </div>

            <!-- CGT Result -->
            <template x-if="cgtResult">
                <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">CGT Calculation Result</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-gray-900" x-text="formatCurrency(cgtResult.capital_gain)">‚Ç¶0</p>
                            <p class="text-xs text-gray-500">Capital Gain</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-blue-600" x-text="formatCurrency(cgtResult.indexation_allowance)">‚Ç¶0</p>
                            <p class="text-xs text-blue-700">Indexation Allowance</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-gray-900" x-text="cgtResult.cgt_rate_percentage">0%</p>
                            <p class="text-xs text-gray-500">CGT Rate</p>
                        </div>
                        <div class="rounded-lg p-4 text-center" :class="cgtResult.is_exempt ? 'bg-green-50' : 'bg-amber-50'">
                            <p class="text-2xl font-bold" :class="cgtResult.is_exempt ? 'text-green-600' : 'text-amber-600'" 
                               x-text="formatCurrency(cgtResult.cgt_liability)">‚Ç¶0</p>
                            <p class="text-xs" :class="cgtResult.is_exempt ? 'text-green-700' : 'text-amber-700'">CGT Liability</p>
                        </div>
                    </div>
                    <div class="mt-4 p-4 rounded-lg" :class="cgtResult.is_exempt ? 'bg-green-50' : 'bg-amber-50'">
                        <p class="text-sm" :class="cgtResult.is_exempt ? 'text-green-800' : 'text-amber-800'" x-text="cgtResult.note"></p>
                    </div>
                </div>
            </template>
        </div>

        <!-- Progressive PAYE Tab -->
        <div x-show="activeTab === 'paye'" x-transition>
            <!-- Info Banner -->
            <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-indigo-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-indigo-800">2026 Reform: Progressive PAYE with ‚Ç¶800,000 Tax-Free Threshold</h3>
                        <p class="mt-1 text-sm text-indigo-700">
                            The 2026 tax reform introduced a tax-free threshold of ‚Ç¶800,000 and progressive rates from 15% to 30%.
                            Plus automatic reliefs: CRA (‚Ç¶200,000 + 20%), Pension (8%), and NHF (2.5%).
                        </p>
                    </div>
                </div>
            </div>

            <!-- PAYE Tax Bands Card -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">2026 PAYE Tax Bands</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Income Range</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rate</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr class="bg-green-50">
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">‚Ç¶0 - ‚Ç¶800,000</td>
                                <td class="px-4 py-3"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">0%</span></td>
                                <td class="px-4 py-3 text-sm text-gray-600">Tax-free threshold</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">‚Ç¶800,001 - ‚Ç¶2,400,000</td>
                                <td class="px-4 py-3"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">15%</span></td>
                                <td class="px-4 py-3 text-sm text-gray-600">First taxable band</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">‚Ç¶2,400,001 - ‚Ç¶4,800,000</td>
                                <td class="px-4 py-3"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">20%</span></td>
                                <td class="px-4 py-3 text-sm text-gray-600">Second band</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">‚Ç¶4,800,001 - ‚Ç¶7,200,000</td>
                                <td class="px-4 py-3"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">25%</span></td>
                                <td class="px-4 py-3 text-sm text-gray-600">Third band</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">Above ‚Ç¶7,200,000</td>
                                <td class="px-4 py-3"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">30%</span></td>
                                <td class="px-4 py-3 text-sm text-gray-600">Top band (no limit)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reliefs Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üìã</span>
                        <span class="font-semibold text-gray-900">CRA</span>
                    </div>
                    <p class="text-indigo-600 font-medium">‚Ç¶200,000 + 20%</p>
                    <p class="text-xs text-gray-500 mt-1">Consolidated Relief Allowance</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üè¶</span>
                        <span class="font-semibold text-gray-900">Pension</span>
                    </div>
                    <p class="text-indigo-600 font-medium">Up to 8%</p>
                    <p class="text-xs text-gray-500 mt-1">Employee contribution (exempt)</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">üè†</span>
                        <span class="font-semibold text-gray-900">NHF</span>
                    </div>
                    <p class="text-indigo-600 font-medium">2.5%</p>
                    <p class="text-xs text-gray-500 mt-1">National Housing Fund</p>
                </div>
            </div>

            <!-- PAYE Calculator -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">PAYE Calculator</h3>
                <form @submit.prevent="calculatePAYE()" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gross Annual Income (‚Ç¶) *</label>
                        <input type="number" x-model="payeForm.gross_annual_income" min="0" step="10000" required
                               placeholder="e.g., 3600000"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Basic Salary (‚Ç¶)</label>
                        <input type="number" x-model="payeForm.basic_salary" min="0" step="10000"
                               placeholder="For NHF calculation"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pension %</label>
                        <input type="number" x-model="payeForm.pension_percentage" min="0" max="20" step="0.5"
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="flex items-end">
                        <button type="submit" 
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition">
                            Calculate PAYE
                        </button>
                    </div>
                </form>
            </div>

            <!-- PAYE Result -->
            <template x-if="payeResult">
                <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">PAYE Calculation Result</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-gray-900" x-text="formatCurrency(payeResult.gross_annual_income)">‚Ç¶0</p>
                            <p class="text-xs text-gray-500">Gross Annual</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-blue-600" x-text="formatCurrency(payeResult.total_reliefs)">‚Ç¶0</p>
                            <p class="text-xs text-blue-700">Total Reliefs</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-gray-900" x-text="formatCurrency(payeResult.taxable_income)">‚Ç¶0</p>
                            <p class="text-xs text-gray-500">Taxable Income</p>
                        </div>
                        <div class="rounded-lg p-4 text-center" :class="payeResult.annual_paye_tax > 0 ? 'bg-indigo-50' : 'bg-green-50'">
                            <p class="text-2xl font-bold" :class="payeResult.annual_paye_tax > 0 ? 'text-indigo-600' : 'text-green-600'" 
                               x-text="formatCurrency(payeResult.annual_paye_tax)">‚Ç¶0</p>
                            <p class="text-xs" :class="payeResult.annual_paye_tax > 0 ? 'text-indigo-700' : 'text-green-700'">Annual PAYE</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-indigo-50 rounded-lg p-4 text-center">
                            <p class="text-xl font-bold text-indigo-600" x-text="formatCurrency(payeResult.monthly_paye_tax)">‚Ç¶0</p>
                            <p class="text-xs text-indigo-700">Monthly PAYE</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-xl font-bold text-gray-900" x-text="payeResult.effective_rate">0%</p>
                            <p class="text-xs text-gray-500">Effective Rate</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <p class="text-xl font-bold text-gray-900" x-text="payeResult.tax_band">-</p>
                            <p class="text-xs text-gray-500">Tax Band</p>
                        </div>
                    </div>
                    <div class="p-4 rounded-lg bg-indigo-50">
                        <p class="text-sm text-indigo-800">
                            <strong>Relief Breakdown:</strong> 
                            CRA ‚Ç¶<span x-text="payeResult.consolidated_relief?.toLocaleString() || 0"></span> + 
                            Pension ‚Ç¶<span x-text="payeResult.pension_relief?.toLocaleString() || 0"></span> + 
                            NHF ‚Ç¶<span x-text="payeResult.nhf_relief?.toLocaleString() || 0"></span>
                        </p>
                    </div>
                </div>
            </template>

            <!-- Quick Threshold Check -->
            <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Tax-Free Threshold Check</h3>
                <form @submit.prevent="checkPAYEThreshold()" class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="number" x-model="payeThresholdCheck" min="0" step="10000"
                               placeholder="Enter gross annual income to check..."
                               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <button type="submit" 
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-medium transition">
                        Check Threshold
                    </button>
                </form>
                <template x-if="payeThresholdResult">
                    <div class="mt-4 p-4 rounded-lg" :class="payeThresholdResult.is_tax_exempt ? 'bg-green-50' : 'bg-indigo-50'">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2" x-text="payeThresholdResult.is_tax_exempt ? '‚úÖ' : 'üìä'"></span>
                            <div>
                                <p class="font-medium" :class="payeThresholdResult.is_tax_exempt ? 'text-green-800' : 'text-indigo-800'" 
                                   x-text="payeThresholdResult.message"></p>
                                <p class="text-sm text-gray-600 mt-1">
                                    Monthly gross: ‚Ç¶<span x-text="payeThresholdResult.monthly_gross?.toLocaleString() || 0"></span> | 
                                    CRA: ‚Ç¶<span x-text="payeThresholdResult.consolidated_relief?.toLocaleString() || 0"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- B2C Real-time Reporting Tab -->
        <div x-show="activeTab === 'b2c-reporting'" x-transition>
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Pending</h3>
                        <span class="p-2 bg-yellow-100 rounded-lg">‚è≥</span>
                    </div>
                    <p class="text-3xl font-bold text-yellow-600" x-text="b2cPending.length">0</p>
                    <p class="text-sm text-gray-500 mt-1">Awaiting NRS submission</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Overdue</h3>
                        <span class="p-2 bg-red-100 rounded-lg">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-3xl font-bold text-red-600" x-text="b2cOverdue.length">0</p>
                    <p class="text-sm text-gray-500 mt-1">Past 24-hour deadline</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Reported</h3>
                        <span class="p-2 bg-green-100 rounded-lg">‚úÖ</span>
                    </div>
                    <p class="text-3xl font-bold text-green-600" x-text="b2cReported.length">0</p>
                    <p class="text-sm text-gray-500 mt-1">Successfully reported</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Penalty Risk</h3>
                        <span class="p-2 bg-orange-100 rounded-lg">üí∞</span>
                    </div>
                    <p class="text-3xl font-bold text-orange-600" x-text="formatCurrency(b2cSummary.potential_penalty || 0)">‚Ç¶0</p>
                    <p class="text-sm text-gray-500 mt-1">‚Ç¶10,000 per late transaction</p>
                </div>
            </div>

            <!-- Info Banner -->
            <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-orange-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-orange-800">2026 Tax Reform: B2C Real-time Reporting</h3>
                        <div class="mt-2 text-sm text-orange-700">
                            <p>Under the 2026 Tax Administration Act, B2C transactions over <strong>‚Ç¶50,000</strong> must be reported to NRS within <strong>24 hours</strong>. Late reporting incurs a penalty of <strong>‚Ç¶10,000 per transaction</strong> (max ‚Ç¶500,000/day).</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Card -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">B2C Reporting Settings</h3>
                        <p class="text-sm text-gray-500">Configure real-time reporting for your entity</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Threshold</p>
                            <p class="font-semibold text-gray-900">‚Ç¶<span x-text="(b2cSettings.b2c_reporting_threshold || 50000).toLocaleString()">50,000</span></p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="b2cSettings.b2c_realtime_reporting_enabled" @change="updateB2CSettings()" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            <span class="ms-3 text-sm font-medium text-gray-700" x-text="b2cSettings.b2c_realtime_reporting_enabled ? 'Enabled' : 'Disabled'">Disabled</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Submit All Button -->
            <div class="flex justify-end mb-4" x-show="b2cPending.length > 0">
                <button @click="submitAllB2CReports()" 
                        :disabled="b2cSubmitting"
                        class="bg-green-600 hover:bg-green-700 disabled:opacity-50 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center space-x-2">
                    <span x-show="!b2cSubmitting">üì° Submit All to NRS (<span x-text="b2cPending.length"></span> pending)</span>
                    <span x-show="b2cSubmitting" class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Submitting...
                    </span>
                </button>
            </div>

            <!-- Pending Transactions Table -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6" x-show="b2cPending.length > 0 || b2cOverdue.length > 0">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Transactions Pending Submission</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deadline</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="tx in [...b2cOverdue, ...b2cPending]" :key="tx.invoice_id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-sm font-medium text-gray-900" x-text="tx.invoice_number"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-sm text-gray-500" x-text="tx.customer_name"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <span class="text-sm font-medium text-gray-900" x-text="formatCurrency(tx.total_amount)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDateTime(tx.report_deadline)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                              :class="tx.is_overdue ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'"
                                              x-text="tx.is_overdue ? 'OVERDUE' : 'Pending'"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button @click="submitSingleB2CReport(tx.invoice_id)" class="text-green-600 hover:text-green-900">Submit</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reported Transactions -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden" x-show="b2cReported.length > 0">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Successfully Reported Transactions</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reported At</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reference</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="tx in b2cReported" :key="tx.invoice_id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-sm font-medium text-gray-900" x-text="tx.invoice_number"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-sm text-gray-500" x-text="tx.customer_name"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <span class="text-sm font-medium text-gray-900" x-text="formatCurrency(tx.total_amount)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDateTime(tx.reported_at)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-sm font-mono text-green-600" x-text="tx.report_reference"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div x-show="b2cPending.length === 0 && b2cOverdue.length === 0 && b2cReported.length === 0" 
                 class="bg-white rounded-xl shadow-sm p-8 text-center">
                <div class="text-4xl mb-4">üì°</div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">No B2C Transactions to Report</h3>
                <p class="text-gray-500">B2C transactions over ‚Ç¶50,000 will appear here for real-time NRS reporting.</p>
            </div>
        </div>

        <!-- Compliance Penalties Tab -->
        <div x-show="activeTab === 'penalties'" x-transition>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                <!-- Summary Cards -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Total Penalties</h3>
                        <span class="p-2 bg-purple-100 rounded-lg">üìã</span>
                    </div>
                    <p class="text-3xl font-bold text-purple-600" x-text="penaltySummary.total_penalties || 0">0</p>
                    <p class="text-sm text-gray-500 mt-1">All time records</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Total Incurred</h3>
                        <span class="p-2 bg-red-100 rounded-lg">üí∏</span>
                    </div>
                    <p class="text-3xl font-bold text-red-600" x-text="formatCurrency(penaltySummary.total_incurred || 0)">‚Ç¶0</p>
                    <p class="text-sm text-gray-500 mt-1">Penalties charged</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Outstanding</h3>
                        <span class="p-2 bg-orange-100 rounded-lg">‚ö†Ô∏è</span>
                    </div>
                    <p class="text-3xl font-bold text-orange-600" x-text="formatCurrency(penaltySummary.total_outstanding || 0)">‚Ç¶0</p>
                    <p class="text-sm text-gray-500 mt-1">Unpaid penalties</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Paid</h3>
                        <span class="p-2 bg-green-100 rounded-lg">‚úÖ</span>
                    </div>
                    <p class="text-3xl font-bold text-green-600" x-text="formatCurrency(penaltySummary.total_paid || 0)">‚Ç¶0</p>
                    <p class="text-sm text-gray-500 mt-1">Settled penalties</p>
                </div>
            </div>

            <!-- Penalty Calculator -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">‚öñÔ∏è Penalty Calculator</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Penalty Type</label>
                        <select x-model="penaltyCalcForm.penalty_type" 
                                @change="penaltyCalcResult = null"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="">Select type...</option>
                            <option value="late_filing">Late Filing</option>
                            <option value="unregistered_vendor">Unregistered Vendor Contract</option>
                            <option value="vat_non_remittance">VAT Non-Remittance</option>
                            <option value="paye_non_remittance">PAYE Non-Remittance</option>
                            <option value="wht_non_remittance">WHT Non-Remittance</option>
                            <option value="b2c_late_reporting">B2C Late Reporting</option>
                            <option value="e_invoice_noncompliance">E-Invoice Non-Compliance</option>
                            <option value="invalid_tin">Invalid TIN</option>
                            <option value="missing_records">Missing Records</option>
                            <option value="nrs_access_denial">NRS Access Denial</option>
                        </select>
                    </div>
                    <!-- Late Filing Fields -->
                    <template x-if="penaltyCalcForm.penalty_type === 'late_filing'">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Original Due Date</label>
                            <input type="date" x-model="penaltyCalcForm.original_due_date" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </template>
                    <template x-if="penaltyCalcForm.penalty_type === 'late_filing'">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Filing Date</label>
                            <input type="date" x-model="penaltyCalcForm.filing_date" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </template>
                    <!-- Unregistered Vendor Fields -->
                    <template x-if="penaltyCalcForm.penalty_type === 'unregistered_vendor'">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contract Amount (‚Ç¶)</label>
                            <input type="number" x-model="penaltyCalcForm.contract_amount" step="0.01"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </template>
                    <!-- Tax Remittance Fields -->
                    <template x-if="['vat_non_remittance', 'paye_non_remittance', 'wht_non_remittance'].includes(penaltyCalcForm.penalty_type)">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tax Amount (‚Ç¶)</label>
                            <input type="number" x-model="penaltyCalcForm.tax_amount" step="0.01"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </template>
                    <template x-if="['vat_non_remittance', 'paye_non_remittance', 'wht_non_remittance'].includes(penaltyCalcForm.penalty_type)">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input type="date" x-model="penaltyCalcForm.due_date" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </template>
                    <template x-if="['vat_non_remittance', 'paye_non_remittance', 'wht_non_remittance'].includes(penaltyCalcForm.penalty_type)">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Payment Date</label>
                            <input type="date" x-model="penaltyCalcForm.payment_date" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </template>
                </div>
                <button @click="calculatePenalty()" 
                        :disabled="!penaltyCalcForm.penalty_type || penaltyCalculating"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50">
                    <span x-show="!penaltyCalculating">Calculate Penalty</span>
                    <span x-show="penaltyCalculating">Calculating...</span>
                </button>

                <!-- Calculation Result -->
                <div x-show="penaltyCalcResult" class="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-semibold text-purple-800">Calculation Result</h4>
                        <span class="text-2xl font-bold text-purple-700" x-text="formatCurrency(penaltyCalcResult?.total_amount || 0)"></span>
                    </div>
                    <p class="text-sm text-purple-700" x-text="penaltyCalcResult?.description"></p>
                    <div x-show="penaltyCalcResult?.months_late > 0" class="mt-2 text-sm text-purple-600">
                        <span class="font-medium">Months Late:</span> <span x-text="penaltyCalcResult?.months_late"></span>
                    </div>
                    <div class="mt-2 text-xs text-purple-600">
                        <span class="font-medium">Base:</span> <span x-text="formatCurrency(penaltyCalcResult?.base_amount || 0)"></span>
                        <span class="mx-2">|</span>
                        <span class="font-medium">Additional:</span> <span x-text="formatCurrency(penaltyCalcResult?.additional_amount || 0)"></span>
                    </div>
                </div>
            </div>

            <!-- Penalty Rates Reference -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-start space-x-3">
                    <span class="text-2xl">üìñ</span>
                    <div>
                        <h3 class="text-sm font-medium text-purple-800">2026 Compliance Penalty Schedule</h3>
                        <div class="mt-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm text-gray-700">
                            <div class="p-2 bg-gray-50 rounded">
                                <strong>Late Filing:</strong> ‚Ç¶100,000 (1st month) + ‚Ç¶50,000/subsequent month
                            </div>
                            <div class="p-2 bg-gray-50 rounded">
                                <strong>Unregistered Vendor:</strong> ‚Ç¶5,000,000 fixed penalty
                            </div>
                            <div class="p-2 bg-gray-50 rounded">
                                <strong>B2C Late Reporting:</strong> ‚Ç¶10,000/transaction (max ‚Ç¶500,000/day)
                            </div>
                            <div class="p-2 bg-gray-50 rounded">
                                <strong>Tax Remittance (VAT/PAYE/WHT):</strong> 10% + 2% monthly interest
                            </div>
                            <div class="p-2 bg-gray-50 rounded">
                                <strong>E-Invoice Non-Compliance:</strong> ‚Ç¶50,000 per invoice
                            </div>
                            <div class="p-2 bg-gray-50 rounded">
                                <strong>NRS Access Denial:</strong> ‚Ç¶1,000,000 fixed penalty
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Penalty Records Table -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Penalty Records</h3>
                    <div class="flex items-center space-x-2">
                        <select x-model="penaltyFilter" @change="loadPenalties()"
                                class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                            <option value="">All Status</option>
                            <option value="potential">Potential</option>
                            <option value="incurred">Incurred</option>
                            <option value="paid">Paid</option>
                            <option value="waived">Waived</option>
                            <option value="disputed">Disputed</option>
                        </select>
                        <button @click="loadPenalties()" class="p-2 text-gray-500 hover:text-gray-700">
                            üîÑ
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Incurred</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Due Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="penalty in penaltyRecords" :key="penalty.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-sm font-medium text-gray-900" x-text="formatPenaltyType(penalty.penalty_type)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full"
                                              :class="{
                                                  'bg-yellow-100 text-yellow-800': penalty.status === 'potential',
                                                  'bg-red-100 text-red-800': penalty.status === 'incurred',
                                                  'bg-green-100 text-green-800': penalty.status === 'paid',
                                                  'bg-gray-100 text-gray-800': penalty.status === 'waived',
                                                  'bg-orange-100 text-orange-800': penalty.status === 'disputed'
                                              }"
                                              x-text="penalty.status.charAt(0).toUpperCase() + penalty.status.slice(1)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right">
                                        <span class="text-sm font-bold text-gray-900" x-text="formatCurrency(penalty.total_amount)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(penalty.incurred_date)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(penalty.due_date)"></td>
                                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" x-text="penalty.description"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <template x-if="penalty.status === 'incurred'">
                                            <div class="flex items-center justify-center space-x-2">
                                                <button @click="updatePenaltyStatus(penalty.id, 'paid')" 
                                                        class="text-green-600 hover:text-green-800 text-xs font-medium">
                                                    Mark Paid
                                                </button>
                                                <button @click="updatePenaltyStatus(penalty.id, 'disputed')" 
                                                        class="text-orange-600 hover:text-orange-800 text-xs font-medium">
                                                    Dispute
                                                </button>
                                            </div>
                                        </template>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <!-- Empty State -->
                <div x-show="penaltyRecords.length === 0" class="p-8 text-center">
                    <div class="text-4xl mb-4">‚úÖ</div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No Penalty Records</h3>
                    <p class="text-gray-500">Your compliance is in good standing. No penalties have been incurred.</p>
                </div>
            </div>

            <!-- By Type Breakdown -->
            <div x-show="Object.keys(penaltySummary.by_type || {}).length > 0" class="mt-6 bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Penalties by Type</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="(data, type) in penaltySummary.by_type" :key="type">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700" x-text="formatPenaltyType(type)"></span>
                                <span class="text-lg font-bold text-gray-900" x-text="formatCurrency(data.total)"></span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1"><span x-text="data.count"></span> occurrences</p>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="toast.show" x-transition
         class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50"
         :class="toast.type === 'success' ? 'bg-green-500 text-white' : toast.type === 'error' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'">
        <div class="flex items-center space-x-2">
            <span x-text="toast.message"></span>
            <button @click="toast.show = false" class="ml-2 text-white/80 hover:text-white">√ó</button>
        </div>
    </div>
</div>

<script>
function tax2026Dashboard() {
    const today = new Date().toISOString().split('T')[0];
    
    return {
        entityId: {{ entity_id|tojson if entity_id else 'null' }},
        activeTab: 'buyer-review',
        polling: false,
        noEntitySelected: false,
        
        // Data
        businessType: {},
        pendingReviews: [],
        overdueReviews: [],
        autoAcceptedReviews: [],
        vatSummary: { total_recoverable: 0, total_non_recoverable: 0, total_input_vat: 0, by_type: {} },
        pitReliefs: [],
        creditNotes: [],
        levyResult: null,
        creditNoteFilter: '',
        
        // B2C Reporting Data
        b2cPending: [],
        b2cOverdue: [],
        b2cReported: [],
        b2cSettings: { b2c_realtime_reporting_enabled: false, b2c_reporting_threshold: 50000 },
        b2cSummary: { potential_penalty: 0 },
        b2cSubmitting: false,
        
        // Compliance Penalties Data
        penaltyRecords: [],
        penaltySummary: { total_penalties: 0, total_incurred: 0, total_paid: 0, total_outstanding: 0, by_type: {} },
        penaltyFilter: '',
        penaltyCalcForm: { penalty_type: '', original_due_date: '', filing_date: '', contract_amount: '', tax_amount: '', due_date: '', payment_date: '' },
        penaltyCalcResult: null,
        penaltyCalculating: false,
        
        // Forms
        vatForm: {
            recovery_type: 'stock_in_trade',
            vat_amount: '',
            vendor_irn: '',
            transaction_date: today,
            vendor_name: '',
            vendor_tin: '',
            description: ''
        },
        levyForm: {
            fiscal_year: 2026,
            assessable_profit: '',
            turnover: '',
            fixed_assets: ''
        },
        reliefForm: {
            relief_type: 'rent',
            fiscal_year: 2026,
            claimed_amount: '',
            annual_rent: ''
        },
        
        // TIN Validation
        tinForm: { tin: '', entity_type: '', search_term: '' },
        tinValidating: false,
        tinResult: null,
        bulkTins: '',
        bulkValidating: false,
        bulkResults: null,
        
        // Zero-Rated VAT
        zeroRatedForm: { category: '', sale_amount: '', transaction_date: today, description: '' },
        inputVATForm: { purchase_amount: '', vat_amount: '', transaction_date: today, vendor_tin: '', vendor_irn: '', description: '' },
        refundClaim: null,
        
        // Minimum ETR (15%)
        etrForm: { annual_turnover: '', assessable_profit: '', regular_tax_paid: '', is_mne_constituent: false, mne_group_revenue_eur: '' },
        etrResult: null,
        
        // CGT (30%)
        cgtForm: { asset_cost: '', sale_proceeds: '', annual_turnover: '', fixed_assets_value: '', acquisition_date: '', disposal_date: today, apply_indexation: true },
        cgtExemptionForm: { annual_turnover: '', fixed_assets_value: '' },
        cgtExemptionResult: null,
        cgtResult: null,
        
        // Progressive PAYE
        payeForm: { gross_annual_income: '', basic_salary: '', pension_percentage: 8, other_reliefs: 0 },
        payeResult: null,
        payeThresholdCheck: '',
        payeThresholdResult: null,
        
        // Toast
        toast: { show: false, message: '', type: 'success' },
        
        async init() {
            // Check if entity is selected before making API calls
            if (!this.entityId) {
                this.noEntitySelected = true;
                console.warn('No entity selected. Redirecting to entity selection.');
                window.location.href = '/select-entity';
                return;
            }
            await this.loadBusinessType();
            await this.loadBuyerReviews();
            await this.loadVATSummary();
            await this.loadPITReliefs();
            await this.loadCreditNotes();
            await this.loadB2CData();
            await this.loadPenalties();
        },
        
        async refreshAll() {
            await this.init();
            this.showToast('Data refreshed', 'success');
        },
        
        getAuthHeaders() {
            return {
                'Authorization': 'Bearer ' + localStorage.getItem('token'),
                'Content-Type': 'application/json'
            };
        },
        
        async loadBusinessType() {
            try {
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/business-type`, {
                    headers: this.getAuthHeaders()
                });
                if (res.ok) this.businessType = await res.json();
            } catch (e) {
                console.error('Failed to load business type:', e);
            }
        },
        
        async loadBuyerReviews() {
            try {
                const [pendingRes, overdueRes, autoAcceptedRes] = await Promise.all([
                    fetch(`/api/v1/tax-2026/${this.entityId}/buyer-review/pending`, { headers: this.getAuthHeaders() }),
                    fetch(`/api/v1/tax-2026/${this.entityId}/buyer-review/overdue`, { headers: this.getAuthHeaders() }),
                    fetch(`/api/v1/tax-2026/${this.entityId}/buyer-review/auto-accepted`, { headers: this.getAuthHeaders() })
                ]);
                if (pendingRes.ok) this.pendingReviews = await pendingRes.json();
                if (overdueRes.ok) this.overdueReviews = await overdueRes.json();
                if (autoAcceptedRes.ok) this.autoAcceptedReviews = await autoAcceptedRes.json();
            } catch (e) {
                console.error('Failed to load buyer reviews:', e);
            }
        },
        
        async loadVATSummary() {
            try {
                const now = new Date();
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/vat-recovery/summary/${now.getFullYear()}/${now.getMonth() + 1}`, {
                    headers: this.getAuthHeaders()
                });
                if (res.ok) this.vatSummary = await res.json();
            } catch (e) {
                console.error('Failed to load VAT summary:', e);
            }
        },
        
        async loadPITReliefs() {
            try {
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/pit-reliefs/my-reliefs`, { headers: this.getAuthHeaders() });
                if (res.ok) this.pitReliefs = await res.json();
            } catch (e) {
                console.error('Failed to load PIT reliefs:', e);
            }
        },
        
        async loadCreditNotes() {
            try {
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/credit-notes`, { headers: this.getAuthHeaders() });
                if (res.ok) this.creditNotes = await res.json();
            } catch (e) {
                console.error('Failed to load credit notes:', e);
            }
        },
        
        // B2C Reporting Methods
        async loadB2CData() {
            try {
                const now = new Date();
                const [settingsRes, pendingRes, overdueRes, reportedRes, summaryRes] = await Promise.all([
                    fetch(`/api/v1/tax-2026/${this.entityId}/b2c/settings`, { headers: this.getAuthHeaders() }),
                    fetch(`/api/v1/tax-2026/${this.entityId}/b2c/pending`, { headers: this.getAuthHeaders() }),
                    fetch(`/api/v1/tax-2026/${this.entityId}/b2c/overdue`, { headers: this.getAuthHeaders() }),
                    fetch(`/api/v1/tax-2026/${this.entityId}/b2c/reported`, { headers: this.getAuthHeaders() }),
                    fetch(`/api/v1/tax-2026/${this.entityId}/b2c/summary/${now.getFullYear()}/${now.getMonth() + 1}`, { headers: this.getAuthHeaders() })
                ]);
                if (settingsRes.ok) this.b2cSettings = await settingsRes.json();
                if (pendingRes.ok) this.b2cPending = await pendingRes.json();
                if (overdueRes.ok) this.b2cOverdue = await overdueRes.json();
                if (reportedRes.ok) this.b2cReported = await reportedRes.json();
                if (summaryRes.ok) this.b2cSummary = await summaryRes.json();
            } catch (e) {
                console.error('Failed to load B2C data:', e);
            }
        },
        
        async updateB2CSettings() {
            try {
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/b2c/settings`, {
                    method: 'PUT',
                    headers: this.getAuthHeaders(),
                    body: JSON.stringify({
                        enabled: this.b2cSettings.b2c_realtime_reporting_enabled,
                        threshold: this.b2cSettings.b2c_reporting_threshold
                    })
                });
                if (res.ok) {
                    const data = await res.json();
                    this.b2cSettings = data;
                    this.showToast('B2C settings updated', 'success');
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Failed to update settings', 'error');
                }
            } catch (e) {
                this.showToast('Failed to update B2C settings', 'error');
            }
        },
        
        async submitSingleB2CReport(invoiceId) {
            try {
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/b2c/${invoiceId}/report`, {
                    method: 'POST',
                    headers: this.getAuthHeaders()
                });
                const data = await res.json();
                if (data.success) {
                    this.showToast('Transaction reported to NRS', 'success');
                    await this.loadB2CData();
                } else {
                    this.showToast(data.error || 'Failed to submit report', 'error');
                }
            } catch (e) {
                this.showToast('Failed to submit B2C report', 'error');
            }
        },
        
        async submitAllB2CReports() {
            this.b2cSubmitting = true;
            try {
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/b2c/submit-all`, {
                    method: 'POST',
                    headers: this.getAuthHeaders()
                });
                const data = await res.json();
                this.showToast(`Submitted ${data.success_count} of ${data.total_processed} transactions`, 'success');
                await this.loadB2CData();
            } catch (e) {
                this.showToast('Failed to submit B2C reports', 'error');
            }
            this.b2cSubmitting = false;
        },
        
        // Compliance Penalties Methods
        async loadPenalties() {
            try {
                const statusParam = this.penaltyFilter ? `?status=${this.penaltyFilter}` : '';
                const [recordsRes, summaryRes] = await Promise.all([
                    fetch(`/api/v1/tax-2026/${this.entityId}/penalties${statusParam}`, { headers: this.getAuthHeaders() }),
                    fetch(`/api/v1/tax-2026/${this.entityId}/penalties/summary`, { headers: this.getAuthHeaders() })
                ]);
                if (recordsRes.ok) this.penaltyRecords = await recordsRes.json();
                if (summaryRes.ok) this.penaltySummary = await summaryRes.json();
            } catch (e) {
                console.error('Failed to load penalties:', e);
            }
        },
        
        async calculatePenalty() {
            if (!this.penaltyCalcForm.penalty_type) return;
            this.penaltyCalculating = true;
            try {
                const res = await fetch('/api/v1/tax-2026/penalties/calculate', {
                    method: 'POST',
                    headers: this.getAuthHeaders(),
                    body: JSON.stringify(this.penaltyCalcForm)
                });
                if (res.ok) {
                    this.penaltyCalcResult = await res.json();
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Calculation failed', 'error');
                }
            } catch (e) {
                this.showToast('Failed to calculate penalty', 'error');
            }
            this.penaltyCalculating = false;
        },
        
        async updatePenaltyStatus(penaltyId, newStatus) {
            try {
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/penalties/${penaltyId}/status`, {
                    method: 'PUT',
                    headers: this.getAuthHeaders(),
                    body: JSON.stringify({ status: newStatus })
                });
                if (res.ok) {
                    await this.loadPenalties();
                    this.showToast(`Penalty marked as ${newStatus}`, 'success');
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Update failed', 'error');
                }
            } catch (e) {
                this.showToast('Failed to update penalty status', 'error');
            }
        },
        
        formatPenaltyType(type) {
            const types = {
                'late_filing': 'Late Filing',
                'unregistered_vendor': 'Unregistered Vendor',
                'b2c_late_reporting': 'B2C Late Reporting',
                'e_invoice_noncompliance': 'E-Invoice Non-Compliance',
                'invalid_tin': 'Invalid TIN',
                'missing_records': 'Missing Records',
                'nrs_access_denial': 'NRS Access Denial',
                'vat_non_remittance': 'VAT Non-Remittance',
                'paye_non_remittance': 'PAYE Non-Remittance',
                'wht_non_remittance': 'WHT Non-Remittance'
            };
            return types[type] || type;
        },
        
        async pollNRS() {
            this.polling = true;
            try {
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/buyer-review/poll-nrs`, {
                    method: 'POST',
                    headers: this.getAuthHeaders()
                });
                const data = await res.json();
                await this.loadBuyerReviews();
                this.showToast(`Processed ${data.processed} responses`, 'success');
            } catch (e) {
                this.showToast('Failed to poll NRS', 'error');
            }
            this.polling = false;
        },
        
        async recordVATRecovery() {
            try {
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/vat-recovery`, {
                    method: 'POST',
                    headers: this.getAuthHeaders(),
                    body: JSON.stringify(this.vatForm)
                });
                if (res.ok) {
                    await this.loadVATSummary();
                    this.showToast('VAT recovery recorded', 'success');
                    this.vatForm = { recovery_type: 'stock_in_trade', vat_amount: '', vendor_irn: '', transaction_date: today, vendor_name: '', vendor_tin: '', description: '' };
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Failed to record', 'error');
                }
            } catch (e) {
                this.showToast('Failed to record VAT recovery', 'error');
            }
        },
        
        async calculateLevy() {
            try {
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/development-levy/calculate`, {
                    method: 'POST',
                    headers: this.getAuthHeaders(),
                    body: JSON.stringify(this.levyForm)
                });
                if (res.ok) {
                    this.levyResult = await res.json();
                    this.showToast('Levy calculated', 'success');
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Calculation failed', 'error');
                }
            } catch (e) {
                this.showToast('Failed to calculate levy', 'error');
            }
        },
        
        async claimRelief() {
            try {
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/pit-reliefs`, {
                    method: 'POST',
                    headers: this.getAuthHeaders(),
                    body: JSON.stringify(this.reliefForm)
                });
                if (res.ok) {
                    await this.loadPITReliefs();
                    this.showToast('Relief claim submitted', 'success');
                    this.reliefForm = { relief_type: 'rent', fiscal_year: 2026, claimed_amount: '', annual_rent: '' };
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Failed to claim relief', 'error');
                }
            } catch (e) {
                this.showToast('Failed to claim relief', 'error');
            }
        },
        
        async submitCreditNote(creditNoteId) {
            try {
                const res = await fetch(`/api/v1/tax-2026/${this.entityId}/credit-notes/${creditNoteId}/submit-nrs`, {
                    method: 'POST',
                    headers: this.getAuthHeaders()
                });
                if (res.ok) {
                    await this.loadCreditNotes();
                    this.showToast('Credit note submitted to NRS', 'success');
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Submission failed', 'error');
                }
            } catch (e) {
                this.showToast('Failed to submit credit note', 'error');
            }
        },
        
        viewInvoice(invoiceId) {
            window.location.href = `/invoices?id=${invoiceId}`;
        },
        
        get filteredCreditNotes() {
            if (!this.creditNoteFilter) return this.creditNotes;
            return this.creditNotes.filter(n => n.status === this.creditNoteFilter);
        },
        
        showToast(message, type = 'success') {
            this.toast = { show: true, message, type };
            setTimeout(() => this.toast.show = false, 3000);
        },
        
        // Formatters
        formatCurrency(amount) {
            return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN', minimumFractionDigits: 0 }).format(amount);
        },
        formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-NG', { year: 'numeric', month: 'short', day: 'numeric' });
        },
        formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('en-NG', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        },
        formatStatus(status) {
            const map = { pending: 'Pending', accepted: 'Accepted', disputed: 'Disputed', auto_accepted: 'Auto-Accepted' };
            return map[status] || status;
        },
        formatBusinessType(type) {
            const map = { sole_proprietor: 'Sole Proprietor', partnership: 'Partnership', llc: 'LLC', plc: 'PLC', non_profit: 'Non-Profit' };
            return map[type] || type || '-';
        },
        formatReliefType(type) {
            const map = { rent: 'Rent', life_insurance: 'Life Insurance', pension: 'Pension', nhf: 'NHF', nhis: 'NHIS', gratuity: 'Gratuity' };
            return map[type] || type;
        },
        getStatusClass(status) {
            const map = { pending: 'bg-yellow-100 text-yellow-800', accepted: 'bg-green-100 text-green-800', disputed: 'bg-red-100 text-red-800', auto_accepted: 'bg-blue-100 text-blue-800' };
            return map[status] || 'bg-gray-100 text-gray-800';
        },
        getTimeLeft(deadline) {
            if (!deadline) return '-';
            const diff = new Date(deadline) - new Date();
            if (diff < 0) return 'Expired';
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}h ${mins}m`;
        },
        getTimeLeftClass(deadline) {
            if (!deadline) return 'text-gray-500';
            const diff = new Date(deadline) - new Date();
            if (diff < 0) return 'text-red-600';
            if (diff < 12 * 60 * 60 * 1000) return 'text-red-600'; // < 12 hours
            if (diff < 24 * 60 * 60 * 1000) return 'text-amber-600'; // < 24 hours
            return 'text-green-600';
        },
        
        // TIN Validation Methods
        async validateTIN() {
            if (!this.tinForm.tin) return;
            
            this.tinValidating = true;
            this.tinResult = null;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/v1/tax-2026/tin/validate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tin: this.tinForm.tin,
                        entity_type: this.tinForm.entity_type || null,
                        search_term: this.tinForm.search_term || null,
                    }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.tinResult = data;
                    this.showToast(data.is_valid ? 'TIN validated successfully!' : 'TIN validation failed', data.is_valid ? 'success' : 'error');
                } else {
                    this.showToast(data.detail || 'Validation failed', 'error');
                }
            } catch (error) {
                console.error('TIN validation error:', error);
                this.showToast('Failed to validate TIN', 'error');
            } finally {
                this.tinValidating = false;
            }
        },
        
        async validateBulkTINs() {
            if (!this.bulkTins.trim()) return;
            
            const tins = this.bulkTins.split('\n')
                .map(t => t.trim())
                .filter(t => t.length > 0)
                .slice(0, 50); // Max 50
            
            if (tins.length === 0) {
                this.showToast('Please enter at least one TIN', 'error');
                return;
            }
            
            this.bulkValidating = true;
            this.bulkResults = null;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/v1/tax-2026/tin/validate-bulk', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ tins }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.bulkResults = data;
                    this.showToast(`Validated ${data.total} TINs: ${data.valid_count} valid, ${data.invalid_count} invalid`, 'success');
                } else {
                    this.showToast(data.detail || 'Bulk validation failed', 'error');
                }
            } catch (error) {
                console.error('Bulk TIN validation error:', error);
                this.showToast('Failed to validate TINs', 'error');
            } finally {
                this.bulkValidating = false;
            }
        },
        
        // Zero-Rated VAT Methods
        async recordZeroRatedSale() {
            if (!this.zeroRatedForm.category || !this.zeroRatedForm.sale_amount) {
                this.showToast('Please fill required fields', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/v1/tax-2026/${this.entityId}/zero-rated/record-sale`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.zeroRatedForm),
                });
                
                if (response.ok) {
                    this.showToast('Zero-rated sale recorded!', 'success');
                    this.zeroRatedForm = { category: '', sale_amount: '', transaction_date: new Date().toISOString().split('T')[0], description: '' };
                    await this.loadRefundClaim();
                } else {
                    const data = await response.json();
                    this.showToast(data.detail || 'Failed to record sale', 'error');
                }
            } catch (error) {
                console.error('Record zero-rated sale error:', error);
                this.showToast('Failed to record sale', 'error');
            }
        },
        
        async recordInputVATForRefund() {
            if (!this.inputVATForm.purchase_amount || !this.inputVATForm.vat_amount || !this.inputVATForm.vendor_tin) {
                this.showToast('Please fill required fields', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/v1/tax-2026/${this.entityId}/zero-rated/record-input`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.inputVATForm),
                });
                
                if (response.ok) {
                    const hasIRN = !!this.inputVATForm.vendor_irn;
                    this.showToast(hasIRN ? 'Input VAT recorded (refund eligible!)' : 'Input VAT recorded (no IRN - not refundable)', hasIRN ? 'success' : 'info');
                    this.inputVATForm = { purchase_amount: '', vat_amount: '', transaction_date: new Date().toISOString().split('T')[0], vendor_tin: '', vendor_irn: '', description: '' };
                    await this.loadRefundClaim();
                } else {
                    const data = await response.json();
                    this.showToast(data.detail || 'Failed to record input VAT', 'error');
                }
            } catch (error) {
                console.error('Record input VAT error:', error);
                this.showToast('Failed to record input VAT', 'error');
            }
        },
        
        async loadRefundClaim() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/v1/tax-2026/${this.entityId}/zero-rated/refund-claim`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });
                
                if (response.ok) {
                    this.refundClaim = await response.json();
                }
            } catch (error) {
                console.error('Load refund claim error:', error);
            }
        },
        
        // Minimum ETR Methods
        async calculateMinimumETR() {
            if (!this.etrForm.annual_turnover || !this.etrForm.assessable_profit || !this.etrForm.regular_tax_paid) {
                this.showToast('Please fill all required fields', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const payload = {
                    annual_turnover: parseFloat(this.etrForm.annual_turnover),
                    assessable_profit: parseFloat(this.etrForm.assessable_profit),
                    regular_tax_paid: parseFloat(this.etrForm.regular_tax_paid),
                    is_mne_constituent: this.etrForm.is_mne_constituent,
                };
                if (this.etrForm.is_mne_constituent && this.etrForm.mne_group_revenue_eur) {
                    payload.mne_group_revenue_eur = parseFloat(this.etrForm.mne_group_revenue_eur);
                }
                
                const response = await fetch(`/api/v1/tax-2026/${this.entityId}/minimum-etr/calculate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                
                if (response.ok) {
                    this.etrResult = await response.json();
                    const msg = this.etrResult.top_up_tax > 0 
                        ? `Top-up tax required: ${this.formatCurrency(this.etrResult.top_up_tax)}` 
                        : 'No top-up tax required - ETR meets 15% minimum';
                    this.showToast(msg, this.etrResult.top_up_tax > 0 ? 'info' : 'success');
                } else {
                    const data = await response.json();
                    this.showToast(data.detail || 'Failed to calculate ETR', 'error');
                }
            } catch (error) {
                console.error('Calculate ETR error:', error);
                this.showToast('Failed to calculate ETR', 'error');
            }
        },
        
        // CGT Methods
        async checkCGTExemption() {
            if (!this.cgtExemptionForm.annual_turnover || !this.cgtExemptionForm.fixed_assets_value) {
                this.showToast('Please enter turnover and fixed assets value', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const params = new URLSearchParams({
                    annual_turnover: this.cgtExemptionForm.annual_turnover,
                    fixed_assets_value: this.cgtExemptionForm.fixed_assets_value,
                });
                
                const response = await fetch(`/api/v1/tax-2026/cgt/check-exemption?${params}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });
                
                if (response.ok) {
                    this.cgtExemptionResult = await response.json();
                    const msg = this.cgtExemptionResult.is_exempt 
                        ? 'Small company - CGT exempt!' 
                        : 'Large company - subject to 30% CGT';
                    this.showToast(msg, this.cgtExemptionResult.is_exempt ? 'success' : 'info');
                } else {
                    const data = await response.json();
                    this.showToast(data.detail || 'Failed to check exemption', 'error');
                }
            } catch (error) {
                console.error('Check CGT exemption error:', error);
                this.showToast('Failed to check exemption', 'error');
            }
        },
        
        async calculateCGT() {
            if (!this.cgtForm.asset_cost || !this.cgtForm.sale_proceeds || !this.cgtForm.annual_turnover || !this.cgtForm.fixed_assets_value) {
                this.showToast('Please fill all required fields', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const payload = {
                    asset_cost: parseFloat(this.cgtForm.asset_cost),
                    sale_proceeds: parseFloat(this.cgtForm.sale_proceeds),
                    annual_turnover: parseFloat(this.cgtForm.annual_turnover),
                    fixed_assets_value: parseFloat(this.cgtForm.fixed_assets_value),
                    apply_indexation: this.cgtForm.apply_indexation,
                };
                if (this.cgtForm.acquisition_date) payload.acquisition_date = this.cgtForm.acquisition_date;
                if (this.cgtForm.disposal_date) payload.disposal_date = this.cgtForm.disposal_date;
                
                const response = await fetch(`/api/v1/tax-2026/${this.entityId}/cgt/calculate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                
                if (response.ok) {
                    this.cgtResult = await response.json();
                    const msg = this.cgtResult.is_exempt 
                        ? 'Small company exempt - no CGT due' 
                        : `CGT liability: ${this.formatCurrency(this.cgtResult.cgt_liability)}`;
                    this.showToast(msg, this.cgtResult.is_exempt ? 'success' : 'info');
                } else {
                    const data = await response.json();
                    this.showToast(data.detail || 'Failed to calculate CGT', 'error');
                }
            } catch (error) {
                console.error('Calculate CGT error:', error);
                this.showToast('Failed to calculate CGT', 'error');
            }
        },
        
        // Progressive PAYE Methods
        async calculatePAYE() {
            if (!this.payeForm.gross_annual_income) {
                this.showToast('Please enter gross annual income', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const payload = {
                    gross_annual_income: parseFloat(this.payeForm.gross_annual_income),
                    pension_percentage: parseFloat(this.payeForm.pension_percentage) || 8,
                    other_reliefs: parseFloat(this.payeForm.other_reliefs) || 0,
                };
                if (this.payeForm.basic_salary) {
                    payload.basic_salary = parseFloat(this.payeForm.basic_salary);
                }
                
                const response = await fetch('/api/v1/tax-2026/paye/quick-calculate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                
                if (response.ok) {
                    this.payeResult = await response.json();
                    const msg = this.payeResult.annual_paye_tax > 0 
                        ? `Annual PAYE: ${this.formatCurrency(this.payeResult.annual_paye_tax)} (Monthly: ${this.formatCurrency(this.payeResult.monthly_paye_tax)})`
                        : 'No PAYE due - income below threshold!';
                    this.showToast(msg, this.payeResult.annual_paye_tax > 0 ? 'info' : 'success');
                } else {
                    const data = await response.json();
                    this.showToast(data.detail || 'Failed to calculate PAYE', 'error');
                }
            } catch (error) {
                console.error('Calculate PAYE error:', error);
                this.showToast('Failed to calculate PAYE', 'error');
            }
        },
        
        async checkPAYEThreshold() {
            if (!this.payeThresholdCheck) {
                this.showToast('Please enter an income amount', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/v1/tax-2026/paye/threshold-check?gross_annual_income=${this.payeThresholdCheck}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });
                
                if (response.ok) {
                    this.payeThresholdResult = await response.json();
                    this.showToast(
                        this.payeThresholdResult.is_tax_exempt ? 'Tax-free!' : 'Above threshold',
                        this.payeThresholdResult.is_tax_exempt ? 'success' : 'info'
                    );
                } else {
                    const data = await response.json();
                    this.showToast(data.detail || 'Failed to check threshold', 'error');
                }
            } catch (error) {
                console.error('Check PAYE threshold error:', error);
                this.showToast('Failed to check threshold', 'error');
            }
        }
    }
}
</script>
{% endblock %}

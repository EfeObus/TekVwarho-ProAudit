{% extends "base.html" %}

{% block title %}Emergency Controls - TekVwarho ProAudit{% endblock %}

{% block head %}
<style>
    :root { --ng-green: #008751; --ng-green-dark: #006741; --ng-green-light: #e6f5ed; }
    .btn-primary { background: var(--ng-green); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.375rem; border: none; cursor: pointer; }
    .btn-primary:hover { background: var(--ng-green-dark); }
    .btn-danger { background: #dc2626; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.375rem; border: none; cursor: pointer; }
    .btn-danger:hover { background: #b91c1c; }
    .btn-secondary { background: white; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer; }
    .btn-secondary:hover { background: #f9fafb; }
    .btn-success { background: var(--ng-green); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; border: none; cursor: pointer; }
    .btn-success:hover { background: var(--ng-green-dark); }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { background: var(--ng-green-light); color: var(--ng-green-dark); font-weight: 600; font-size: 0.7rem; text-transform: uppercase; padding: 0.75rem 1rem; text-align: left; }
    .data-table td { padding: 0.875rem 1rem; font-size: 0.875rem; border-bottom: 1px solid #f3f4f6; }
    .data-table tr:hover td { background: #fafbfc; }
    .badge { display: inline-flex; align-items: center; padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .stat-card { background: white; border-radius: 0.75rem; padding: 1.25rem; border: 1px solid #e5e7eb; }
    .section-card { background: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; margin-bottom: 1.5rem; }
    .section-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; }
    .section-header h3 { font-size: 1rem; font-weight: 600; color: #111827; margin: 0; }
    .section-body { padding: 1.5rem; }
    .control-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .control-item { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
    .control-item:hover { border-color: var(--ng-green); box-shadow: 0 2px 8px rgba(0,135,81,0.1); }
    .control-item.disabled { background: #fef2f2; border-color: #fecaca; }
    .control-info h4 { margin: 0 0 0.25rem 0; font-size: 0.875rem; font-weight: 600; color: #111827; }
    .control-info p { margin: 0; font-size: 0.75rem; color: #6b7280; }
    .toggle-btn { padding: 0.375rem 0.75rem; border-radius: 0.375rem; border: none; font-weight: 500; cursor: pointer; font-size: 0.75rem; }
    .toggle-btn.enable { background: var(--ng-green); color: white; }
    .toggle-btn.enable:hover { background: var(--ng-green-dark); }
    .toggle-btn.disable { background: #dc2626; color: white; }
    .toggle-btn.disable:hover { background: #b91c1c; }
    .status-banner { padding: 1rem 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between; }
    .status-banner.normal { background: var(--ng-green-light); border: 1px solid var(--ng-green); }
    .status-banner.warning { background: #fef3c7; border: 1px solid #f59e0b; }
    .status-banner.danger { background: #fee2e2; border: 1px solid #dc2626; }
    .status-badge { padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 600; font-size: 0.75rem; }
    .status-badge.normal { background: var(--ng-green); color: white; }
    .status-badge.warning { background: #f59e0b; color: white; }
    .status-badge.danger { background: #dc2626; color: white; }
    .warning-box { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; display: flex; gap: 0.75rem; align-items: flex-start; }
    .warning-box svg { flex-shrink: 0; width: 1.25rem; height: 1.25rem; color: #f59e0b; }
    [x-cloak] { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div x-data="emergencyControlsPage()" class="min-h-screen bg-gray-50">
    <!-- Toast Container -->
    <div x-show="toast.show" x-transition x-cloak class="fixed top-4 right-4 z-50">
        <div :class="toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'" class="text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2">
            <span x-text="toast.message"></span>
        </div>
    </div>

    <!-- Header -->
    <div class="bg-white border-b border-gray-200 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/dashboard" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                </a>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Emergency Controls</h1>
                    <p class="text-sm text-gray-500">Super Admin Only - All actions are fully audited</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-sm text-gray-500">Platform Status:</span>
                {% if platform_status.is_maintenance_mode %}
                <span class="status-badge danger">MAINTENANCE MODE</span>
                {% elif platform_status.is_read_only %}
                <span class="status-badge danger">READ-ONLY MODE</span>
                {% elif platform_status.disabled_features|length > 0 %}
                <span class="status-badge warning">{{ platform_status.disabled_features|length }} FEATURES DISABLED</span>
                {% else %}
                <span class="status-badge normal">NORMAL OPERATIONS</span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="p-6">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="stat-card">
                <p class="text-sm text-gray-500">Active Controls</p>
                <p class="text-2xl font-bold {% if active_controls_count > 0 %}text-red-600{% else %}text-gray-900{% endif %}">{{ active_controls_count }}</p>
            </div>
            <div class="stat-card">
                <p class="text-sm text-gray-500">Suspended Tenants</p>
                <p class="text-2xl font-bold {% if suspended_tenants_count > 0 %}text-red-600{% else %}text-gray-900{% endif %}">{{ suspended_tenants_count }}</p>
            </div>
            <div class="stat-card">
                <p class="text-sm text-gray-500">Disabled Features</p>
                <p class="text-2xl font-bold {% if platform_status.disabled_features|length > 0 %}text-yellow-600{% else %}text-gray-900{% endif %}">{{ platform_status.disabled_features|length }}</p>
            </div>
            <div class="stat-card">
                <p class="text-sm text-gray-500">Login Status</p>
                <p class="text-2xl font-bold {% if platform_status.is_login_locked %}text-red-600{% else %}text-green-600{% endif %}">{% if platform_status.is_login_locked %}LOCKED{% else %}OPEN{% endif %}</p>
            </div>
        </div>

        {% if platform_status.maintenance_message %}
        <!-- Maintenance Message Banner -->
        <div class="status-banner danger mb-6">
            <div>
                <p class="font-semibold text-red-800">Maintenance Message Active</p>
                <p class="text-sm text-red-700">{{ platform_status.maintenance_message }}</p>
                {% if platform_status.maintenance_expected_end %}
                <p class="text-xs text-red-600 mt-1">Expected end: {{ platform_status.maintenance_expected_end }}</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Platform-Wide Controls -->
        <div class="section-card">
            <div class="section-header">
                <h3>Platform-Wide Controls</h3>
            </div>
            <div class="section-body">
                <div class="control-grid">
                    <!-- Read-Only Mode -->
                    <div class="control-item {% if platform_status.is_read_only %}disabled{% endif %}">
                        <div class="control-info">
                            <h4>Read-Only Mode</h4>
                            <p>Block all write operations</p>
                        </div>
                        {% if platform_status.is_read_only %}
                        <button class="toggle-btn enable" @click="showDisableReadOnlyModal()">Disable</button>
                        {% else %}
                        <button class="toggle-btn disable" @click="showEnableReadOnlyModal()">Enable</button>
                        {% endif %}
                    </div>
                    
                    <!-- Maintenance Mode -->
                    <div class="control-item {% if platform_status.is_maintenance_mode %}disabled{% endif %}">
                        <div class="control-info">
                            <h4>Maintenance Mode</h4>
                            <p>Block all non-admin access</p>
                        </div>
                        {% if platform_status.is_maintenance_mode %}
                        <button class="toggle-btn enable" @click="showDisableMaintenanceModal()">End</button>
                        {% else %}
                        <button class="toggle-btn disable" @click="showEnableMaintenanceModal()">Start</button>
                        {% endif %}
                    </div>
                    
                    <!-- Login Lockdown -->
                    <div class="control-item {% if platform_status.is_login_locked %}disabled{% endif %}">
                        <div class="control-info">
                            <h4>Login Lockdown</h4>
                            <p>Block non-admin logins</p>
                        </div>
                        {% if platform_status.is_login_locked %}
                        <button class="toggle-btn enable" @click="showDisableLoginLockdownModal()">Unlock</button>
                        {% else %}
                        <button class="toggle-btn disable" @click="showEnableLoginLockdownModal()">Lock</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Feature Kill Switches -->
        <div class="section-card">
            <div class="section-header">
                <h3>Feature Kill Switches</h3>
                <span class="text-sm text-gray-500">Toggle individual features on/off</span>
            </div>
            <div class="section-body">
                <div class="control-grid">
                    {% for feature in available_features %}
                    <div class="control-item {% if feature.key in platform_status.disabled_features %}disabled{% endif %}">
                        <div class="control-info">
                            <h4>{{ feature.name }}</h4>
                            <p>{{ feature.description }}</p>
                        </div>
                        {% if feature.key in platform_status.disabled_features %}
                        <button class="toggle-btn enable" @click="showEnableFeatureModal('{{ feature.key }}', '{{ feature.name }}')">Enable</button>
                        {% else %}
                        <button class="toggle-btn disable" @click="showDisableFeatureModal('{{ feature.key }}', '{{ feature.name }}')">Disable</button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Emergency Tenant Suspension -->
        <div class="section-card">
            <div class="section-header">
                <h3>Emergency Tenant Suspension</h3>
                <button class="btn-danger" @click="showSuspendTenantModal()">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                    Suspend Tenant
                </button>
            </div>
            <div class="section-body">
                {% if suspended_tenants %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tenant</th>
                            <th>Suspended At</th>
                            <th>Reason</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tenant in suspended_tenants %}
                        <tr>
                            <td class="font-medium">{{ tenant.name }}</td>
                            <td class="text-gray-500">{{ tenant.suspended_at }}</td>
                            <td class="text-gray-600">{{ tenant.reason[:50] }}{% if tenant.reason|length > 50 %}...{% endif %}</td>
                            <td>
                                <button class="toggle-btn enable" @click="showLiftSuspensionModal('{{ tenant.id }}', '{{ tenant.name }}')">Lift Suspension</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-8 text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <p>No tenants are currently emergency suspended.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Emergency Actions -->
        <div class="section-card">
            <div class="section-header">
                <h3>Recent Emergency Actions</h3>
            </div>
            <div class="section-body">
                {% if recent_controls %}
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    {% for control in recent_controls %}
                    <div class="flex items-start justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-gray-900">{{ control.action_type.replace('_', ' ').title() }}</span>
                                {% if control.is_active %}
                                <span class="badge badge-danger">ACTIVE</span>
                                {% else %}
                                <span class="badge badge-success">RESOLVED</span>
                                {% endif %}
                            </div>
                            <p class="text-sm text-gray-600 mt-1">
                                {% if control.target_id %}Target: {{ control.target_type }} - {{ control.target_id[:8] }}...{% else %}Target: {{ control.target_type }}{% endif %}
                            </p>
                            <p class="text-sm text-gray-500">{{ control.reason[:80] }}{% if control.reason|length > 80 %}...{% endif %}</p>
                        </div>
                        <div class="text-right text-xs text-gray-500">
                            <div>{{ control.started_at }}</div>
                            {% if control.ended_at %}
                            <div class="text-green-600">Ended: {{ control.ended_at }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-500">
                    <p>No emergency actions recorded yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Enable Read-Only Mode Modal -->
    <div x-show="modals.enableReadOnly" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="modals.enableReadOnly = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Enable Read-Only Mode</h3>
                    <button @click="modals.enableReadOnly = false" class="text-gray-400 hover:text-gray-600">x</button>
                </div>
                <div class="warning-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    <div class="text-sm text-yellow-800">
                        <strong>Warning!</strong> This will block ALL write operations platform-wide. Only read operations will be permitted.
                    </div>
                </div>
                <form @submit.prevent="submitEnableReadOnly()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason (Required) *</label>
                        <textarea x-model="forms.readOnly.reason" required minlength="10" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Explain why read-only mode is being enabled..."></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">User Message (Optional)</label>
                        <input type="text" x-model="forms.readOnly.message" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Message to display to users...">
                    </div>
                    <div class="flex gap-3 justify-end">
                        <button type="button" @click="modals.enableReadOnly = false" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-danger" :disabled="loading">Enable Read-Only Mode</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Disable Read-Only Mode Modal -->
    <div x-show="modals.disableReadOnly" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="modals.disableReadOnly = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Disable Read-Only Mode</h3>
                    <button @click="modals.disableReadOnly = false" class="text-gray-400 hover:text-gray-600">x</button>
                </div>
                <form @submit.prevent="submitDisableReadOnly()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason (Required) *</label>
                        <textarea x-model="forms.disableReadOnly.reason" required minlength="10" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Explain why read-only mode is being disabled..."></textarea>
                    </div>
                    <div class="flex gap-3 justify-end">
                        <button type="button" @click="modals.disableReadOnly = false" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-success" :disabled="loading">Disable Read-Only Mode</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Enable Maintenance Mode Modal -->
    <div x-show="modals.enableMaintenance" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="modals.enableMaintenance = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Enable Maintenance Mode</h3>
                    <button @click="modals.enableMaintenance = false" class="text-gray-400 hover:text-gray-600">x</button>
                </div>
                <div class="warning-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    <div class="text-sm text-yellow-800">
                        <strong>Warning!</strong> This will block ALL non-admin users from accessing the platform.
                    </div>
                </div>
                <form @submit.prevent="submitEnableMaintenance()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason (Required) *</label>
                        <textarea x-model="forms.maintenance.reason" required minlength="10" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Explain why maintenance is needed..."></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">User Message (Required) *</label>
                        <input type="text" x-model="forms.maintenance.message" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Message to display to users...">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Expected End Time (Optional)</label>
                        <input type="datetime-local" x-model="forms.maintenance.expectedEnd" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div class="flex gap-3 justify-end">
                        <button type="button" @click="modals.enableMaintenance = false" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-danger" :disabled="loading">Start Maintenance</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Disable Maintenance Mode Modal -->
    <div x-show="modals.disableMaintenance" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="modals.disableMaintenance = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">End Maintenance Mode</h3>
                    <button @click="modals.disableMaintenance = false" class="text-gray-400 hover:text-gray-600">x</button>
                </div>
                <form @submit.prevent="submitDisableMaintenance()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason (Required) *</label>
                        <textarea x-model="forms.disableMaintenance.reason" required minlength="10" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Explain why maintenance is ending..."></textarea>
                    </div>
                    <div class="flex gap-3 justify-end">
                        <button type="button" @click="modals.disableMaintenance = false" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-success" :disabled="loading">End Maintenance</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Enable Login Lockdown Modal -->
    <div x-show="modals.enableLoginLockdown" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="modals.enableLoginLockdown = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Enable Login Lockdown</h3>
                    <button @click="modals.enableLoginLockdown = false" class="text-gray-400 hover:text-gray-600">x</button>
                </div>
                <div class="warning-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    <div class="text-sm text-yellow-800">
                        <strong>Warning!</strong> This will prevent all non-admin users from logging in.
                    </div>
                </div>
                <form @submit.prevent="submitEnableLoginLockdown()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason (Required) *</label>
                        <textarea x-model="forms.loginLockdown.reason" required minlength="10" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Explain why login lockdown is being enabled..."></textarea>
                    </div>
                    <div class="flex gap-3 justify-end">
                        <button type="button" @click="modals.enableLoginLockdown = false" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-danger" :disabled="loading">Lock Logins</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Disable Login Lockdown Modal -->
    <div x-show="modals.disableLoginLockdown" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="modals.disableLoginLockdown = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Disable Login Lockdown</h3>
                    <button @click="modals.disableLoginLockdown = false" class="text-gray-400 hover:text-gray-600">x</button>
                </div>
                <form @submit.prevent="submitDisableLoginLockdown()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason (Required) *</label>
                        <textarea x-model="forms.disableLoginLockdown.reason" required minlength="10" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Explain why login lockdown is being disabled..."></textarea>
                    </div>
                    <div class="flex gap-3 justify-end">
                        <button type="button" @click="modals.disableLoginLockdown = false" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-success" :disabled="loading">Unlock Logins</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Feature Toggle Modal -->
    <div x-show="modals.feature" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="modals.feature = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900" x-text="forms.feature.action === 'disable' ? 'Disable ' + forms.feature.name : 'Enable ' + forms.feature.name"></h3>
                    <button @click="modals.feature = false" class="text-gray-400 hover:text-gray-600">x</button>
                </div>
                <div x-show="forms.feature.action === 'disable'" class="warning-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    <div class="text-sm text-yellow-800">
                        <strong>Warning!</strong> This will disable the <span x-text="forms.feature.name"></span> feature for ALL users.
                    </div>
                </div>
                <form @submit.prevent="submitFeatureToggle()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason (Required) *</label>
                        <textarea x-model="forms.feature.reason" required minlength="10" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Explain why this feature is being toggled..."></textarea>
                    </div>
                    <div class="flex gap-3 justify-end">
                        <button type="button" @click="modals.feature = false" class="btn-secondary">Cancel</button>
                        <button type="submit" :class="forms.feature.action === 'disable' ? 'btn-danger' : 'btn-success'" :disabled="loading" x-text="forms.feature.action === 'disable' ? 'Disable Feature' : 'Enable Feature'"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Suspend Tenant Modal -->
    <div x-show="modals.suspendTenant" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="modals.suspendTenant = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Emergency Suspend Tenant</h3>
                    <button @click="modals.suspendTenant = false" class="text-gray-400 hover:text-gray-600">x</button>
                </div>
                <div class="warning-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    <div class="text-sm text-yellow-800">
                        <strong>Warning!</strong> This will immediately block ALL access for the tenant's users.
                    </div>
                </div>
                <form @submit.prevent="submitSuspendTenant()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tenant ID *</label>
                        <input type="text" x-model="forms.suspend.tenantId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Enter tenant UUID...">
                        <p class="text-xs text-gray-500 mt-1">You can find tenant IDs in the Tenants section.</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason (Required) *</label>
                        <textarea x-model="forms.suspend.reason" required minlength="10" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Explain why this tenant is being suspended..."></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="flex items-center gap-2 text-sm text-gray-700">
                            <input type="checkbox" x-model="forms.suspend.notifyUsers" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                            Notify tenant users via email
                        </label>
                    </div>
                    <div class="flex gap-3 justify-end">
                        <button type="button" @click="modals.suspendTenant = false" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-danger" :disabled="loading">Suspend Tenant</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Lift Suspension Modal -->
    <div x-show="modals.liftSuspension" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black/50" @click="modals.liftSuspension = false"></div>
            <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Lift Emergency Suspension</h3>
                    <button @click="modals.liftSuspension = false" class="text-gray-400 hover:text-gray-600">x</button>
                </div>
                <p class="text-sm text-gray-600 mb-4">Lifting suspension for: <strong x-text="forms.lift.tenantName"></strong></p>
                <form @submit.prevent="submitLiftSuspension()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason (Required) *</label>
                        <textarea x-model="forms.lift.reason" required minlength="10" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Explain why suspension is being lifted..."></textarea>
                    </div>
                    <div class="flex gap-3 justify-end">
                        <button type="button" @click="modals.liftSuspension = false" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-success" :disabled="loading">Lift Suspension</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function emergencyControlsPage() {
    return {
        loading: false,
        toast: { show: false, message: '', type: 'success' },
        modals: {
            enableReadOnly: false,
            disableReadOnly: false,
            enableMaintenance: false,
            disableMaintenance: false,
            enableLoginLockdown: false,
            disableLoginLockdown: false,
            feature: false,
            suspendTenant: false,
            liftSuspension: false
        },
        forms: {
            readOnly: { reason: '', message: '' },
            disableReadOnly: { reason: '' },
            maintenance: { reason: '', message: '', expectedEnd: '' },
            disableMaintenance: { reason: '' },
            loginLockdown: { reason: '' },
            disableLoginLockdown: { reason: '' },
            feature: { key: '', name: '', action: '', reason: '' },
            suspend: { tenantId: '', reason: '', notifyUsers: true },
            lift: { tenantId: '', tenantName: '', reason: '' }
        },

        showToast(message, type = 'success') {
            this.toast = { show: true, message, type };
            setTimeout(() => { this.toast.show = false; }, 4000);
        },

        showEnableReadOnlyModal() { this.modals.enableReadOnly = true; },
        showDisableReadOnlyModal() { this.modals.disableReadOnly = true; },
        showEnableMaintenanceModal() { this.modals.enableMaintenance = true; },
        showDisableMaintenanceModal() { this.modals.disableMaintenance = true; },
        showEnableLoginLockdownModal() { this.modals.enableLoginLockdown = true; },
        showDisableLoginLockdownModal() { this.modals.disableLoginLockdown = true; },
        showSuspendTenantModal() { this.modals.suspendTenant = true; },
        
        showDisableFeatureModal(key, name) {
            this.forms.feature = { key, name, action: 'disable', reason: '' };
            this.modals.feature = true;
        },
        showEnableFeatureModal(key, name) {
            this.forms.feature = { key, name, action: 'enable', reason: '' };
            this.modals.feature = true;
        },
        showLiftSuspensionModal(tenantId, tenantName) {
            this.forms.lift = { tenantId, tenantName, reason: '' };
            this.modals.liftSuspension = true;
        },

        async submitEnableReadOnly() {
            this.loading = true;
            try {
                const res = await fetch('/api/v1/admin/emergency/read-only-mode/enable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: this.forms.readOnly.reason, message: this.forms.readOnly.message || null })
                });
                if (res.ok) {
                    this.showToast('Read-only mode enabled successfully');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Failed to enable read-only mode', 'error');
                }
            } catch (e) { this.showToast('Network error', 'error'); }
            this.loading = false;
        },

        async submitDisableReadOnly() {
            this.loading = true;
            try {
                const res = await fetch('/api/v1/admin/emergency/read-only-mode/disable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: this.forms.disableReadOnly.reason })
                });
                if (res.ok) {
                    this.showToast('Read-only mode disabled successfully');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Failed to disable read-only mode', 'error');
                }
            } catch (e) { this.showToast('Network error', 'error'); }
            this.loading = false;
        },

        async submitEnableMaintenance() {
            this.loading = true;
            try {
                const res = await fetch('/api/v1/admin/emergency/maintenance-mode/enable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reason: this.forms.maintenance.reason,
                        message: this.forms.maintenance.message,
                        expected_end: this.forms.maintenance.expectedEnd || null
                    })
                });
                if (res.ok) {
                    this.showToast('Maintenance mode enabled successfully');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Failed to enable maintenance mode', 'error');
                }
            } catch (e) { this.showToast('Network error', 'error'); }
            this.loading = false;
        },

        async submitDisableMaintenance() {
            this.loading = true;
            try {
                const res = await fetch('/api/v1/admin/emergency/maintenance-mode/disable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: this.forms.disableMaintenance.reason })
                });
                if (res.ok) {
                    this.showToast('Maintenance mode disabled successfully');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Failed to disable maintenance mode', 'error');
                }
            } catch (e) { this.showToast('Network error', 'error'); }
            this.loading = false;
        },

        async submitEnableLoginLockdown() {
            this.loading = true;
            try {
                const res = await fetch('/api/v1/admin/emergency/login-lockdown/enable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: this.forms.loginLockdown.reason })
                });
                if (res.ok) {
                    this.showToast('Login lockdown enabled successfully');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Failed to enable login lockdown', 'error');
                }
            } catch (e) { this.showToast('Network error', 'error'); }
            this.loading = false;
        },

        async submitDisableLoginLockdown() {
            this.loading = true;
            try {
                const res = await fetch('/api/v1/admin/emergency/login-lockdown/disable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: this.forms.disableLoginLockdown.reason })
                });
                if (res.ok) {
                    this.showToast('Login lockdown disabled successfully');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Failed to disable login lockdown', 'error');
                }
            } catch (e) { this.showToast('Network error', 'error'); }
            this.loading = false;
        },

        async submitFeatureToggle() {
            this.loading = true;
            try {
                const res = await fetch(`/api/v1/admin/emergency/kill-switch/${this.forms.feature.key}/${this.forms.feature.action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: this.forms.feature.reason })
                });
                if (res.ok) {
                    this.showToast(`Feature ${this.forms.feature.action}d successfully`);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || `Failed to ${this.forms.feature.action} feature`, 'error');
                }
            } catch (e) { this.showToast('Network error', 'error'); }
            this.loading = false;
        },

        async submitSuspendTenant() {
            this.loading = true;
            try {
                const res = await fetch(`/api/v1/admin/emergency/tenant/${this.forms.suspend.tenantId}/emergency-suspend`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reason: this.forms.suspend.reason,
                        notify_users: this.forms.suspend.notifyUsers
                    })
                });
                if (res.ok) {
                    this.showToast('Tenant suspended successfully');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Failed to suspend tenant', 'error');
                }
            } catch (e) { this.showToast('Network error', 'error'); }
            this.loading = false;
        },

        async submitLiftSuspension() {
            this.loading = true;
            try {
                const res = await fetch(`/api/v1/admin/emergency/tenant/${this.forms.lift.tenantId}/lift-suspension`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: this.forms.lift.reason })
                });
                if (res.ok) {
                    this.showToast('Suspension lifted successfully');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await res.json();
                    this.showToast(err.detail || 'Failed to lift suspension', 'error');
                }
            } catch (e) { this.showToast('Network error', 'error'); }
            this.loading = false;
        }
    };
}
</script>
{% endblock %}

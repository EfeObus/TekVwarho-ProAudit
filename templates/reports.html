{% extends "base.html" %}

{% block title %}Reports - TekVwarho ProAudit{% endblock %}

{% block content %}
<div x-data="reportsPage()" x-init="init()">
    <!-- Header -->
    <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Reports</h1>
            <p class="text-gray-600">Financial and tax reports for compliance</p>
        </div>
        <div class="mt-4 md:mt-0">
            <a href="/accounting" 
               class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-md text-sm font-medium hover:bg-green-50 hover:text-green-800 transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Accounting
            </a>
        </div>
    </div>

    <!-- Report Type Selector -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px">
                <button 
                    @click="activeTab = 'financial'"
                    :class="activeTab === 'financial' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="px-6 py-4 text-sm font-medium border-b-2 transition-colors"
                >
                    Financial Reports
                </button>
                <button 
                    @click="activeTab = 'tax'"
                    :class="activeTab === 'tax' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="px-6 py-4 text-sm font-medium border-b-2 transition-colors"
                >
                    Tax Reports
                </button>
                <button 
                    @click="activeTab = 'selfAssessment'; loadSelfAssessmentInfo()"
                    :class="activeTab === 'selfAssessment' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="px-6 py-4 text-sm font-medium border-b-2 transition-colors flex items-center space-x-2"
                >
                    <span></span>
                    <span>Self-Assessment</span>
                </button>
                <button 
                    @click="activeTab = 'vault'; loadVaultData()"
                    :class="activeTab === 'vault' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="px-6 py-4 text-sm font-medium border-b-2 transition-colors flex items-center space-x-2"
                >
                    <span></span>
                    <span>Audit Vault</span>
                </button>
            </nav>
        </div>

        <!-- Date Range Selector -->
        <div class="p-4 bg-gray-50 border-b border-gray-200">
            <div class="flex items-center gap-4 flex-wrap">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">From</label>
                    <input type="date" x-model="startDate" class="border-gray-300 rounded-md shadow-sm text-sm focus:ring-green-500 focus:border-green-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">To</label>
                    <input type="date" x-model="endDate" class="border-gray-300 rounded-md shadow-sm text-sm focus:ring-green-500 focus:border-green-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">As of Date</label>
                    <input type="date" x-model="asOfDate" class="border-gray-300 rounded-md shadow-sm text-sm focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="flex gap-2 mt-5">
                    <button @click="setPreset('thisMonth')" class="px-3 py-1 text-xs border rounded hover:bg-gray-100">This Month</button>
                    <button @click="setPreset('lastMonth')" class="px-3 py-1 text-xs border rounded hover:bg-gray-100">Last Month</button>
                    <button @click="setPreset('thisQuarter')" class="px-3 py-1 text-xs border rounded hover:bg-gray-100">This Quarter</button>
                    <button @click="setPreset('thisYear')" class="px-3 py-1 text-xs border rounded hover:bg-gray-100">This Year</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Reports -->
    <div x-show="activeTab === 'financial'" class="space-y-6">
        <!-- Profit & Loss -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Profit & Loss Statement</h3>
                    <p class="text-sm text-gray-500">Income and expenses summary</p>
                </div>
                <div class="flex gap-2">
                    <button @click="generatePnL()" :disabled="loading.pnl" class="bg-green-600 text-white px-4 py-2 text-sm rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center gap-2">
                        <svg x-show="loading.pnl" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Generate Report
                    </button>
                    <!-- Export Dropdown -->
                    <div x-show="reports.pnl" class="relative" x-data="{ exportOpen: false }">
                        <button @click="exportOpen = !exportOpen" class="border border-green-600 text-green-600 px-3 py-2 text-sm rounded-md hover:bg-green-50 flex items-center gap-1">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div x-show="exportOpen" @click.away="exportOpen = false" x-cloak
                             class="absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg z-10 border">
                            <button @click="exportReport('profit-loss', 'pdf'); exportOpen = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">PDF</button>
                            <button @click="exportReport('profit-loss', 'excel'); exportOpen = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Excel</button>
                            <button @click="exportReport('profit-loss', 'csv'); exportOpen = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CSV</button>
                        </div>
                    </div>
                </div>
            </div>
            <div x-show="reports.pnl" class="p-6">
                <div class="grid grid-cols-3 gap-6 mb-6">
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <p class="text-sm text-green-600 font-medium">Total Revenue</p>
                        <p class="text-2xl font-bold text-green-700" x-text="formatCurrency(reports.pnl?.summary?.total_revenue)">₦0</p>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <p class="text-sm text-red-600 font-medium">Total Expenses</p>
                        <p class="text-2xl font-bold text-red-700" x-text="formatCurrency(reports.pnl?.summary?.total_expenses)">₦0</p>
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-600 font-medium">Net Profit</p>
                        <p class="text-2xl font-bold" 
                           :class="(reports.pnl?.summary?.net_profit || 0) >= 0 ? 'text-green-700' : 'text-red-700'"
                           x-text="formatCurrency(reports.pnl?.summary?.net_profit)">₦0</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-6">
                    <!-- Revenue Breakdown -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Revenue by Category</h4>
                        <div class="space-y-2">
                            <template x-for="(amount, category) in reports.pnl?.revenue?.categories" :key="category">
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-sm text-gray-600" x-text="category"></span>
                                    <span class="text-sm font-medium text-green-600" x-text="formatCurrency(amount)"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Expense Breakdown -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Expenses by Category</h4>
                        <div class="space-y-2">
                            <template x-for="(data, category) in reports.pnl?.expenses?.categories" :key="category">
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <div>
                                        <span class="text-sm text-gray-600" x-text="category"></span>
                                        <span x-show="data.wren_status" class="ml-2 text-xs px-1 rounded bg-gray-100" x-text="data.wren_status"></span>
                                    </div>
                                    <span class="text-sm font-medium text-red-600" x-text="formatCurrency(data.total)"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trial Balance -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Trial Balance</h3>
                    <p class="text-sm text-gray-500">Account balances summary - debits and credits</p>
                </div>
                <div class="flex gap-2">
                    <button @click="generateTrialBalance()" :disabled="loading.trialBalance" class="bg-green-600 text-white px-4 py-2 text-sm rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center gap-2">
                        <svg x-show="loading.trialBalance" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Generate Report
                    </button>
                    <!-- Export Dropdown -->
                    <div x-show="reports.trialBalance" class="relative" x-data="{ exportOpen: false }">
                        <button @click="exportOpen = !exportOpen" class="border border-green-600 text-green-600 px-3 py-2 text-sm rounded-md hover:bg-green-50 flex items-center gap-1">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div x-show="exportOpen" @click.away="exportOpen = false" x-cloak
                             class="absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg z-10 border">
                            <button @click="exportReport('trial-balance', 'pdf'); exportOpen = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">PDF</button>
                            <button @click="exportReport('trial-balance', 'excel'); exportOpen = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Excel</button>
                            <button @click="exportReport('trial-balance', 'csv'); exportOpen = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CSV</button>
                        </div>
                    </div>
                </div>
                        PDF
                    </button>
                </div>
            </div>
            <div x-show="reports.trialBalance" class="p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Account</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Debit (₦)</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Credit (₦)</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="account in reports.trialBalance?.accounts" :key="account.account">
                                <tr>
                                    <td class="px-4 py-3 text-sm text-gray-900" x-text="account.account"></td>
                                    <td class="px-4 py-3 text-sm text-gray-500" x-text="account.type"></td>
                                    <td class="px-4 py-3 text-sm text-right font-medium" x-text="account.debit > 0 ? formatCurrency(account.debit) : '-'"></td>
                                    <td class="px-4 py-3 text-sm text-right font-medium" x-text="account.credit > 0 ? formatCurrency(account.credit) : '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                        <tfoot class="bg-green-50">
                            <tr>
                                <td colspan="2" class="px-4 py-3 text-sm font-bold text-gray-900">TOTALS</td>
                                <td class="px-4 py-3 text-sm text-right font-bold text-gray-900" x-text="formatCurrency(reports.trialBalance?.totals?.total_debit)"></td>
                                <td class="px-4 py-3 text-sm text-right font-bold text-gray-900" x-text="formatCurrency(reports.trialBalance?.totals?.total_credit)"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="mt-4 flex items-center gap-2">
                    <span class="text-sm font-medium">Status:</span>
                    <span x-show="reports.trialBalance?.totals?.is_balanced" class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">OK Balanced</span>
                    <span x-show="!reports.trialBalance?.totals?.is_balanced" class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">X Not Balanced</span>
                </div>
            </div>
        </div>

        <!-- Balance Sheet -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Balance Sheet</h3>
                    <p class="text-sm text-gray-500">Assets, liabilities, and equity statement</p>
                </div>
                <button @click="generateBalanceSheet()" :disabled="loading.balanceSheet" class="bg-green-600 text-white px-4 py-2 text-sm rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center gap-2">
                    <svg x-show="loading.balanceSheet" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    Generate Report
                </button>
            </div>
            <div x-show="reports.balanceSheet" class="p-6">
                <div class="grid grid-cols-2 gap-6">
                    <!-- Assets -->
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-4 pb-2 border-b">ASSETS</h4>
                        <div class="space-y-3">
                            <div class="font-medium text-gray-700">Current Assets</div>
                            <div class="pl-4 space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Cash and Bank</span>
                                    <span x-text="formatCurrency(reports.balanceSheet?.assets?.current_assets?.cash_and_bank)"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Accounts Receivable</span>
                                    <span x-text="formatCurrency(reports.balanceSheet?.assets?.current_assets?.accounts_receivable)"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">VAT Recoverable</span>
                                    <span x-text="formatCurrency(reports.balanceSheet?.assets?.current_assets?.vat_recoverable)"></span>
                                </div>
                                <div class="flex justify-between font-medium border-t pt-2">
                                    <span>Total Current Assets</span>
                                    <span x-text="formatCurrency(reports.balanceSheet?.assets?.current_assets?.total)"></span>
                                </div>
                            </div>
                            <div class="font-medium text-gray-700 mt-4">Fixed Assets</div>
                            <div class="pl-4 space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Cost</span>
                                    <span x-text="formatCurrency(reports.balanceSheet?.assets?.fixed_assets?.cost)"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Less: Depreciation</span>
                                    <span x-text="'(' + formatCurrency(reports.balanceSheet?.assets?.fixed_assets?.accumulated_depreciation) + ')'"></span>
                                </div>
                                <div class="flex justify-between font-medium border-t pt-2">
                                    <span>Net Book Value</span>
                                    <span x-text="formatCurrency(reports.balanceSheet?.assets?.fixed_assets?.net_book_value)"></span>
                                </div>
                            </div>
                            <div class="flex justify-between font-bold text-lg mt-4 pt-2 border-t-2">
                                <span>TOTAL ASSETS</span>
                                <span class="text-green-600" x-text="formatCurrency(reports.balanceSheet?.assets?.total_assets)"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Liabilities & Equity -->
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-4 pb-2 border-b">LIABILITIES & EQUITY</h4>
                        <div class="space-y-3">
                            <div class="font-medium text-gray-700">Current Liabilities</div>
                            <div class="pl-4 space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">VAT Payable</span>
                                    <span x-text="formatCurrency(reports.balanceSheet?.liabilities?.current_liabilities?.vat_payable)"></span>
                                </div>
                                <div class="flex justify-between font-medium border-t pt-2">
                                    <span>Total Liabilities</span>
                                    <span x-text="formatCurrency(reports.balanceSheet?.liabilities?.total_liabilities)"></span>
                                </div>
                            </div>
                            <div class="font-medium text-gray-700 mt-4">Owner's Equity</div>
                            <div class="pl-4 space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Retained Earnings</span>
                                    <span x-text="formatCurrency(reports.balanceSheet?.equity?.retained_earnings)"></span>
                                </div>
                                <div class="flex justify-between font-medium border-t pt-2">
                                    <span>Total Equity</span>
                                    <span x-text="formatCurrency(reports.balanceSheet?.equity?.total_equity)"></span>
                                </div>
                            </div>
                            <div class="flex justify-between font-bold text-lg mt-4 pt-2 border-t-2">
                                <span>TOTAL LIAB. & EQUITY</span>
                                <span class="text-green-600" x-text="formatCurrency((reports.balanceSheet?.liabilities?.total_liabilities || 0) + (reports.balanceSheet?.equity?.total_equity || 0))"></span>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center gap-2">
                            <span x-show="reports.balanceSheet?.validation?.assets_equal_liabilities_plus_equity" class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">OK Balanced</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fixed Asset Register -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Fixed Asset Register</h3>
                    <p class="text-sm text-gray-500">Capital assets with depreciation schedules</p>
                </div>
                <div class="flex gap-2">
                    <button @click="generateFixedAssets()" :disabled="loading.fixedAssets" class="bg-green-600 text-white px-4 py-2 text-sm rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center gap-2">
                        <svg x-show="loading.fixedAssets" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Generate Report
                    </button>
                    <button x-show="reports.fixedAssets" @click="exportPDF('fixed-assets')" class="border border-green-600 text-green-600 px-3 py-2 text-sm rounded-md hover:bg-green-50 flex items-center gap-1">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        PDF
                    </button>
                </div>
            </div>
            <div x-show="reports.fixedAssets" class="p-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 font-medium">Active Assets</p>
                        <p class="text-xl font-bold text-gray-700" x-text="reports.fixedAssets?.summary?.total_assets || 0">0</p>
                    </div>
                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                        <p class="text-xs text-blue-600 font-medium">Total Cost</p>
                        <p class="text-xl font-bold text-blue-700" x-text="formatCurrency(reports.fixedAssets?.summary?.total_acquisition_cost)">₦0</p>
                    </div>
                    <div class="text-center p-3 bg-amber-50 rounded-lg">
                        <p class="text-xs text-amber-600 font-medium">Depreciation</p>
                        <p class="text-xl font-bold text-amber-700" x-text="formatCurrency(reports.fixedAssets?.summary?.total_accumulated_depreciation)">₦0</p>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <p class="text-xs text-green-600 font-medium">Net Book Value</p>
                        <p class="text-xl font-bold text-green-700" x-text="formatCurrency(reports.fixedAssets?.summary?.total_net_book_value)">₦0</p>
                    </div>
                </div>
                
                <!-- Assets Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Asset</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acquired</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Cost</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Depreciation</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">NBV</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="asset in reports.fixedAssets?.assets" :key="asset.id">
                                <tr>
                                    <td class="px-4 py-3 text-sm text-gray-900" x-text="asset.name"></td>
                                    <td class="px-4 py-3 text-sm text-gray-500" x-text="asset.asset_type"></td>
                                    <td class="px-4 py-3 text-sm text-gray-500" x-text="asset.acquisition_date"></td>
                                    <td class="px-4 py-3 text-sm text-right" x-text="formatCurrency(asset.acquisition_cost)"></td>
                                    <td class="px-4 py-3 text-sm text-right text-amber-600" x-text="formatCurrency(asset.accumulated_depreciation)"></td>
                                    <td class="px-4 py-3 text-sm text-right font-medium text-green-600" x-text="formatCurrency(asset.net_book_value)"></td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="px-2 py-1 text-xs rounded-full" 
                                              :class="asset.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                                              x-text="asset.status"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div x-show="!reports.fixedAssets?.assets?.length" class="text-center py-8 text-gray-500">
                    No fixed assets found
                </div>
            </div>
        </div>

        <!-- Cash Flow -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Cash Flow Statement</h3>
                    <p class="text-sm text-gray-500">Operating cash flow analysis</p>
                </div>
                <button @click="generateCashFlow()" :disabled="loading.cashflow" class="bg-green-600 text-white px-4 py-2 text-sm rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center gap-2">
                    <svg x-show="loading.cashflow" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    Generate Report
                </button>
            </div>
            <div x-show="reports.cashflow" class="p-6">
                <div class="grid grid-cols-3 gap-6">
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <p class="text-sm text-green-600 font-medium">Cash Received</p>
                        <p class="text-xl font-bold text-green-700" x-text="formatCurrency(reports.cashflow?.operating_activities?.cash_received)">₦0</p>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <p class="text-sm text-red-600 font-medium">Cash Paid</p>
                        <p class="text-xl font-bold text-red-700" x-text="formatCurrency(reports.cashflow?.operating_activities?.cash_paid)">₦0</p>
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-600 font-medium">Net Cash Flow</p>
                        <p class="text-xl font-bold text-blue-700" x-text="formatCurrency(reports.cashflow?.summary?.net_cash_flow)">₦0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tax Reports -->
    <div x-show="activeTab === 'tax'" class="space-y-6">
        <!-- VAT Return -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">VAT Return</h3>
                    <p class="text-sm text-gray-500">Monthly VAT filing report</p>
                </div>
                <div class="flex gap-2">
                    <select x-model="taxMonth" class="border-gray-300 rounded-md text-sm">
                        <template x-for="m in 12">
                            <option :value="m" x-text="new Date(2024, m-1).toLocaleString('default', {month: 'long'})"></option>
                        </template>
                    </select>
                    <select x-model="taxYear" class="border-gray-300 rounded-md text-sm">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                    <button @click="generateVATReturn()" :disabled="loading.vat" class="bg-green-600 text-white px-4 py-2 text-sm rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center gap-2">
                        <svg x-show="loading.vat" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Generate
                    </button>
                </div>
            </div>
            <div x-show="reports.vat" class="p-6">
                <div class="grid grid-cols-3 gap-6 mb-6">
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <p class="text-sm text-green-600 font-medium">Output VAT (Sales)</p>
                        <p class="text-xl font-bold text-green-700" x-text="formatCurrency(reports.vat?.output_vat?.amount)">₦0</p>
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-600 font-medium">Input VAT (Purchases)</p>
                        <p class="text-xl font-bold text-blue-700" x-text="formatCurrency(reports.vat?.input_vat?.amount)">₦0</p>
                    </div>
                    <div class="text-center p-4 rounded-lg" :class="reports.vat?.is_refund ? 'bg-amber-50' : 'bg-red-50'">
                        <p class="text-sm font-medium" :class="reports.vat?.is_refund ? 'text-amber-600' : 'text-red-600'" x-text="reports.vat?.is_refund ? 'VAT Refundable' : 'VAT Payable'"></p>
                        <p class="text-xl font-bold" :class="reports.vat?.is_refund ? 'text-amber-700' : 'text-red-700'" x-text="formatCurrency(Math.abs(reports.vat?.net_vat_payable || 0))">₦0</p>
                    </div>
                </div>
                <div class="text-sm text-gray-500">
                    Filing deadline: <span class="font-medium" x-text="reports.vat?.filing_deadline"></span>
                </div>
            </div>
        </div>

        <!-- WHT Summary -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Withholding Tax Summary</h3>
                    <p class="text-sm text-gray-500">WHT deducted on payments</p>
                </div>
                <button @click="generateWHT()" :disabled="loading.wht" class="bg-green-600 text-white px-4 py-2 text-sm rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center gap-2">
                    <svg x-show="loading.wht" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    Generate Report
                </button>
            </div>
            <div x-show="reports.wht" class="p-6">
                <div class="grid grid-cols-3 gap-6">
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 font-medium">Transactions</p>
                        <p class="text-xl font-bold text-gray-700" x-text="reports.wht?.summary?.transaction_count || 0">0</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 font-medium">Gross Payments</p>
                        <p class="text-xl font-bold text-gray-700" x-text="formatCurrency(reports.wht?.summary?.total_gross_payments)">₦0</p>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <p class="text-sm text-purple-600 font-medium">Total WHT Deducted</p>
                        <p class="text-xl font-bold text-purple-700" x-text="formatCurrency(reports.wht?.summary?.total_wht_deducted)">₦0</p>
                    </div>
                </div>
                
                <!-- WHT By Vendor Table -->
                <div x-show="reports.whtByVendor && reports.whtByVendor.length > 0" class="mt-6">
                    <h4 class="font-medium text-gray-900 mb-3">WHT By Vendor (for Certificate Generation)</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">TIN</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Gross Paid</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">WHT Deducted</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <template x-for="vendor in reports.whtByVendor" :key="vendor.vendor_id">
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900" x-text="vendor.vendor_name"></td>
                                        <td class="px-4 py-2 text-sm text-gray-600" x-text="vendor.vendor_tin || 'N/A'"></td>
                                        <td class="px-4 py-2 text-sm text-right text-gray-900" x-text="formatCurrency(vendor.total_gross_paid)"></td>
                                        <td class="px-4 py-2 text-sm text-right font-medium text-purple-700" x-text="formatCurrency(vendor.total_wht_deducted)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- WHT Calculator Tool -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">WHT Calculator</h3>
                <p class="text-sm text-gray-500">Calculate withholding tax before making payments</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gross Amount (₦)</label>
                        <input type="number" x-model="whtCalc.grossAmount" 
                               class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500"
                               placeholder="Enter gross amount">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Service Type</label>
                        <select x-model="whtCalc.serviceType" class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="">Select service type</option>
                            <option value="dividends">Dividends (10%)</option>
                            <option value="interest">Interest (10%)</option>
                            <option value="rent">Rent (10%)</option>
                            <option value="royalties">Royalties (10%)</option>
                            <option value="professional_services">Professional Services (10%/5%)</option>
                            <option value="contract_supply">Contract/Supply (5%)</option>
                            <option value="consultancy">Consultancy (5%)</option>
                            <option value="technical_services">Technical Services (10%)</option>
                            <option value="management_fees">Management Fees (10%)</option>
                            <option value="director_fees">Director Fees (10%)</option>
                            <option value="construction">Construction (5%)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payee Type</label>
                        <select x-model="whtCalc.payeeType" class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="company">Company</option>
                            <option value="individual">Individual</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button @click="calculateWHT()" :disabled="!whtCalc.grossAmount || !whtCalc.serviceType"
                            class="bg-green-600 text-white px-4 py-2 text-sm rounded-md hover:bg-green-700 disabled:opacity-50">
                        Calculate WHT
                    </button>
                    <button @click="calculateGrossFromNet()" :disabled="!whtCalc.grossAmount || !whtCalc.serviceType"
                            class="bg-blue-600 text-white px-4 py-2 text-sm rounded-md hover:bg-blue-700 disabled:opacity-50">
                        Calculate Gross from Net
                    </button>
                </div>
                
                <!-- WHT Calculation Result -->
                <div x-show="whtCalc.result" class="mt-4 p-4 bg-purple-50 rounded-lg">
                    <h4 class="font-medium text-purple-900 mb-3">WHT Calculation Result</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <p class="text-gray-600">Gross Amount</p>
                            <p class="font-semibold text-gray-900" x-text="formatCurrency(whtCalc.result?.gross_amount)"></p>
                        </div>
                        <div>
                            <p class="text-gray-600">WHT Rate</p>
                            <p class="font-semibold text-gray-900" x-text="whtCalc.result?.wht_rate + '%'"></p>
                        </div>
                        <div>
                            <p class="text-purple-600">WHT Amount</p>
                            <p class="font-bold text-purple-700" x-text="formatCurrency(whtCalc.result?.wht_amount)"></p>
                        </div>
                        <div>
                            <p class="text-green-600">Net Payable</p>
                            <p class="font-bold text-green-700" x-text="formatCurrency(whtCalc.result?.net_amount)"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- WHT Rates Reference -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Nigerian WHT Rates (2026)</h3>
                    <p class="text-sm text-gray-500">Reference rates by service type and payee</p>
                </div>
                <button @click="loadWHTRates()" :disabled="loading.whtRates" class="bg-gray-600 text-white px-4 py-2 text-sm rounded-md hover:bg-gray-700 disabled:opacity-50">
                    Load Rates
                </button>
            </div>
            <div x-show="whtRates && whtRates.length > 0" class="p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Service Type</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Individual Rate</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Company Rate</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <template x-for="rate in whtRates" :key="rate.service_type">
                                <tr>
                                    <td class="px-4 py-2 text-sm text-gray-900 capitalize" x-text="rate.service_type.replace(/_/g, ' ')"></td>
                                    <td class="px-4 py-2 text-sm text-center font-medium text-gray-700" x-text="rate.individual_rate + '%'"></td>
                                    <td class="px-4 py-2 text-sm text-center font-medium text-gray-700" x-text="rate.company_rate + '%'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CIT Report -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Company Income Tax (CIT)</h3>
                    <p class="text-sm text-gray-500">Annual CIT calculation</p>
                </div>
                <div class="flex gap-2">
                    <select x-model="fiscalYear" class="border-gray-300 rounded-md text-sm">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                    <button @click="generateCIT()" :disabled="loading.cit" class="bg-green-600 text-white px-4 py-2 text-sm rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center gap-2">
                        <svg x-show="loading.cit" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Generate
                    </button>
                </div>
            </div>
            <div x-show="reports.cit" class="p-6">
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">Company Size: <span class="font-semibold" x-text="reports.cit?.cit_calculation?.company_size"></span></p>
                    <p class="text-sm text-gray-600">CIT Rate: <span class="font-semibold" x-text="(reports.cit?.cit_calculation?.cit_rate * 100) + '%'"></span></p>
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Financial Summary</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Gross Turnover:</span>
                                <span class="font-medium" x-text="formatCurrency(reports.cit?.financial_summary?.gross_turnover)"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total Expenses:</span>
                                <span class="font-medium" x-text="formatCurrency(reports.cit?.financial_summary?.total_expenses)"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Assessable Profit:</span>
                                <span class="font-medium" x-text="formatCurrency(reports.cit?.financial_summary?.assessable_profit)"></span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Tax Calculation</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">CIT Payable:</span>
                                <span class="font-medium" x-text="formatCurrency(reports.cit?.cit_calculation?.cit_payable)"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Tertiary Education Tax:</span>
                                <span class="font-medium" x-text="formatCurrency(reports.cit?.cit_calculation?.tertiary_education_tax)"></span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-gray-200">
                                <span class="text-gray-900 font-semibold">Total Tax:</span>
                                <span class="font-bold text-red-600" x-text="formatCurrency(reports.cit?.cit_calculation?.total_tax)"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Self-Assessment & TaxPro Max Export Tab -->
    <div x-show="activeTab === 'selfAssessment'" class="space-y-6">
        <!-- Info Banner -->
        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
            <div class="flex items-start space-x-3">
                <span class="text-2xl"></span>
                <div>
                    <h3 class="text-sm font-medium text-green-800">Self-Assessment & TaxPro Max Export</h3>
                    <p class="text-sm text-green-700 mt-1">Pre-fill NRS tax forms based on your yearly financial data. Export ready-to-upload CSV/Excel files for the TaxPro Max portal.</p>
                </div>
            </div>
        </div>

        <!-- Fiscal Year Selector -->
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Fiscal Year</label>
                    <select x-model="selfAssessment.fiscalYear" class="border-gray-300 rounded-md text-sm focus:ring-green-500 focus:border-green-500">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
                <div class="flex gap-2 mt-5">
                    <button @click="generateAnnualReturns()" :disabled="loading.selfAssessment" class="bg-green-600 text-white px-4 py-2 text-sm rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center gap-2">
                        <svg x-show="loading.selfAssessment" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Generate Annual Returns Package
                    </button>
                </div>
            </div>
        </div>

        <!-- Annual Returns Summary -->
        <div x-show="selfAssessment.annualReturns" class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Annual Returns Summary - <span x-text="selfAssessment.fiscalYear"></span></h3>
                <p class="text-sm text-gray-500" x-text="selfAssessment.annualReturns?.company_name"></p>
            </div>
            <div class="p-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-xs text-blue-600 font-medium">CIT Payable</p>
                        <p class="text-lg font-bold text-blue-700" x-text="formatCurrency(selfAssessment.annualReturns?.summary?.total_cit)">₦0</p>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <p class="text-xs text-purple-600 font-medium">VAT (Annual)</p>
                        <p class="text-lg font-bold text-purple-700" x-text="formatCurrency(selfAssessment.annualReturns?.summary?.total_vat)">₦0</p>
                    </div>
                    <div class="text-center p-4 bg-amber-50 rounded-lg">
                        <p class="text-xs text-amber-600 font-medium">PAYE</p>
                        <p class="text-lg font-bold text-amber-700" x-text="formatCurrency(selfAssessment.annualReturns?.summary?.total_paye)">₦0</p>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <p class="text-xs text-red-600 font-medium">Dev. Levy</p>
                        <p class="text-lg font-bold text-red-700" x-text="formatCurrency(selfAssessment.annualReturns?.summary?.development_levy)">₦0</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <p class="text-xs text-green-600 font-medium">Grand Total</p>
                        <p class="text-lg font-bold text-green-700" x-text="formatCurrency(selfAssessment.annualReturns?.summary?.grand_total)">₦0</p>
                    </div>
                </div>

                <!-- CIT Assessment Details -->
                <div x-show="selfAssessment.annualReturns?.cit_assessment" class="border rounded-lg p-4 mb-4">
                    <h4 class="font-medium text-gray-900 mb-3 flex items-center gap-2">
                        <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">CIT-01</span>
                        Company Income Tax Assessment
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500">Gross Turnover</p>
                            <p class="font-medium" x-text="formatCurrency(selfAssessment.annualReturns?.cit_assessment?.income_statement?.gross_turnover)"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Net Profit</p>
                            <p class="font-medium" x-text="formatCurrency(selfAssessment.annualReturns?.cit_assessment?.income_statement?.net_profit_before_tax)"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Assessable Profit</p>
                            <p class="font-medium" x-text="formatCurrency(selfAssessment.annualReturns?.cit_assessment?.tax_computation?.assessable_profit)"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Tax Rate</p>
                            <p class="font-medium"><span x-text="selfAssessment.annualReturns?.cit_assessment?.tax_computation?.tax_rate_percent"></span>%</p>
                        </div>
                        <div>
                            <p class="text-gray-500">CIT Liability</p>
                            <p class="font-medium text-blue-600" x-text="formatCurrency(selfAssessment.annualReturns?.cit_assessment?.tax_computation?.cit_liability)"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Capital Gains</p>
                            <p class="font-medium" x-text="formatCurrency(selfAssessment.annualReturns?.cit_assessment?.capital_gains?.total_gains)"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">WHT Credits</p>
                            <p class="font-medium text-green-600" x-text="formatCurrency(selfAssessment.annualReturns?.cit_assessment?.final_computation?.wht_credits)"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Net Tax Payable</p>
                            <p class="font-bold text-lg text-blue-700" x-text="formatCurrency(selfAssessment.annualReturns?.cit_assessment?.final_computation?.net_tax_payable)"></p>
                        </div>
                    </div>
                </div>

                <!-- VAT Monthly Breakdown -->
                <div x-show="selfAssessment.annualReturns?.vat_monthly_breakdown?.length > 0" class="border rounded-lg p-4 mb-4">
                    <h4 class="font-medium text-gray-900 mb-3 flex items-center gap-2">
                        <span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded">VAT-01</span>
                        Monthly VAT Returns
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Month</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Output VAT</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Input VAT</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Net VAT</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <template x-for="vat in selfAssessment.annualReturns?.vat_monthly_breakdown" :key="vat.month">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-2" x-text="getMonthName(vat.month)"></td>
                                        <td class="px-4 py-2 text-right text-red-600" x-text="formatCurrency(vat.output_vat)"></td>
                                        <td class="px-4 py-2 text-right text-green-600" x-text="formatCurrency(vat.input_vat)"></td>
                                        <td class="px-4 py-2 text-right font-medium" x-text="formatCurrency(vat.net_vat)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TaxPro Max Export Section -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">TaxPro Max Export</h3>
                <p class="text-sm text-gray-500">Download ready-to-upload files for NRS TaxPro Max portal</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- CIT Export -->
                    <div class="border rounded-lg p-4 hover:border-green-500 transition-colors">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded">CIT-01</span>
                            <span class="text-sm font-medium text-gray-900">Company Income Tax</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3">Annual CIT return with assessable profit and tax computation</p>
                        <button @click="exportTaxPro('cit')" :disabled="loading.taxProExport" class="w-full bg-blue-600 text-white px-3 py-2 text-sm rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center gap-2">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export CSV
                        </button>
                    </div>

                    <!-- VAT Export -->
                    <div class="border rounded-lg p-4 hover:border-green-500 transition-colors">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs font-medium rounded">VAT-01</span>
                            <span class="text-sm font-medium text-gray-900">Value Added Tax</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3">12 monthly VAT returns with input/output breakdown</p>
                        <button @click="exportTaxPro('vat')" :disabled="loading.taxProExport" class="w-full bg-purple-600 text-white px-3 py-2 text-sm rounded-md hover:bg-purple-700 disabled:opacity-50 flex items-center justify-center gap-2">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export CSV
                        </button>
                    </div>

                    <!-- All Returns Export -->
                    <div class="border rounded-lg p-4 hover:border-green-500 transition-colors bg-gray-50">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded">AR-01</span>
                            <span class="text-sm font-medium text-gray-900">Annual Returns Package</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3">Complete package: CIT, VAT, Development Levy</p>
                        <button @click="exportAllReturns()" :disabled="loading.taxProExport" class="w-full bg-green-600 text-white px-3 py-2 text-sm rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center justify-center gap-2">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export All (ZIP)
                        </button>
                    </div>
                </div>

                <!-- TaxPro Max Portal Link -->
                <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                    <div class="flex items-start gap-3">
                        <span class="text-xl">📤</span>
                        <div>
                            <h4 class="text-sm font-medium text-amber-800">Upload to TaxPro Max</h4>
                            <p class="text-sm text-amber-700 mt-1">After downloading your CSV files, upload them to the NRS TaxPro Max portal:</p>
                            <a href="https://taxpromax.nrs.gov.ng/" target="_blank" class="inline-flex items-center gap-1 text-sm text-amber-800 font-medium mt-2 hover:underline">
                                https://taxpromax.nrs.gov.ng/
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Filing Deadlines -->
                <div class="mt-4 p-4 border rounded-lg">
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Filing Deadlines (2026 Tax Reform)</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500">CIT</p>
                            <p class="font-medium">Within 6 months of fiscal year end</p>
                        </div>
                        <div>
                            <p class="text-gray-500">VAT</p>
                            <p class="font-medium">21st of following month</p>
                        </div>
                        <div>
                            <p class="text-gray-500">PAYE</p>
                            <p class="font-medium">10th of following month</p>
                        </div>
                        <div>
                            <p class="text-gray-500">WHT</p>
                            <p class="font-medium">21st of following month</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Vault Tab -->
    <div x-show="activeTab === 'vault'" class="space-y-6">
        <!-- Vault Info Banner -->
        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
            <div class="flex items-start space-x-3">
                <span class="text-2xl"></span>
                <div>
                    <h3 class="text-sm font-medium text-blue-800">NTAA 2025 Compliant Audit Vault</h3>
                    <p class="text-sm text-blue-700 mt-1">5-year digital record keeping with immutable audit trail, cryptographic integrity verification, and regulatory export capabilities.</p>
                </div>
            </div>
        </div>

        <!-- Vault Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-500">Total Records</span>
                    <span class="p-2 bg-green-100 rounded-lg"></span>
                </div>
                <p class="text-2xl font-bold text-gray-900" x-text="vaultStats.total_records?.toLocaleString() || '0'"></p>
                <p class="text-xs text-gray-500 mt-1">Since <span x-text="vaultStats.oldest_record || 'N/A'"></span></p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-500">Active Records</span>
                    <span class="p-2 bg-blue-100 rounded-lg">Success: </span>
                </div>
                <p class="text-2xl font-bold text-blue-600" x-text="vaultStats.active_records?.toLocaleString() || '0'"></p>
                <p class="text-xs text-gray-500 mt-1">Last 2 years</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-500">Archived Records</span>
                    <span class="p-2 bg-yellow-100 rounded-lg"></span>
                </div>
                <p class="text-2xl font-bold text-yellow-600" x-text="vaultStats.archived_records?.toLocaleString() || '0'"></p>
                <p class="text-xs text-gray-500 mt-1">2-5 years old</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-500">Storage Used</span>
                    <span class="p-2 bg-purple-100 rounded-lg">💾</span>
                </div>
                <p class="text-2xl font-bold text-purple-600" x-text="(vaultStats.storage_size_mb || 0) + ' MB'"></p>
                <p class="text-xs text-gray-500 mt-1">Estimated</p>
            </div>
        </div>

        <!-- Fiscal Years & Retention Timeline -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Available Fiscal Years -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Records by Fiscal Year</h3>
                    <p class="text-sm text-gray-500">Click to filter records</p>
                </div>
                <div class="p-6">
                    <div class="space-y-2">
                        <template x-for="(count, year) in vaultStats.by_fiscal_year" :key="year">
                            <div @click="vaultFilter.fiscal_year = year; loadVaultRecords()" 
                                 class="flex items-center justify-between p-3 rounded-lg cursor-pointer hover:bg-gray-50 transition"
                                 :class="vaultFilter.fiscal_year == year ? 'bg-green-50 border border-green-200' : 'bg-gray-50'">
                                <span class="font-medium text-gray-900">FY <span x-text="year"></span></span>
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm" x-text="count.toLocaleString()"></span>
                            </div>
                        </template>
                        <div x-show="Object.keys(vaultStats.by_fiscal_year || {}).length === 0" class="text-center text-gray-500 py-4">
                            No records in vault
                        </div>
                    </div>
                </div>
            </div>

            <!-- Retention Timeline -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Retention Timeline</h3>
                    <p class="text-sm text-gray-500">Records expiring by year</p>
                </div>
                <div class="p-6">
                    <div class="space-y-3">
                        <template x-for="item in retentionTimeline" :key="item.expiry_year">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <span class="text-sm" :class="item.status === 'current' ? 'text-red-600 font-medium' : 'text-gray-600'" x-text="item.expiry_year"></span>
                                    <span x-show="item.status === 'current'" class="text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded">Current</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-32 bg-gray-200 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" :style="'width: ' + Math.min(100, (item.record_count / (vaultStats.total_records || 1)) * 100 * 5) + '%'"></div>
                                    </div>
                                    <span class="text-sm text-gray-600 w-16 text-right" x-text="item.record_count.toLocaleString()"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Record Browser -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Vault Records</h3>
                    <p class="text-sm text-gray-500">Browse and verify audit records</p>
                </div>
                <div class="flex items-center gap-2">
                    <select x-model="vaultFilter.document_type" @change="loadVaultRecords()" class="text-sm border-gray-300 rounded-md">
                        <option value="">All Types</option>
                        <option value="invoice">Invoices</option>
                        <option value="transaction">Transactions</option>
                        <option value="receipt">Receipts</option>
                        <option value="nrs_submission">NRS Submissions</option>
                        <option value="fixed_asset">Fixed Assets</option>
                    </select>
                    <select x-model="vaultFilter.retention_status" @change="loadVaultRecords()" class="text-sm border-gray-300 rounded-md">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="archived">Archived</option>
                        <option value="pending_purge">Pending Purge</option>
                    </select>
                    <button @click="vaultFilter = {}; loadVaultRecords()" class="text-sm text-gray-500 hover:text-gray-700">Clear</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reference</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NRS</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-for="record in vaultRecords" :key="record.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-900" x-text="new Date(record.created_at).toLocaleDateString()"></td>
                                <td class="px-4 py-3 text-sm text-gray-600" x-text="record.document_type"></td>
                                <td class="px-4 py-3 text-sm font-mono text-gray-600" x-text="record.reference_id.substring(0, 8) + '...'"></td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs rounded-full"
                                          :class="{
                                              'bg-green-100 text-green-800': record.action === 'create',
                                              'bg-blue-100 text-blue-800': record.action === 'update',
                                              'bg-red-100 text-red-800': record.action === 'delete',
                                              'bg-purple-100 text-purple-800': record.action === 'nrs_submit',
                                              'bg-gray-100 text-gray-800': !['create','update','delete','nrs_submit'].includes(record.action)
                                          }"
                                          x-text="record.action"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs rounded-full"
                                          :class="{
                                              'bg-green-100 text-green-800': record.status === 'active',
                                              'bg-yellow-100 text-yellow-800': record.status === 'archived',
                                              'bg-red-100 text-red-800': record.status === 'pending_purge'
                                          }"
                                          x-text="record.status"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span x-show="record.has_nrs_data" class="text-green-600">OK</span>
                                    <span x-show="!record.has_nrs_data" class="text-gray-400">-</span>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <button @click="viewRecordDetail(record.id)" class="text-blue-600 hover:text-blue-800 text-sm">View</button>
                                    <button @click="verifyRecord(record.id)" class="ml-2 text-green-600 hover:text-green-800 text-sm">Verify</button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="vaultRecords.length === 0">
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">No records found</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                <p class="text-sm text-gray-600">Showing <span x-text="vaultRecords.length"></span> of <span x-text="vaultTotal"></span> records</p>
                <div class="flex items-center gap-2">
                    <button @click="vaultPage > 0 && (vaultPage--, loadVaultRecords())" :disabled="vaultPage === 0" class="px-3 py-1 text-sm border rounded disabled:opacity-50">Previous</button>
                    <button @click="(vaultPage + 1) * 50 < vaultTotal && (vaultPage++, loadVaultRecords())" :disabled="(vaultPage + 1) * 50 >= vaultTotal" class="px-3 py-1 text-sm border rounded disabled:opacity-50">Next</button>
                </div>
            </div>
        </div>

        <!-- Compliance Export -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Regulatory Export</h3>
                <p class="text-sm text-gray-500">Generate audit-ready exports for FIRS/NRS</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fiscal Year</label>
                        <select x-model="exportYear" class="w-full border-gray-300 rounded-md">
                            <template x-for="year in Object.keys(vaultStats.by_fiscal_year || {}).sort().reverse()" :key="year">
                                <option :value="year" x-text="year"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Include Full Data</label>
                        <select x-model="exportFullData" class="w-full border-gray-300 rounded-md">
                            <option value="false">Summary Only</option>
                            <option value="true">Full Data (with old/new values)</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button @click="generateExport()" :disabled="exporting" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:opacity-50">
                            <span x-show="!exporting">Generate Export</span>
                            <span x-show="exporting">Generating...</span>
                        </button>
                    </div>
                </div>
                
                <!-- Export Result -->
                <div x-show="exportResult" class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="font-medium text-gray-900">Export Ready</h4>
                            <p class="text-sm text-gray-500">FY <span x-text="exportResult?.export_metadata?.fiscal_year"></span> • <span x-text="exportResult?.export_metadata?.record_count"></span> records</p>
                        </div>
                        <button @click="downloadExport()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            ⬇️ Download JSON
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">Export Hash:</span>
                            <code class="ml-2 text-xs text-green-700" x-text="exportResult?.export_metadata?.export_hash?.substring(0, 16) + '...'"></code>
                        </div>
                        <div>
                            <span class="text-gray-500">NRS Submissions:</span>
                            <span class="ml-2 font-medium" x-text="exportResult?.export_metadata?.nrs_submission_count"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Integrity Verification -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Integrity Verification</h3>
                <p class="text-sm text-gray-500">Verify cryptographic integrity of vault records</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Verify Fiscal Year</label>
                        <div class="flex items-center gap-2">
                            <select x-model="verifyYear" class="flex-1 border-gray-300 rounded-md">
                                <template x-for="year in Object.keys(vaultStats.by_fiscal_year || {}).sort().reverse()" :key="year">
                                    <option :value="year" x-text="year"></option>
                                </template>
                            </select>
                            <button @click="verifyFiscalYear()" :disabled="verifying" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50">
                                Verify
                            </button>
                        </div>
                    </div>
                    <div x-show="verificationResult" class="p-4 rounded-lg" :class="verificationResult?.verified ? 'bg-green-50' : 'bg-red-50'">
                        <div class="flex items-center space-x-2">
                            <span x-text="verificationResult?.verified ? 'Success: ' : 'Failed: '" class="text-xl"></span>
                            <div>
                                <p class="font-medium" :class="verificationResult?.verified ? 'text-green-800' : 'text-red-800'">
                                    <span x-text="verificationResult?.verified ? 'Integrity Verified' : 'Verification Failed'"></span>
                                </p>
                                <p class="text-sm text-gray-600">
                                    <span x-text="verificationResult?.record_count"></span> records • Chain hash: 
                                    <code class="text-xs" x-text="verificationResult?.chain_hash?.substring(0, 12) + '...'"></code>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Retention Policy Info -->
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <h4 class="font-medium text-gray-800 mb-2">NTAA 2025 Retention Policy</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm text-gray-600">
                <div><strong>Retention Period:</strong> 5 years minimum</div>
                <div><strong>Archive After:</strong> 2 years</div>
                <div><strong>Compliance:</strong> NTAA 2025</div>
                <div><strong>Integrity:</strong> SHA-256 cryptographic verification</div>
            </div>
        </div>
    </div>
</div>

<script>
function reportsPage() {
    const today = new Date();
    const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    
    return {
        entityId: {{ entity_id|tojson if entity_id else 'null' }},
        activeTab: 'financial',
        startDate: firstOfMonth.toISOString().split('T')[0],
        endDate: today.toISOString().split('T')[0],
        asOfDate: today.toISOString().split('T')[0],
        taxMonth: today.getMonth() + 1,
        taxYear: today.getFullYear(),
        fiscalYear: today.getFullYear(),
        reports: {},
        loading: {
            pnl: false,
            cashflow: false,
            trialBalance: false,
            balanceSheet: false,
            fixedAssets: false,
            vat: false,
            wht: false,
            whtRates: false,
            cit: false,
            selfAssessment: false,
            taxProExport: false,
        },
        
        // WHT Calculator Data
        whtCalc: {
            grossAmount: null,
            serviceType: '',
            payeeType: 'company',
            result: null,
        },
        whtRates: [],
        
        // Self-Assessment Data
        selfAssessment: {
            fiscalYear: today.getFullYear(),
            info: null,
            annualReturns: null,
            citAssessment: null,
            vatAssessments: [],
        },
        
        // Audit Vault Data
        vaultStats: {},
        vaultRecords: [],
        vaultTotal: 0,
        vaultPage: 0,
        vaultFilter: {},
        retentionTimeline: [],
        exportYear: today.getFullYear(),
        exportFullData: 'false',
        exportResult: null,
        exporting: false,
        verifyYear: today.getFullYear(),
        verificationResult: null,
        verifying: false,
        recordDetail: null,
        
        init() {
            if (!this.entityId) {
                console.warn('No entity selected');
                return;
            }
        },
        
        setPreset(preset) {
            const now = new Date();
            let start, end;
            
            switch(preset) {
                case 'thisMonth':
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = now;
                    break;
                case 'lastMonth':
                    start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    end = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;
                case 'thisQuarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    start = new Date(now.getFullYear(), quarter * 3, 1);
                    end = now;
                    break;
                case 'thisYear':
                    start = new Date(now.getFullYear(), 0, 1);
                    end = now;
                    break;
            }
            
            this.startDate = start.toISOString().split('T')[0];
            this.endDate = end.toISOString().split('T')[0];
            this.asOfDate = end.toISOString().split('T')[0];
        },
        
        async generatePnL() {
            this.loading.pnl = true;
            try {
                const response = await authFetch(
                    `/api/v1/entities/${this.entityId}/reports/profit-loss?start_date=${this.startDate}&end_date=${this.endDate}`,
                    
                );
                if (response.ok) {
                    this.reports.pnl = await response.json();
                } else {
                    console.error('Failed to generate P&L');
                }
            } catch (error) {
                console.error('Failed to generate P&L:', error);
            } finally {
                this.loading.pnl = false;
            }
        },
        
        async generateCashFlow() {
            this.loading.cashflow = true;
            try {
                const response = await authFetch(
                    `/api/v1/entities/${this.entityId}/reports/cash-flow?start_date=${this.startDate}&end_date=${this.endDate}`,
                    
                );
                if (response.ok) {
                    this.reports.cashflow = await response.json();
                }
            } catch (error) {
                console.error('Failed to generate cash flow:', error);
            } finally {
                this.loading.cashflow = false;
            }
        },
        
        async generateTrialBalance() {
            this.loading.trialBalance = true;
            try {
                const response = await authFetch(
                    `/api/v1/entities/${this.entityId}/reports/trial-balance?as_of_date=${this.asOfDate}`,
                    
                );
                if (response.ok) {
                    this.reports.trialBalance = await response.json();
                }
            } catch (error) {
                console.error('Failed to generate trial balance:', error);
            } finally {
                this.loading.trialBalance = false;
            }
        },
        
        async generateBalanceSheet() {
            this.loading.balanceSheet = true;
            try {
                const response = await authFetch(
                    `/api/v1/entities/${this.entityId}/reports/balance-sheet?as_of_date=${this.asOfDate}`,
                    
                );
                if (response.ok) {
                    this.reports.balanceSheet = await response.json();
                }
            } catch (error) {
                console.error('Failed to generate balance sheet:', error);
            } finally {
                this.loading.balanceSheet = false;
            }
        },
        
        async generateFixedAssets() {
            this.loading.fixedAssets = true;
            try {
                const response = await authFetch(
                    `/api/v1/entities/${this.entityId}/reports/fixed-assets?as_of_date=${this.asOfDate}`,
                    
                );
                if (response.ok) {
                    this.reports.fixedAssets = await response.json();
                }
            } catch (error) {
                console.error('Failed to generate fixed assets report:', error);
            } finally {
                this.loading.fixedAssets = false;
            }
        },
        
        async generateVATReturn() {
            this.loading.vat = true;
            try {
                const response = await authFetch(
                    `/api/v1/entities/${this.entityId}/reports/tax/vat-return?year=${this.taxYear}&month=${this.taxMonth}`,
                    
                );
                if (response.ok) {
                    this.reports.vat = await response.json();
                }
            } catch (error) {
                console.error('Failed to generate VAT return:', error);
            } finally {
                this.loading.vat = false;
            }
        },
        
        async generateWHT() {
            this.loading.wht = true;
            try {
                // Get WHT summary
                const response = await authFetch(
                    `/api/v1/entities/${this.entityId}/reports/tax/wht-summary?start_date=${this.startDate}&end_date=${this.endDate}`,
                    
                );
                if (response.ok) {
                    this.reports.wht = await response.json();
                }
                
                // Also get WHT by vendor
                const vendorResponse = await authFetch(
                    `/api/v1/tax/${this.entityId}/wht/by-vendor?start_date=${this.startDate}&end_date=${this.endDate}`,
                    
                );
                if (vendorResponse.ok) {
                    this.reports.whtByVendor = await vendorResponse.json();
                }
            } catch (error) {
                console.error('Failed to generate WHT summary:', error);
            } finally {
                this.loading.wht = false;
            }
        },
        
        async calculateWHT() {
            if (!this.whtCalc.grossAmount || !this.whtCalc.serviceType) return;
            
            try {
                const response = await authFetch('/api/v1/tax/wht/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gross_amount: parseFloat(this.whtCalc.grossAmount),
                        service_type: this.whtCalc.serviceType,
                        payee_type: this.whtCalc.payeeType
                    })
                });
                if (response.ok) {
                    this.whtCalc.result = await response.json();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to calculate WHT'));
                }
            } catch (error) {
                console.error('Failed to calculate WHT:', error);
            }
        },
        
        async calculateGrossFromNet() {
            if (!this.whtCalc.grossAmount || !this.whtCalc.serviceType) return;
            
            try {
                const response = await authFetch('/api/v1/tax/wht/calculate-gross', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        net_amount: parseFloat(this.whtCalc.grossAmount),
                        service_type: this.whtCalc.serviceType,
                        payee_type: this.whtCalc.payeeType
                    })
                });
                if (response.ok) {
                    this.whtCalc.result = await response.json();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to calculate gross'));
                }
            } catch (error) {
                console.error('Failed to calculate gross from net:', error);
            }
        },
        
        async loadWHTRates() {
            this.loading.whtRates = true;
            try {
                const response = await authFetch('/api/v1/tax/wht/rates', {
                    credentials: 'include'
                });
                if (response.ok) {
                    this.whtRates = await response.json();
                }
            } catch (error) {
                console.error('Failed to load WHT rates:', error);
            } finally {
                this.loading.whtRates = false;
            }
        },
        
        async generateCIT() {
            this.loading.cit = true;
            try {
                const response = await authFetch(
                    `/api/v1/entities/${this.entityId}/reports/tax/cit?fiscal_year=${this.fiscalYear}`,
                    
                );
                if (response.ok) {
                    this.reports.cit = await response.json();
                }
            } catch (error) {
                console.error('Failed to generate CIT report:', error);
            } finally {
                this.loading.cit = false;
            }
        },
        
        async exportReport(reportType, format = 'pdf') {
            // Build base URL based on report type
            let baseUrl = `/api/v1/entities/${this.entityId}/reports/export/${reportType}`;
            let params = new URLSearchParams();
            params.append('format', format);
            
            // Add date parameters based on report type
            switch(reportType) {
                case 'profit-loss':
                case 'income-statement':
                    params.append('start_date', this.startDate);
                    params.append('end_date', this.endDate);
                    break;
                case 'trial-balance':
                case 'balance-sheet':
                case 'fixed-assets':
                    params.append('as_of_date', this.asOfDate);
                    break;
                case 'general-ledger':
                case 'journal-entries':
                    params.append('start_date', this.startDate);
                    params.append('end_date', this.endDate);
                    break;
            }
            
            const url = `${baseUrl}?${params.toString()}`;
            
            try {
                const response = await authFetch(url, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    
                    // Determine file extension
                    let extension = format;
                    if (format === 'excel') extension = 'xlsx';
                    
                    a.download = `${reportType}_${this.asOfDate || this.endDate}.${extension}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                } else {
                    console.error(`Failed to export ${format.toUpperCase()}`);
                    alert(`Failed to export ${format.toUpperCase()}. Please try again.`);
                }
            } catch (error) {
                console.error(`Failed to export ${format.toUpperCase()}:`, error);
                alert(`Failed to export ${format.toUpperCase()}. Please try again.`);
            }
        },
        
        // Legacy exportPDF function for backward compatibility
        async exportPDF(reportType) {
            await this.exportReport(reportType, 'pdf');
        },
        
        formatCurrency(amount) {
            return new Intl.NumberFormat('en-NG', {
                style: 'currency',
                currency: 'NGN',
                minimumFractionDigits: 2
            }).format(amount || 0);
        },
        
        // ===========================================
        // SELF-ASSESSMENT & TAXPRO MAX METHODS
        // ===========================================
        
        async loadSelfAssessmentInfo() {
            try {
                const response = await authFetch('/api/v1/tax-2026/self-assessment/info', {
                    credentials: 'include'
                });
                if (response.ok) {
                    this.selfAssessment.info = await response.json();
                }
            } catch (error) {
                console.error('Failed to load self-assessment info:', error);
            }
        },
        
        async generateAnnualReturns() {
            if (!this.entityId) return;
            this.loading.selfAssessment = true;
            
            try {
                const response = await authFetch(
                    `/api/v1/self-assessment/${this.entityId}/annual-returns/${this.selfAssessment.fiscalYear}`,
                    
                );
                
                if (response.ok) {
                    this.selfAssessment.annualReturns = await response.json();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to generate annual returns');
                }
            } catch (error) {
                console.error('Failed to generate annual returns:', error);
                alert('Error generating annual returns');
            } finally {
                this.loading.selfAssessment = false;
            }
        },
        
        async exportTaxPro(returnType) {
            if (!this.entityId) return;
            this.loading.taxProExport = true;
            
            try {
                const response = await authFetch(`/api/v1/self-assessment/${this.entityId}/taxpro-export`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fiscal_year: parseInt(this.selfAssessment.fiscalYear),
                        return_type: returnType,
                        format: 'csv',
                    }),
                });
                
                if (response.ok) {
                    const result = await response.json();
                    this.downloadCSV(result.content, result.filename);
                    alert(`Export successful: ${result.filename}\n\nRecords: ${result.record_count}`);
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to export');
                }
            } catch (error) {
                console.error('Failed to export:', error);
                alert('Error exporting data');
            } finally {
                this.loading.taxProExport = false;
            }
        },
        
        async exportAllReturns() {
            // Export CIT and VAT together
            await this.exportTaxPro('cit');
            await this.exportTaxPro('vat');
        },
        
        downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        },
        
        getMonthName(month) {
            const months = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return months[month] || '';
        },
        
        // ===========================================
        // AUDIT VAULT METHODS
        // ===========================================
        
        async loadVaultData() {
            if (!this.entityId) return;
            await Promise.all([
                this.loadVaultStats(),
                this.loadVaultRecords(),
                this.loadRetentionTimeline(),
            ]);
        },
        
        async loadVaultStats() {
            try {
                const res = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/statistics`, {
                    
                });
                if (res.ok) {
                    this.vaultStats = await res.json();
                    // Set default export/verify year to most recent
                    const years = Object.keys(this.vaultStats.by_fiscal_year || {}).sort().reverse();
                    if (years.length > 0) {
                        this.exportYear = years[0];
                        this.verifyYear = years[0];
                    }
                }
            } catch (e) {
                console.error('Failed to load vault statistics:', e);
            }
        },
        
        async loadVaultRecords() {
            try {
                const params = new URLSearchParams({
                    skip: this.vaultPage * 50,
                    limit: 50,
                });
                if (this.vaultFilter.fiscal_year) params.append('fiscal_year', this.vaultFilter.fiscal_year);
                if (this.vaultFilter.document_type) params.append('document_type', this.vaultFilter.document_type);
                if (this.vaultFilter.retention_status) params.append('retention_status', this.vaultFilter.retention_status);
                
                const res = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/records?${params}`, {
                    
                });
                if (res.ok) {
                    const data = await res.json();
                    this.vaultRecords = data.items;
                    this.vaultTotal = data.total;
                }
            } catch (e) {
                console.error('Failed to load vault records:', e);
            }
        },
        
        async loadRetentionTimeline() {
            try {
                const res = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/retention-timeline`, {
                    
                });
                if (res.ok) {
                    const data = await res.json();
                    this.retentionTimeline = data.timeline;
                }
            } catch (e) {
                console.error('Failed to load retention timeline:', e);
            }
        },
        
        async viewRecordDetail(recordId) {
            try {
                const res = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/records/${recordId}`, {
                    
                });
                if (res.ok) {
                    this.recordDetail = await res.json();
                    alert(`Record ${recordId}\n\nType: ${this.recordDetail.document_type}\nAction: ${this.recordDetail.action}\nIntegrity Hash: ${this.recordDetail.integrity_hash}\nVerified: ${this.recordDetail.integrity_verified ? 'Yes' : 'No'}`);
                }
            } catch (e) {
                console.error('Failed to load record detail:', e);
            }
        },
        
        async verifyRecord(recordId) {
            try {
                const res = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/verify/${recordId}`, {
                    method: 'POST',
                    
                });
                if (res.ok) {
                    const result = await res.json();
                    alert(`Success:  Record Verified\n\nHash: ${result.integrity_hash.substring(0, 32)}...`);
                } else {
                    alert('Failed:  Verification failed');
                }
            } catch (e) {
                console.error('Failed to verify record:', e);
            }
        },
        
        async verifyFiscalYear() {
            this.verifying = true;
            try {
                const res = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/verify-year/${this.verifyYear}`, {
                    method: 'POST',
                    
                });
                if (res.ok) {
                    this.verificationResult = await res.json();
                }
            } catch (e) {
                console.error('Failed to verify fiscal year:', e);
            }
            this.verifying = false;
        },
        
        async generateExport() {
            this.exporting = true;
            try {
                const params = new URLSearchParams({
                    include_full_data: this.exportFullData,
                });
                const res = await authFetch(`/api/v1/entities/${this.entityId}/audit/vault/export/${this.exportYear}?${params}`, {
                    
                });
                if (res.ok) {
                    this.exportResult = await res.json();
                }
            } catch (e) {
                console.error('Failed to generate export:', e);
            }
            this.exporting = false;
        },
        
        downloadExport() {
            if (!this.exportResult) return;
            const blob = new Blob([JSON.stringify(this.exportResult, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit_vault_fy${this.exportResult.export_metadata?.fiscal_year}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    }
}
</script>
{% endblock %}

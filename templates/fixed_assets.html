{% extends "base.html" %}

{% block title %}Fixed Asset Register - TekVwarho ProAudit{% endblock %}

{% block content %}
<div x-data="fixedAssetsPage()" x-init="init()">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Fixed Asset Register</h1>
            <p class="text-gray-600">Track capital assets, depreciation, and capital gains</p>
        </div>
        <button @click="showModal = true" class="mt-4 sm:mt-0 inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Asset
        </button>
    </div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">Total Assets</p>
                    <p class="text-2xl font-bold text-gray-900" x-text="summary.total_assets || 0"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">Total Cost</p>
                    <p class="text-2xl font-bold text-gray-900" x-text="formatCurrency(summary.total_acquisition_cost || 0)"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-amber-100">
                    <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">Accum. Depreciation</p>
                    <p class="text-2xl font-bold text-amber-600" x-text="formatCurrency(summary.total_accumulated_depreciation || 0)"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">Net Book Value</p>
                    <p class="text-2xl font-bold text-purple-600" x-text="formatCurrency(summary.total_net_book_value || 0)"></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- VAT Recovery Info (2026 Compliance) -->
    <div x-show="summary.vat_recovery" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-green-800">2026 VAT Recovery on Capital Assets</h3>
                <div class="mt-2 text-sm text-green-700">
                    <p>Pending recovery: <strong x-text="formatCurrency(summary.vat_recovery?.recoverable_pending || 0)"></strong></p>
                    <p>Already recovered: <strong x-text="formatCurrency(summary.vat_recovery?.already_recovered || 0)"></strong></p>
                    <p class="text-xs mt-1 text-green-600" x-text="summary.vat_recovery?.note"></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search & Filter -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <input type="text" x-model="searchQuery" @input.debounce.300ms="loadAssets()" placeholder="Search by code, name, or description..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
            </div>
            <div>
                <select x-model="categoryFilter" @change="loadAssets()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option value="">All Categories</option>
                    <option value="land">Land</option>
                    <option value="buildings">Buildings</option>
                    <option value="plant_machinery">Plant & Machinery</option>
                    <option value="furniture_fittings">Furniture & Fittings</option>
                    <option value="motor_vehicles">Motor Vehicles</option>
                    <option value="computer_equipment">Computer Equipment</option>
                    <option value="office_equipment">Office Equipment</option>
                    <option value="leasehold_improvements">Leasehold Improvements</option>
                    <option value="intangible_assets">Intangible Assets</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div>
                <select x-model="statusFilter" @change="loadAssets()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="disposed">Disposed</option>
                    <option value="written_off">Written Off</option>
                    <option value="under_repair">Under Repair</option>
                    <option value="idle">Idle</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Actions Bar -->
    <div class="flex flex-wrap gap-3 mb-6">
        <button @click="runDepreciation()" :disabled="runningDepreciation" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors">
            <svg x-show="runningDepreciation" class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <svg x-show="!runningDepreciation" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            Run Depreciation
        </button>
        <button @click="showScheduleModal = true" class="inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            View Depreciation Schedule
        </button>
        <button @click="showCapitalGainsModal = true" class="inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
            </svg>
            Capital Gains Report
        </button>
    </div>
    
    <!-- Assets Table -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Code</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acquisition Date</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Accum. Dep.</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">NBV</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="loading">
                        <tr>
                            <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                                <svg class="animate-spin h-8 w-8 mx-auto text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p class="mt-2">Loading assets...</p>
                            </td>
                        </tr>
                    </template>
                    <template x-if="!loading && assets.length === 0">
                        <tr>
                            <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                                <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                                <p>No fixed assets found</p>
                                <button @click="showModal = true" class="mt-3 text-green-600 hover:text-green-700 font-medium">Add your first asset</button>
                            </td>
                        </tr>
                    </template>
                    <template x-for="asset in assets" :key="asset.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="asset.asset_code"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900" x-text="asset.name"></div>
                                <div x-show="asset.vendor_irn" class="text-xs text-green-600">VAT Recoverable (IRN Valid)</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700" x-text="formatCategory(asset.category)"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="formatDate(asset.acquisition_date)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right" x-text="formatCurrency(asset.acquisition_cost)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-amber-600 text-right" x-text="formatCurrency(asset.accumulated_depreciation)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-right" x-text="formatCurrency(asset.net_book_value)"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="{
                                    'bg-green-100 text-green-800': asset.status === 'active',
                                    'bg-red-100 text-red-800': asset.status === 'disposed',
                                    'bg-gray-100 text-gray-800': asset.status === 'written_off',
                                    'bg-yellow-100 text-yellow-800': asset.status === 'under_repair',
                                    'bg-blue-100 text-blue-800': asset.status === 'idle'
                                }" class="px-2 py-1 text-xs rounded-full capitalize" x-text="asset.status.replace('_', ' ')"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                                <button @click="viewAsset(asset)" class="text-blue-600 hover:text-blue-800 mr-3">View</button>
                                <button @click="editAsset(asset)" class="text-green-600 hover:text-green-800 mr-3" x-show="asset.status === 'active'">Edit</button>
                                <button @click="disposeAsset(asset)" class="text-red-600 hover:text-red-800" x-show="asset.status === 'active'">Dispose</button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div x-show="totalPages > 1" class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
            <div class="text-sm text-gray-500">
                Showing <span x-text="((currentPage - 1) * pageSize) + 1"></span> to <span x-text="Math.min(currentPage * pageSize, totalItems)"></span> of <span x-text="totalItems"></span> assets
            </div>
            <div class="flex gap-2">
                <button @click="prevPage()" :disabled="currentPage === 1" class="px-3 py-1 border border-gray-300 rounded-md text-sm disabled:opacity-50">Previous</button>
                <button @click="nextPage()" :disabled="currentPage === totalPages" class="px-3 py-1 border border-gray-300 rounded-md text-sm disabled:opacity-50">Next</button>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Asset Modal -->
    <div x-show="showModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showModal = false"></div>
            
            <div x-show="showModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <form @submit.prevent="saveAsset()">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="editingAsset ? 'Edit Fixed Asset' : 'Add New Fixed Asset'"></h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Name -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Asset Name *</label>
                                <input type="text" x-model="form.name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="e.g., Dell Latitude 5520 Laptop">
                            </div>
                            
                            <!-- Description -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea x-model="form.description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Optional asset description"></textarea>
                            </div>
                            
                            <!-- Category -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                                <select x-model="form.category" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    <option value="">Select Category</option>
                                    <option value="land">Land (0%)</option>
                                    <option value="buildings">Buildings (10%)</option>
                                    <option value="plant_machinery">Plant & Machinery (25%)</option>
                                    <option value="furniture_fittings">Furniture & Fittings (20%)</option>
                                    <option value="motor_vehicles">Motor Vehicles (25%)</option>
                                    <option value="computer_equipment">Computer Equipment (25%)</option>
                                    <option value="office_equipment">Office Equipment (20%)</option>
                                    <option value="leasehold_improvements">Leasehold Improvements (10%)</option>
                                    <option value="intangible_assets">Intangible Assets (12.5%)</option>
                                    <option value="other">Other (20%)</option>
                                </select>
                            </div>
                            
                            <!-- Acquisition Date -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Acquisition Date *</label>
                                <input type="date" x-model="form.acquisition_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            </div>
                            
                            <!-- Acquisition Cost -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Acquisition Cost (₦) *</label>
                                <input type="number" step="0.01" x-model="form.acquisition_cost" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="0.00">
                            </div>
                            
                            <!-- Residual Value -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Residual Value (₦)</label>
                                <input type="number" step="0.01" x-model="form.residual_value" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="0.00">
                            </div>
                            
                            <!-- Depreciation Method -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Depreciation Method</label>
                                <select x-model="form.depreciation_method" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    <option value="straight_line">Straight Line</option>
                                    <option value="reducing_balance">Reducing Balance (Nigerian Standard)</option>
                                    <option value="units_of_production">Units of Production</option>
                                </select>
                            </div>
                            
                            <!-- Useful Life -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Useful Life (Years)</label>
                                <input type="number" x-model="form.useful_life_years" min="1" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="e.g., 5">
                            </div>
                            
                            <hr class="md:col-span-2 border-gray-200 my-2">
                            <h4 class="md:col-span-2 text-sm font-medium text-gray-700">Vendor & VAT Recovery (2026 Compliance)</h4>
                            
                            <!-- Vendor Name -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Vendor Name</label>
                                <input type="text" x-model="form.vendor_name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Vendor/Supplier name">
                            </div>
                            
                            <!-- Vendor IRN -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Vendor NRS IRN <span class="text-green-600 text-xs">(for VAT recovery)</span></label>
                                <input type="text" x-model="form.vendor_irn" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Invoice Reference Number">
                            </div>
                            
                            <hr class="md:col-span-2 border-gray-200 my-2">
                            <h4 class="md:col-span-2 text-sm font-medium text-gray-700">Additional Details</h4>
                            
                            <!-- Serial Number -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number</label>
                                <input type="text" x-model="form.serial_number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Optional">
                            </div>
                            
                            <!-- Location -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                                <input type="text" x-model="form.location" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="e.g., Head Office">
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" :disabled="saving" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50">
                            <svg x-show="saving" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span x-text="saving ? 'Saving...' : (editingAsset ? 'Update Asset' : 'Add Asset')"></span>
                        </button>
                        <button type="button" @click="showModal = false; resetForm()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:mt-0 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Dispose Asset Modal -->
    <div x-show="showDisposeModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showDisposeModal" x-transition class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showDisposeModal = false"></div>
            
            <div x-show="showDisposeModal" x-transition class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form @submit.prevent="confirmDispose()">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                        <div class="flex items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                        </div>
                        <h3 class="mt-4 text-lg font-medium text-gray-900 text-center">Dispose Asset</h3>
                        <p class="mt-2 text-sm text-gray-500 text-center">
                            Disposing: <strong x-text="disposingAsset?.name"></strong>
                        </p>
                        <p class="text-sm text-gray-500 text-center">
                            Current NBV: <strong x-text="formatCurrency(disposingAsset?.net_book_value)"></strong>
                        </p>
                        
                        <div class="mt-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Disposal Type *</label>
                                <select x-model="disposeForm.disposal_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    <option value="sale">Sale</option>
                                    <option value="trade_in">Trade-In</option>
                                    <option value="scrapped">Scrapped</option>
                                    <option value="donated">Donated</option>
                                    <option value="theft">Theft/Loss</option>
                                    <option value="insurance_claim">Insurance Claim</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Disposal Date *</label>
                                <input type="date" x-model="disposeForm.disposal_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Disposal Proceeds (₦)</label>
                                <input type="number" step="0.01" x-model="disposeForm.disposal_proceeds" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Buyer Name</label>
                                <input type="text" x-model="disposeForm.buyer_name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                <textarea x-model="disposeForm.notes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                            <p class="text-sm text-amber-700">
                                <strong>2026 Tax Note:</strong> Capital gains on disposal are taxed at the flat CIT rate (30% for large companies).
                            </p>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" :disabled="disposing" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50">
                            <span x-text="disposing ? 'Processing...' : 'Confirm Disposal'"></span>
                        </button>
                        <button type="button" @click="showDisposeModal = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- View Asset Modal -->
    <div x-show="showViewModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showViewModal" x-transition class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showViewModal = false"></div>
            
            <div x-show="showViewModal" x-transition class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900" x-text="viewingAsset?.name"></h3>
                            <p class="text-sm text-gray-500" x-text="viewingAsset?.asset_code"></p>
                        </div>
                        <span :class="{
                            'bg-green-100 text-green-800': viewingAsset?.status === 'active',
                            'bg-red-100 text-red-800': viewingAsset?.status === 'disposed',
                            'bg-gray-100 text-gray-800': viewingAsset?.status === 'written_off'
                        }" class="px-3 py-1 text-sm rounded-full capitalize" x-text="viewingAsset?.status?.replace('_', ' ')"></span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500">Category</p>
                            <p class="font-medium" x-text="formatCategory(viewingAsset?.category)"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Acquisition Date</p>
                            <p class="font-medium" x-text="formatDate(viewingAsset?.acquisition_date)"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Acquisition Cost</p>
                            <p class="font-medium" x-text="formatCurrency(viewingAsset?.acquisition_cost)"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Residual Value</p>
                            <p class="font-medium" x-text="formatCurrency(viewingAsset?.residual_value)"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Depreciation Method</p>
                            <p class="font-medium capitalize" x-text="viewingAsset?.depreciation_method?.replace('_', ' ')"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Depreciation Rate</p>
                            <p class="font-medium" x-text="viewingAsset?.depreciation_rate + '%'"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Accumulated Depreciation</p>
                            <p class="font-medium text-amber-600" x-text="formatCurrency(viewingAsset?.accumulated_depreciation)"></p>
                        </div>
                        <div>
                            <p class="text-gray-500">Net Book Value</p>
                            <p class="font-medium text-green-600" x-text="formatCurrency(viewingAsset?.net_book_value)"></p>
                        </div>
                        <div x-show="viewingAsset?.vendor_name">
                            <p class="text-gray-500">Vendor</p>
                            <p class="font-medium" x-text="viewingAsset?.vendor_name"></p>
                        </div>
                        <div x-show="viewingAsset?.vendor_irn">
                            <p class="text-gray-500">Vendor IRN</p>
                            <p class="font-medium text-green-600" x-text="viewingAsset?.vendor_irn"></p>
                        </div>
                        <div x-show="viewingAsset?.location">
                            <p class="text-gray-500">Location</p>
                            <p class="font-medium" x-text="viewingAsset?.location"></p>
                        </div>
                        <div x-show="viewingAsset?.is_fully_depreciated">
                            <p class="text-gray-500">Fully Depreciated</p>
                            <p class="font-medium text-amber-600">Yes</p>
                        </div>
                    </div>
                    
                    <div x-show="viewingAsset?.description" class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-gray-500 text-sm">Description</p>
                        <p class="text-sm" x-text="viewingAsset?.description"></p>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="showViewModal = false" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function fixedAssetsPage() {
    return {
        // State
        assets: [],
        summary: {},
        loading: true,
        saving: false,
        disposing: false,
        runningDepreciation: false,
        
        // Filters
        searchQuery: '',
        categoryFilter: '',
        statusFilter: '',
        
        // Pagination
        currentPage: 1,
        pageSize: 20,
        totalItems: 0,
        totalPages: 1,
        
        // Modals
        showModal: false,
        showDisposeModal: false,
        showViewModal: false,
        showScheduleModal: false,
        showCapitalGainsModal: false,
        
        // Editing state
        editingAsset: null,
        disposingAsset: null,
        viewingAsset: null,
        
        // Forms - Initialize directly instead of calling this.getDefaultForm()
        form: {
            name: '',
            description: '',
            category: '',
            acquisition_date: new Date().toISOString().split('T')[0],
            acquisition_cost: '',
            residual_value: 0,
            depreciation_method: 'reducing_balance',
            useful_life_years: null,
            vendor_name: '',
            vendor_irn: '',
            serial_number: '',
            location: ''
        },
        disposeForm: {
            disposal_type: 'sale',
            disposal_date: new Date().toISOString().split('T')[0],
            disposal_proceeds: 0,
            buyer_name: '',
            notes: ''
        },
        
        getDefaultForm() {
            return {
                name: '',
                description: '',
                category: '',
                acquisition_date: new Date().toISOString().split('T')[0],
                acquisition_cost: '',
                residual_value: 0,
                depreciation_method: 'reducing_balance',
                useful_life_years: null,
                vendor_name: '',
                vendor_irn: '',
                serial_number: '',
                location: ''
            };
        },
        
        async init() {
            await this.loadAssets();
            await this.loadSummary();
        },
        
        async loadAssets() {
            this.loading = true;
            try {
                const entityId = this.getEntityId();
                if (!entityId) {
                    console.error('No entity ID found');
                    window.location.href = '/select-entity?next=/fixed-assets';
                    return;
                }
                
                let url = `/api/v1/fixed-assets/entity/${entityId}?skip=${(this.currentPage - 1) * this.pageSize}&limit=${this.pageSize}`;
                if (this.categoryFilter) url += `&category=${this.categoryFilter}`;
                if (this.statusFilter) url += `&status=${this.statusFilter}`;
                
                const response = await fetch(url, { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    this.assets = Array.isArray(data) ? data : (data.items || []);
                    this.totalItems = data.total || this.assets.length;
                    this.totalPages = Math.ceil(this.totalItems / this.pageSize);
                }
            } catch (error) {
                console.error('Error loading assets:', error);
            } finally {
                this.loading = false;
            }
        },
        
        async loadSummary() {
            try {
                const entityId = this.getEntityId();
                if (!entityId) return;
                
                const response = await fetch(`/api/v1/fixed-assets/entity/${entityId}/summary`, { credentials: 'include' });
                if (response.ok) {
                    this.summary = await response.json();
                }
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        },
        
        async saveAsset() {
            this.saving = true;
            try {
                const entityId = this.getEntityId();
                const payload = {
                    entity_id: entityId,
                    ...this.form,
                    acquisition_cost: parseFloat(this.form.acquisition_cost) || 0,
                    residual_value: parseFloat(this.form.residual_value) || 0
                };
                
                let url = '/api/v1/fixed-assets/';
                let method = 'POST';
                
                if (this.editingAsset) {
                    url = `/api/v1/fixed-assets/${this.editingAsset.id}`;
                    method = 'PATCH';
                }
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    this.showModal = false;
                    this.resetForm();
                    await this.loadAssets();
                    await this.loadSummary();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to save asset');
                }
            } catch (error) {
                console.error('Error saving asset:', error);
                alert('An error occurred while saving the asset');
            } finally {
                this.saving = false;
            }
        },
        
        editAsset(asset) {
            this.editingAsset = asset;
            this.form = {
                name: asset.name,
                description: asset.description || '',
                category: asset.category,
                acquisition_date: asset.acquisition_date,
                acquisition_cost: asset.acquisition_cost,
                residual_value: asset.residual_value,
                depreciation_method: asset.depreciation_method,
                useful_life_years: asset.useful_life_years,
                vendor_name: asset.vendor_name || '',
                vendor_irn: asset.vendor_irn || '',
                serial_number: asset.serial_number || '',
                location: asset.location || ''
            };
            this.showModal = true;
        },
        
        viewAsset(asset) {
            this.viewingAsset = asset;
            this.showViewModal = true;
        },
        
        disposeAsset(asset) {
            this.disposingAsset = asset;
            this.disposeForm = {
                disposal_type: 'sale',
                disposal_date: new Date().toISOString().split('T')[0],
                disposal_proceeds: 0,
                buyer_name: '',
                notes: ''
            };
            this.showDisposeModal = true;
        },
        
        async confirmDispose() {
            this.disposing = true;
            try {
                const response = await fetch(`/api/v1/fixed-assets/${this.disposingAsset.id}/dispose`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...this.disposeForm,
                        disposal_proceeds: parseFloat(this.disposeForm.disposal_proceeds) || 0
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    this.showDisposeModal = false;
                    await this.loadAssets();
                    await this.loadSummary();
                    
                    if (result.capital_gain_loss) {
                        const gainLoss = parseFloat(result.capital_gain_loss);
                        const message = gainLoss > 0 
                            ? `Capital gain of ${this.formatCurrency(gainLoss)} recorded. This will be taxed at CIT rate.`
                            : gainLoss < 0
                            ? `Capital loss of ${this.formatCurrency(Math.abs(gainLoss))} recorded.`
                            : 'Asset disposed with no gain or loss.';
                        alert(message);
                    }
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to dispose asset');
                }
            } catch (error) {
                console.error('Error disposing asset:', error);
                alert('An error occurred while disposing the asset');
            } finally {
                this.disposing = false;
            }
        },
        
        async runDepreciation() {
            const year = new Date().getFullYear();
            const month = new Date().getMonth() + 1;
            
            if (!confirm(`Run depreciation for ${year}/${month}? This will calculate and post depreciation for all active assets.`)) {
                return;
            }
            
            this.runningDepreciation = true;
            try {
                const entityId = this.getEntityId();
                const response = await fetch('/api/v1/fixed-assets/depreciation/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        entity_id: entityId,
                        fiscal_year_end: `${year}-12-31`,
                        period_start: `${year}-${String(month).padStart(2, '0')}-01`,
                        period_end: `${year}-${String(month).padStart(2, '0')}-28`
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'Depreciation posted successfully');
                    await this.loadAssets();
                    await this.loadSummary();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to run depreciation');
                }
            } catch (error) {
                console.error('Error running depreciation:', error);
                alert('An error occurred while running depreciation');
            } finally {
                this.runningDepreciation = false;
            }
        },
        
        resetForm() {
            this.editingAsset = null;
            this.form = this.getDefaultForm();
        },
        
        prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.loadAssets();
            }
        },
        
        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.loadAssets();
            }
        },
        
        getEntityId() {
            // Check localStorage first, then cookie
            const fromStorage = localStorage.getItem('currentEntityId');
            if (fromStorage && fromStorage !== 'null' && fromStorage !== 'undefined') {
                return fromStorage;
            }
            const cookie = document.cookie.split('; ').find(row => row.startsWith('entity_id='));
            return cookie ? cookie.split('=')[1] : null;
        },
        
        formatCurrency(value) {
            const num = parseFloat(value) || 0;
            return '₦' + num.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },
        
        formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-NG', { year: 'numeric', month: 'short', day: 'numeric' });
        },
        
        formatCategory(category) {
            if (!category) return '';
            const names = {
                'land': 'Land',
                'buildings': 'Buildings',
                'plant_machinery': 'Plant & Machinery',
                'furniture_fittings': 'Furniture & Fittings',
                'motor_vehicles': 'Motor Vehicles',
                'computer_equipment': 'Computer Equipment',
                'office_equipment': 'Office Equipment',
                'leasehold_improvements': 'Leasehold Improvements',
                'intangible_assets': 'Intangible Assets',
                'other': 'Other'
            };
            return names[category] || category;
        }
    };
}
</script>

<style>
[x-cloak] { display: none !important; }
</style>
{% endblock %}

<!-- Salary Calculator Modal -->
<div x-show="showCalculatorModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showCalculatorModal = false"></div>

        <div class="relative bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-4xl sm:w-full" @click.stop
             x-data="{
                 calcForm: {
                     basic_salary: 0,
                     housing_allowance: 0,
                     transport_allowance: 0,
                     other_allowances: 0,
                     annual_rent_paid: 0,
                     has_life_insurance: false,
                     pension_applicable: true,
                     nhf_applicable: true
                 },
                 result: null,
                 loading: false,
                 grossMonthly() {
                     return (this.calcForm.basic_salary || 0) + (this.calcForm.housing_allowance || 0) + (this.calcForm.transport_allowance || 0) + (this.calcForm.other_allowances || 0);
                 },
                 async calculate() {
                     this.loading = true;
                     try {
                         const response = await fetch('/api/v1/payroll/calculate-salary', {
                             method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify({
                                 basic_salary: this.calcForm.basic_salary * 12,
                                 housing_allowance: this.calcForm.housing_allowance * 12,
                                 transport_allowance: this.calcForm.transport_allowance * 12,
                                 other_allowances: this.calcForm.other_allowances * 12,
                                 annual_rent_paid: this.calcForm.annual_rent_paid,
                                 has_life_insurance: this.calcForm.has_life_insurance,
                                 pension_applicable: this.calcForm.pension_applicable,
                                 nhf_applicable: this.calcForm.nhf_applicable
                             })
                         });
                         if (response.ok) {
                             this.result = await response.json();
                         } else {
                             alert('Calculation failed');
                         }
                     } catch (e) {
                         console.error(e);
                     } finally {
                         this.loading = false;
                     }
                 }
             }">
            <div class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center text-white">
                        <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        <div>
                            <h3 class="text-xl font-semibold">Nigerian Salary Calculator</h3>
                            <p class="text-sm text-green-100">2026 PAYE Rates with Tax Reform</p>
                        </div>
                    </div>
                    <button type="button" @click="showCalculatorModal = false" class="text-white hover:text-green-200">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 divide-y lg:divide-y-0 lg:divide-x divide-gray-200">
                <!-- Input Section -->
                <div class="p-6">
                    <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Monthly Income Details</h4>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Basic Salary</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-gray-500">₦</span>
                                <input type="number" x-model.number="calcForm.basic_salary" min="0" step="1000" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Housing Allowance</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-gray-500">₦</span>
                                <input type="number" x-model.number="calcForm.housing_allowance" min="0" step="1000" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Transport Allowance</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-gray-500">₦</span>
                                <input type="number" x-model.number="calcForm.transport_allowance" min="0" step="1000" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Other Allowances</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-gray-500">₦</span>
                                <input type="number" x-model.number="calcForm.other_allowances" min="0" step="1000" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <span class="font-medium text-gray-900">Monthly Gross</span>
                                <span class="text-xl font-bold text-green-600">₦<span x-text="grossMonthly().toLocaleString()"></span></span>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-200">
                            <h5 class="text-sm font-medium text-gray-700 mb-3">Tax Relief Options (2026)</h5>
                            
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Annual Rent Paid</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-gray-500">₦</span>
                                    <input type="number" x-model.number="calcForm.annual_rent_paid" min="0" step="10000" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Rent Relief: 20% of annual rent, max ₦500,000</p>
                            </div>
                            
                            <div class="flex items-center mb-2">
                                <input type="checkbox" x-model="calcForm.has_life_insurance" id="calc-life-insurance" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                <label for="calc-life-insurance" class="ml-2 text-sm text-gray-700">Has Life Insurance Premium</label>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-200">
                            <h5 class="text-sm font-medium text-gray-700 mb-3">Statutory Deductions</h5>
                            
                            <div class="flex items-center mb-2">
                                <input type="checkbox" x-model="calcForm.pension_applicable" id="calc-pension" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                <label for="calc-pension" class="ml-2 text-sm text-gray-700">Pension (8% Employee)</label>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" x-model="calcForm.nhf_applicable" id="calc-nhf" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                <label for="calc-nhf" class="ml-2 text-sm text-gray-700">NHF (2.5% of Basic)</label>
                            </div>
                        </div>

                        <button @click="calculate()" :disabled="loading" class="w-full mt-4 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium disabled:opacity-50 flex items-center justify-center">
                            <template x-if="loading">
                                <svg class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                </svg>
                            </template>
                            <span x-text="loading ? 'Calculating...' : 'Calculate Take-Home Pay'"></span>
                        </button>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="p-6 bg-gray-50">
                    <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Salary Breakdown</h4>
                    
                    <template x-if="!result">
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-gray-500 mt-4">Enter salary details and click calculate to see the breakdown</p>
                        </div>
                    </template>

                    <template x-if="result">
                        <div class="space-y-4">
                            <!-- Gross Income -->
                            <div class="p-4 bg-white rounded-lg border border-gray-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Annual Gross Income</span>
                                    <span class="text-lg font-bold text-gray-900">₦<span x-text="result.gross_income?.toLocaleString()"></span></span>
                                </div>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-xs text-gray-500">Monthly</span>
                                    <span class="text-sm font-medium text-gray-600">₦<span x-text="(result.gross_income / 12)?.toLocaleString()"></span></span>
                                </div>
                            </div>

                            <!-- Deductions -->
                            <div class="p-4 bg-white rounded-lg border border-gray-200">
                                <h5 class="text-sm font-medium text-gray-700 mb-3">Deductions (Annual)</h5>
                                
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between" x-show="result.employee_pension > 0">
                                        <span class="text-gray-600">Pension (8%)</span>
                                        <span class="text-red-600">- ₦<span x-text="result.employee_pension?.toLocaleString()"></span></span>
                                    </div>
                                    <div class="flex justify-between" x-show="result.nhf_contribution > 0">
                                        <span class="text-gray-600">NHF (2.5%)</span>
                                        <span class="text-red-600">- ₦<span x-text="result.nhf_contribution?.toLocaleString()"></span></span>
                                    </div>
                                    <div class="flex justify-between border-t pt-2">
                                        <span class="text-gray-600">PAYE Tax</span>
                                        <span class="text-red-600 font-medium">- ₦<span x-text="result.paye_tax?.toLocaleString()"></span></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Tax Relief Applied -->
                            <div class="p-4 bg-green-50 rounded-lg border border-green-200" x-show="result.cra > 0 || result.rent_relief > 0">
                                <h5 class="text-sm font-medium text-green-700 mb-2">Tax Relief Applied</h5>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-green-600">CRA (₦200K + 20% Gross)</span>
                                        <span class="text-green-700 font-medium">₦<span x-text="result.cra?.toLocaleString()"></span></span>
                                    </div>
                                    <div class="flex justify-between" x-show="result.rent_relief > 0">
                                        <span class="text-green-600">Rent Relief (20% up to ₦500K)</span>
                                        <span class="text-green-700 font-medium">₦<span x-text="result.rent_relief?.toLocaleString()"></span></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Taxable Income -->
                            <div class="p-4 bg-white rounded-lg border border-gray-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Taxable Income (Annual)</span>
                                    <span class="font-medium text-gray-900">₦<span x-text="result.taxable_income?.toLocaleString()"></span></span>
                                </div>
                            </div>

                            <!-- Net Pay Highlight -->
                            <div class="p-4 bg-gradient-to-r from-green-500 to-green-600 rounded-lg text-white">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-green-100 text-sm">Annual Net Pay</p>
                                        <p class="text-2xl font-bold">₦<span x-text="result.annual_net_pay?.toLocaleString()"></span></p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-green-100 text-sm">Monthly Take-Home</p>
                                        <p class="text-2xl font-bold">₦<span x-text="result.monthly_net_pay?.toLocaleString()"></span></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Effective Tax Rate -->
                            <div class="text-center">
                                <span class="inline-flex items-center px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-medium">
                                    Effective Tax Rate: <span x-text="((result.paye_tax / result.gross_income) * 100).toFixed(1)"></span>%
                                </span>
                            </div>

                            <!-- 2026 PAYE Bands Info -->
                            <div class="mt-6 p-4 bg-orange-50 rounded-lg border border-orange-200">
                                <h5 class="text-sm font-medium text-orange-800 mb-2">2026 PAYE Tax Bands</h5>
                                <div class="grid grid-cols-2 gap-2 text-xs text-orange-700">
                                    <div>₦0 - ₦800K: <span class="font-semibold">0%</span></div>
                                    <div>₦800K - ₦2.4M: <span class="font-semibold">15%</span></div>
                                    <div>₦2.4M - ₦4.8M: <span class="font-semibold">20%</span></div>
                                    <div>₦4.8M - ₦7.2M: <span class="font-semibold">25%</span></div>
                                    <div class="col-span-2">Above ₦7.2M: <span class="font-semibold">30%</span></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

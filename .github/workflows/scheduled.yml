# =============================================
# TekVwarho ProAudit - Scheduled Tasks
# Cron jobs for maintenance and security
# =============================================

name: Scheduled Tasks

on:
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
    # Run dependency update check weekly on Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run'
        required: true
        type: choice
        options:
          - security-scan
          - dependency-check
          - all

env:
  PYTHON_VERSION: '3.11'

jobs:
  # =============================================
  # DAILY SECURITY SCAN
  # =============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * *' || github.event.inputs.task == 'security-scan' || github.event.inputs.task == 'all'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pip-audit
          pip install -r requirements.txt
      
      - name: Run Bandit
        id: bandit
        run: |
          bandit -r app/ -f json -o bandit-report.json || true
          if [ -f bandit-report.json ]; then
            ISSUES=$(cat bandit-report.json | python -c "import json,sys; d=json.load(sys.stdin); print(len(d.get('results', [])))")
            echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          fi
      
      - name: Run pip-audit
        id: audit
        run: |
          pip-audit --format json --output audit-report.json || true
          if [ -f audit-report.json ]; then
            VULNS=$(cat audit-report.json | python -c "import json,sys; d=json.load(sys.stdin); print(len(d))")
            echo "vulnerabilities=$VULNS" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_number }}
          path: |
            bandit-report.json
            audit-report.json
          retention-days: 30
      
      - name: Create issue if vulnerabilities found
        if: steps.audit.outputs.vulnerabilities > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditReport = JSON.parse(fs.readFileSync('audit-report.json', 'utf8'));
            
            const issueBody = `## ðŸ” Security Vulnerability Report
            
            **Date:** ${new Date().toISOString().split('T')[0]}
            **Vulnerabilities Found:** ${auditReport.length}
            
            ### Affected Packages:
            ${auditReport.slice(0, 10).map(v => `- **${v.name}** (${v.version}): ${v.vulns.map(vv => vv.id).join(', ')}`).join('\n')}
            
            ${auditReport.length > 10 ? `\n... and ${auditReport.length - 10} more` : ''}
            
            ### Actions Required:
            1. Review the full security report in workflow artifacts
            2. Update affected packages to patched versions
            3. Test the application after updates
            
            ---
            *This issue was automatically created by the security scan workflow.*
            `;
            
            // Check if there's already an open security issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security',
              state: 'open'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ” Security Vulnerabilities Detected',
                body: issueBody,
                labels: ['security', 'automated']
              });
            }
        continue-on-error: true

  # =============================================
  # WEEKLY DEPENDENCY CHECK
  # =============================================
  dependency-check:
    name: Dependency Update Check
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 3 * * 1' || github.event.inputs.task == 'dependency-check' || github.event.inputs.task == 'all'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools
      
      - name: Check for outdated packages
        run: |
          pip install -r requirements.txt
          pip list --outdated --format=json > outdated.json
          
          echo "## Outdated Packages Report" >> $GITHUB_STEP_SUMMARY
          echo "Date: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          python -c "
          import json
          with open('outdated.json') as f:
              packages = json.load(f)
          
          if packages:
              print('| Package | Current | Latest | Type |')
              print('|---------|---------|--------|------|')
              for p in packages:
                  print(f\"| {p['name']} | {p['version']} | {p['latest_version']} | {p['latest_filetype']} |\")
          else:
              print('âœ… All packages are up to date!')
          " >> $GITHUB_STEP_SUMMARY
      
      - name: Upload outdated packages report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report-${{ github.run_number }}
          path: outdated.json
          retention-days: 7

  # =============================================
  # DATABASE BACKUP VERIFICATION
  # =============================================
  backup-verification:
    name: Backup Verification
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * *' || github.event.inputs.task == 'all'
    
    steps:
      - name: Verify backup systems
        run: |
          echo "## Backup System Verification" >> $GITHUB_STEP_SUMMARY
          echo "Date: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Note: Configure backup verification with your cloud provider" >> $GITHUB_STEP_SUMMARY
          # Add actual backup verification commands here
          # Example: Check Azure Backup, AWS S3 snapshots, etc.
